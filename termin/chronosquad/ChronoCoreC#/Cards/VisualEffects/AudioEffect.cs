#if UNITY_64
using UnityEngine;
#endif

using System;

class AudioEffect : GlobalEvent
{
    float audio_start_time = 0.4f;
    private Vector3 position;

    [IgnoreRefflectionAttribute]
    double audio_modif = 0.0f;

    [IgnoreRefflectionAttribute]
    private AudioSource audio_source;
    string clip_name;

    public AudioEffect(long start_step, Vector3 position, string clip_name, float duration)
        : base(
            start_step,
            finish_step: (long)(start_step + Utility.GAME_GLOBAL_FREQUENCY * duration)
        )
    {
        this.position = position;
        this.clip_name = clip_name;
    }

    public override void on_enter(long current_step, ITimeline tl)
    {
        if ((tl as Timeline).IsTimeSpirit)
            return;

        var ao = new GameObject("ShootEffectAudio");
        audio_source = ao.AddComponent<AudioSource>();
        audio_source.clip = MaterialKeeper.Instance.GetAudioClip(clip_name);
        audio_source.volume = 0.5f;
        audio_source.time = audio_start_time;
        audio_source.Play();
        update(current_step, tl);
    }

    public override void on_leave(long current_step, ITimeline tl)
    {
        if (tl.IsTimeSpirit)
            return;

        if (audio_source != null)
        {
            GameObject.Destroy(audio_source.gameObject);
            audio_source = null;
        }
    }

    public override void update(long current_step, ITimeline tl)
    {
        if (tl.IsTimeSpirit)
            return;

        float phase = (current_step - StartStep) / (float)(FinishStep - StartStep);

        var modif = tl.GetChronoSphere().GetAudioTimeScale();
        if (audio_modif != modif)
        {
            audio_source.pitch = (float)modif;
            float audio_time = FinishTime - StartTime;
            var current_time = audio_source.time;
            var evaluated_time = audio_start_time + phase * audio_time;

            if (Mathf.Abs(evaluated_time - current_time) > 0.2f)
                audio_source.time = evaluated_time;

            audio_modif = modif;
        }
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, audio_start_time);
        result = FieldScanner.ModifyHash(result, position);
        result = FieldScanner.ModifyHash(result, clip_name);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as AudioEffect;
        return audio_start_time == other.audio_start_time
            && position == other.position
            && clip_name == other.clip_name
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
