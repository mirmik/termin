using System.Collections.Generic;
using UnityEngine;

public abstract class TimelineScript
{
    protected MyList<ReferencedPoint> points = new MyList<ReferencedPoint>();

    public void SetPoints(MyList<GameObject> points)
    {
        // foreach (var point in points)
        // {
        // 	this.points.Add(new ReferencedPoint(point.transform.position, null));
        // }
    }

    public abstract void ApplyForTimeline(ITimeline tl);
}

public class TimelineScriptApplyDialogueGraph : TimelineScript
{
    public DialogueGraph dialogue;

    public TimelineScriptApplyDialogueGraph(DialogueGraph dialogue)
    {
        this.dialogue = dialogue;
    }

    public override void ApplyForTimeline(ITimeline tl)
    {
        Debug.Log("TimelineScriptApplyDialogueGraph ApplyForTimeline");
        tl.AddDialogue(dialogue, tl.CurrentStep());
    }
}

public class TimelineScriptApplyScr : TimelineScript
{
    public ScrTree scr;

    public TimelineScriptApplyScr(ScrTree scr)
    {
        this.scr = scr;
    }

    public override void ApplyForTimeline(ITimeline tl)
    {
        foreach (var speach in scr.speaches)
        {
            var copy = speach.ShiftedCopy(speach, tl.CurrentStep());
            (tl as Timeline).NarativeState.speach_objects.Add(copy);
        }

        foreach (var action in scr.actions)
        {
            var obj = tl.GetObject(action.name);
            var point_name = action.target;
            var point_index = scr.points.FindIndex(x => x.name == point_name);
            var point_coord = points[point_index].LocalPosition;
            (obj as Actor).MoveToCommand(point_coord, action.type);
        }
    }
}

public class SpeachObject : BasicMultipleAction
{
    public string speaker;
    public string text;

    public Sprite GetImageSpriteForSpeaker()
    {
        var sprite = GameCore.GetImageSpriteForSpeaker(speaker);
        return sprite;
    }

    public SpeachObject(string speaker, string text, long start, long end) : base(start, end)
    {
        //Debug.Log("SpeachObject " + speaker + " " + text + " " + start + " " + end);
        this.speaker = speaker;
        this.text = text;
    }

    public string CompileText(long step)
    {
        var speed = 30f;
        var step_from_start = step - StartStep;
        var time_from_start = Utility.DurationFromSteps(step_from_start);
        var count = (int)(time_from_start * speed);
        if (count > text.Length)
            count = text.Length;
        var subtext = this.text.Substring(0, count);
        return subtext;
    }

    public SpeachObject ShiftedCopy(SpeachObject original, long step)
    {
        return new SpeachObject(
            original.speaker,
            original.text,
            original.StartStep + step,
            original.FinishStep + step
        );
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, speaker);
        result = FieldScanner.ModifyHash(result, text);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as SpeachObject;
        return speaker == other.speaker
            && text == other.text
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}

public struct SpeachObjectPair
{
    public Sprite sprite;
    public string text;
}

public class NarativeState
{
    public MultipleActionList<SpeachObject> speach_objects = new MultipleActionList<SpeachObject>(
        true
    );
    public MultipleActionList<DialogueObject> dialogue_objects =
        new MultipleActionList<DialogueObject>(true);

    public string CompileText(long step)
    {
        // Для тестов
        var active_states = speach_objects.ActiveStates();
        var text = "";
        foreach (var state in active_states)
        {
            text += state.CompileText(step);
        }
        return text;
    }

    MyList<SpeachObjectPair> speach_pairs = new MyList<SpeachObjectPair>();

    public MyList<SpeachObjectPair> CompileSpeachObjects(long step)
    {
        //Debug.Log("NarativeState CompileSpeachObjects " + step);
        var active_states = speach_objects.ActiveStates();
        speach_pairs.Clear();
        foreach (var state in active_states)
        {
            if (state == null)
                continue;

            Debug.Log(
                "NarativeState CompileSpeachObjects state "
                    + state.StartStep
                    + " "
                    + state.FinishStep
            );
            var sprite = state.GetImageSpriteForSpeaker();
            var text = state.CompileText(step);
            speach_pairs.Add(new SpeachObjectPair() { sprite = sprite, text = text });
        }
        // reverse
        speach_pairs.Reverse();
        return speach_pairs;
    }

    public void Promote(long step)
    {
        MyList<SpeachObject> speach_added;
        MyList<SpeachObject> speach_goned;
        MyList<DialogueObject> dialogue_added;
        MyList<DialogueObject> dialogue_goned;

        dialogue_objects.Promote(step, out dialogue_added, out dialogue_goned);
        foreach (var dialobj in dialogue_added)
        {
            if (dialobj == null)
                continue;
            dialobj.Apply(this, step);
        }

        speach_objects.Promote(step, out speach_added, out speach_goned);
    }

    public void AddDialogue(DialogueGraph dialogue, long step)
    {
        Debug.Log("NarativeState AddDialogue " + step);
        dialogue_objects.Add(new DialogueObject(dialogue, step));
    }

    public void DropToCurrentState()
    {
        speach_objects.DropToCurrentState();
        dialogue_objects.DropToCurrentState();
    }
}

#if !UNITY_64

[TestClass]
public static class NarativeStateTests
{
    public static void CompileTextTest(Checker checker)
    {
        var speach = new SpeachObject("NPC", "Hello", 0, 100);
        var text = speach.CompileText(50);
        checker.Equal(text, "Hello");
    }

    public static void CompileText2Test(Checker checker)
    {
        var state = new NarativeState();
        var speach = new SpeachObject("NPC", "Hello", 0, 100);
        state.speach_objects.Add(speach);
        state.Promote(50);
        var text = speach.CompileText(50);
        checker.Equal(text, "Hello");
    }

    public static void CompileText3Test(Checker checker)
    {
        DialogueGraph graph = new DialogueGraph();
        graph.entrance = new DialogueNode("hello");

        var state = new NarativeState();
        var dialogue = new DialogueObject(graph, 10);

        state.dialogue_objects.Add(dialogue);

        state.Promote(50);

        var text = state.CompileText(50);
        checker.Equal(text, "hello");
    }
}
#endif
