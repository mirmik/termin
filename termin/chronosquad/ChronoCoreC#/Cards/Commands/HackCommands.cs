using System.Collections.Generic;
using System;

#if UNITY_64
using UnityEngine;
#endif

public enum HackCommandType
{
    InjectAvatar,
    FormatNetwork
}

public class HackCommand : ClosestCommand
{
    string _avatar_name;
    HackCommandType _hack_type;

    public HackCommand(
        ObjectOfTimeline target_actor,
        WalkingType walktype,
        float punch_distance,
        long stamp,
        HackCommandType hack_type,
        string avatar_name
    ) : base(target_actor.ObjectId(), walktype, punch_distance, stamp)
    {
        _avatar_name = avatar_name;
        _hack_type = hack_type;
    }

    void StartHackPhase(ObjectOfTimeline actor, ITimeline timeline)
    {
        actor.UnDisguise();
        actor.ShowModel();

        var target_actor = TargetObject(timeline);
        var curstep = actor.LocalStep();
        InteractionAnimatronic punch = new InteractionAnimatronic(
            start_step: curstep,
            finish_step: curstep + 480,
            pose: target_actor.InteractionPose(),
            anim_type: AnimationType.TerminalUsing
        );
        actor.SetNextAnimatronic(punch);
    }

    void HackTarget(ObjectOfTimeline obj, ITimeline timeline)
    {
        if (_hack_type == HackCommandType.InjectAvatar)
        {
            var materialize_event = new AnigilationEvent(
                step: timeline.CurrentStep(),
                object_name: _avatar_name,
                reversed: true
            );
            timeline.AddEvent(materialize_event);

            var avatar = timeline.GetObject(_avatar_name) as Avatar;
            avatar.MoveCommand(TargetObject(timeline).ObjectId(), ignore_pathfinding: true);
        }
        else if (_hack_type == HackCommandType.FormatNetwork)
        {
            var target_object = TargetObject(timeline);
            var net_point = target_object.GetComponent<NetPoint>();
            net_point.StartFormatCommand(timeline as Timeline, timeline.CurrentStep());
        }
    }

    public override bool ActionPhase(ObjectOfTimeline actor, ITimeline timeline)
    {
        bool is_shoot_started = actor.CurrentAnimatronic() is InteractionAnimatronic;

        if (!is_shoot_started)
        {
            StartHackPhase(actor, timeline);
            return false;
        }
        else
        {
            var start_local_time = actor.CurrentAnimatronic().StartStep;
            var current_local_time = actor.LocalStep();
            if (current_local_time - start_local_time > 480)
            {
                HackTarget(actor, timeline);
                return true;
            }
            else
            {
                return false;
            }
        }
    }

    public override bool IsActionStarted(ObjectOfTimeline actor)
    {
        return actor.CurrentAnimatronic() is InteractionAnimatronic;
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, _avatar_name);
        result = FieldScanner.ModifyHash(result, _hack_type);
        result = FieldScanner.ModifyHash(result, _action_distance);
        result = FieldScanner.ModifyHash(result, target_actor_name);
        result = FieldScanner.ModifyHash(result, can_use_air_strike);
        result = FieldScanner.ModifyHash(result, walktype);
        result = FieldScanner.ModifyHash(result, use_interaction_pose);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as HackCommand;
        return _avatar_name == other._avatar_name
            && _hack_type == other._hack_type
            && _action_distance == other._action_distance
            && target_actor_name == other.target_actor_name
            && can_use_air_strike == other.can_use_air_strike
            && walktype == other.walktype
            && use_interaction_pose == other.use_interaction_pose
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
