using System.Collections.Generic;
using System;

#if UNITY_64
using UnityEngine;
#endif

public enum ParasiteMode
{
    Control,
    Passanger
}

public class ParasiteCommand : ClosestCommand
{
    ParasiteMode parasiteMode;

    public ParasiteCommand(
        ObjectId target_actor,
        WalkingType walktype,
        float punch_distance,
        long stamp,
        ParasiteMode parasiteMode
    ) : base(target_actor, walktype, punch_distance, stamp)
    {
        this.parasiteMode = parasiteMode;
    }

    void ParasiteTargetControlMode(ObjectOfTimeline obj, ITimeline timeline)
    {
        Debug.Log("ParasiteTargetControlMode");
        var actor = obj as Actor;
        var target_actor = TargetObject(timeline) as Actor;
        // if (actor.HostActor() != null)
        // {
        // 	actor.HostActor().Death(timeline, actor.Name());
        // }

        var animatronic = new ParasiteParasiteAnimatronic(
            start_step: actor.LocalStep(),
            finish_step: Int32.MaxValue,
            host: target_actor.ObjectId()
        );
        actor.SetNextAnimatronic(animatronic);
        actor.SetHostActor(target_actor);
        actor.Disguise(0);

        target_actor.Stop(timeline);
        target_actor.DisableBehaviour();
    }

    void ParasiteTargetPassangerMode(ObjectOfTimeline obj, ITimeline timeline)
    {
        Debug.Log("ParasiteTargetPassangerMode");
        var actor = obj as Actor;
        var target_actor = TargetObject(timeline) as Actor;

        var animatronic = new ParasiteParasiteAnimatronic(
            start_step: actor.LocalStep(),
            finish_step: Int32.MaxValue,
            host: target_actor.ObjectId()
        );
        actor.SetNextAnimatronic(animatronic);
        actor.SetHostActor(target_actor);
        actor.Disguise(0);
    }

    void ParasiteTarget(ObjectOfTimeline obj, ITimeline timeline)
    {
        if (parasiteMode == ParasiteMode.Control)
        {
            ParasiteTargetControlMode(obj, timeline);
        }
        else
        {
            ParasiteTargetPassangerMode(obj, timeline);
        }
    }

    public override bool ActionPhase(ObjectOfTimeline actor, ITimeline timeline)
    {
        var current_animatronic = actor.CurrentAnimatronic();
        if (current_animatronic is ParasiteParasiteAnimatronic)
        {
            Debug.Log("ParasiteCommand.ActionPhase");
            return false;
        }

        //bool is_shoot_started = actor.CurrentAnimatronic() is InteractionAnimatronic;

        //if (!is_shoot_started)
        //{
        // 	Debug.Log("Parasite.StartAtackPhase");
        // 	StartAtackPhase(actor, timeline);
        // 	return false;
        // }
        // else
        // {
        // var start_local_time = actor.CurrentAnimatronic().StartStep;
        // var current_local_time = actor.LocalStep();
        // if (current_local_time - start_local_time > 0)
        // {
        ParasiteTarget(actor, timeline);
        return false;
        // }
        // else
        // {
        // 	return false;
        // }
        //}
    }

    public override bool IsActionStarted(ObjectOfTimeline actor)
    {
        return actor.CurrentAnimatronic() is InteractionAnimatronic
            || actor.CurrentAnimatronic() is ParasiteParasiteAnimatronic;
    }

    public override void StopHandler(CommandBufferBehaviour command_buffer)
    {
        // Debug.Log("ParasiteCommand.StopHandler");
        // var actor = command_buffer.Actor();
        // actor.UnDisguise();
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, parasiteMode);
        result = FieldScanner.ModifyHash(result, _action_distance);
        result = FieldScanner.ModifyHash(result, target_actor_name);
        result = FieldScanner.ModifyHash(result, can_use_air_strike);
        result = FieldScanner.ModifyHash(result, walktype);
        result = FieldScanner.ModifyHash(result, use_interaction_pose);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as ParasiteCommand;
        return parasiteMode == other.parasiteMode
            && _action_distance == other._action_distance
            && target_actor_name == other.target_actor_name
            && can_use_air_strike == other.can_use_air_strike
            && walktype == other.walktype
            && use_interaction_pose == other.use_interaction_pose
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
