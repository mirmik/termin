using System.Collections;
using System.Collections.Generic;
using System;
using UnityEngine;

public class SlugSnipeCommand : ThrowToEnvironmentCommand
{
    public float radius_of_sound = 2;
    public string slug_name;

    public SlugSnipeCommand(
        ReferencedPoint target,
        float shoot_distance,
        float radius_of_sound,
        RestlessnessParameters restlessnessParameters,
        long stamp,
        string slug_name
    ) : base(target, shoot_distance, stamp, can_shoot_from_croach: true)
    {
        this.radius_of_sound = radius_of_sound;
        this.noise_parameters = restlessnessParameters;
        this.slug_name = slug_name;
    }

    override protected void AddEvents(ObjectOfTimeline actor, ITimeline tl)
    {
        Debug.Log("SlugSnipeCommand.AddEvents");
        var target = _target_position.GlobalPosition(tl);
        long offset = (long)(0.0f * Utility.GAME_GLOBAL_FREQUENCY);

        var global_step = tl.CurrentStep();
        Vector3 gun_position = actor.GunPosition();

        float blaster_speed = 50.0f;
        var target_global = _target_position.GlobalPosition(tl);
        float distance = Vector3.Distance(gun_position, target_global);
        float time = distance / blaster_speed;

        var ev = new LoudSoundEvent(
            step: tl.CurrentStep() + offset,
            center: _target_position,
            radius: radius_of_sound,
            noise_parameters: noise_parameters
        );
        tl.AddEvent(ev);

        var effect = new LoudSoundVisualEffect(
            start_step: tl.CurrentStep() + offset,
            finish_step: tl.CurrentStep() + offset + (long)(Utility.GAME_GLOBAL_FREQUENCY * 0.5f),
            position: _target_position,
            maxRadius: radius_of_sound
        );
        tl.AddEvent(effect);

        var p1 = actor.CurrentReferencedPose();
        var p2 = actor.CurrentReferencedPose();
        var p2_global = p2.GlobalPose(tl);
        p2_global.position = target_global;
        p2 = ReferencedPose.FromGlobalPose(p2_global, p1.Frame, tl);

        var slug = tl.GetObject(slug_name);
        var jump_anim = new PoseLerpAnimatronic(
            start_step: tl.CurrentStep() + offset,
            finish_step: tl.CurrentStep() + offset + (long)(Utility.GAME_GLOBAL_FREQUENCY * 0.5f),
            pose_a: p1,
            pose_b: p2
        );
        slug.SetNextAnimatronic(jump_anim);

        var set_hosted = new SetHostedEvent(slug.LocalStep(), next: default, prev: slug._hosted);
        slug.AddCard(set_hosted);
    }

    public override bool IsTrajectoryClear(
        ObjectOfTimeline actor,
        ITimeline timeline,
        Vector3 target_global
    )
    {
        return GameCore.InLineOfSight(actor, target_global, maxdistance: shoot_distance);
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, radius_of_sound);
        result = FieldScanner.ModifyHash(result, slug_name);
        result = FieldScanner.ModifyHash(result, shoot_distance);
        result = FieldScanner.ModifyHash(result, noise_parameters);
        result = FieldScanner.ModifyHash(result, can_shoot_from_croach);
        result = FieldScanner.ModifyHash(result, _target_position);
        result = FieldScanner.ModifyHash(result, _target_type);
        result = FieldScanner.ModifyHash(result, _start_type);
        result = FieldScanner.ModifyHash(result, _walking_type);
        result = FieldScanner.ModifyHash(result, _braced_coordinates);
        result = FieldScanner.ModifyHash(result, _look_around);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as SlugSnipeCommand;
        return radius_of_sound == other.radius_of_sound
            && slug_name == other.slug_name
            && shoot_distance == other.shoot_distance
            && noise_parameters == other.noise_parameters
            && can_shoot_from_croach == other.can_shoot_from_croach
            && _target_position == other._target_position
            && _target_type == other._target_type
            && _start_type == other._start_type
            && _walking_type == other._walking_type
            && _braced_coordinates == other._braced_coordinates
            && _look_around == other._look_around
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
