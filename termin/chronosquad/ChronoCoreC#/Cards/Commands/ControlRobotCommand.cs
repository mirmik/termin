#if UNITY_64
using UnityEngine;
#endif

public class ControlRobotCommand : ActorCommand
{
    bool _control_on_forward;

    public ControlRobotCommand(long step, bool control_on_forward) : base(step)
    {
        _control_on_forward = control_on_forward;
    }

    void DisableHostAI(ObjectOfTimeline host_actor)
    {
        var card = new ChangeAiEnabledCard(
            host_actor,
            host_actor.LocalStep() + 1,
            host_actor.IsAiEnabled(),
            false
        );
        host_actor.AddCard(card);
    }

    void EnableHostAI(ObjectOfTimeline host_actor)
    {
        var card = new ChangeAiEnabledCard(
            host_actor,
            host_actor.LocalStep() + 1,
            !host_actor.IsAiEnabled(),
            false
        );
        host_actor.AddCard(card);
    }

    void SetHostAsControledByAvatar(Avatar avatar, ObjectOfTimeline host_actor)
    {
        ObjectId name = host_actor != null ? host_actor.ObjectId() : default(ObjectId);
        var card = new SetControlledHostCard(
            avatar.LocalStep() + 1,
            name: name,
            attached_on_forward: true
        );
        avatar.AddCard(card);
    }

    public override bool ExecuteFirstTime(ObjectOfTimeline actor, ITimeline timeline)
    {
        Debug.Log("ControlRobotCommand.ExecuteFirstTime");

        var location = (actor as Avatar).Location;
        var host_actor = timeline.GetObject(location);

        var controlled = actor.DirrectControlled;

        if (_control_on_forward)
        {
            DisableHostAI(host_actor);
            SetHostAsControledByAvatar(actor as Avatar, host_actor);
        }
        else
        {
            EnableHostAI(timeline.GetObject(controlled));
            SetHostAsControledByAvatar(actor as Avatar, null);
        }

        return true;
    }

    public override bool Execute(ObjectOfTimeline actor, ITimeline timeline)
    {
        return true;
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, _control_on_forward);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as ControlRobotCommand;
        return _control_on_forward == other._control_on_forward
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
