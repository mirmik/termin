using UnityEngine;
using System.Collections.Generic;
using System;

class TimeStopEffect : GlobalEvent
{
    private ReferencedPoint center;
    private float radius;

    [IgnoreRefflectionAttribute]
    GameObject sphere;

    [IgnoreRefflectionAttribute]
    List<ObjectOfTimeline> objects_in_radius_on_previous_step = new List<ObjectOfTimeline>();

    public TimeStopEffect(long start_step, long finish_step, ReferencedPoint center, float radius)
        : base(start_step, finish_step)
    {
        this.center = center;
        this.radius = radius;
    }

    public override void on_enter(long current_step, ITimeline tl)
    {
        if (sphere == null)
            sphere = GameObject.Instantiate(MaterialKeeper.Instance.GetPrefab("TimeStopSphere"));

        sphere.transform.position = center.GlobalPosition(tl);
    }

    public override void on_leave(long current_step, ITimeline tl)
    {
        GameObject.Destroy(sphere);

        foreach (ObjectOfTimeline obj in objects_in_radius_on_previous_step)
        {
            //obj.Unpause();
            Debug.Log("Unpause");
        }
        objects_in_radius_on_previous_step.Clear();
    }

    public override void update(long current_step, ITimeline tl)
    {
        UpdateLogic(tl);
    }

    public void UpdateLogic(ITimeline tl)
    {
        var global_position = center.GlobalPosition(tl);
        foreach (ObjectOfTimeline obj in (tl as Timeline).present._active_objects_list)
        {
            if (Vector3.Distance(obj.GlobalPosition(), global_position) < radius)
            {
                if (!objects_in_radius_on_previous_step.Contains(obj))
                {
                    //obj.Pause();
                    Debug.Log("Pause");
                    objects_in_radius_on_previous_step.Add(obj);
                }
            }
            else
            {
                if (objects_in_radius_on_previous_step.Contains(obj))
                {
                    //obj.Unpause();
                    Debug.Log("Unpause");
                    objects_in_radius_on_previous_step.Remove(obj);
                }
            }
        }
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, center);
        result = FieldScanner.ModifyHash(result, radius);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as TimeStopEffect;
        return center == other.center
            && radius == other.radius
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
