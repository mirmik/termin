using System;
#if UNITY_64
using UnityEngine;
#endif

[Serializable]
public class AnigilationEvent : GlobalEvent
{
    // Карта не может содержать ссылки на актора, потому что она применима ко многим таймлайнам, где объекты акторов различны.
    string actor_id;
    bool reversed;

    public AnigilationEvent(long step, string object_name, bool reversed) : base(step)
    {
        this.actor_id = object_name;
        this.reversed = reversed;
    }

    public override void on_forward_enter(long current_step, ITimeline tl)
    {
        var actor = tl.TryGetObject(actor_id);
        if (actor == null)
        {
            return;
        }

        if (!reversed)
            actor.Anigilation();
        else
        {
            actor.Materialization();
        }

        ResetGlowRender();
    }

    public override void on_backward_leave(long current_step, ITimeline tl)
    {
        var actor = tl.TryGetObject(actor_id);
        if (actor == null)
            return;

        if (!reversed)
        {
            //if (actor.IsTimePhantom())
            //	return;
            actor.Materialization();
        }
        else
            actor.Anigilation();

        ResetGlowRender();
    }

    void ResetGlowRender()
    {
        var custom_glow_renderer = GameObject
            .Find("Main Camera")
            .GetComponent<CustomGlowRenderer>();
        if (custom_glow_renderer != null)
            custom_glow_renderer.ResetCommandBuffer();
    }

    //BEGIN################################################################
    // This code was generated by FieldScanner

    public override long HashCode()
    {
        long result = 0;
        result = FieldScanner.ModifyHash(result, actor_id);
        result = FieldScanner.ModifyHash(result, reversed);
        result = FieldScanner.ModifyHash(result, start_step);
        result = FieldScanner.ModifyHash(result, finish_step);
        return result;
    }

    public override bool Equals(object obj)
    {
        if (obj == null)
            return false;
        if (obj.GetType() != GetType())
            return false;
        var other = obj as AnigilationEvent;
        return actor_id == other.actor_id
            && reversed == other.reversed
            && start_step == other.start_step
            && finish_step == other.finish_step
            && true;
    }

    public override int GetHashCode()
    {
        return (int)HashCode();
    }
    //END################################################################
}
