<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/closest.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
def&nbsp;_dot(a,&nbsp;b):&nbsp;return&nbsp;float(np.dot(a,&nbsp;b))<br>
<br>
def&nbsp;_project_point_to_segment(p,&nbsp;a,&nbsp;b):<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;возвращает&nbsp;(t_clamped,&nbsp;closest_point)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ab&nbsp;=&nbsp;b&nbsp;-&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;denom&nbsp;=&nbsp;_dot(ab,&nbsp;ab)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;denom&nbsp;&lt;&nbsp;1e-12:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0.0,&nbsp;a&nbsp;&nbsp;#&nbsp;вырожденный&nbsp;отрезок<br>
&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;_dot(p&nbsp;-&nbsp;a,&nbsp;ab)&nbsp;/&nbsp;denom<br>
&nbsp;&nbsp;&nbsp;&nbsp;t_clamped&nbsp;=&nbsp;max(0.0,&nbsp;min(1.0,&nbsp;t))<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t_clamped,&nbsp;a&nbsp;+&nbsp;t_clamped&nbsp;*&nbsp;ab<br>
<br>
def&nbsp;closest_points_between_segments(p0,&nbsp;p1,&nbsp;q0,&nbsp;q1,&nbsp;eps=1e-12):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;(p_near,&nbsp;q_near,&nbsp;dist)&nbsp;—&nbsp;ближайшие&nbsp;точки&nbsp;на&nbsp;отрезках&nbsp;[p0,p1]&nbsp;и&nbsp;[q0,q1]&nbsp;и&nbsp;расстояние.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Корректно&nbsp;обрабатывает&nbsp;границы&nbsp;и&nbsp;вырожденные&nbsp;случаи.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;u&nbsp;=&nbsp;p1&nbsp;-&nbsp;p0<br>
&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;q1&nbsp;-&nbsp;q0<br>
&nbsp;&nbsp;&nbsp;&nbsp;w0&nbsp;=&nbsp;p0&nbsp;-&nbsp;q0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;_dot(u,&nbsp;u)<br>
&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;_dot(u,&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;_dot(v,&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;_dot(u,&nbsp;w0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;_dot(v,&nbsp;w0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;=&nbsp;a&nbsp;*&nbsp;c&nbsp;-&nbsp;b&nbsp;*&nbsp;b<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;candidates&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Алгоритм&nbsp;ищет&nbsp;минимум&nbsp;на&nbsp;квадрате&nbsp;(s,t):([0,1],[0,1])<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1)&nbsp;Внутренний&nbsp;кандидат<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;D&nbsp;&gt;&nbsp;eps:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;(b&nbsp;*&nbsp;e&nbsp;-&nbsp;c&nbsp;*&nbsp;d)&nbsp;/&nbsp;D<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;(a&nbsp;*&nbsp;e&nbsp;-&nbsp;b&nbsp;*&nbsp;d)&nbsp;/&nbsp;D<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;0.0&nbsp;&lt;=&nbsp;s&nbsp;&lt;=&nbsp;1.0&nbsp;and&nbsp;0.0&nbsp;&lt;=&nbsp;t&nbsp;&lt;=&nbsp;1.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_int&nbsp;=&nbsp;p0&nbsp;+&nbsp;s&nbsp;*&nbsp;u<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_int&nbsp;=&nbsp;q0&nbsp;+&nbsp;t&nbsp;*&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;candidates.append((p_int,&nbsp;q_int))<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;прямые&nbsp;параллельны&nbsp;(D&lt;eps),&nbsp;то&nbsp;решений&nbsp;множество&nbsp;и&nbsp;одно&nbsp;из&nbsp;них&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;лежит&nbsp;на&nbsp;рёбрах,&nbsp;поэтому&nbsp;ничего&nbsp;не&nbsp;делаем<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2)&nbsp;Рёбра&nbsp;и&nbsp;углы&nbsp;(фиксируем&nbsp;одну&nbsp;переменную&nbsp;и&nbsp;оптимизируем&nbsp;другую)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;t&nbsp;=&nbsp;0&nbsp;&nbsp;(Q&nbsp;=&nbsp;q0)&nbsp;-&gt;&nbsp;проектируем&nbsp;q0&nbsp;на&nbsp;P<br>
&nbsp;&nbsp;&nbsp;&nbsp;s_t0,&nbsp;p_t0&nbsp;=&nbsp;_project_point_to_segment(q0,&nbsp;p0,&nbsp;p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;candidates.append((p_t0,&nbsp;q0))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;t&nbsp;=&nbsp;1&nbsp;&nbsp;(Q&nbsp;=&nbsp;q1)&nbsp;-&gt;&nbsp;проектируем&nbsp;q1&nbsp;на&nbsp;P<br>
&nbsp;&nbsp;&nbsp;&nbsp;s_t1,&nbsp;p_t1&nbsp;=&nbsp;_project_point_to_segment(q1,&nbsp;p0,&nbsp;p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;candidates.append((p_t1,&nbsp;q1))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;s&nbsp;=&nbsp;0&nbsp;&nbsp;(P&nbsp;=&nbsp;p0)&nbsp;-&gt;&nbsp;проектируем&nbsp;p0&nbsp;на&nbsp;Q<br>
&nbsp;&nbsp;&nbsp;&nbsp;t_s0,&nbsp;q_s0&nbsp;=&nbsp;_project_point_to_segment(p0,&nbsp;q0,&nbsp;q1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;candidates.append((p0,&nbsp;q_s0))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;s&nbsp;=&nbsp;1&nbsp;&nbsp;(P&nbsp;=&nbsp;p1)&nbsp;-&gt;&nbsp;проектируем&nbsp;p1&nbsp;на&nbsp;Q<br>
&nbsp;&nbsp;&nbsp;&nbsp;t_s1,&nbsp;q_s1&nbsp;=&nbsp;_project_point_to_segment(p1,&nbsp;q0,&nbsp;q1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;candidates.append((p1,&nbsp;q_s1))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3)&nbsp;Выбор&nbsp;лучшего&nbsp;кандидата<br>
&nbsp;&nbsp;&nbsp;&nbsp;best&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;best_d2&nbsp;=&nbsp;float(&quot;inf&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;P,&nbsp;Q&nbsp;in&nbsp;candidates:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d2&nbsp;=&nbsp;_dot(P&nbsp;-&nbsp;Q,&nbsp;P&nbsp;-&nbsp;Q)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;d2&nbsp;&lt;&nbsp;best_d2:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_d2&nbsp;=&nbsp;d2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best&nbsp;=&nbsp;(P,&nbsp;Q)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p_near,&nbsp;q_near&nbsp;=&nbsp;best<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;p_near,&nbsp;q_near,&nbsp;float(np.sqrt(best_d2))<br>
<br>
def&nbsp;closest_points_between_capsules(p0,&nbsp;p1,&nbsp;r1,&nbsp;q0,&nbsp;q1,&nbsp;r2):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;ближайшие&nbsp;точки&nbsp;на&nbsp;поверхностях&nbsp;двух&nbsp;капсул&nbsp;и&nbsp;расстояние&nbsp;между&nbsp;ними.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Капсулы&nbsp;заданы&nbsp;своими&nbsp;осями&nbsp;(отрезками&nbsp;[p0,p1]&nbsp;и&nbsp;[q0,q1])&nbsp;и&nbsp;радиусами&nbsp;r1,&nbsp;r2.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Используем&nbsp;уже&nbsp;реализованный&nbsp;поиск&nbsp;ближайших&nbsp;точек&nbsp;между&nbsp;отрезками<br>
&nbsp;&nbsp;&nbsp;&nbsp;p,&nbsp;q,&nbsp;dist_axis&nbsp;=&nbsp;closest_points_between_segments(p0,&nbsp;p1,&nbsp;q0,&nbsp;q1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;оси&nbsp;почти&nbsp;совпадают&nbsp;(вектор&nbsp;нулевой)<br>
&nbsp;&nbsp;&nbsp;&nbsp;diff&nbsp;=&nbsp;p&nbsp;-&nbsp;q<br>
&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;np.linalg.norm(diff)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;оси&nbsp;пересекаются&nbsp;или&nbsp;капсулы&nbsp;перекрываются<br>
&nbsp;&nbsp;&nbsp;&nbsp;penetration&nbsp;=&nbsp;r1&nbsp;+&nbsp;r2&nbsp;-&nbsp;dist<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;penetration&nbsp;&gt;=&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Пересекаются<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Поскольку&nbsp;множество&nbsp;точек&nbsp;имеют&nbsp;расстояние&nbsp;0.0&nbsp;до&nbsp;коллайдера-антагонистa.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Выбор&nbsp;решения&nbsp;осуществляется&nbsp;из&nbsp;соображения&nbsp;наибольшей&nbsp;плавности.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k&nbsp;=&nbsp;r1&nbsp;/&nbsp;(r1&nbsp;+&nbsp;r2)&nbsp;if&nbsp;(r1&nbsp;+&nbsp;r2)&nbsp;&gt;&nbsp;1e-12&nbsp;else&nbsp;0.5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_surface&nbsp;=&nbsp;p&nbsp;-&nbsp;diff&nbsp;*&nbsp;k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_surface&nbsp;=&nbsp;q&nbsp;+&nbsp;diff&nbsp;*&nbsp;(1&nbsp;-&nbsp;k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance&nbsp;=&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Разделены<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;direction&nbsp;=&nbsp;diff&nbsp;/&nbsp;dist<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_surface&nbsp;=&nbsp;p&nbsp;-&nbsp;direction&nbsp;*&nbsp;r1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_surface&nbsp;=&nbsp;q&nbsp;+&nbsp;direction&nbsp;*&nbsp;r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance&nbsp;=&nbsp;dist&nbsp;-&nbsp;(r1&nbsp;+&nbsp;r2)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;p_surface,&nbsp;q_surface,&nbsp;distance<br>
<br>
def&nbsp;closest_points_between_capsule_and_sphere(capsule_a,&nbsp;capsule_b,&nbsp;capsule_r,&nbsp;sphere_center,&nbsp;sphere_r):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;ближайшие&nbsp;точки&nbsp;на&nbsp;поверхности&nbsp;капсулы&nbsp;и&nbsp;сферы,&nbsp;а&nbsp;также&nbsp;расстояние&nbsp;между&nbsp;ними.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Капсула&nbsp;задана&nbsp;своими&nbsp;концами&nbsp;(отрезком&nbsp;[capsule_a,&nbsp;capsule_b])&nbsp;и&nbsp;радиусом&nbsp;capsule_r.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Сфера&nbsp;задана&nbsp;центром&nbsp;sphere_center&nbsp;и&nbsp;радиусом&nbsp;sphere_r.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Используем&nbsp;уже&nbsp;реализованный&nbsp;поиск&nbsp;ближайших&nbsp;точек&nbsp;между&nbsp;отрезком&nbsp;и&nbsp;точкой<br>
&nbsp;&nbsp;&nbsp;&nbsp;t,&nbsp;p&nbsp;=&nbsp;_project_point_to_segment(sphere_center,&nbsp;capsule_a,&nbsp;capsule_b)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;diff&nbsp;=&nbsp;p&nbsp;-&nbsp;sphere_center<br>
&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;np.linalg.norm(diff)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;penetration&nbsp;=&nbsp;capsule_r&nbsp;+&nbsp;sphere_r&nbsp;-&nbsp;dist<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;penetration&nbsp;&gt;=&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Пересекаются<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k&nbsp;=&nbsp;capsule_r&nbsp;/&nbsp;(capsule_r&nbsp;+&nbsp;sphere_r)&nbsp;if&nbsp;(capsule_r&nbsp;+&nbsp;sphere_r)&nbsp;&gt;&nbsp;1e-12&nbsp;else&nbsp;0.5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_surface&nbsp;=&nbsp;p&nbsp;-&nbsp;diff&nbsp;*&nbsp;k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_surface&nbsp;=&nbsp;sphere_center&nbsp;+&nbsp;diff&nbsp;*&nbsp;(1&nbsp;-&nbsp;k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance&nbsp;=&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Разделены<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;direction&nbsp;=&nbsp;diff&nbsp;/&nbsp;dist<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_surface&nbsp;=&nbsp;p&nbsp;-&nbsp;direction&nbsp;*&nbsp;capsule_r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_surface&nbsp;=&nbsp;sphere_center&nbsp;+&nbsp;direction&nbsp;*&nbsp;sphere_r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance&nbsp;=&nbsp;dist&nbsp;-&nbsp;(capsule_r&nbsp;+&nbsp;sphere_r)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;p_surface,&nbsp;q_surface,&nbsp;max(0.0,&nbsp;distance)<br>
<!-- END SCAT CODE -->
</body>
</html>
