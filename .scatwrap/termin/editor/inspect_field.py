<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/editor/inspect_field.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;termin/visualization/inspect.py<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass<br>
from&nbsp;typing&nbsp;import&nbsp;Any,&nbsp;Callable,&nbsp;Optional<br>
<br>
<br>
@dataclass<br>
class&nbsp;InspectField:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Описание&nbsp;одного&nbsp;поля&nbsp;для&nbsp;инспектора.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;путь&nbsp;к&nbsp;полю&nbsp;(&quot;enabled&quot;,&nbsp;&quot;material.color&quot;&nbsp;и&nbsp;т.п.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;label&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;подпись&nbsp;в&nbsp;UI<br>
&nbsp;&nbsp;&nbsp;&nbsp;kind&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;тип&nbsp;виджета:&nbsp;'float',&nbsp;'int',&nbsp;'bool',&nbsp;'vec3',&nbsp;'color',&nbsp;'string',&nbsp;'enum',&nbsp;...<br>
&nbsp;&nbsp;&nbsp;&nbsp;min,&nbsp;max&nbsp;&nbsp;–&nbsp;ограничения<br>
&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;шаг&nbsp;(для&nbsp;спинбоксов)<br>
&nbsp;&nbsp;&nbsp;&nbsp;choices&nbsp;&nbsp;&nbsp;–&nbsp;для&nbsp;enum:&nbsp;список&nbsp;(value,&nbsp;label)<br>
&nbsp;&nbsp;&nbsp;&nbsp;getter,&nbsp;setter&nbsp;–&nbsp;если&nbsp;нужно&nbsp;обращаться&nbsp;к&nbsp;полю&nbsp;вручную.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;label:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;kind:&nbsp;str&nbsp;=&nbsp;&quot;float&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;min:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;max:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;step:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;choices:&nbsp;list[tuple[Any,&nbsp;str]]&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;getter:&nbsp;Optional[Callable[[Any],&nbsp;Any]]&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;setter:&nbsp;Optional[Callable[[Any,&nbsp;Any],&nbsp;None]]&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_value(self,&nbsp;obj):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.getter:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.getter(obj)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.path&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;InspectField:&nbsp;path&nbsp;or&nbsp;getter&nbsp;must&nbsp;be&nbsp;set&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_resolve_path_get(obj,&nbsp;self.path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_value(self,&nbsp;obj,&nbsp;value):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.setter:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setter(obj,&nbsp;value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.path&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;InspectField:&nbsp;path&nbsp;or&nbsp;setter&nbsp;must&nbsp;be&nbsp;set&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_resolve_path_set(obj,&nbsp;self.path,&nbsp;value)<br>
<br>
<br>
def&nbsp;_resolve_path_get(obj,&nbsp;path:&nbsp;str):<br>
&nbsp;&nbsp;&nbsp;&nbsp;cur&nbsp;=&nbsp;obj<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;part&nbsp;in&nbsp;path.split(&quot;.&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur&nbsp;=&nbsp;getattr(cur,&nbsp;part)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cur<br>
<br>
<br>
def&nbsp;_resolve_path_set(obj,&nbsp;path:&nbsp;str,&nbsp;value):<br>
&nbsp;&nbsp;&nbsp;&nbsp;parts&nbsp;=&nbsp;path.split(&quot;.&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;cur&nbsp;=&nbsp;obj<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;part&nbsp;in&nbsp;parts[:-1]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur&nbsp;=&nbsp;getattr(cur,&nbsp;part)<br>
&nbsp;&nbsp;&nbsp;&nbsp;last&nbsp;=&nbsp;parts[-1]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;небольшой&nbsp;хак:&nbsp;если&nbsp;там&nbsp;numpy-вектор,&nbsp;обновляем&nbsp;по&nbsp;месту<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;numpy&nbsp;as&nbsp;np<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arr&nbsp;=&nbsp;getattr(cur,&nbsp;last)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(arr,&nbsp;np.ndarray):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arr[...]&nbsp;=&nbsp;value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setattr(cur,&nbsp;last,&nbsp;value)<br>
<br>
<br>
class&nbsp;InspectAttr:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Дескриптор:&nbsp;хранит&nbsp;значение&nbsp;на&nbsp;инстансе&nbsp;и&nbsp;регистрирует&nbsp;себя&nbsp;как&nbsp;InspectField<br>
&nbsp;&nbsp;&nbsp;&nbsp;в&nbsp;классе&nbsp;компонента.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Использование:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;Foo(Component):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bar&nbsp;=&nbsp;inspect(42,&nbsp;label=&quot;Bar&quot;,&nbsp;kind=&quot;int&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:&nbsp;Any&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind:&nbsp;str&nbsp;=&nbsp;&quot;float&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;choices:&nbsp;list[tuple[Any,&nbsp;str]]&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getter:&nbsp;Optional[Callable[[Any],&nbsp;Any]]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter:&nbsp;Optional[Callable[[Any,&nbsp;Any],&nbsp;None]]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.default&nbsp;=&nbsp;default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._field&nbsp;=&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=None,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;узнаем&nbsp;позже,&nbsp;в&nbsp;__set_name__<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=label,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=kind,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min=min,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max=max,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step=step,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;choices=choices,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getter=getter,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter=setter,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._name:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__set_name__(self,&nbsp;owner,&nbsp;name:&nbsp;str):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._name&nbsp;=&nbsp;name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;если&nbsp;путь&nbsp;не&nbsp;задан&nbsp;—&nbsp;считаем,&nbsp;что&nbsp;поле&nbsp;лежит&nbsp;прямо&nbsp;на&nbsp;компоненте<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._field.path&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._field.path&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;если&nbsp;label&nbsp;не&nbsp;задан&nbsp;–&nbsp;используем&nbsp;имя<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._field.label&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._field.label&nbsp;=&nbsp;name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;регистрируем&nbsp;поле&nbsp;в&nbsp;owner.inspect_fields<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fields&nbsp;=&nbsp;getattr(owner,&nbsp;&quot;inspect_fields&quot;,&nbsp;None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fields&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fields&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setattr(owner,&nbsp;&quot;inspect_fields&quot;,&nbsp;fields)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fields[name]&nbsp;=&nbsp;self._field<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__get__(self,&nbsp;instance,&nbsp;owner=None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;instance&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;instance.__dict__.get(self._name,&nbsp;self.default)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__set__(self,&nbsp;instance,&nbsp;value):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.__dict__[self._name]&nbsp;=&nbsp;value<br>
<br>
<br>
def&nbsp;inspect(default:&nbsp;Any&nbsp;=&nbsp;None,&nbsp;**meta)&nbsp;-&gt;&nbsp;InspectAttr:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Сахар:&nbsp;aaa&nbsp;=&nbsp;inspect(42,&nbsp;label=&quot;AAA&quot;,&nbsp;kind=&quot;int&quot;).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;meta&nbsp;→&nbsp;параметры&nbsp;для&nbsp;InspectField&nbsp;(label,&nbsp;kind,&nbsp;min,&nbsp;max,&nbsp;step,&nbsp;...)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;InspectAttr(default,&nbsp;**meta)<br>
<!-- END SCAT CODE -->
</body>
</html>
