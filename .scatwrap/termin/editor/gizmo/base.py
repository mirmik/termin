<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/editor/gizmo/base.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Base&nbsp;classes&nbsp;for&nbsp;the&nbsp;unified&nbsp;gizmo&nbsp;system.<br>
<br>
Architecture:<br>
-&nbsp;Gizmo:&nbsp;декларативный&nbsp;объект,&nbsp;умеет&nbsp;рисовать&nbsp;себя&nbsp;и&nbsp;объявлять&nbsp;colliders<br>
-&nbsp;GizmoCollider:&nbsp;геометрия&nbsp;+&nbsp;constraint&nbsp;для&nbsp;picking/drag<br>
-&nbsp;DragConstraint:&nbsp;как&nbsp;проецировать&nbsp;движение&nbsp;мыши&nbsp;при&nbsp;drag<br>
-&nbsp;GizmoManager:&nbsp;управляет&nbsp;всеми&nbsp;гизмо,&nbsp;raycast,&nbsp;вычисляет&nbsp;drag<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;abc&nbsp;import&nbsp;ABC,&nbsp;abstractmethod<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass,&nbsp;field<br>
from&nbsp;typing&nbsp;import&nbsp;Any,&nbsp;Callable,&nbsp;TYPE_CHECKING<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.immediate&nbsp;import&nbsp;ImmediateRenderer<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.solid_primitives&nbsp;import&nbsp;SolidPrimitiveRenderer<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.platform.backends.base&nbsp;import&nbsp;GraphicsBackend<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;Drag&nbsp;Constraints<br>
#&nbsp;============================================================<br>
<br>
class&nbsp;DragConstraint(ABC):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Base&nbsp;class&nbsp;for&nbsp;drag&nbsp;constraints.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
<br>
@dataclass<br>
class&nbsp;AxisConstraint(DragConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Constrain&nbsp;drag&nbsp;to&nbsp;a&nbsp;single&nbsp;axis.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;origin:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;axis:&nbsp;np.ndarray&nbsp;&nbsp;#&nbsp;normalized&nbsp;direction<br>
<br>
<br>
@dataclass<br>
class&nbsp;PlaneConstraint(DragConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Constrain&nbsp;drag&nbsp;to&nbsp;a&nbsp;plane.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;origin:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;np.ndarray&nbsp;&nbsp;#&nbsp;normalized<br>
<br>
<br>
@dataclass<br>
class&nbsp;RadiusConstraint(DragConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Constrain&nbsp;drag&nbsp;to&nbsp;change&nbsp;radius&nbsp;from&nbsp;center.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;center:&nbsp;np.ndarray<br>
<br>
<br>
@dataclass<br>
class&nbsp;AngleConstraint(DragConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Constrain&nbsp;drag&nbsp;to&nbsp;rotation&nbsp;around&nbsp;axis.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;center:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;axis:&nbsp;np.ndarray&nbsp;&nbsp;#&nbsp;normalized&nbsp;rotation&nbsp;axis<br>
<br>
<br>
@dataclass<br>
class&nbsp;NoDrag(DragConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;No&nbsp;drag&nbsp;-&nbsp;click&nbsp;only.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;Collider&nbsp;Geometry<br>
#&nbsp;============================================================<br>
<br>
class&nbsp;ColliderGeometry(ABC):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Base&nbsp;class&nbsp;for&nbsp;collider&nbsp;geometry.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@abstractmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;ray_intersect(self,&nbsp;ray_origin:&nbsp;np.ndarray,&nbsp;ray_dir:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test&nbsp;ray&nbsp;intersection.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Distance&nbsp;along&nbsp;ray&nbsp;(t)&nbsp;or&nbsp;None&nbsp;if&nbsp;no&nbsp;hit.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
<br>
<br>
@dataclass<br>
class&nbsp;SphereGeometry(ColliderGeometry):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Sphere&nbsp;collider.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;center:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;radius:&nbsp;float<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;ray_intersect(self,&nbsp;ray_origin:&nbsp;np.ndarray,&nbsp;ray_dir:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oc&nbsp;=&nbsp;ray_origin&nbsp;-&nbsp;self.center<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;np.dot(ray_dir,&nbsp;ray_dir)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;2.0&nbsp;*&nbsp;np.dot(oc,&nbsp;ray_dir)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;np.dot(oc,&nbsp;oc)&nbsp;-&nbsp;self.radius&nbsp;*&nbsp;self.radius<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discriminant&nbsp;=&nbsp;b&nbsp;*&nbsp;b&nbsp;-&nbsp;4&nbsp;*&nbsp;a&nbsp;*&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;discriminant&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sqrt_disc&nbsp;=&nbsp;np.sqrt(discriminant)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t1&nbsp;=&nbsp;(-b&nbsp;-&nbsp;sqrt_disc)&nbsp;/&nbsp;(2&nbsp;*&nbsp;a)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t2&nbsp;=&nbsp;(-b&nbsp;+&nbsp;sqrt_disc)&nbsp;/&nbsp;(2&nbsp;*&nbsp;a)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t1&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t2&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
@dataclass<br>
class&nbsp;CylinderGeometry(ColliderGeometry):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Cylinder&nbsp;collider&nbsp;(finite,&nbsp;capped).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;start:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;end:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;radius:&nbsp;float<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;ray_intersect(self,&nbsp;ray_origin:&nbsp;np.ndarray,&nbsp;ray_dir:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cyl_axis&nbsp;=&nbsp;self.end&nbsp;-&nbsp;self.start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cyl_length&nbsp;=&nbsp;np.linalg.norm(cyl_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cyl_length&nbsp;&lt;&nbsp;1e-6:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cyl_axis&nbsp;=&nbsp;cyl_axis&nbsp;/&nbsp;cyl_length<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;ray_origin&nbsp;-&nbsp;self.start<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ray_dot_axis&nbsp;=&nbsp;np.dot(ray_dir,&nbsp;cyl_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta_dot_axis&nbsp;=&nbsp;np.dot(delta,&nbsp;cyl_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_perp&nbsp;=&nbsp;ray_dir&nbsp;-&nbsp;ray_dot_axis&nbsp;*&nbsp;cyl_axis<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta_perp&nbsp;=&nbsp;delta&nbsp;-&nbsp;delta_dot_axis&nbsp;*&nbsp;cyl_axis<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;np.dot(d_perp,&nbsp;d_perp)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;2.0&nbsp;*&nbsp;np.dot(d_perp,&nbsp;delta_perp)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;np.dot(delta_perp,&nbsp;delta_perp)&nbsp;-&nbsp;self.radius&nbsp;*&nbsp;self.radius<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discriminant&nbsp;=&nbsp;b&nbsp;*&nbsp;b&nbsp;-&nbsp;4&nbsp;*&nbsp;a&nbsp;*&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;discriminant&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;a&nbsp;&lt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;c&nbsp;&lt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sqrt_disc&nbsp;=&nbsp;np.sqrt(discriminant)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t1&nbsp;=&nbsp;(-b&nbsp;-&nbsp;sqrt_disc)&nbsp;/&nbsp;(2&nbsp;*&nbsp;a)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t2&nbsp;=&nbsp;(-b&nbsp;+&nbsp;sqrt_disc)&nbsp;/&nbsp;(2&nbsp;*&nbsp;a)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;t&nbsp;in&nbsp;[t1,&nbsp;t2]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hit_point&nbsp;=&nbsp;ray_origin&nbsp;+&nbsp;ray_dir&nbsp;*&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;np.dot(hit_point&nbsp;-&nbsp;self.start,&nbsp;cyl_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;0&nbsp;&lt;=&nbsp;proj&nbsp;&lt;=&nbsp;cyl_length:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
@dataclass<br>
class&nbsp;TorusGeometry(ColliderGeometry):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Torus&nbsp;collider&nbsp;(for&nbsp;rotation&nbsp;rings).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;center:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;axis:&nbsp;np.ndarray&nbsp;&nbsp;#&nbsp;normalized<br>
&nbsp;&nbsp;&nbsp;&nbsp;major_radius:&nbsp;float<br>
&nbsp;&nbsp;&nbsp;&nbsp;minor_radius:&nbsp;float<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;ray_intersect(self,&nbsp;ray_origin:&nbsp;np.ndarray,&nbsp;ray_dir:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Simplified:&nbsp;intersect&nbsp;with&nbsp;plane,&nbsp;check&nbsp;if&nbsp;in&nbsp;annulus<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangent,&nbsp;bitangent&nbsp;=&nbsp;_build_basis(self.axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_local&nbsp;=&nbsp;np.array([tangent,&nbsp;bitangent,&nbsp;self.axis],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_origin&nbsp;=&nbsp;to_local&nbsp;@&nbsp;(ray_origin&nbsp;-&nbsp;self.center)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_dir&nbsp;=&nbsp;to_local&nbsp;@&nbsp;ray_dir<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(local_dir[2])&nbsp;&lt;&nbsp;1e-6:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(local_origin[2])&nbsp;&gt;&nbsp;self.minor_radius:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_plane&nbsp;=&nbsp;-local_origin[2]&nbsp;/&nbsp;local_dir[2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t_plane&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hit_local&nbsp;=&nbsp;local_origin&nbsp;+&nbsp;local_dir&nbsp;*&nbsp;t_plane<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist_from_center&nbsp;=&nbsp;np.sqrt(hit_local[0]**2&nbsp;+&nbsp;hit_local[1]**2)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(dist_from_center&nbsp;-&nbsp;self.major_radius)&nbsp;&lt;=&nbsp;self.minor_radius:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t_plane<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;slightly&nbsp;above/below&nbsp;for&nbsp;minor&nbsp;radius<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;dz&nbsp;in&nbsp;[-self.minor_radius&nbsp;*&nbsp;0.5,&nbsp;self.minor_radius&nbsp;*&nbsp;0.5]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(local_dir[2])&nbsp;&lt;&nbsp;1e-6:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_off&nbsp;=&nbsp;-(local_origin[2]&nbsp;-&nbsp;dz)&nbsp;/&nbsp;local_dir[2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t_off&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hit&nbsp;=&nbsp;local_origin&nbsp;+&nbsp;local_dir&nbsp;*&nbsp;t_off<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;np.sqrt(hit[0]**2&nbsp;+&nbsp;hit[1]**2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(dist&nbsp;-&nbsp;self.major_radius)&nbsp;&lt;=&nbsp;self.minor_radius:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t_off<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
@dataclass<br>
class&nbsp;QuadGeometry(ColliderGeometry):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Quad&nbsp;collider&nbsp;(for&nbsp;plane&nbsp;handles).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;p0:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;p1:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;p3:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;np.ndarray<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;ray_intersect(self,&nbsp;ray_origin:&nbsp;np.ndarray,&nbsp;ray_dir:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;denom&nbsp;=&nbsp;np.dot(ray_dir,&nbsp;self.normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(denom)&nbsp;&lt;&nbsp;1e-6:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;np.dot(self.p0&nbsp;-&nbsp;ray_origin,&nbsp;self.normal)&nbsp;/&nbsp;denom<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hit&nbsp;=&nbsp;ray_origin&nbsp;+&nbsp;ray_dir&nbsp;*&nbsp;t<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;same_side(edge_start,&nbsp;edge_end,&nbsp;point,&nbsp;n):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge&nbsp;=&nbsp;edge_end&nbsp;-&nbsp;edge_start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_point&nbsp;=&nbsp;point&nbsp;-&nbsp;edge_start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cross&nbsp;=&nbsp;np.cross(edge,&nbsp;to_point)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.dot(cross,&nbsp;n)&nbsp;&gt;=&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(same_side(self.p0,&nbsp;self.p1,&nbsp;hit,&nbsp;self.normal)&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;same_side(self.p1,&nbsp;self.p2,&nbsp;hit,&nbsp;self.normal)&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;same_side(self.p2,&nbsp;self.p3,&nbsp;hit,&nbsp;self.normal)&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;same_side(self.p3,&nbsp;self.p0,&nbsp;hit,&nbsp;self.normal)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;GizmoCollider<br>
#&nbsp;============================================================<br>
<br>
@dataclass<br>
class&nbsp;GizmoCollider:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Collider&nbsp;for&nbsp;gizmo&nbsp;picking.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id:&nbsp;Identifier&nbsp;for&nbsp;the&nbsp;gizmo&nbsp;to&nbsp;know&nbsp;which&nbsp;collider&nbsp;was&nbsp;hit<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry:&nbsp;Shape&nbsp;for&nbsp;ray&nbsp;intersection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;constraint:&nbsp;How&nbsp;to&nbsp;project&nbsp;mouse&nbsp;movement&nbsp;during&nbsp;drag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;id:&nbsp;Any<br>
&nbsp;&nbsp;&nbsp;&nbsp;geometry:&nbsp;ColliderGeometry<br>
&nbsp;&nbsp;&nbsp;&nbsp;constraint:&nbsp;DragConstraint<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;Gizmo&nbsp;Base&nbsp;Class<br>
#&nbsp;============================================================<br>
<br>
class&nbsp;Gizmo(ABC):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Abstract&nbsp;base&nbsp;class&nbsp;for&nbsp;all&nbsp;gizmos.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;gizmo&nbsp;is&nbsp;an&nbsp;interactive&nbsp;3D&nbsp;widget&nbsp;that:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Draws&nbsp;itself&nbsp;using&nbsp;ImmediateRenderer<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Declares&nbsp;colliders&nbsp;for&nbsp;picking<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Receives&nbsp;events&nbsp;when&nbsp;colliders&nbsp;are&nbsp;clicked/dragged<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;visible:&nbsp;bool&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw(self,&nbsp;renderer:&nbsp;&quot;ImmediateRenderer&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Draw&nbsp;opaque&nbsp;gizmo&nbsp;geometry&nbsp;using&nbsp;ImmediateRenderer.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Called&nbsp;every&nbsp;frame.&nbsp;Add&nbsp;primitives&nbsp;to&nbsp;the&nbsp;renderer.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Override&nbsp;this&nbsp;for&nbsp;opaque&nbsp;geometry&nbsp;(arrows,&nbsp;rings,&nbsp;spheres).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOTE:&nbsp;Prefer&nbsp;implementing&nbsp;draw_solid()&nbsp;for&nbsp;better&nbsp;performance.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw_solid(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderer:&nbsp;&quot;SolidPrimitiveRenderer&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics:&nbsp;&quot;GraphicsBackend&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Draw&nbsp;opaque&nbsp;gizmo&nbsp;geometry&nbsp;using&nbsp;SolidPrimitiveRenderer.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;More&nbsp;efficient&nbsp;than&nbsp;draw()&nbsp;-&nbsp;uses&nbsp;pre-built&nbsp;GPU&nbsp;meshes.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;implemented,&nbsp;this&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;draw().<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw_transparent(self,&nbsp;renderer:&nbsp;&quot;ImmediateRenderer&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Draw&nbsp;transparent&nbsp;gizmo&nbsp;geometry.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Called&nbsp;after&nbsp;opaque&nbsp;pass.&nbsp;Override&nbsp;for&nbsp;transparent&nbsp;geometry&nbsp;(plane&nbsp;quads).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw_transparent_solid(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderer:&nbsp;&quot;SolidPrimitiveRenderer&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics:&nbsp;&quot;GraphicsBackend&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Draw&nbsp;transparent&nbsp;gizmo&nbsp;geometry&nbsp;using&nbsp;SolidPrimitiveRenderer.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;More&nbsp;efficient&nbsp;than&nbsp;draw_transparent().<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;implemented,&nbsp;this&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;draw_transparent().<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;uses_solid_renderer(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Return&nbsp;True&nbsp;if&nbsp;this&nbsp;gizmo&nbsp;uses&nbsp;SolidPrimitiveRenderer.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@abstractmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_colliders(self)&nbsp;-&gt;&nbsp;list[GizmoCollider]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;colliders&nbsp;for&nbsp;picking.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Called&nbsp;when&nbsp;checking&nbsp;for&nbsp;mouse&nbsp;interaction.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_hover_enter(self,&nbsp;collider_id:&nbsp;Any)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Called&nbsp;when&nbsp;mouse&nbsp;starts&nbsp;hovering&nbsp;over&nbsp;a&nbsp;collider.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_hover_exit(self,&nbsp;collider_id:&nbsp;Any)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Called&nbsp;when&nbsp;mouse&nbsp;stops&nbsp;hovering&nbsp;over&nbsp;a&nbsp;collider.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_click(self,&nbsp;collider_id:&nbsp;Any,&nbsp;hit_position:&nbsp;np.ndarray&nbsp;|&nbsp;None)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Called&nbsp;when&nbsp;a&nbsp;collider&nbsp;is&nbsp;clicked&nbsp;(mouse&nbsp;down).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collider_id:&nbsp;Which&nbsp;collider&nbsp;was&nbsp;clicked<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hit_position:&nbsp;Projected&nbsp;position&nbsp;on&nbsp;the&nbsp;constraint&nbsp;(for&nbsp;computing&nbsp;grab&nbsp;offset)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_drag(self,&nbsp;collider_id:&nbsp;Any,&nbsp;position:&nbsp;np.ndarray,&nbsp;delta:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Called&nbsp;during&nbsp;drag&nbsp;with&nbsp;projected&nbsp;position.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collider_id:&nbsp;Which&nbsp;collider&nbsp;is&nbsp;being&nbsp;dragged<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position:&nbsp;New&nbsp;position&nbsp;(projected&nbsp;according&nbsp;to&nbsp;constraint)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta:&nbsp;Change&nbsp;from&nbsp;last&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_release(self,&nbsp;collider_id:&nbsp;Any)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Called&nbsp;when&nbsp;drag&nbsp;ends&nbsp;(mouse&nbsp;up).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;Utility<br>
#&nbsp;============================================================<br>
<br>
def&nbsp;_build_basis(axis:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;tuple[np.ndarray,&nbsp;np.ndarray]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Build&nbsp;orthonormal&nbsp;basis&nbsp;from&nbsp;axis&nbsp;(tangent,&nbsp;bitangent).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;axis&nbsp;=&nbsp;np.asarray(axis,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(axis[0])&nbsp;&lt;&nbsp;0.9:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangent&nbsp;=&nbsp;np.cross(axis,&nbsp;np.array([1,&nbsp;0,&nbsp;0],&nbsp;dtype=np.float32))<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangent&nbsp;=&nbsp;np.cross(axis,&nbsp;np.array([0,&nbsp;1,&nbsp;0],&nbsp;dtype=np.float32))<br>
&nbsp;&nbsp;&nbsp;&nbsp;tangent&nbsp;=&nbsp;tangent&nbsp;/&nbsp;np.linalg.norm(tangent)<br>
&nbsp;&nbsp;&nbsp;&nbsp;bitangent&nbsp;=&nbsp;np.cross(axis,&nbsp;tangent)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tangent,&nbsp;bitangent<br>
<!-- END SCAT CODE -->
</body>
</html>
