<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/editor/drag_drop.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Centralized&nbsp;drag-drop&nbsp;support&nbsp;for&nbsp;the&nbsp;editor.<br>
<br>
Defines&nbsp;MIME&nbsp;types&nbsp;and&nbsp;helper&nbsp;functions&nbsp;for&nbsp;drag-drop&nbsp;operations<br>
across&nbsp;different&nbsp;editor&nbsp;widgets&nbsp;(SceneTree,&nbsp;ProjectBrowser,&nbsp;Viewport,&nbsp;Inspector).<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;json<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;Optional<br>
<br>
from&nbsp;PyQt6.QtCore&nbsp;import&nbsp;QMimeData<br>
<br>
from&nbsp;termin._native&nbsp;import&nbsp;log<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.entity&nbsp;import&nbsp;Entity<br>
<br>
<br>
class&nbsp;EditorMimeTypes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;MIME&nbsp;types&nbsp;used&nbsp;in&nbsp;the&nbsp;editor&nbsp;for&nbsp;drag-drop&nbsp;operations.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Entity&nbsp;from&nbsp;SceneTree&nbsp;(stores&nbsp;entity&nbsp;name&nbsp;for&nbsp;lookup)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ENTITY&nbsp;=&nbsp;&quot;application/x-termin-entity&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Asset&nbsp;path&nbsp;from&nbsp;ProjectBrowser<br>
&nbsp;&nbsp;&nbsp;&nbsp;ASSET_PATH&nbsp;=&nbsp;&quot;application/x-termin-asset-path&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Resource&nbsp;references&nbsp;(mesh,&nbsp;material,&nbsp;texture&nbsp;names)<br>
&nbsp;&nbsp;&nbsp;&nbsp;MESH_REF&nbsp;=&nbsp;&quot;application/x-termin-mesh-ref&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;MATERIAL_REF&nbsp;=&nbsp;&quot;application/x-termin-material-ref&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;TEXTURE_REF&nbsp;=&nbsp;&quot;application/x-termin-texture-ref&quot;<br>
<br>
<br>
def&nbsp;create_entity_mime_data(entity:&nbsp;&quot;Entity&quot;)&nbsp;-&gt;&nbsp;QMimeData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;QMimeData&nbsp;for&nbsp;dragging&nbsp;an&nbsp;Entity.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Stores&nbsp;entity&nbsp;UUID&nbsp;and&nbsp;name&nbsp;as&nbsp;JSON&nbsp;for&nbsp;lookup&nbsp;on&nbsp;drop.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime&nbsp;=&nbsp;QMimeData()<br>
&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;entity_uuid&quot;:&nbsp;entity.uuid,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;entity_name&quot;:&nbsp;entity.name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime.setData(EditorMimeTypes.ENTITY,&nbsp;json.dumps(data).encode(&quot;utf-8&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mime<br>
<br>
<br>
def&nbsp;parse_entity_mime_data(mime:&nbsp;QMimeData)&nbsp;-&gt;&nbsp;dict&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parse&nbsp;entity&nbsp;data&nbsp;from&nbsp;QMimeData.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;dict&nbsp;with&nbsp;'entity_uuid'&nbsp;and&nbsp;'entity_name'&nbsp;or&nbsp;None&nbsp;if&nbsp;not&nbsp;valid.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;mime.hasFormat(EditorMimeTypes.ENTITY):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw&nbsp;=&nbsp;mime.data(EditorMimeTypes.ENTITY).data()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;json.loads(raw.decode(&quot;utf-8&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;(json.JSONDecodeError,&nbsp;UnicodeDecodeError)&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(f&quot;[DragDrop]&nbsp;Failed&nbsp;to&nbsp;parse&nbsp;entity&nbsp;MIME&nbsp;data:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;create_asset_path_mime_data(path:&nbsp;str)&nbsp;-&gt;&nbsp;QMimeData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;QMimeData&nbsp;for&nbsp;dragging&nbsp;an&nbsp;asset&nbsp;from&nbsp;ProjectBrowser.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime&nbsp;=&nbsp;QMimeData()<br>
&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;{&quot;path&quot;:&nbsp;path}<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime.setData(EditorMimeTypes.ASSET_PATH,&nbsp;json.dumps(data).encode(&quot;utf-8&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Also&nbsp;set&nbsp;as&nbsp;URL&nbsp;for&nbsp;compatibility&nbsp;with&nbsp;external&nbsp;apps<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime.setText(path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mime<br>
<br>
<br>
def&nbsp;parse_asset_path_mime_data(mime:&nbsp;QMimeData)&nbsp;-&gt;&nbsp;str&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parse&nbsp;asset&nbsp;path&nbsp;from&nbsp;QMimeData.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;path&nbsp;string&nbsp;or&nbsp;None&nbsp;if&nbsp;not&nbsp;valid.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;mime.hasFormat(EditorMimeTypes.ASSET_PATH):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw&nbsp;=&nbsp;mime.data(EditorMimeTypes.ASSET_PATH).data()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;json.loads(raw.decode(&quot;utf-8&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;data.get(&quot;path&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;(json.JSONDecodeError,&nbsp;UnicodeDecodeError)&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(f&quot;[DragDrop]&nbsp;Failed&nbsp;to&nbsp;parse&nbsp;asset&nbsp;path&nbsp;MIME&nbsp;data:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;create_resource_ref_mime_data(<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_name:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_type:&nbsp;str,<br>
)&nbsp;-&gt;&nbsp;QMimeData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;QMimeData&nbsp;for&nbsp;dragging&nbsp;a&nbsp;resource&nbsp;reference&nbsp;(mesh,&nbsp;material,&nbsp;texture).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_name:&nbsp;Name&nbsp;of&nbsp;the&nbsp;resource&nbsp;in&nbsp;ResourceManager<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_type:&nbsp;One&nbsp;of&nbsp;'mesh',&nbsp;'material',&nbsp;'texture'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime&nbsp;=&nbsp;QMimeData()<br>
&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;{&quot;name&quot;:&nbsp;resource_name,&nbsp;&quot;type&quot;:&nbsp;resource_type}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime_type&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;mesh&quot;:&nbsp;EditorMimeTypes.MESH_REF,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;material&quot;:&nbsp;EditorMimeTypes.MATERIAL_REF,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;texture&quot;:&nbsp;EditorMimeTypes.TEXTURE_REF,<br>
&nbsp;&nbsp;&nbsp;&nbsp;}.get(resource_type,&nbsp;EditorMimeTypes.MESH_REF)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime.setData(mime_type,&nbsp;json.dumps(data).encode(&quot;utf-8&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mime<br>
<br>
<br>
def&nbsp;parse_resource_ref_mime_data(<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime:&nbsp;QMimeData,<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_type:&nbsp;str,<br>
)&nbsp;-&gt;&nbsp;str&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parse&nbsp;resource&nbsp;reference&nbsp;name&nbsp;from&nbsp;QMimeData.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mime:&nbsp;The&nbsp;mime&nbsp;data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_type:&nbsp;One&nbsp;of&nbsp;'mesh',&nbsp;'material',&nbsp;'texture'<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Resource&nbsp;name&nbsp;or&nbsp;None&nbsp;if&nbsp;not&nbsp;valid.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mime_type&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;mesh&quot;:&nbsp;EditorMimeTypes.MESH_REF,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;material&quot;:&nbsp;EditorMimeTypes.MATERIAL_REF,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;texture&quot;:&nbsp;EditorMimeTypes.TEXTURE_REF,<br>
&nbsp;&nbsp;&nbsp;&nbsp;}.get(resource_type)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mime_type&nbsp;is&nbsp;None&nbsp;or&nbsp;not&nbsp;mime.hasFormat(mime_type):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw&nbsp;=&nbsp;mime.data(mime_type).data()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;json.loads(raw.decode(&quot;utf-8&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;data.get(&quot;name&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;(json.JSONDecodeError,&nbsp;UnicodeDecodeError)&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(f&quot;[DragDrop]&nbsp;Failed&nbsp;to&nbsp;parse&nbsp;{resource_type}&nbsp;ref&nbsp;MIME&nbsp;data:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<!-- END SCAT CODE -->
</body>
</html>
