<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/navmesh/pathfinding.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Pathfinding&nbsp;на&nbsp;основе&nbsp;графа&nbsp;треугольников.<br>
<br>
Иерархическая&nbsp;структура:<br>
-&nbsp;RegionGraph:&nbsp;граф&nbsp;треугольников&nbsp;внутри&nbsp;одного&nbsp;региона<br>
-&nbsp;NavMeshGraph:&nbsp;граф&nbsp;регионов&nbsp;+&nbsp;порталы&nbsp;между&nbsp;ними<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass,&nbsp;field<br>
import&nbsp;heapq<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
<br>
@dataclass<br>
class&nbsp;RegionGraph:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Граф&nbsp;треугольников&nbsp;для&nbsp;одного&nbsp;региона.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;region_id:&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(N,&nbsp;3)&nbsp;—&nbsp;вершины<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;индексы&nbsp;вершин&nbsp;треугольников<br>
&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;np.ndarray&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;соседи&nbsp;по&nbsp;каждому&nbsp;ребру,&nbsp;-1&nbsp;=&nbsp;нет&nbsp;соседа<br>
&nbsp;&nbsp;&nbsp;&nbsp;centroids:&nbsp;np.ndarray&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;центры&nbsp;треугольников<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@classmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;from_mesh(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;region_id:&nbsp;int&nbsp;=&nbsp;0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;RegionGraph:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Построить&nbsp;граф&nbsp;из&nbsp;меша.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors&nbsp;=&nbsp;build_adjacency(triangles)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroids&nbsp;=&nbsp;compute_centroids(vertices,&nbsp;triangles)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cls(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;region_id=region_id,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=vertices,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles=triangles,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors=neighbors,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroids=centroids,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;find_triangle(self,&nbsp;point:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Найти&nbsp;треугольник,&nbsp;содержащий&nbsp;точку.&nbsp;Возвращает&nbsp;-1&nbsp;если&nbsp;не&nbsp;найден.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;find_triangle_containing_point(point,&nbsp;self.vertices,&nbsp;self.triangles)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;find_path(self,&nbsp;start:&nbsp;np.ndarray,&nbsp;end:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;list[int]&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Найти&nbsp;путь&nbsp;между&nbsp;двумя&nbsp;точками.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Список&nbsp;индексов&nbsp;треугольников&nbsp;от&nbsp;старта&nbsp;до&nbsp;финиша,&nbsp;или&nbsp;None.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_tri&nbsp;=&nbsp;self.find_triangle(start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_tri&nbsp;=&nbsp;self.find_triangle(end)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;start_tri&nbsp;&lt;&nbsp;0&nbsp;or&nbsp;end_tri&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;start_tri&nbsp;==&nbsp;end_tri:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[start_tri]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;astar_triangles(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_tri,&nbsp;end_tri,&nbsp;self.neighbors,&nbsp;self.centroids,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.triangles,&nbsp;self.vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
@dataclass<br>
class&nbsp;Portal:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Связь&nbsp;между&nbsp;двумя&nbsp;регионами.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;region_a:&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;region_b:&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;tri_a:&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;треугольник&nbsp;в&nbsp;регионе&nbsp;A<br>
&nbsp;&nbsp;&nbsp;&nbsp;tri_b:&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;треугольник&nbsp;в&nbsp;регионе&nbsp;B<br>
&nbsp;&nbsp;&nbsp;&nbsp;edge:&nbsp;tuple[int,&nbsp;int]&nbsp;&nbsp;&nbsp;#&nbsp;общее&nbsp;ребро&nbsp;(индексы&nbsp;вершин)<br>
<br>
<br>
@dataclass<br>
class&nbsp;NavMeshGraph:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Глобальный&nbsp;граф&nbsp;навигации.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;regions:&nbsp;list[RegionGraph]&nbsp;=&nbsp;field(default_factory=list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;portals:&nbsp;list[Portal]&nbsp;=&nbsp;field(default_factory=list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Граф&nbsp;смежности&nbsp;регионов:&nbsp;region_id&nbsp;-&gt;&nbsp;list&nbsp;of&nbsp;(neighbor_region_id,&nbsp;portal_index)<br>
&nbsp;&nbsp;&nbsp;&nbsp;region_adjacency:&nbsp;dict[int,&nbsp;list[tuple[int,&nbsp;int]]]&nbsp;=&nbsp;field(default_factory=dict)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Центроиды&nbsp;регионов&nbsp;для&nbsp;эвристики&nbsp;A*<br>
&nbsp;&nbsp;&nbsp;&nbsp;region_centroids:&nbsp;dict[int,&nbsp;np.ndarray]&nbsp;=&nbsp;field(default_factory=dict)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_region(self,&nbsp;region:&nbsp;RegionGraph)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Добавить&nbsp;регион.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.regions.append(region)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_portal(self,&nbsp;portal:&nbsp;Portal)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Добавить&nbsp;портал&nbsp;между&nbsp;регионами.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.portals.append(portal)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;build_region_adjacency(self,&nbsp;portals_data:&nbsp;list)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Построить&nbsp;граф&nbsp;смежности&nbsp;регионов&nbsp;из&nbsp;списка&nbsp;порталов.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portals_data:&nbsp;Список&nbsp;Portal&nbsp;из&nbsp;types.py&nbsp;(с&nbsp;region_a,&nbsp;region_b,&nbsp;center).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_adjacency.clear()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Инициализируем&nbsp;пустые&nbsp;списки&nbsp;для&nbsp;всех&nbsp;регионов<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(self.regions)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_adjacency[i]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Добавляем&nbsp;рёбра&nbsp;между&nbsp;регионами<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;portal_idx,&nbsp;portal&nbsp;in&nbsp;enumerate(portals_data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;region_a&nbsp;=&nbsp;portal.region_a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;region_b&nbsp;=&nbsp;portal.region_b<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;region_a&nbsp;&lt;&nbsp;len(self.regions)&nbsp;and&nbsp;region_b&nbsp;&lt;&nbsp;len(self.regions):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_adjacency[region_a].append((region_b,&nbsp;portal_idx))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_adjacency[region_b].append((region_a,&nbsp;portal_idx))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Вычисляем&nbsp;центроиды&nbsp;регионов<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_centroids.clear()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;region_id,&nbsp;region&nbsp;in&nbsp;enumerate(self.regions):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(region.centroids)&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_centroids[region_id]&nbsp;=&nbsp;np.mean(region.centroids,&nbsp;axis=0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;find_region(self,&nbsp;point:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Найти&nbsp;регион,&nbsp;содержащий&nbsp;точку.&nbsp;Возвращает&nbsp;-1&nbsp;если&nbsp;не&nbsp;найден.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;region&nbsp;in&nbsp;enumerate(self.regions):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;region.find_triangle(point)&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;find_path(self,&nbsp;start:&nbsp;np.ndarray,&nbsp;end:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;list[tuple[int,&nbsp;int]]&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Найти&nbsp;путь&nbsp;между&nbsp;двумя&nbsp;точками.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Список&nbsp;(region_id,&nbsp;triangle_id)&nbsp;от&nbsp;старта&nbsp;до&nbsp;финиша,&nbsp;или&nbsp;None.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_region&nbsp;=&nbsp;self.find_region(start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_region&nbsp;=&nbsp;self.find_region(end)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;start_region&nbsp;&lt;&nbsp;0&nbsp;or&nbsp;end_region&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;start_region&nbsp;==&nbsp;end_region:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Путь&nbsp;внутри&nbsp;одного&nbsp;региона<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;region&nbsp;=&nbsp;self.regions[start_region]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;region.find_path(start,&nbsp;end)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;path&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[(start_region,&nbsp;tri)&nbsp;for&nbsp;tri&nbsp;in&nbsp;path]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;TODO:&nbsp;межрегиональный&nbsp;поиск&nbsp;через&nbsp;порталы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;find_region_path(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_region:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_region:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portals_data:&nbsp;list,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;list[tuple[int,&nbsp;int]]&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Высокоуровневый&nbsp;A*&nbsp;для&nbsp;поиска&nbsp;пути&nbsp;через&nbsp;регионы.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_region:&nbsp;Начальный&nbsp;регион.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_region:&nbsp;Целевой&nbsp;регион.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portals_data:&nbsp;Список&nbsp;Portal&nbsp;из&nbsp;types.py.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Список&nbsp;(region_id,&nbsp;portal_index)&nbsp;—&nbsp;путь&nbsp;через&nbsp;регионы.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal_index&nbsp;=&nbsp;-1&nbsp;для&nbsp;начального&nbsp;и&nbsp;конечного&nbsp;региона.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;start_region&nbsp;==&nbsp;end_region:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[(start_region,&nbsp;-1)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;self.region_adjacency:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A*&nbsp;на&nbsp;графе&nbsp;регионов<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;heuristic(region_id:&nbsp;int)&nbsp;-&gt;&nbsp;float:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;region_id&nbsp;in&nbsp;self.region_centroids&nbsp;and&nbsp;end_region&nbsp;in&nbsp;self.region_centroids:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;float(np.linalg.norm(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.region_centroids[region_id]&nbsp;-&nbsp;self.region_centroids[end_region]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(f_score,&nbsp;counter,&nbsp;region_id)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;counter&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;open_set:&nbsp;list[tuple[float,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;[(heuristic(start_region),&nbsp;counter,&nbsp;start_region)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;came_from:&nbsp;dict[int,&nbsp;tuple[int,&nbsp;int]]&nbsp;=&nbsp;{}&nbsp;&nbsp;#&nbsp;region&nbsp;-&gt;&nbsp;(prev_region,&nbsp;portal_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_score:&nbsp;dict[int,&nbsp;float]&nbsp;=&nbsp;{start_region:&nbsp;0.0}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;open_set:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_,&nbsp;_,&nbsp;current&nbsp;=&nbsp;heapq.heappop(open_set)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;current&nbsp;==&nbsp;end_region:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Восстанавливаем&nbsp;путь<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;list[tuple[int,&nbsp;int]]&nbsp;=&nbsp;[(current,&nbsp;-1)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;current&nbsp;in&nbsp;came_from:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_region,&nbsp;portal_idx&nbsp;=&nbsp;came_from[current]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path.append((prev_region,&nbsp;portal_idx))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current&nbsp;=&nbsp;prev_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;path[::-1]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_g&nbsp;=&nbsp;g_score[current]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;neighbor,&nbsp;portal_idx&nbsp;in&nbsp;self.region_adjacency.get(current,&nbsp;[]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Расстояние&nbsp;между&nbsp;регионами&nbsp;через&nbsp;портал<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal&nbsp;=&nbsp;portals_data[portal_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal_center&nbsp;=&nbsp;portal.center<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Расстояние&nbsp;от&nbsp;центроида&nbsp;текущего&nbsp;региона&nbsp;до&nbsp;портала&nbsp;+&nbsp;от&nbsp;портала&nbsp;до&nbsp;центроида&nbsp;соседа<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;current&nbsp;in&nbsp;self.region_centroids:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;+=&nbsp;float(np.linalg.norm(self.region_centroids[current]&nbsp;-&nbsp;portal_center))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbor&nbsp;in&nbsp;self.region_centroids:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;+=&nbsp;float(np.linalg.norm(portal_center&nbsp;-&nbsp;self.region_centroids[neighbor]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tentative_g&nbsp;=&nbsp;current_g&nbsp;+&nbsp;max(dist,&nbsp;0.1)&nbsp;&nbsp;#&nbsp;Минимальная&nbsp;стоимость<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbor&nbsp;not&nbsp;in&nbsp;g_score&nbsp;or&nbsp;tentative_g&nbsp;&lt;&nbsp;g_score[neighbor]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;came_from[neighbor]&nbsp;=&nbsp;(current,&nbsp;portal_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_score[neighbor]&nbsp;=&nbsp;tentative_g<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;tentative_g&nbsp;+&nbsp;heuristic(neighbor)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;counter&nbsp;+=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;heapq.heappush(open_set,&nbsp;(f,&nbsp;counter,&nbsp;neighbor))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;build_adjacency(triangles:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Построить&nbsp;массив&nbsp;смежности&nbsp;треугольников.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;индексы&nbsp;вершин&nbsp;треугольников.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;для&nbsp;каждого&nbsp;треугольника,&nbsp;сосед&nbsp;по&nbsp;каждому&nbsp;ребру.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors[t,&nbsp;e]&nbsp;=&nbsp;индекс&nbsp;соседнего&nbsp;треугольника&nbsp;по&nbsp;ребру&nbsp;e,&nbsp;или&nbsp;-1.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ребро&nbsp;0:&nbsp;вершины&nbsp;(0,&nbsp;1),&nbsp;ребро&nbsp;1:&nbsp;(1,&nbsp;2),&nbsp;ребро&nbsp;2:&nbsp;(2,&nbsp;0).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;=&nbsp;len(triangles)<br>
&nbsp;&nbsp;&nbsp;&nbsp;neighbors&nbsp;=&nbsp;np.full((m,&nbsp;3),&nbsp;-1,&nbsp;dtype=np.int32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;edge&nbsp;-&gt;&nbsp;(triangle_idx,&nbsp;edge_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;edge_to_tri:&nbsp;dict[tuple[int,&nbsp;int],&nbsp;tuple[int,&nbsp;int]]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;tri_idx&nbsp;in&nbsp;range(m):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;triangles[tri_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;edge_idx&nbsp;in&nbsp;range(3):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v0&nbsp;=&nbsp;int(t[edge_idx])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;int(t[(edge_idx&nbsp;+&nbsp;1)&nbsp;%&nbsp;3])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Нормализуем&nbsp;ребро&nbsp;(меньший&nbsp;индекс&nbsp;первым)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge&nbsp;=&nbsp;(min(v0,&nbsp;v1),&nbsp;max(v0,&nbsp;v1))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;edge&nbsp;in&nbsp;edge_to_tri:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Нашли&nbsp;соседа<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_tri,&nbsp;other_edge&nbsp;=&nbsp;edge_to_tri[edge]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors[tri_idx,&nbsp;edge_idx]&nbsp;=&nbsp;other_tri<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors[other_tri,&nbsp;other_edge]&nbsp;=&nbsp;tri_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge_to_tri[edge]&nbsp;=&nbsp;(tri_idx,&nbsp;edge_idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;neighbors<br>
<br>
<br>
def&nbsp;compute_centroids(vertices:&nbsp;np.ndarray,&nbsp;triangles:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Вычислить&nbsp;центроиды&nbsp;треугольников.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v0&nbsp;=&nbsp;vertices[triangles[:,&nbsp;0]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;vertices[triangles[:,&nbsp;1]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;vertices[triangles[:,&nbsp;2]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(v0&nbsp;+&nbsp;v1&nbsp;+&nbsp;v2)&nbsp;/&nbsp;3.0<br>
<br>
<br>
def&nbsp;find_triangle_containing_point(<br>
&nbsp;&nbsp;&nbsp;&nbsp;point:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;tolerance:&nbsp;float&nbsp;=&nbsp;0.5,<br>
)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Найти&nbsp;треугольник,&nbsp;содержащий&nbsp;точку.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Проецирует&nbsp;точку&nbsp;на&nbsp;плоскость&nbsp;каждого&nbsp;треугольника&nbsp;и&nbsp;проверяет:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Расстояние&nbsp;до&nbsp;плоскости&nbsp;&lt;&nbsp;tolerance<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Проекция&nbsp;внутри&nbsp;треугольника<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;point:&nbsp;(3,)&nbsp;—&nbsp;точка&nbsp;в&nbsp;3D.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;(N,&nbsp;3)&nbsp;—&nbsp;вершины.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;треугольники.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tolerance:&nbsp;максимальное&nbsp;расстояние&nbsp;до&nbsp;плоскости&nbsp;треугольника.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Индекс&nbsp;треугольника&nbsp;или&nbsp;-1.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;best_tri&nbsp;=&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;best_dist&nbsp;=&nbsp;tolerance<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;tri_idx&nbsp;in&nbsp;range(len(triangles)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;triangles[tri_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v0&nbsp;=&nbsp;vertices[t[0]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;vertices[t[1]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;vertices[t[2]]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Рёбра&nbsp;треугольника<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge1&nbsp;=&nbsp;v1&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge2&nbsp;=&nbsp;v2&nbsp;-&nbsp;v0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Нормаль&nbsp;треугольника<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.cross(edge1,&nbsp;edge2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal_len&nbsp;=&nbsp;np.linalg.norm(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normal_len&nbsp;&lt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;normal&nbsp;/&nbsp;normal_len<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Расстояние&nbsp;от&nbsp;точки&nbsp;до&nbsp;плоскости<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;np.dot(point&nbsp;-&nbsp;v0,&nbsp;normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abs_d&nbsp;=&nbsp;abs(d)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs_d&nbsp;&gt;&nbsp;tolerance:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проекция&nbsp;точки&nbsp;на&nbsp;плоскость<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_proj&nbsp;=&nbsp;point&nbsp;-&nbsp;d&nbsp;*&nbsp;normal<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Локальная&nbsp;2D&nbsp;система&nbsp;координат&nbsp;на&nbsp;плоскости<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u_axis&nbsp;=&nbsp;edge1&nbsp;/&nbsp;np.linalg.norm(edge1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v_axis&nbsp;=&nbsp;np.cross(normal,&nbsp;u_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Перевод&nbsp;в&nbsp;2D<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rel&nbsp;=&nbsp;p_proj&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p2d_u&nbsp;=&nbsp;np.dot(rel,&nbsp;u_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p2d_v&nbsp;=&nbsp;np.dot(rel,&nbsp;v_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b2d_u&nbsp;=&nbsp;np.dot(edge1,&nbsp;u_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b2d_v&nbsp;=&nbsp;np.dot(edge1,&nbsp;v_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c2d_u&nbsp;=&nbsp;np.dot(edge2,&nbsp;u_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c2d_v&nbsp;=&nbsp;np.dot(edge2,&nbsp;v_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверка&nbsp;point_in_triangle_2d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;point_in_triangle_2d(p2d_u,&nbsp;p2d_v,&nbsp;0.0,&nbsp;0.0,&nbsp;b2d_u,&nbsp;b2d_v,&nbsp;c2d_u,&nbsp;c2d_v):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs_d&nbsp;&lt;&nbsp;best_dist:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_dist&nbsp;=&nbsp;abs_d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_tri&nbsp;=&nbsp;tri_idx<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;best_tri<br>
<br>
<br>
def&nbsp;point_in_triangle_2d(<br>
&nbsp;&nbsp;&nbsp;&nbsp;px:&nbsp;float,&nbsp;py:&nbsp;float,<br>
&nbsp;&nbsp;&nbsp;&nbsp;x0:&nbsp;float,&nbsp;y0:&nbsp;float,<br>
&nbsp;&nbsp;&nbsp;&nbsp;x1:&nbsp;float,&nbsp;y1:&nbsp;float,<br>
&nbsp;&nbsp;&nbsp;&nbsp;x2:&nbsp;float,&nbsp;y2:&nbsp;float,<br>
&nbsp;&nbsp;&nbsp;&nbsp;epsilon:&nbsp;float&nbsp;=&nbsp;0.05,<br>
)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Проверить,&nbsp;находится&nbsp;ли&nbsp;точка&nbsp;внутри&nbsp;треугольника&nbsp;(2D).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;epsilon:&nbsp;Допуск&nbsp;для&nbsp;точек&nbsp;на&nbsp;границе&nbsp;или&nbsp;чуть&nbsp;за&nbsp;ней.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Нормализуется&nbsp;относительно&nbsp;площади&nbsp;треугольника.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;signed_area(ax,&nbsp;ay,&nbsp;bx,&nbsp;by,&nbsp;cx,&nbsp;cy):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(bx&nbsp;-&nbsp;ax)&nbsp;*&nbsp;(cy&nbsp;-&nbsp;ay)&nbsp;-&nbsp;(cx&nbsp;-&nbsp;ax)&nbsp;*&nbsp;(by&nbsp;-&nbsp;ay)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Площадь&nbsp;треугольника<br>
&nbsp;&nbsp;&nbsp;&nbsp;area&nbsp;=&nbsp;signed_area(x0,&nbsp;y0,&nbsp;x1,&nbsp;y1,&nbsp;x2,&nbsp;y2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(area)&nbsp;&lt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Барицентрические&nbsp;координаты&nbsp;(не&nbsp;нормализованные)<br>
&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;signed_area(px,&nbsp;py,&nbsp;x0,&nbsp;y0,&nbsp;x1,&nbsp;y1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;signed_area(px,&nbsp;py,&nbsp;x1,&nbsp;y1,&nbsp;x2,&nbsp;y2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;u&nbsp;=&nbsp;signed_area(px,&nbsp;py,&nbsp;x2,&nbsp;y2,&nbsp;x0,&nbsp;y0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Порог&nbsp;пропорционален&nbsp;площади<br>
&nbsp;&nbsp;&nbsp;&nbsp;threshold&nbsp;=&nbsp;epsilon&nbsp;*&nbsp;abs(area)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;area&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;CCW&nbsp;winding<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;s&nbsp;&gt;=&nbsp;-threshold&nbsp;and&nbsp;t&nbsp;&gt;=&nbsp;-threshold&nbsp;and&nbsp;u&nbsp;&gt;=&nbsp;-threshold<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;CW&nbsp;winding<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;s&nbsp;&lt;=&nbsp;threshold&nbsp;and&nbsp;t&nbsp;&lt;=&nbsp;threshold&nbsp;and&nbsp;u&nbsp;&lt;=&nbsp;threshold<br>
<br>
<br>
def&nbsp;get_portals_from_path(<br>
&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;list[int],<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;np.ndarray,<br>
)&nbsp;-&gt;&nbsp;list[tuple[np.ndarray,&nbsp;np.ndarray]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Извлечь&nbsp;порталы&nbsp;(рёбра&nbsp;между&nbsp;смежными&nbsp;треугольниками)&nbsp;из&nbsp;пути.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left/right&nbsp;ориентированы&nbsp;консистентно:&nbsp;общие&nbsp;вершины&nbsp;соседних&nbsp;порталов<br>
&nbsp;&nbsp;&nbsp;&nbsp;остаются&nbsp;на&nbsp;той&nbsp;же&nbsp;стороне&nbsp;(left&nbsp;или&nbsp;right).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;Список&nbsp;индексов&nbsp;треугольников.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;индексы&nbsp;вершин&nbsp;треугольников.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;(N,&nbsp;3)&nbsp;—&nbsp;вершины.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;соседи&nbsp;по&nbsp;каждому&nbsp;ребру.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Список&nbsp;порталов&nbsp;(left,&nbsp;right)&nbsp;—&nbsp;координаты&nbsp;концов&nbsp;общего&nbsp;ребра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;portals:&nbsp;list[tuple[np.ndarray,&nbsp;np.ndarray]]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log&nbsp;as&nbsp;_log<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Храним&nbsp;индексы&nbsp;вершин&nbsp;для&nbsp;обеспечения&nbsp;консистентности<br>
&nbsp;&nbsp;&nbsp;&nbsp;prev_left_idx:&nbsp;int&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;prev_right_idx:&nbsp;int&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(path)&nbsp;-&nbsp;1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tri_a&nbsp;=&nbsp;path[i]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tri_b&nbsp;=&nbsp;path[i&nbsp;+&nbsp;1]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tri_a_verts&nbsp;=&nbsp;triangles[tri_a]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Найти&nbsp;общее&nbsp;ребро&nbsp;между&nbsp;tri_a&nbsp;и&nbsp;tri_b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found_edge&nbsp;=&nbsp;False<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;edge_idx&nbsp;in&nbsp;range(3):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbors[tri_a,&nbsp;edge_idx]&nbsp;==&nbsp;tri_b:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v0_idx&nbsp;=&nbsp;triangles[tri_a,&nbsp;edge_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1_idx&nbsp;=&nbsp;triangles[tri_a,&nbsp;(edge_idx&nbsp;+&nbsp;1)&nbsp;%&nbsp;3]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p0&nbsp;=&nbsp;vertices[v0_idx].copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p1&nbsp;=&nbsp;vertices[v1_idx].copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Определяем&nbsp;left/right<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Первый&nbsp;портал:&nbsp;определяем&nbsp;ориентацию&nbsp;по&nbsp;направлению&nbsp;движения<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tri_b_verts&nbsp;=&nbsp;triangles[tri_b]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroid_a&nbsp;=&nbsp;(vertices[tri_a_verts[0]]&nbsp;+&nbsp;vertices[tri_a_verts[1]]&nbsp;+&nbsp;vertices[tri_a_verts[2]])&nbsp;/&nbsp;3.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroid_b&nbsp;=&nbsp;(vertices[tri_b_verts[0]]&nbsp;+&nbsp;vertices[tri_b_verts[1]]&nbsp;+&nbsp;vertices[tri_b_verts[2]])&nbsp;/&nbsp;3.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;move_dir&nbsp;=&nbsp;centroid_b&nbsp;-&nbsp;centroid_a<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Нормаль&nbsp;треугольника&nbsp;A<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va0&nbsp;=&nbsp;vertices[tri_a_verts[0]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va1&nbsp;=&nbsp;vertices[tri_a_verts[1]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va2&nbsp;=&nbsp;vertices[tri_a_verts[2]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.cross(va1&nbsp;-&nbsp;va0,&nbsp;va2&nbsp;-&nbsp;va0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal_len&nbsp;=&nbsp;np.linalg.norm(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normal_len&nbsp;&gt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;normal&nbsp;/&nbsp;normal_len<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge_vec&nbsp;=&nbsp;p1&nbsp;-&nbsp;p0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cross&nbsp;=&nbsp;np.cross(move_dir,&nbsp;edge_vec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sign&nbsp;=&nbsp;np.dot(cross,&nbsp;normal)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sign&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_idx,&nbsp;right_idx&nbsp;=&nbsp;v0_idx,&nbsp;v1_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_idx,&nbsp;right_idx&nbsp;=&nbsp;v1_idx,&nbsp;v0_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Последующие&nbsp;порталы:&nbsp;сохраняем&nbsp;консистентность&nbsp;с&nbsp;предыдущим<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;одна&nbsp;из&nbsp;вершин&nbsp;совпадает&nbsp;с&nbsp;предыдущей,&nbsp;она&nbsp;остаётся&nbsp;на&nbsp;той&nbsp;же&nbsp;стороне<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;v0_idx&nbsp;==&nbsp;prev_left_idx&nbsp;or&nbsp;v1_idx&nbsp;==&nbsp;prev_right_idx:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_idx,&nbsp;right_idx&nbsp;=&nbsp;v0_idx,&nbsp;v1_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;v1_idx&nbsp;==&nbsp;prev_left_idx&nbsp;or&nbsp;v0_idx&nbsp;==&nbsp;prev_right_idx:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_idx,&nbsp;right_idx&nbsp;=&nbsp;v1_idx,&nbsp;v0_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Нет&nbsp;общих&nbsp;вершин&nbsp;с&nbsp;предыдущим&nbsp;порталом&nbsp;—&nbsp;используем&nbsp;move_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tri_b_verts&nbsp;=&nbsp;triangles[tri_b]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroid_a&nbsp;=&nbsp;(vertices[tri_a_verts[0]]&nbsp;+&nbsp;vertices[tri_a_verts[1]]&nbsp;+&nbsp;vertices[tri_a_verts[2]])&nbsp;/&nbsp;3.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroid_b&nbsp;=&nbsp;(vertices[tri_b_verts[0]]&nbsp;+&nbsp;vertices[tri_b_verts[1]]&nbsp;+&nbsp;vertices[tri_b_verts[2]])&nbsp;/&nbsp;3.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;move_dir&nbsp;=&nbsp;centroid_b&nbsp;-&nbsp;centroid_a<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va0&nbsp;=&nbsp;vertices[tri_a_verts[0]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va1&nbsp;=&nbsp;vertices[tri_a_verts[1]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va2&nbsp;=&nbsp;vertices[tri_a_verts[2]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.cross(va1&nbsp;-&nbsp;va0,&nbsp;va2&nbsp;-&nbsp;va0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal_len&nbsp;=&nbsp;np.linalg.norm(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normal_len&nbsp;&gt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;normal&nbsp;/&nbsp;normal_len<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge_vec&nbsp;=&nbsp;p1&nbsp;-&nbsp;p0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cross&nbsp;=&nbsp;np.cross(move_dir,&nbsp;edge_vec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sign&nbsp;=&nbsp;np.dot(cross,&nbsp;normal)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sign&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_idx,&nbsp;right_idx&nbsp;=&nbsp;v0_idx,&nbsp;v1_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_idx,&nbsp;right_idx&nbsp;=&nbsp;v1_idx,&nbsp;v0_idx<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;vertices[left_idx].copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;vertices[right_idx].copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Portal&nbsp;{i}]&nbsp;tri&nbsp;{tri_a}-&gt;{tri_b},&nbsp;left_idx={left_idx},&nbsp;right_idx={right_idx}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Portal&nbsp;{i}]&nbsp;left={left},&nbsp;right={right}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portals.append((left,&nbsp;right))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_left_idx&nbsp;=&nbsp;left_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_right_idx&nbsp;=&nbsp;right_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found_edge&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;found_edge:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.warn(f&quot;[Portal&nbsp;{i}]&nbsp;NO&nbsp;SHARED&nbsp;EDGE&nbsp;between&nbsp;tri&nbsp;{tri_a}&nbsp;and&nbsp;{tri_b}!&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.warn(f&quot;[Portal&nbsp;{i}]&nbsp;neighbors[{tri_a}]&nbsp;=&nbsp;{neighbors[tri_a]}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;portals<br>
<br>
<br>
def&nbsp;funnel_algorithm(<br>
&nbsp;&nbsp;&nbsp;&nbsp;start:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;end:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;portals:&nbsp;list[tuple[np.ndarray,&nbsp;np.ndarray]],<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
)&nbsp;-&gt;&nbsp;list[np.ndarray]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Funnel&nbsp;Algorithm&nbsp;(Simple&nbsp;Stupid&nbsp;Funnel&nbsp;Algorithm).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Оптимизирует&nbsp;путь&nbsp;через&nbsp;порталы,&nbsp;&quot;натягивая&nbsp;верёвку&quot;.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start:&nbsp;Начальная&nbsp;точка.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end:&nbsp;Конечная&nbsp;точка.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portals:&nbsp;Список&nbsp;порталов&nbsp;(left,&nbsp;right).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;Нормаль&nbsp;плоскости&nbsp;региона.&nbsp;Если&nbsp;None,&nbsp;вычисляется&nbsp;из&nbsp;первого&nbsp;портала.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Оптимизированный&nbsp;список&nbsp;точек&nbsp;пути.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log&nbsp;as&nbsp;_log<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(portals)&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[start.copy(),&nbsp;end.copy()]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Funnel]&nbsp;start={start},&nbsp;end={end},&nbsp;{len(portals)}&nbsp;portals&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;pi,&nbsp;(pl,&nbsp;pr)&nbsp;in&nbsp;enumerate(portals):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Funnel]&nbsp;portal&nbsp;{pi}:&nbsp;left={pl},&nbsp;right={pr}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Вычисляем&nbsp;нормаль&nbsp;из&nbsp;первого&nbsp;портала&nbsp;если&nbsp;не&nbsp;задана<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normal&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Используем&nbsp;start,&nbsp;portal_left,&nbsp;portal_right&nbsp;для&nbsp;определения&nbsp;плоскости<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_left,&nbsp;p_right&nbsp;=&nbsp;portals[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;p_left&nbsp;-&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;p_right&nbsp;-&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.cross(v1,&nbsp;v2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n_len&nbsp;=&nbsp;np.linalg.norm(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;n_len&nbsp;&gt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;normal&nbsp;/&nbsp;n_len<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fallback&nbsp;на&nbsp;Y-up<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.array([0.0,&nbsp;1.0,&nbsp;0.0],&nbsp;dtype=np.float64)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Добавляем&nbsp;конечную&nbsp;точку&nbsp;как&nbsp;&quot;портал&quot;&nbsp;с&nbsp;left=right=end<br>
&nbsp;&nbsp;&nbsp;&nbsp;portals&nbsp;=&nbsp;portals&nbsp;+&nbsp;[(end.copy(),&nbsp;end.copy())]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;list[np.ndarray]&nbsp;=&nbsp;[start.copy()]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Вершина&nbsp;воронки<br>
&nbsp;&nbsp;&nbsp;&nbsp;apex&nbsp;=&nbsp;start.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;apex_index&nbsp;=&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Левая&nbsp;и&nbsp;правая&nbsp;границы&nbsp;воронки<br>
&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;portals[0][0].copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;portals[0][1].copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;left_index&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;right_index&nbsp;=&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Funnel]&nbsp;initial:&nbsp;apex={apex},&nbsp;left={left},&nbsp;right={right}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;triarea2(a:&nbsp;np.ndarray,&nbsp;b:&nbsp;np.ndarray,&nbsp;c:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Знаковая&nbsp;площадь&nbsp;треугольника&nbsp;в&nbsp;плоскости&nbsp;с&nbsp;заданной&nbsp;нормалью.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Положительная&nbsp;=&nbsp;c&nbsp;слева&nbsp;от&nbsp;вектора&nbsp;a→b.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Отрицательная&nbsp;=&nbsp;c&nbsp;справа.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ab&nbsp;=&nbsp;b&nbsp;-&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ac&nbsp;=&nbsp;c&nbsp;-&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cross&nbsp;=&nbsp;np.cross(ab,&nbsp;ac)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;float(np.dot(cross,&nbsp;normal))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_iterations&nbsp;=&nbsp;len(portals)&nbsp;*&nbsp;3&nbsp;&nbsp;#&nbsp;Защита&nbsp;от&nbsp;бесконечного&nbsp;цикла<br>
&nbsp;&nbsp;&nbsp;&nbsp;iteration&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;i&nbsp;&lt;&nbsp;len(portals):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iteration&nbsp;+=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;iteration&nbsp;&gt;&nbsp;max_iterations:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.warn(f&quot;[Funnel]&nbsp;max&nbsp;iterations&nbsp;exceeded,&nbsp;breaking&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal_left&nbsp;=&nbsp;portals[i][0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal_right&nbsp;=&nbsp;portals[i][1]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Обновляем&nbsp;правую&nbsp;границу<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Пропускаем&nbsp;если&nbsp;portal_right&nbsp;==&nbsp;right&nbsp;(граница&nbsp;не&nbsp;изменилась)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;np.allclose(right,&nbsp;portal_right):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass&nbsp;&nbsp;#&nbsp;Правая&nbsp;граница&nbsp;не&nbsp;изменилась<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;triarea2(apex,&nbsp;right,&nbsp;portal_right)&nbsp;&lt;=&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем&nbsp;пересечение&nbsp;с&nbsp;левой&nbsp;границей<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;apex&nbsp;==&nbsp;left&nbsp;или&nbsp;apex&nbsp;==&nbsp;right&nbsp;—&nbsp;воронка&nbsp;схлопнулась&nbsp;в&nbsp;точку,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;нет&nbsp;границы&nbsp;для&nbsp;пересечения,&nbsp;просто&nbsp;сужаем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apex_collapsed&nbsp;=&nbsp;np.allclose(apex,&nbsp;left)&nbsp;or&nbsp;np.allclose(apex,&nbsp;right)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;apex_collapsed&nbsp;or&nbsp;triarea2(apex,&nbsp;left,&nbsp;portal_right)&nbsp;&gt;&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Сужаем&nbsp;воронку&nbsp;справа<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;portal_right.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_index&nbsp;=&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Правая&nbsp;граница&nbsp;пересекла&nbsp;левую&nbsp;—&nbsp;добавляем&nbsp;left&nbsp;в&nbsp;путь<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Funnel]&nbsp;i={i}:&nbsp;right&nbsp;crossed&nbsp;left,&nbsp;adding&nbsp;waypoint&nbsp;left={left}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path.append(left.copy())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apex&nbsp;=&nbsp;left.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apex_index&nbsp;=&nbsp;left_index<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Перезапускаем&nbsp;воронку<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;apex.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;apex.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_index&nbsp;=&nbsp;apex_index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_index&nbsp;=&nbsp;apex_index<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Перезапускаем&nbsp;сканирование&nbsp;с&nbsp;apex<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;apex_index&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Обновляем&nbsp;левую&nbsp;границу<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Пропускаем&nbsp;если&nbsp;portal_left&nbsp;==&nbsp;left&nbsp;(граница&nbsp;не&nbsp;изменилась)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;np.allclose(left,&nbsp;portal_left):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass&nbsp;&nbsp;#&nbsp;Левая&nbsp;граница&nbsp;не&nbsp;изменилась<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;triarea2(apex,&nbsp;left,&nbsp;portal_left)&nbsp;&gt;=&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем&nbsp;пересечение&nbsp;с&nbsp;правой&nbsp;границей<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;apex&nbsp;==&nbsp;left&nbsp;или&nbsp;apex&nbsp;==&nbsp;right&nbsp;—&nbsp;воронка&nbsp;схлопнулась&nbsp;в&nbsp;точку,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;нет&nbsp;границы&nbsp;для&nbsp;пересечения,&nbsp;просто&nbsp;сужаем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apex_collapsed&nbsp;=&nbsp;np.allclose(apex,&nbsp;left)&nbsp;or&nbsp;np.allclose(apex,&nbsp;right)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;apex_collapsed&nbsp;or&nbsp;triarea2(apex,&nbsp;right,&nbsp;portal_left)&nbsp;&lt;&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Сужаем&nbsp;воронку&nbsp;слева<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;portal_left.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_index&nbsp;=&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Левая&nbsp;граница&nbsp;пересекла&nbsp;правую&nbsp;—&nbsp;добавляем&nbsp;right&nbsp;в&nbsp;путь<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[Funnel]&nbsp;i={i}:&nbsp;left&nbsp;crossed&nbsp;right,&nbsp;adding&nbsp;waypoint&nbsp;right={right}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path.append(right.copy())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apex&nbsp;=&nbsp;right.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apex_index&nbsp;=&nbsp;right_index<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Перезапускаем&nbsp;воронку<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;apex.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;apex.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_index&nbsp;=&nbsp;apex_index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_index&nbsp;=&nbsp;apex_index<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Перезапускаем&nbsp;сканирование&nbsp;с&nbsp;apex<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;apex_index&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Добавляем&nbsp;конечную&nbsp;точку<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(path)&nbsp;==&nbsp;0&nbsp;or&nbsp;not&nbsp;np.allclose(path[-1],&nbsp;end):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path.append(end.copy())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;path<br>
<br>
<br>
def&nbsp;navmesh_line_of_sight(<br>
&nbsp;&nbsp;&nbsp;&nbsp;start:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;end:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;start_tri:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;np.ndarray,<br>
)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Проверка&nbsp;прямой&nbsp;видимости&nbsp;на&nbsp;NavMesh.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Идёт&nbsp;от&nbsp;start_tri&nbsp;к&nbsp;end&nbsp;по&nbsp;прямой,&nbsp;переходя&nbsp;через&nbsp;порталы.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;True&nbsp;если&nbsp;можно&nbsp;дойти,&nbsp;не&nbsp;выходя&nbsp;за&nbsp;границы&nbsp;NavMesh.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start:&nbsp;Начальная&nbsp;точка.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end:&nbsp;Конечная&nbsp;точка.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_tri:&nbsp;Индекс&nbsp;треугольника,&nbsp;содержащего&nbsp;start.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;индексы&nbsp;вершин&nbsp;треугольников.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;(N,&nbsp;3)&nbsp;—&nbsp;вершины.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;соседи.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;True&nbsp;если&nbsp;прямой&nbsp;путь&nbsp;возможен.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log&nbsp;as&nbsp;_log<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;direction&nbsp;=&nbsp;end&nbsp;-&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;dir_len&nbsp;=&nbsp;float(np.linalg.norm(direction))<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dir_len&nbsp;&lt;&nbsp;1e-8:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;current_tri&nbsp;=&nbsp;start_tri<br>
&nbsp;&nbsp;&nbsp;&nbsp;prev_tri&nbsp;=&nbsp;-1&nbsp;&nbsp;#&nbsp;Предыдущий&nbsp;треугольник&nbsp;(чтобы&nbsp;не&nbsp;возвращаться)<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_iterations&nbsp;=&nbsp;len(triangles)&nbsp;*&nbsp;2&nbsp;&nbsp;#&nbsp;защита&nbsp;от&nbsp;бесконечного&nbsp;цикла<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;iteration&nbsp;in&nbsp;range(max_iterations):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем,&nbsp;находится&nbsp;ли&nbsp;end&nbsp;в&nbsp;текущем&nbsp;треугольнике<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tri&nbsp;=&nbsp;triangles[current_tri]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v0&nbsp;=&nbsp;vertices[tri[0]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;vertices[tri[1]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;vertices[tri[2]]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_point_in_triangle_3d(end,&nbsp;v0,&nbsp;v1,&nbsp;v2):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[LOS]&nbsp;end&nbsp;found&nbsp;in&nbsp;tri&nbsp;{current_tri}&nbsp;after&nbsp;{iteration}&nbsp;iterations&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Вычисляем&nbsp;базис&nbsp;плоскости&nbsp;треугольника<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge1&nbsp;=&nbsp;v1&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge2&nbsp;=&nbsp;v2&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.cross(edge1,&nbsp;edge2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal_len&nbsp;=&nbsp;np.linalg.norm(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normal_len&nbsp;&lt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.warn(f&quot;[LOS]&nbsp;degenerate&nbsp;triangle&nbsp;{current_tri}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;normal&nbsp;/&nbsp;normal_len<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u_axis&nbsp;=&nbsp;edge1&nbsp;/&nbsp;np.linalg.norm(edge1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v_axis&nbsp;=&nbsp;np.cross(normal,&nbsp;u_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ищем&nbsp;ребро,&nbsp;которое&nbsp;пересекает&nbsp;луч&nbsp;start-&gt;end<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Исключаем&nbsp;ребро,&nbsp;через&nbsp;которое&nbsp;мы&nbsp;пришли&nbsp;(prev_tri)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_edge&nbsp;=&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_t&nbsp;=&nbsp;float('inf')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;edge_idx&nbsp;in&nbsp;range(3):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbor&nbsp;=&nbsp;neighbors[current_tri,&nbsp;edge_idx]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Не&nbsp;возвращаемся&nbsp;назад<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbor&nbsp;==&nbsp;prev_tri:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e0&nbsp;=&nbsp;vertices[tri[edge_idx]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e1&nbsp;=&nbsp;vertices[tri[(edge_idx&nbsp;+&nbsp;1)&nbsp;%&nbsp;3]]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;_ray_edge_intersection_3d(start,&nbsp;direction,&nbsp;e0,&nbsp;e1,&nbsp;u_axis,&nbsp;v_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;0.0&nbsp;&lt;&nbsp;t&nbsp;&lt;=&nbsp;1.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;t&nbsp;&lt;&nbsp;best_t:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_t&nbsp;=&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_edge&nbsp;=&nbsp;edge_idx<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;best_edge&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[LOS]&nbsp;no&nbsp;exit&nbsp;edge&nbsp;found&nbsp;in&nbsp;tri&nbsp;{current_tri}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False&nbsp;&nbsp;#&nbsp;Нет&nbsp;пересечения&nbsp;—&nbsp;луч&nbsp;не&nbsp;выходит&nbsp;через&nbsp;это&nbsp;ребро<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbor&nbsp;=&nbsp;neighbors[current_tri,&nbsp;best_edge]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbor&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_log.info(f&quot;[LOS]&nbsp;hit&nbsp;boundary&nbsp;edge&nbsp;{best_edge}&nbsp;in&nbsp;tri&nbsp;{current_tri}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False&nbsp;&nbsp;#&nbsp;Граничное&nbsp;ребро&nbsp;—&nbsp;нет&nbsp;прямой&nbsp;видимости<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_tri&nbsp;=&nbsp;current_tri<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_tri&nbsp;=&nbsp;neighbor<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_log.warn(f&quot;[LOS]&nbsp;max&nbsp;iterations&nbsp;reached&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
<br>
def&nbsp;_point_in_triangle_3d(<br>
&nbsp;&nbsp;&nbsp;&nbsp;point:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;v0:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;v1:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;v2:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;tolerance:&nbsp;float&nbsp;=&nbsp;0.5,<br>
)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Проверить,&nbsp;находится&nbsp;ли&nbsp;точка&nbsp;в&nbsp;треугольнике&nbsp;(3D&nbsp;с&nbsp;проекцией).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;edge1&nbsp;=&nbsp;v1&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;edge2&nbsp;=&nbsp;v2&nbsp;-&nbsp;v0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;np.cross(edge1,&nbsp;edge2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal_len&nbsp;=&nbsp;np.linalg.norm(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normal_len&nbsp;&lt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;normal&nbsp;/&nbsp;normal_len<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;np.dot(point&nbsp;-&nbsp;v0,&nbsp;normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(d)&nbsp;&gt;&nbsp;tolerance:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p_proj&nbsp;=&nbsp;point&nbsp;-&nbsp;d&nbsp;*&nbsp;normal<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;u_axis&nbsp;=&nbsp;edge1&nbsp;/&nbsp;np.linalg.norm(edge1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_axis&nbsp;=&nbsp;np.cross(normal,&nbsp;u_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;rel&nbsp;=&nbsp;p_proj&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2d_u&nbsp;=&nbsp;np.dot(rel,&nbsp;u_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2d_v&nbsp;=&nbsp;np.dot(rel,&nbsp;v_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;b2d_u&nbsp;=&nbsp;np.dot(edge1,&nbsp;u_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;b2d_v&nbsp;=&nbsp;np.dot(edge1,&nbsp;v_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;c2d_u&nbsp;=&nbsp;np.dot(edge2,&nbsp;u_axis)<br>
&nbsp;&nbsp;&nbsp;&nbsp;c2d_v&nbsp;=&nbsp;np.dot(edge2,&nbsp;v_axis)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;point_in_triangle_2d(p2d_u,&nbsp;p2d_v,&nbsp;0.0,&nbsp;0.0,&nbsp;b2d_u,&nbsp;b2d_v,&nbsp;c2d_u,&nbsp;c2d_v)<br>
<br>
<br>
def&nbsp;_ray_edge_intersection_3d(<br>
&nbsp;&nbsp;&nbsp;&nbsp;origin:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;direction:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;e0:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;e1:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;u_axis:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_axis:&nbsp;np.ndarray,<br>
)&nbsp;-&gt;&nbsp;float&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Пересечение&nbsp;луча&nbsp;с&nbsp;ребром&nbsp;в&nbsp;плоскости&nbsp;треугольника.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;origin:&nbsp;Начало&nbsp;луча&nbsp;(3D).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;direction:&nbsp;Направление&nbsp;луча&nbsp;(3D).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e0,&nbsp;e1:&nbsp;Концы&nbsp;ребра&nbsp;(3D).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u_axis,&nbsp;v_axis:&nbsp;Базис&nbsp;плоскости&nbsp;треугольника.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Параметр&nbsp;t&nbsp;вдоль&nbsp;direction,&nbsp;или&nbsp;None.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проецируем&nbsp;на&nbsp;плоскость&nbsp;треугольника<br>
&nbsp;&nbsp;&nbsp;&nbsp;ou&nbsp;=&nbsp;float(np.dot(origin,&nbsp;u_axis))<br>
&nbsp;&nbsp;&nbsp;&nbsp;ov&nbsp;=&nbsp;float(np.dot(origin,&nbsp;v_axis))<br>
&nbsp;&nbsp;&nbsp;&nbsp;du&nbsp;=&nbsp;float(np.dot(direction,&nbsp;u_axis))<br>
&nbsp;&nbsp;&nbsp;&nbsp;dv&nbsp;=&nbsp;float(np.dot(direction,&nbsp;v_axis))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;e0u&nbsp;=&nbsp;float(np.dot(e0,&nbsp;u_axis))<br>
&nbsp;&nbsp;&nbsp;&nbsp;e0v&nbsp;=&nbsp;float(np.dot(e0,&nbsp;v_axis))<br>
&nbsp;&nbsp;&nbsp;&nbsp;e1u&nbsp;=&nbsp;float(np.dot(e1,&nbsp;u_axis))<br>
&nbsp;&nbsp;&nbsp;&nbsp;e1v&nbsp;=&nbsp;float(np.dot(e1,&nbsp;v_axis))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;eu&nbsp;=&nbsp;e1u&nbsp;-&nbsp;e0u<br>
&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;=&nbsp;e1v&nbsp;-&nbsp;e0v<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;denom&nbsp;=&nbsp;du&nbsp;*&nbsp;ev&nbsp;-&nbsp;dv&nbsp;*&nbsp;eu<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(denom)&nbsp;&lt;&nbsp;1e-10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None&nbsp;&nbsp;#&nbsp;Параллельны<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;diff_u&nbsp;=&nbsp;e0u&nbsp;-&nbsp;ou<br>
&nbsp;&nbsp;&nbsp;&nbsp;diff_v&nbsp;=&nbsp;e0v&nbsp;-&nbsp;ov<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;(diff_u&nbsp;*&nbsp;ev&nbsp;-&nbsp;diff_v&nbsp;*&nbsp;eu)&nbsp;/&nbsp;denom<br>
&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;(diff_u&nbsp;*&nbsp;dv&nbsp;-&nbsp;diff_v&nbsp;*&nbsp;du)&nbsp;/&nbsp;denom<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;0.0&nbsp;&lt;=&nbsp;s&nbsp;&lt;=&nbsp;1.0&nbsp;and&nbsp;t&nbsp;&gt;&nbsp;1e-8:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;astar_triangles(<br>
&nbsp;&nbsp;&nbsp;&nbsp;start_tri:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;end_tri:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;centroids:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;start_pos:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;end_pos:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
)&nbsp;-&gt;&nbsp;list[int]&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;A*&nbsp;поиск&nbsp;пути&nbsp;по&nbsp;графу&nbsp;треугольников.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_tri:&nbsp;индекс&nbsp;стартового&nbsp;треугольника.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_tri:&nbsp;индекс&nbsp;целевого&nbsp;треугольника.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;массив&nbsp;соседей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;centroids:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;центры&nbsp;треугольников.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;(M,&nbsp;3)&nbsp;—&nbsp;индексы&nbsp;вершин&nbsp;(опционально,&nbsp;для&nbsp;расчёта&nbsp;по&nbsp;рёбрам).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;(N,&nbsp;3)&nbsp;—&nbsp;вершины&nbsp;(опционально,&nbsp;для&nbsp;расчёта&nbsp;по&nbsp;рёбрам).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pos:&nbsp;Реальная&nbsp;начальная&nbsp;точка&nbsp;(опционально).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_pos:&nbsp;Реальная&nbsp;конечная&nbsp;точка&nbsp;(опционально).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Список&nbsp;индексов&nbsp;треугольников&nbsp;от&nbsp;старта&nbsp;до&nbsp;финиша,&nbsp;или&nbsp;None.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;use_edge_centers&nbsp;=&nbsp;triangles&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;vertices&nbsp;is&nbsp;not&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Используем&nbsp;реальные&nbsp;позиции&nbsp;если&nbsp;заданы,&nbsp;иначе&nbsp;центроиды<br>
&nbsp;&nbsp;&nbsp;&nbsp;actual_start&nbsp;=&nbsp;start_pos&nbsp;if&nbsp;start_pos&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;centroids[start_tri]<br>
&nbsp;&nbsp;&nbsp;&nbsp;actual_goal&nbsp;=&nbsp;end_pos&nbsp;if&nbsp;end_pos&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;centroids[end_tri]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_edge_center(tri_idx:&nbsp;int,&nbsp;edge_idx:&nbsp;int)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;центр&nbsp;ребра&nbsp;треугольника.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v0_idx&nbsp;=&nbsp;triangles[tri_idx,&nbsp;edge_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1_idx&nbsp;=&nbsp;triangles[tri_idx,&nbsp;(edge_idx&nbsp;+&nbsp;1)&nbsp;%&nbsp;3]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(vertices[v0_idx]&nbsp;+&nbsp;vertices[v1_idx])&nbsp;*&nbsp;0.5<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;heuristic_from_pos(pos:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;float:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Эвристика:&nbsp;расстояние&nbsp;от&nbsp;текущей&nbsp;позиции&nbsp;до&nbsp;цели.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;float(np.linalg.norm(pos&nbsp;-&nbsp;actual_goal))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Начальная&nbsp;позиция<br>
&nbsp;&nbsp;&nbsp;&nbsp;initial_pos&nbsp;=&nbsp;actual_start.copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(f_score,&nbsp;counter,&nbsp;triangle_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;counter&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;open_set:&nbsp;list[tuple[float,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;[(heuristic_from_pos(initial_pos),&nbsp;counter,&nbsp;start_tri)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;came_from:&nbsp;dict[int,&nbsp;int]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;g_score&nbsp;хранит&nbsp;(расстояние,&nbsp;последняя&nbsp;точка&nbsp;на&nbsp;пути)<br>
&nbsp;&nbsp;&nbsp;&nbsp;g_score:&nbsp;dict[int,&nbsp;tuple[float,&nbsp;np.ndarray]]&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_tri:&nbsp;(0.0,&nbsp;initial_pos)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log&nbsp;as&nbsp;_astar_log<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;open_set:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_val,&nbsp;_,&nbsp;current&nbsp;=&nbsp;heapq.heappop(open_set)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_g,&nbsp;current_pos&nbsp;=&nbsp;g_score[current]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_astar_log.info(f&quot;[A*]&nbsp;pop&nbsp;tri={current},&nbsp;g={current_g:.2f},&nbsp;f={f_val:.2f},&nbsp;pos={current_pos}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;current&nbsp;==&nbsp;end_tri:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Восстанавливаем&nbsp;путь<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;[current]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;current&nbsp;in&nbsp;came_from:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current&nbsp;=&nbsp;came_from[current]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path.append(current)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;path[::-1]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_g,&nbsp;current_pos&nbsp;=&nbsp;g_score[current]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;edge_idx&nbsp;in&nbsp;range(3):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbor&nbsp;=&nbsp;neighbors[current,&nbsp;edge_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbor&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;use_edge_centers:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Расстояние&nbsp;через&nbsp;центр&nbsp;общего&nbsp;ребра<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edge_center&nbsp;=&nbsp;get_edge_center(current,&nbsp;edge_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;float(np.linalg.norm(current_pos&nbsp;-&nbsp;edge_center))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_pos&nbsp;=&nbsp;edge_center<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fallback:&nbsp;расстояние&nbsp;между&nbsp;центроидами<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;float(np.linalg.norm(centroids[current]&nbsp;-&nbsp;centroids[neighbor]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_pos&nbsp;=&nbsp;centroids[neighbor].copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tentative_g&nbsp;=&nbsp;current_g&nbsp;+&nbsp;dist<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;neighbor&nbsp;not&nbsp;in&nbsp;g_score&nbsp;or&nbsp;tentative_g&nbsp;&lt;&nbsp;g_score[neighbor][0]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;came_from[neighbor]&nbsp;=&nbsp;current<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_score[neighbor]&nbsp;=&nbsp;(tentative_g,&nbsp;next_pos)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h&nbsp;=&nbsp;heuristic_from_pos(next_pos)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;tentative_g&nbsp;+&nbsp;h<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_astar_log.info(f&quot;[A*]&nbsp;&nbsp;&nbsp;-&gt;&nbsp;tri={neighbor},&nbsp;dist={dist:.2f},&nbsp;g={tentative_g:.2f},&nbsp;h={h:.2f},&nbsp;f={f:.2f}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;counter&nbsp;+=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;heapq.heappush(open_set,&nbsp;(f,&nbsp;counter,&nbsp;neighbor))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<!-- END SCAT CODE -->
</body>
</html>
