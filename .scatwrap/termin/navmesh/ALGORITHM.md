<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/navmesh/ALGORITHM.md</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;NavMesh&nbsp;Polygon&nbsp;Building&nbsp;Algorithm<br>
<br>
##&nbsp;Обзор<br>
<br>
Алгоритм&nbsp;строит&nbsp;NavMesh&nbsp;из&nbsp;воксельной&nbsp;сетки&nbsp;с&nbsp;нормалями&nbsp;поверхности.<br>
Каждый&nbsp;регион&nbsp;обрабатывается&nbsp;независимо,&nbsp;результаты&nbsp;объединяются&nbsp;без&nbsp;геометрической&nbsp;сшивки.<br>
<br>
###&nbsp;Стадии&nbsp;(NavMeshStage)<br>
<br>
|&nbsp;#&nbsp;|&nbsp;Стадия&nbsp;|&nbsp;Описание&nbsp;|<br>
|---|--------|----------|<br>
|&nbsp;0&nbsp;|&nbsp;REGIONS_BASIC&nbsp;|&nbsp;Region&nbsp;growing&nbsp;(базовые&nbsp;регионы)&nbsp;|<br>
|&nbsp;1&nbsp;|&nbsp;REGIONS_EXPANDED&nbsp;|&nbsp;+&nbsp;расширение&nbsp;регионов&nbsp;на&nbsp;граничные&nbsp;воксели&nbsp;|<br>
|&nbsp;2&nbsp;|&nbsp;STITCHED&nbsp;|&nbsp;+&nbsp;проекция&nbsp;вершин&nbsp;на&nbsp;пересечения&nbsp;плоскостей&nbsp;|<br>
|&nbsp;3&nbsp;|&nbsp;WITH_CONTOURS&nbsp;|&nbsp;+&nbsp;извлечение&nbsp;контуров&nbsp;из&nbsp;треугольников&nbsp;|<br>
|&nbsp;4&nbsp;|&nbsp;SIMPLIFIED&nbsp;|&nbsp;+&nbsp;упрощение&nbsp;контуров&nbsp;(Douglas-Peucker)&nbsp;|<br>
|&nbsp;5&nbsp;|&nbsp;FINAL&nbsp;|&nbsp;+&nbsp;Ear&nbsp;Clipping&nbsp;триангуляция&nbsp;|<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;1:&nbsp;Сбор&nbsp;поверхностных&nbsp;вокселей<br>
<br>
**Вход:**&nbsp;VoxelGrid&nbsp;с&nbsp;surface_normals&nbsp;(dict:&nbsp;coord&nbsp;→&nbsp;list[normal])<br>
<br>
**Выход:**&nbsp;dict&nbsp;`{(vx,&nbsp;vy,&nbsp;vz):&nbsp;[normal,&nbsp;...]}`&nbsp;—&nbsp;воксели&nbsp;со&nbsp;списками&nbsp;нормалей&nbsp;треугольников<br>
<br>
**Примечание:**&nbsp;Каждый&nbsp;воксель&nbsp;хранит&nbsp;список&nbsp;нормалей&nbsp;всех&nbsp;треугольников,&nbsp;которые&nbsp;его&nbsp;пересекают.&nbsp;Это&nbsp;позволяет&nbsp;корректно&nbsp;обрабатывать&nbsp;воксели&nbsp;на&nbsp;стыке&nbsp;поверхностей.<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;2:&nbsp;Region&nbsp;Growing<br>
<br>
**Вход:**&nbsp;dict&nbsp;`{(vx,&nbsp;vy,&nbsp;vz):&nbsp;[normal,&nbsp;...]}`<br>
<br>
**Алгоритм:**&nbsp;BFS&nbsp;с&nbsp;26-связностью:<br>
1.&nbsp;Берём&nbsp;seed-воксель<br>
2.&nbsp;Добавляем&nbsp;соседей&nbsp;если&nbsp;`dot(seed_normal,&nbsp;neighbor_first_normal)&nbsp;&gt;=&nbsp;threshold`<br>
3.&nbsp;Используется&nbsp;первая&nbsp;нормаль&nbsp;из&nbsp;списка&nbsp;для&nbsp;сравнения<br>
<br>
**Выход:**&nbsp;list&nbsp;of&nbsp;`(list[coord],&nbsp;avg_normal)`&nbsp;—&nbsp;группы&nbsp;вокселей&nbsp;с&nbsp;усреднённой&nbsp;нормалью<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;2.5:&nbsp;Расширение&nbsp;регионов&nbsp;(Region&nbsp;Expansion)<br>
<br>
**Вход:**&nbsp;регионы&nbsp;из&nbsp;шага&nbsp;2,&nbsp;dict&nbsp;`{coord:&nbsp;[normal,&nbsp;...]}`<br>
<br>
**Алгоритм:**&nbsp;Для&nbsp;каждого&nbsp;региона:<br>
1.&nbsp;Находим&nbsp;граничные&nbsp;воксели&nbsp;(соседи&nbsp;региона,&nbsp;не&nbsp;входящие&nbsp;в&nbsp;него)<br>
2.&nbsp;Если&nbsp;у&nbsp;граничного&nbsp;вокселя&nbsp;есть&nbsp;ХОТЯ&nbsp;БЫ&nbsp;ОДНА&nbsp;нормаль,&nbsp;близкая&nbsp;к&nbsp;нормали&nbsp;региона&nbsp;(`dot&nbsp;&gt;=&nbsp;threshold`),&nbsp;добавляем&nbsp;его&nbsp;в&nbsp;регион<br>
<br>
**Выход:**&nbsp;расширенные&nbsp;регионы&nbsp;(могут&nbsp;перекрываться)<br>
<br>
**Примечание:**&nbsp;После&nbsp;этого&nbsp;шага&nbsp;один&nbsp;воксель&nbsp;может&nbsp;принадлежать&nbsp;нескольким&nbsp;регионам&nbsp;—&nbsp;это&nbsp;ожидаемое&nbsp;поведение&nbsp;для&nbsp;вокселей&nbsp;на&nbsp;стыке&nbsp;поверхностей.<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;3:&nbsp;Вычисление&nbsp;плоскости&nbsp;для&nbsp;региона<br>
<br>
**Вход:**&nbsp;`list[coord]`&nbsp;—&nbsp;координаты&nbsp;вокселей&nbsp;группы,&nbsp;`avg_normal`<br>
<br>
**Алгоритм:**<br>
1.&nbsp;Переводим&nbsp;coord&nbsp;в&nbsp;мировые&nbsp;координаты&nbsp;центров&nbsp;вокселей<br>
2.&nbsp;Вычисляем&nbsp;центроид&nbsp;(среднее)<br>
3.&nbsp;Плоскость:&nbsp;точка&nbsp;=&nbsp;центроид,&nbsp;нормаль&nbsp;=&nbsp;avg_normal<br>
<br>
**Выход:**&nbsp;`(plane_point,&nbsp;plane_normal)`&nbsp;—&nbsp;плоскость&nbsp;региона<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;4:&nbsp;Проекция&nbsp;на&nbsp;плоскость&nbsp;(с&nbsp;опциональной&nbsp;сшивкой)<br>
<br>
**Вход:**&nbsp;центры&nbsp;вокселей&nbsp;(3D),&nbsp;плоскость&nbsp;региона,&nbsp;информация&nbsp;о&nbsp;принадлежности&nbsp;вокселей&nbsp;регионам<br>
<br>
**Алгоритм&nbsp;без&nbsp;сшивки:**<br>
```<br>
projected&nbsp;=&nbsp;point&nbsp;-&nbsp;dot(point&nbsp;-&nbsp;plane_point,&nbsp;normal)&nbsp;*&nbsp;normal<br>
```<br>
<br>
**Алгоритм&nbsp;со&nbsp;сшивкой&nbsp;(stitch_polygons=True):**<br>
-&nbsp;Воксель&nbsp;в&nbsp;1&nbsp;регионе:&nbsp;обычная&nbsp;проекция&nbsp;на&nbsp;плоскость<br>
-&nbsp;Воксель&nbsp;в&nbsp;2&nbsp;регионах:&nbsp;проекция&nbsp;на&nbsp;линию&nbsp;пересечения&nbsp;двух&nbsp;плоскостей<br>
-&nbsp;Воксель&nbsp;в&nbsp;3+&nbsp;регионах:&nbsp;проекция&nbsp;в&nbsp;точку&nbsp;пересечения&nbsp;трёх&nbsp;плоскостей<br>
<br>
**Математика&nbsp;сшивки:**<br>
-&nbsp;Линия&nbsp;пересечения&nbsp;двух&nbsp;плоскостей:&nbsp;направление&nbsp;`d&nbsp;=&nbsp;n1&nbsp;×&nbsp;n2`,&nbsp;точка&nbsp;через&nbsp;least&nbsp;squares<br>
-&nbsp;Точка&nbsp;пересечения&nbsp;трёх&nbsp;плоскостей:&nbsp;решение&nbsp;системы&nbsp;`[n1;&nbsp;n2;&nbsp;n3]&nbsp;*&nbsp;x&nbsp;=&nbsp;[d1;&nbsp;d2;&nbsp;d3]`<br>
<br>
**Выход:**&nbsp;list&nbsp;of&nbsp;3D&nbsp;точек&nbsp;(на&nbsp;плоскости&nbsp;или&nbsp;на&nbsp;пересечениях)<br>
<br>
**Эффект:**&nbsp;Вершины&nbsp;на&nbsp;границах&nbsp;регионов&nbsp;совпадают&nbsp;геометрически,&nbsp;что&nbsp;даёт&nbsp;ровные&nbsp;стыки.<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;5:&nbsp;Перевод&nbsp;в&nbsp;2D<br>
<br>
**Вход:**&nbsp;3D&nbsp;точки&nbsp;на&nbsp;плоскости,&nbsp;normal<br>
<br>
**Алгоритм:**<br>
1.&nbsp;Строим&nbsp;ортонормированный&nbsp;базис&nbsp;(u,&nbsp;v)&nbsp;перпендикулярный&nbsp;normal<br>
2.&nbsp;Проецируем&nbsp;точки&nbsp;на&nbsp;этот&nbsp;базис<br>
<br>
**Выход:**&nbsp;list&nbsp;of&nbsp;2D&nbsp;точек&nbsp;`(u,&nbsp;v)`,&nbsp;базис&nbsp;`(centroid,&nbsp;u,&nbsp;v)`&nbsp;для&nbsp;обратного&nbsp;преобразования<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;6:&nbsp;Alpha&nbsp;Shape&nbsp;(Delaunay&nbsp;+&nbsp;фильтрация)<br>
<br>
**Вход:**&nbsp;list&nbsp;of&nbsp;2D&nbsp;точек,&nbsp;alpha&nbsp;=&nbsp;cell_size&nbsp;*&nbsp;1.5<br>
<br>
**Алгоритм:**<br>
1.&nbsp;Delaunay&nbsp;триангуляция&nbsp;(scipy.spatial.Delaunay)<br>
2.&nbsp;Для&nbsp;каждого&nbsp;треугольника&nbsp;вычисляем&nbsp;circumradius:&nbsp;`R&nbsp;=&nbsp;(a&nbsp;*&nbsp;b&nbsp;*&nbsp;c)&nbsp;/&nbsp;(4&nbsp;*&nbsp;area)`<br>
3.&nbsp;Оставляем&nbsp;треугольники&nbsp;где&nbsp;`circumradius&nbsp;&lt;=&nbsp;alpha`<br>
<br>
**Выход:**&nbsp;треугольники&nbsp;(индексы&nbsp;вершин)<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;7:&nbsp;Обратно&nbsp;в&nbsp;3D<br>
<br>
**Вход:**&nbsp;2D&nbsp;точки,&nbsp;треугольники,&nbsp;базис&nbsp;`(centroid,&nbsp;u,&nbsp;v)`<br>
<br>
**Алгоритм:**<br>
```<br>
vertex_3d&nbsp;=&nbsp;centroid&nbsp;+&nbsp;u_coord&nbsp;*&nbsp;basis_u&nbsp;+&nbsp;v_coord&nbsp;*&nbsp;basis_v<br>
```<br>
<br>
**Выход:**&nbsp;NavPolygon&nbsp;с&nbsp;vertices&nbsp;(3D),&nbsp;triangles,&nbsp;normal<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;8:&nbsp;Извлечение&nbsp;контуров&nbsp;(опционально)<br>
<br>
**Вход:**&nbsp;треугольники&nbsp;(индексы&nbsp;вершин),&nbsp;2D&nbsp;точки<br>
<br>
**Алгоритм:**<br>
1.&nbsp;Собираем&nbsp;все&nbsp;рёбра&nbsp;из&nbsp;треугольников<br>
2.&nbsp;Boundary&nbsp;=&nbsp;рёбра,&nbsp;встречающиеся&nbsp;ровно&nbsp;1&nbsp;раз<br>
3.&nbsp;Строим&nbsp;граф&nbsp;смежности&nbsp;из&nbsp;boundary&nbsp;edges<br>
4.&nbsp;Обходим&nbsp;граф,&nbsp;собирая&nbsp;замкнутые&nbsp;цепочки<br>
5.&nbsp;Определяем&nbsp;внешний&nbsp;контур&nbsp;(содержит&nbsp;точку&nbsp;с&nbsp;min&nbsp;X)&nbsp;и&nbsp;дыры<br>
6.&nbsp;Нормализуем&nbsp;ориентацию:&nbsp;внешний&nbsp;→&nbsp;CCW,&nbsp;дыры&nbsp;→&nbsp;CW<br>
<br>
**Выход:**&nbsp;outer_contour&nbsp;(CCW),&nbsp;holes&nbsp;(CW)<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;9:&nbsp;Douglas-Peucker&nbsp;упрощение&nbsp;(опционально)<br>
<br>
**Вход:**&nbsp;контур&nbsp;(список&nbsp;индексов&nbsp;вершин),&nbsp;epsilon<br>
<br>
**Алгоритм:**<br>
1.&nbsp;Разбиваем&nbsp;замкнутый&nbsp;контур&nbsp;в&nbsp;точке&nbsp;максимально&nbsp;удалённой&nbsp;от&nbsp;начала<br>
2.&nbsp;Рекурсивно&nbsp;находим&nbsp;точку&nbsp;максимально&nbsp;удалённую&nbsp;от&nbsp;прямой&nbsp;между&nbsp;концами<br>
3.&nbsp;Если&nbsp;расстояние&nbsp;&lt;&nbsp;epsilon&nbsp;—&nbsp;удаляем&nbsp;все&nbsp;промежуточные&nbsp;точки<br>
4.&nbsp;Иначе&nbsp;—&nbsp;разбиваем&nbsp;на&nbsp;две&nbsp;части&nbsp;и&nbsp;повторяем<br>
<br>
**Выход:**&nbsp;упрощённый&nbsp;контур&nbsp;(подмножество&nbsp;исходных&nbsp;индексов)<br>
<br>
Применяем&nbsp;к&nbsp;внешнему&nbsp;контуру&nbsp;и&nbsp;каждой&nbsp;дыре&nbsp;отдельно.<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;10:&nbsp;Ear&nbsp;Clipping&nbsp;триангуляция<br>
<br>
**Вход:**&nbsp;упрощённый&nbsp;контур&nbsp;(CCW)<br>
<br>
**Алгоритм:**<br>
1.&nbsp;Проверяем&nbsp;ориентацию&nbsp;контура&nbsp;(должна&nbsp;быть&nbsp;CCW)<br>
2.&nbsp;Находим&nbsp;&quot;ухо&quot;&nbsp;—&nbsp;вершину,&nbsp;где:<br>
&nbsp;&nbsp;&nbsp;-&nbsp;Угол&nbsp;выпуклый&nbsp;(не&nbsp;reflex)<br>
&nbsp;&nbsp;&nbsp;-&nbsp;Внутри&nbsp;треугольника&nbsp;с&nbsp;соседями&nbsp;нет&nbsp;других&nbsp;вершин<br>
3.&nbsp;Отрезаем&nbsp;ухо&nbsp;—&nbsp;добавляем&nbsp;треугольник,&nbsp;удаляем&nbsp;вершину<br>
4.&nbsp;Повторяем&nbsp;пока&nbsp;не&nbsp;останется&nbsp;3&nbsp;вершины<br>
<br>
**Выход:**&nbsp;N-2&nbsp;треугольников&nbsp;для&nbsp;контура&nbsp;из&nbsp;N&nbsp;вершин&nbsp;(минимально&nbsp;возможное&nbsp;число)<br>
<br>
**Примечание:**&nbsp;Алгоритм&nbsp;работает&nbsp;с&nbsp;любыми&nbsp;простыми&nbsp;полигонами&nbsp;(выпуклыми&nbsp;и&nbsp;невыпуклыми)<br>
<br>
---<br>
<br>
##&nbsp;Шаг&nbsp;11:&nbsp;Объединение&nbsp;регионов<br>
<br>
**Вход:**&nbsp;список&nbsp;NavPolygon&nbsp;от&nbsp;всех&nbsp;регионов<br>
<br>
**Алгоритм:**&nbsp;Конкатенация&nbsp;вершин&nbsp;и&nbsp;треугольников&nbsp;(без&nbsp;геометрической&nbsp;сшивки)<br>
<br>
**Выход:**&nbsp;NavMesh<br>
<br>
**Примечание:**&nbsp;Граф&nbsp;связности&nbsp;регионов&nbsp;строится&nbsp;отдельно&nbsp;на&nbsp;основе&nbsp;общих&nbsp;вокселей.&nbsp;Геометрическая&nbsp;сшивка&nbsp;не&nbsp;требуется&nbsp;для&nbsp;pathfinding.<br>
<br>
---<br>
<br>
##&nbsp;TODO<br>
<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;1:&nbsp;Сбор&nbsp;поверхностных&nbsp;вокселей&nbsp;(список&nbsp;нормалей&nbsp;на&nbsp;воксель)<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;2:&nbsp;Region&nbsp;Growing<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;2.5:&nbsp;Расширение&nbsp;регионов&nbsp;(Region&nbsp;Expansion)<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;3-4:&nbsp;Плоскость&nbsp;+&nbsp;проекция&nbsp;с&nbsp;сшивкой<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;5-7:&nbsp;2D&nbsp;→&nbsp;Alpha&nbsp;Shape&nbsp;→&nbsp;3D<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;8:&nbsp;Извлечение&nbsp;контуров<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;9:&nbsp;Douglas-Peucker<br>
-&nbsp;[x]&nbsp;Шаг&nbsp;10:&nbsp;Ear&nbsp;Clipping<br>
-&nbsp;[&nbsp;]&nbsp;Граф&nbsp;связности&nbsp;регионов<br>
-&nbsp;[&nbsp;]&nbsp;Перенос&nbsp;Delaunay&nbsp;на&nbsp;C++<br>
<!-- END SCAT CODE -->
</body>
</html>
