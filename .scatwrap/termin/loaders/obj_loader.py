<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/loaders/obj_loader.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;termin/loaders/obj_loader.py<br>
&quot;&quot;&quot;Pure&nbsp;Python&nbsp;OBJ&nbsp;loader.&nbsp;No&nbsp;external&nbsp;dependencies.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;pathlib&nbsp;import&nbsp;Path<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.loaders.mesh_spec&nbsp;import&nbsp;MeshSpec<br>
<br>
<br>
class&nbsp;OBJMeshData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name,&nbsp;vertices,&nbsp;normals,&nbsp;uvs,&nbsp;indices):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.vertices&nbsp;=&nbsp;vertices&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(N,&nbsp;3)&nbsp;float32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.normals&nbsp;=&nbsp;normals&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(N,&nbsp;3)&nbsp;float32&nbsp;or&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.uvs&nbsp;=&nbsp;uvs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(N,&nbsp;2)&nbsp;float32&nbsp;or&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.indices&nbsp;=&nbsp;indices&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(M,)&nbsp;uint32<br>
<br>
<br>
class&nbsp;OBJSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.meshes&nbsp;=&nbsp;[]<br>
<br>
<br>
def&nbsp;load_obj_file(path,&nbsp;spec:&nbsp;&quot;MeshSpec&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;OBJSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Load&nbsp;OBJ&nbsp;file.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;Path(path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;open(path,&nbsp;&quot;r&quot;,&nbsp;encoding=&quot;utf-8&quot;,&nbsp;errors=&quot;ignore&quot;)&nbsp;as&nbsp;f:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text&nbsp;=&nbsp;f.read()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;parse_obj_text(text,&nbsp;name=path.stem,&nbsp;spec=spec)<br>
<br>
<br>
def&nbsp;parse_obj_text(text:&nbsp;str,&nbsp;name:&nbsp;str&nbsp;=&nbsp;&quot;mesh&quot;,&nbsp;spec:&nbsp;&quot;MeshSpec&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;OBJSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;OBJ&nbsp;from&nbsp;text&nbsp;content.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;OBJSceneData()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Raw&nbsp;data&nbsp;from&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;positions&nbsp;=&nbsp;[]&nbsp;&nbsp;#&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;tex_coords&nbsp;=&nbsp;[]&nbsp;&nbsp;#&nbsp;vt<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals_raw&nbsp;=&nbsp;[]&nbsp;&nbsp;#&nbsp;vn<br>
&nbsp;&nbsp;&nbsp;&nbsp;faces&nbsp;=&nbsp;[]&nbsp;&nbsp;#&nbsp;f<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;line&nbsp;in&nbsp;text.splitlines():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;=&nbsp;line.strip()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;line&nbsp;or&nbsp;line.startswith(&quot;#&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parts&nbsp;=&nbsp;line.split()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;parts:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd&nbsp;=&nbsp;parts[0]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cmd&nbsp;==&nbsp;&quot;v&quot;&nbsp;and&nbsp;len(parts)&nbsp;&gt;=&nbsp;4:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;positions.append((float(parts[1]),&nbsp;float(parts[2]),&nbsp;float(parts[3])))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;cmd&nbsp;==&nbsp;&quot;vt&quot;&nbsp;and&nbsp;len(parts)&nbsp;&gt;=&nbsp;3:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_coords.append((float(parts[1]),&nbsp;float(parts[2])))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;cmd&nbsp;==&nbsp;&quot;vn&quot;&nbsp;and&nbsp;len(parts)&nbsp;&gt;=&nbsp;4:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals_raw.append((float(parts[1]),&nbsp;float(parts[2]),&nbsp;float(parts[3])))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;cmd&nbsp;==&nbsp;&quot;f&quot;&nbsp;and&nbsp;len(parts)&nbsp;&gt;=&nbsp;4:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;face&nbsp;vertices&nbsp;(can&nbsp;be&nbsp;triangles&nbsp;or&nbsp;quads)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;face_verts&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;vert&nbsp;in&nbsp;parts[1:]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Format:&nbsp;v,&nbsp;v/vt,&nbsp;v/vt/vn,&nbsp;v//vn<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices_str&nbsp;=&nbsp;vert.split(&quot;/&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v_idx&nbsp;=&nbsp;int(indices_str[0])&nbsp;-&nbsp;1&nbsp;&nbsp;#&nbsp;OBJ&nbsp;is&nbsp;1-indexed<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt_idx&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(indices_str)&nbsp;&gt;&nbsp;1&nbsp;and&nbsp;indices_str[1]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt_idx&nbsp;=&nbsp;int(indices_str[1])&nbsp;-&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vn_idx&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(indices_str)&nbsp;&gt;&nbsp;2&nbsp;and&nbsp;indices_str[2]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vn_idx&nbsp;=&nbsp;int(indices_str[2])&nbsp;-&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;face_verts.append((v_idx,&nbsp;vt_idx,&nbsp;vn_idx))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Triangulate&nbsp;(fan&nbsp;triangulation&nbsp;for&nbsp;convex&nbsp;polygons)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(1,&nbsp;len(face_verts)&nbsp;-&nbsp;1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;faces.append(face_verts[0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;faces.append(face_verts[i])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;faces.append(face_verts[i&nbsp;+&nbsp;1])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;positions:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.meshes.append(OBJMeshData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=np.array([],&nbsp;dtype=np.float32).reshape(0,&nbsp;3),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals=None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs=None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices=np.array([],&nbsp;dtype=np.uint32),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene_data<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;final&nbsp;vertex&nbsp;arrays&nbsp;(expand&nbsp;indexed&nbsp;data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;out_vertices&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;out_normals&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;out_uvs&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_normals&nbsp;=&nbsp;bool(normals_raw)<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_uvs&nbsp;=&nbsp;bool(tex_coords)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;v_idx,&nbsp;vt_idx,&nbsp;vn_idx&nbsp;in&nbsp;faces:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_vertices.append(positions[v_idx])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_normals&nbsp;and&nbsp;vn_idx&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_normals.append(normals_raw[vn_idx])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_uvs&nbsp;and&nbsp;vt_idx&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_uvs.append(tex_coords[vt_idx])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices_np&nbsp;=&nbsp;np.array(out_vertices,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals_np&nbsp;=&nbsp;np.array(out_normals,&nbsp;dtype=np.float32)&nbsp;if&nbsp;out_normals&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;uvs_np&nbsp;=&nbsp;np.array(out_uvs,&nbsp;dtype=np.float32)&nbsp;if&nbsp;out_uvs&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;indices_np&nbsp;=&nbsp;np.arange(len(out_vertices),&nbsp;dtype=np.uint32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;OBJMeshData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=vertices_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals=normals_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs=uvs_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices=indices_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Apply&nbsp;spec&nbsp;transformations<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;spec&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.vertices&nbsp;=&nbsp;spec.apply_to_vertices(mesh.vertices)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.normals&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.normals&nbsp;=&nbsp;spec.apply_to_normals(mesh.normals)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.uvs&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.uvs&nbsp;=&nbsp;spec.apply_to_uvs(mesh.uvs)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data.meshes.append(mesh)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene_data<br>
<!-- END SCAT CODE -->
</body>
</html>
