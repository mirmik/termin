<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/loaders/fbx_extractor.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;FBX&nbsp;extractor&nbsp;-&nbsp;extracts&nbsp;meshes&nbsp;and&nbsp;textures&nbsp;from&nbsp;FBX&nbsp;files.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;pathlib&nbsp;import&nbsp;Path<br>
from&nbsp;typing&nbsp;import&nbsp;List,&nbsp;Tuple<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin._native&nbsp;import&nbsp;log<br>
from&nbsp;termin.loaders.fbx_loader&nbsp;import&nbsp;load_fbx_file,&nbsp;FBXMeshData<br>
<br>
<br>
def&nbsp;save_mesh_as_obj(mesh:&nbsp;FBXMeshData,&nbsp;output_path:&nbsp;Path)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Save&nbsp;mesh&nbsp;data&nbsp;as&nbsp;OBJ&nbsp;file.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh:&nbsp;FBXMeshData&nbsp;with&nbsp;vertices,&nbsp;normals,&nbsp;uvs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_path:&nbsp;Path&nbsp;to&nbsp;save&nbsp;the&nbsp;.obj&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;#&nbsp;Extracted&nbsp;from&nbsp;FBX:&nbsp;{mesh.name}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;#&nbsp;Vertices:&nbsp;{len(mesh.vertices)}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines.append(&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Vertices&nbsp;are&nbsp;already&nbsp;expanded&nbsp;(one&nbsp;per&nbsp;face&nbsp;corner)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;OBJ&nbsp;format:&nbsp;v&nbsp;x&nbsp;y&nbsp;z<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;v&nbsp;in&nbsp;mesh.vertices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;v&nbsp;{v[0]:.6f}&nbsp;{v[1]:.6f}&nbsp;{v[2]:.6f}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines.append(&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Texture&nbsp;coordinates:&nbsp;vt&nbsp;u&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.uvs&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;len(mesh.uvs)&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;uv&nbsp;in&nbsp;mesh.uvs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;vt&nbsp;{uv[0]:.6f}&nbsp;{uv[1]:.6f}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Normals:&nbsp;vn&nbsp;x&nbsp;y&nbsp;z<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.normals&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;len(mesh.normals)&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;n&nbsp;in&nbsp;mesh.normals:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;vn&nbsp;{n[0]:.6f}&nbsp;{n[1]:.6f}&nbsp;{n[2]:.6f}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Faces&nbsp;-&nbsp;vertices&nbsp;are&nbsp;already&nbsp;triangulated&nbsp;and&nbsp;expanded<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;So&nbsp;indices&nbsp;are&nbsp;simply&nbsp;sequential:&nbsp;0,1,2,&nbsp;3,4,5,&nbsp;etc.<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_triangles&nbsp;=&nbsp;len(mesh.vertices)&nbsp;//&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_uvs&nbsp;=&nbsp;mesh.uvs&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;len(mesh.uvs)&nbsp;&gt;&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_normals&nbsp;=&nbsp;mesh.normals&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;len(mesh.normals)&nbsp;&gt;&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(num_triangles):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;=&nbsp;i&nbsp;*&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;OBJ&nbsp;indices&nbsp;are&nbsp;1-based<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i1,&nbsp;i2,&nbsp;i3&nbsp;=&nbsp;base&nbsp;+&nbsp;1,&nbsp;base&nbsp;+&nbsp;2,&nbsp;base&nbsp;+&nbsp;3<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_uvs&nbsp;and&nbsp;has_normals:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;f&nbsp;{i1}/{i1}/{i1}&nbsp;{i2}/{i2}/{i2}&nbsp;{i3}/{i3}/{i3}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;has_uvs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;f&nbsp;{i1}/{i1}&nbsp;{i2}/{i2}&nbsp;{i3}/{i3}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;has_normals:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;f&nbsp;{i1}//{i1}&nbsp;{i2}//{i2}&nbsp;{i3}//{i3}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;f&nbsp;{i1}&nbsp;{i2}&nbsp;{i3}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;output_path.write_text(&quot;\n&quot;.join(lines),&nbsp;encoding=&quot;utf-8&quot;)<br>
<br>
<br>
def&nbsp;extract_fbx(fbx_path:&nbsp;Path,&nbsp;output_dir:&nbsp;Path&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;Tuple[Path,&nbsp;List[Path]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Extract&nbsp;meshes&nbsp;and&nbsp;textures&nbsp;from&nbsp;FBX&nbsp;file&nbsp;into&nbsp;a&nbsp;directory.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbx_path:&nbsp;Path&nbsp;to&nbsp;the&nbsp;FBX&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir:&nbsp;Directory&nbsp;to&nbsp;extract&nbsp;to.&nbsp;If&nbsp;None,&nbsp;creates&nbsp;directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next&nbsp;to&nbsp;FBX&nbsp;with&nbsp;same&nbsp;name.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tuple&nbsp;of&nbsp;(output_directory,&nbsp;list_of_created_files)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbx_path&nbsp;=&nbsp;Path(fbx_path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;output_dir&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir&nbsp;=&nbsp;fbx_path.parent&nbsp;/&nbsp;fbx_path.stem<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;output_dir.mkdir(parents=True,&nbsp;exist_ok=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Load&nbsp;FBX<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;load_fbx_file(str(fbx_path))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;created_files&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Extract&nbsp;meshes<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;mesh&nbsp;in&nbsp;scene_data.meshes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Sanitize&nbsp;mesh&nbsp;name&nbsp;for&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_name&nbsp;=&nbsp;&quot;&quot;.join(c&nbsp;if&nbsp;c.isalnum()&nbsp;or&nbsp;c&nbsp;in&nbsp;&quot;-_&quot;&nbsp;else&nbsp;&quot;_&quot;&nbsp;for&nbsp;c&nbsp;in&nbsp;mesh.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;safe_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_name&nbsp;=&nbsp;f&quot;mesh_{len(created_files)}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj_path&nbsp;=&nbsp;output_dir&nbsp;/&nbsp;f&quot;{safe_name}.obj&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_mesh_as_obj(mesh,&nbsp;obj_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;created_files.append(obj_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[FBX&nbsp;Extract]&nbsp;Saved&nbsp;mesh:&nbsp;{obj_path.name}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Extract&nbsp;embedded&nbsp;textures<br>
&nbsp;&nbsp;&nbsp;&nbsp;textures_dir&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;tex&nbsp;in&nbsp;scene_data.textures:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;tex.content&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue&nbsp;&nbsp;#&nbsp;External&nbsp;texture,&nbsp;skip<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;textures&nbsp;subdirectory&nbsp;on&nbsp;first&nbsp;embedded&nbsp;texture<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;textures_dir&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textures_dir&nbsp;=&nbsp;output_dir&nbsp;/&nbsp;&quot;textures&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textures_dir.mkdir(exist_ok=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Determine&nbsp;filename&nbsp;from&nbsp;original&nbsp;path&nbsp;or&nbsp;texture&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;tex.filename:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_filename&nbsp;=&nbsp;Path(tex.filename).name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_filename&nbsp;=&nbsp;tex.name&nbsp;if&nbsp;tex.name&nbsp;else&nbsp;f&quot;texture_{len(created_files)}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Add&nbsp;extension&nbsp;based&nbsp;on&nbsp;content&nbsp;signature<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;tex.content[:4]&nbsp;==&nbsp;b'\x89PNG':<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_filename&nbsp;+=&nbsp;&quot;.png&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;tex.content[:2]&nbsp;==&nbsp;b'\xff\xd8':<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_filename&nbsp;+=&nbsp;&quot;.jpg&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_filename&nbsp;+=&nbsp;&quot;.bin&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Sanitize&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_name&nbsp;=&nbsp;&quot;&quot;.join(c&nbsp;if&nbsp;c.isalnum()&nbsp;or&nbsp;c&nbsp;in&nbsp;&quot;-_.&quot;&nbsp;else&nbsp;&quot;_&quot;&nbsp;for&nbsp;c&nbsp;in&nbsp;tex_filename)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_path&nbsp;=&nbsp;textures_dir&nbsp;/&nbsp;safe_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tex_path.write_bytes(tex.content)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;created_files.append(tex_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[FBX&nbsp;Extract]&nbsp;Saved&nbsp;texture:&nbsp;{tex_path.name}&nbsp;({len(tex.content)}&nbsp;bytes)&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Save&nbsp;material&nbsp;info&nbsp;as&nbsp;reference<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene_data.materials:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mat_info_path&nbsp;=&nbsp;output_dir&nbsp;/&nbsp;&quot;_materials.txt&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;=&nbsp;[&quot;#&nbsp;Materials&nbsp;from&nbsp;FBX&quot;,&nbsp;&quot;&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;mat&nbsp;in&nbsp;scene_data.materials:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;Material:&nbsp;{mat.name}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mat.diffuse_color&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;mat.diffuse_color<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;&nbsp;&nbsp;Diffuse:&nbsp;({c[0]:.3f},&nbsp;{c[1]:.3f},&nbsp;{c[2]:.3f},&nbsp;{c[3]:.3f})&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mat.diffuse_texture:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(f&quot;&nbsp;&nbsp;Texture:&nbsp;{mat.diffuse_texture}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lines.append(&quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mat_info_path.write_text(&quot;\n&quot;.join(lines),&nbsp;encoding=&quot;utf-8&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;created_files.append(mat_info_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[FBX&nbsp;Extract]&nbsp;Saved&nbsp;materials&nbsp;info:&nbsp;{mat_info_path.name}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;embedded_tex_count&nbsp;=&nbsp;sum(1&nbsp;for&nbsp;t&nbsp;in&nbsp;scene_data.textures&nbsp;if&nbsp;t.content&nbsp;is&nbsp;not&nbsp;None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[FBX&nbsp;Extract]&nbsp;Extracted&nbsp;{len(scene_data.meshes)}&nbsp;meshes,&nbsp;{embedded_tex_count}&nbsp;textures&nbsp;to&nbsp;{output_dir}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Extract&nbsp;animations<br>
&nbsp;&nbsp;&nbsp;&nbsp;anim_files&nbsp;=&nbsp;extract_animations(fbx_path,&nbsp;output_dir,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;created_files.extend(anim_files)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;output_dir,&nbsp;created_files<br>
<br>
<br>
def&nbsp;extract_animations(<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbx_path:&nbsp;Path,<br>
&nbsp;&nbsp;&nbsp;&nbsp;output_dir:&nbsp;Path&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data=None,<br>
)&nbsp;-&gt;&nbsp;List[Path]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Extract&nbsp;animations&nbsp;from&nbsp;FBX&nbsp;file&nbsp;into&nbsp;.tanim&nbsp;files.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbx_path:&nbsp;Path&nbsp;to&nbsp;the&nbsp;FBX&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir:&nbsp;Directory&nbsp;to&nbsp;extract&nbsp;to.&nbsp;If&nbsp;None,&nbsp;creates&nbsp;directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next&nbsp;to&nbsp;FBX&nbsp;with&nbsp;same&nbsp;name.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data:&nbsp;Pre-loaded&nbsp;FBXSceneData&nbsp;(optional,&nbsp;avoids&nbsp;reloading)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&nbsp;of&nbsp;created&nbsp;animation&nbsp;files<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.animation.clip&nbsp;import&nbsp;clip_from_fbx<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.animation.clip_io&nbsp;import&nbsp;save_animation_clip<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbx_path&nbsp;=&nbsp;Path(fbx_path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;output_dir&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir&nbsp;=&nbsp;fbx_path.parent&nbsp;/&nbsp;fbx_path.stem<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;output_dir.mkdir(parents=True,&nbsp;exist_ok=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Load&nbsp;FBX&nbsp;if&nbsp;not&nbsp;provided<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene_data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;load_fbx_file(str(fbx_path))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;created_files&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Extract&nbsp;animations<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;fbx_anim&nbsp;in&nbsp;scene_data.animations:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Convert&nbsp;FBX&nbsp;animation&nbsp;to&nbsp;AnimationClip<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clip&nbsp;=&nbsp;clip_from_fbx(fbx_anim)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Sanitize&nbsp;name&nbsp;for&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_name&nbsp;=&nbsp;&quot;&quot;.join(c&nbsp;if&nbsp;c.isalnum()&nbsp;or&nbsp;c&nbsp;in&nbsp;&quot;-_&quot;&nbsp;else&nbsp;&quot;_&quot;&nbsp;for&nbsp;c&nbsp;in&nbsp;clip.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;safe_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_name&nbsp;=&nbsp;f&quot;animation_{len(created_files)}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anim_path&nbsp;=&nbsp;output_dir&nbsp;/&nbsp;f&quot;{safe_name}.tanim&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_animation_clip(clip,&nbsp;anim_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;created_files.append(anim_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[FBX&nbsp;Extract]&nbsp;Saved&nbsp;animation:&nbsp;{anim_path.name}&nbsp;({clip.duration:.2f}s,&nbsp;{len(clip.channels)}&nbsp;channels)&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;created_files:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[FBX&nbsp;Extract]&nbsp;Extracted&nbsp;{len(created_files)}&nbsp;animation(s)&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;created_files<br>
<!-- END SCAT CODE -->
</body>
</html>
