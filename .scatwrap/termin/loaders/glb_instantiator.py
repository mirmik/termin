<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/loaders/glb_instantiator.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;termin/loaders/glb_instantiator.py<br>
&quot;&quot;&quot;GLB&nbsp;instantiator&nbsp;-&nbsp;creates&nbsp;Entity&nbsp;hierarchy&nbsp;from&nbsp;GLBAsset.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;Dict,&nbsp;List,&nbsp;Optional<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.geombase&nbsp;import&nbsp;Pose3<br>
from&nbsp;termin.geombase&nbsp;import&nbsp;GeneralPose3<br>
from&nbsp;termin.skeleton&nbsp;import&nbsp;SkeletonInstance,&nbsp;TcSkeleton<br>
from&nbsp;termin.visualization.core.entity&nbsp;import&nbsp;Entity<br>
from&nbsp;termin.mesh&nbsp;import&nbsp;TcMesh<br>
from&nbsp;termin.visualization.render.components.mesh_renderer&nbsp;import&nbsp;MeshRenderer<br>
from&nbsp;termin.visualization.render.components.skinned_mesh_renderer&nbsp;import&nbsp;SkinnedMeshRenderer<br>
from&nbsp;termin.visualization.render.components.skeleton_controller&nbsp;import&nbsp;SkeletonController<br>
from&nbsp;termin.visualization.animation.player&nbsp;import&nbsp;AnimationPlayer<br>
from&nbsp;termin.visualization.animation.clip&nbsp;import&nbsp;TcAnimationClip<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.assets.mesh_asset&nbsp;import&nbsp;MeshAsset<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.glb_asset&nbsp;import&nbsp;GLBAsset<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.scene&nbsp;import&nbsp;Scene<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.loaders.glb_loader&nbsp;import&nbsp;GLBSceneData,&nbsp;GLBMeshData<br>
<br>
<br>
def&nbsp;_compute_vertex_normals(vertices:&nbsp;np.ndarray,&nbsp;indices:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Compute&nbsp;per-vertex&nbsp;normals&nbsp;from&nbsp;vertices&nbsp;and&nbsp;triangle&nbsp;indices.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;np.zeros_like(vertices,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_tris&nbsp;=&nbsp;len(indices)&nbsp;//&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;t&nbsp;in&nbsp;range(num_tris):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i0,&nbsp;i1,&nbsp;i2&nbsp;=&nbsp;indices[t&nbsp;*&nbsp;3],&nbsp;indices[t&nbsp;*&nbsp;3&nbsp;+&nbsp;1],&nbsp;indices[t&nbsp;*&nbsp;3&nbsp;+&nbsp;2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v0,&nbsp;v1,&nbsp;v2&nbsp;=&nbsp;vertices[i0],&nbsp;vertices[i1],&nbsp;vertices[i2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e1&nbsp;=&nbsp;v1&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e2&nbsp;=&nbsp;v2&nbsp;-&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;face_normal&nbsp;=&nbsp;np.cross(e1,&nbsp;e2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals[i0]&nbsp;+=&nbsp;face_normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals[i1]&nbsp;+=&nbsp;face_normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals[i2]&nbsp;+=&nbsp;face_normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Normalize<br>
&nbsp;&nbsp;&nbsp;&nbsp;lengths&nbsp;=&nbsp;np.linalg.norm(normals,&nbsp;axis=1,&nbsp;keepdims=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;lengths&nbsp;=&nbsp;np.where(lengths&nbsp;&lt;&nbsp;1e-8,&nbsp;1.0,&nbsp;lengths)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;normals&nbsp;/&nbsp;lengths<br>
<br>
<br>
def&nbsp;_glb_mesh_to_tc_mesh(glb_mesh:&nbsp;&quot;GLBMeshData&quot;,&nbsp;uuid:&nbsp;str&nbsp;=&nbsp;&quot;&quot;)&nbsp;-&gt;&nbsp;&quot;TcMesh&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Convert&nbsp;GLBMeshData&nbsp;to&nbsp;TcMesh&nbsp;directly&nbsp;(no&nbsp;intermediate&nbsp;Mesh3).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glb_mesh:&nbsp;Mesh&nbsp;data&nbsp;from&nbsp;GLB&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uuid:&nbsp;Optional&nbsp;UUID&nbsp;to&nbsp;use&nbsp;for&nbsp;TcMesh&nbsp;(if&nbsp;empty,&nbsp;generates&nbsp;new)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.mesh._mesh_native&nbsp;import&nbsp;TcMesh,&nbsp;TcVertexLayout<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;glb_mesh.vertices.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;indices&nbsp;=&nbsp;glb_mesh.indices.astype(np.uint32).ravel()<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_verts&nbsp;=&nbsp;len(vertices)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Compute&nbsp;normals&nbsp;if&nbsp;not&nbsp;provided<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;glb_mesh.normals&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;glb_mesh.normals.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;_compute_vertex_normals(vertices,&nbsp;indices)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;UVs&nbsp;(default&nbsp;to&nbsp;zeros)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;glb_mesh.uvs&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;glb_mesh.uvs.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;2),&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Tangents&nbsp;(optional,&nbsp;vec4&nbsp;with&nbsp;w&nbsp;=&nbsp;handedness)<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_tangents&nbsp;=&nbsp;glb_mesh.tangents&nbsp;is&nbsp;not&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_tangents:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangents&nbsp;=&nbsp;glb_mesh.tangents.astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_skinned&nbsp;=&nbsp;glb_mesh.is_skinned<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_skinned:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skinned&nbsp;layout:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;joints(4)&nbsp;+&nbsp;weights(4)&nbsp;=&nbsp;16&nbsp;floats&nbsp;=&nbsp;64&nbsp;bytes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Note:&nbsp;skinned&nbsp;meshes&nbsp;don't&nbsp;include&nbsp;tangents&nbsp;in&nbsp;current&nbsp;layout<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout.skinned()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Joint&nbsp;indices&nbsp;and&nbsp;weights<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_indices&nbsp;=&nbsp;glb_mesh.joint_indices.astype(np.float32)&nbsp;&nbsp;#&nbsp;stored&nbsp;as&nbsp;float&nbsp;for&nbsp;GPU<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_weights&nbsp;=&nbsp;glb_mesh.joint_weights.astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;interleaved&nbsp;buffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;16),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;0:3]&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;3:6]&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;6:8]&nbsp;=&nbsp;uvs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;8:12]&nbsp;=&nbsp;joint_indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;12:16]&nbsp;=&nbsp;joint_weights<br>
&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;has_tangents:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Layout&nbsp;with&nbsp;tangents:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;tangent(4)&nbsp;=&nbsp;12&nbsp;floats&nbsp;=&nbsp;48&nbsp;bytes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout.pos_normal_uv_tangent()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;interleaved&nbsp;buffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;12),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;0:3]&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;3:6]&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;6:8]&nbsp;=&nbsp;uvs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;8:12]&nbsp;=&nbsp;tangents<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Standard&nbsp;layout:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;=&nbsp;8&nbsp;floats&nbsp;=&nbsp;32&nbsp;bytes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout.pos_normal_uv()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;interleaved&nbsp;buffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;8),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;0:3]&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;3:6]&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;6:8]&nbsp;=&nbsp;uvs<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Flatten&nbsp;buffer&nbsp;for&nbsp;TcMesh<br>
&nbsp;&nbsp;&nbsp;&nbsp;buffer_flat&nbsp;=&nbsp;buffer.ravel().astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TcMesh.from_interleaved(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_flat,&nbsp;num_verts,&nbsp;indices,&nbsp;layout,&nbsp;glb_mesh.name,&nbsp;uuid<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
def&nbsp;_populate_tc_mesh_from_glb(tc_mesh:&nbsp;TcMesh,&nbsp;glb_mesh:&nbsp;&quot;GLBMeshData&quot;)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Populate&nbsp;an&nbsp;existing&nbsp;declared&nbsp;TcMesh&nbsp;with&nbsp;data&nbsp;from&nbsp;GLBMeshData.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;True&nbsp;if&nbsp;successful,&nbsp;False&nbsp;otherwise.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.mesh._mesh_native&nbsp;import&nbsp;TcVertexLayout,&nbsp;tc_mesh_set_data<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;glb_mesh.vertices.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;indices&nbsp;=&nbsp;glb_mesh.indices.astype(np.uint32).ravel()<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_verts&nbsp;=&nbsp;len(vertices)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Compute&nbsp;normals&nbsp;if&nbsp;not&nbsp;provided<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;glb_mesh.normals&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;glb_mesh.normals.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;_compute_vertex_normals(vertices,&nbsp;indices)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;UVs&nbsp;(default&nbsp;to&nbsp;zeros)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;glb_mesh.uvs&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;glb_mesh.uvs.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;2),&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Tangents&nbsp;(optional,&nbsp;vec4&nbsp;with&nbsp;w&nbsp;=&nbsp;handedness)<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_tangents&nbsp;=&nbsp;glb_mesh.tangents&nbsp;is&nbsp;not&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_tangents:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangents&nbsp;=&nbsp;glb_mesh.tangents.astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_skinned&nbsp;=&nbsp;glb_mesh.is_skinned<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_skinned:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skinned&nbsp;layout:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;joints(4)&nbsp;+&nbsp;weights(4)&nbsp;=&nbsp;16&nbsp;floats<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Note:&nbsp;skinned&nbsp;meshes&nbsp;don't&nbsp;include&nbsp;tangents&nbsp;in&nbsp;current&nbsp;layout<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout.skinned()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_indices&nbsp;=&nbsp;glb_mesh.joint_indices.astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_weights&nbsp;=&nbsp;glb_mesh.joint_weights.astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;16),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;0:3]&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;3:6]&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;6:8]&nbsp;=&nbsp;uvs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;8:12]&nbsp;=&nbsp;joint_indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;12:16]&nbsp;=&nbsp;joint_weights<br>
&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;has_tangents:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Layout&nbsp;with&nbsp;tangents:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;tangent(4)&nbsp;=&nbsp;12&nbsp;floats<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout.pos_normal_uv_tangent()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;12),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;0:3]&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;3:6]&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;6:8]&nbsp;=&nbsp;uvs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;8:12]&nbsp;=&nbsp;tangents<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Standard&nbsp;layout:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;=&nbsp;8&nbsp;floats<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout.pos_normal_uv()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;8),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;0:3]&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;3:6]&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer[:,&nbsp;6:8]&nbsp;=&nbsp;uvs<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;buffer_flat&nbsp;=&nbsp;buffer.ravel().astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tc_mesh_set_data(tc_mesh,&nbsp;buffer_flat,&nbsp;num_verts,&nbsp;layout,&nbsp;indices,&nbsp;glb_mesh.name)<br>
<br>
<br>
def&nbsp;_glb_skin_to_tc_skeleton(skin,&nbsp;nodes,&nbsp;uuid:&nbsp;str&nbsp;=&nbsp;&quot;&quot;)&nbsp;-&gt;&nbsp;&quot;TcSkeleton&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Convert&nbsp;GLB&nbsp;skin&nbsp;data&nbsp;to&nbsp;TcSkeleton.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin:&nbsp;GLBSkinData&nbsp;from&nbsp;GLB&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodes:&nbsp;List&nbsp;of&nbsp;GLBNodeData<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uuid:&nbsp;Optional&nbsp;UUID&nbsp;to&nbsp;use&nbsp;(if&nbsp;empty,&nbsp;generates&nbsp;new)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcSkeleton&nbsp;with&nbsp;bone&nbsp;data&nbsp;populated<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.skeleton&nbsp;import&nbsp;TcSkeleton<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_skel&nbsp;=&nbsp;TcSkeleton.get_or_create(uuid)&nbsp;if&nbsp;uuid&nbsp;else&nbsp;TcSkeleton.create()<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;tc_skel.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tc_skel<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_populate_tc_skeleton_from_glb(tc_skel,&nbsp;skin,&nbsp;nodes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tc_skel<br>
<br>
<br>
def&nbsp;_populate_tc_skeleton_from_glb(tc_skel:&nbsp;&quot;TcSkeleton&quot;,&nbsp;skin,&nbsp;nodes)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Populate&nbsp;an&nbsp;existing&nbsp;declared&nbsp;TcSkeleton&nbsp;with&nbsp;data&nbsp;from&nbsp;GLB&nbsp;skin.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tc_skel:&nbsp;TcSkeleton&nbsp;to&nbsp;populate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin:&nbsp;GLBSkinData&nbsp;from&nbsp;GLB&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodes:&nbsp;List&nbsp;of&nbsp;GLBNodeData<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;True&nbsp;if&nbsp;successful,&nbsp;False&nbsp;otherwise<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.skeleton._skeleton_native&nbsp;import&nbsp;TcSkeleton<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;tc_skel.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_skeleton_ptr&nbsp;=&nbsp;tc_skel.get()<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;tc_skeleton_ptr&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;joint_indices&nbsp;=&nbsp;skin.joint_node_indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices&nbsp;=&nbsp;skin.inverse_bind_matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_joints&nbsp;=&nbsp;len(joint_indices)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;num_joints&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Allocate&nbsp;bones<br>
&nbsp;&nbsp;&nbsp;&nbsp;bones&nbsp;=&nbsp;tc_skel.alloc_bones(num_joints)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;bones&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;a&nbsp;mapping&nbsp;from&nbsp;joint&nbsp;bone&nbsp;index&nbsp;-&gt;&nbsp;node&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;joint_to_node&nbsp;=&nbsp;{i:&nbsp;joint_indices[i]&nbsp;for&nbsp;i&nbsp;in&nbsp;range(num_joints)}<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Inverse:&nbsp;node&nbsp;index&nbsp;-&gt;&nbsp;bone&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_to_bone&nbsp;=&nbsp;{node_idx:&nbsp;bone_idx&nbsp;for&nbsp;bone_idx,&nbsp;node_idx&nbsp;in&nbsp;enumerate(joint_indices)}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Populate&nbsp;each&nbsp;bone<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;bone_idx&nbsp;in&nbsp;range(num_joints):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_idx&nbsp;=&nbsp;joint_indices[bone_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;=&nbsp;nodes[node_idx]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;parent&nbsp;bone&nbsp;index&nbsp;by&nbsp;checking&nbsp;which&nbsp;other&nbsp;bone's&nbsp;node&nbsp;has&nbsp;this&nbsp;node&nbsp;as&nbsp;a&nbsp;child<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_bone_idx&nbsp;=&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;other_bone_idx&nbsp;in&nbsp;range(num_joints):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_node_idx&nbsp;=&nbsp;joint_indices[other_bone_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_node&nbsp;=&nbsp;nodes[other_node_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node_idx&nbsp;in&nbsp;other_node.children:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_bone_idx&nbsp;=&nbsp;other_bone_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;tc_bone&nbsp;pointer&nbsp;and&nbsp;populate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone&nbsp;=&nbsp;tc_skel.get_bone(bone_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;bone&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;bone&nbsp;data&nbsp;via&nbsp;C&nbsp;API<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.name&nbsp;=&nbsp;node.name[:63]&nbsp;&nbsp;#&nbsp;TC_BONE_NAME_MAX&nbsp;=&nbsp;64<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.index&nbsp;=&nbsp;bone_idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.parent_index&nbsp;=&nbsp;parent_bone_idx<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Inverse&nbsp;bind&nbsp;matrix&nbsp;(row-major&nbsp;4x4)&nbsp;-&nbsp;must&nbsp;assign&nbsp;entire&nbsp;list&nbsp;at&nbsp;once<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ibm&nbsp;=&nbsp;inverse_bind_matrices[bone_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.inverse_bind_matrix&nbsp;=&nbsp;[float(x)&nbsp;for&nbsp;x&nbsp;in&nbsp;ibm.flat]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Bind&nbsp;pose<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.bind_translation&nbsp;=&nbsp;(float(node.translation[0]),&nbsp;float(node.translation[1]),&nbsp;float(node.translation[2]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.bind_rotation&nbsp;=&nbsp;(float(node.rotation[0]),&nbsp;float(node.rotation[1]),&nbsp;float(node.rotation[2]),&nbsp;float(node.rotation[3]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone.bind_scale&nbsp;=&nbsp;(float(node.scale[0]),&nbsp;float(node.scale[1]),&nbsp;float(node.scale[2]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Rebuild&nbsp;root&nbsp;indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_skel.rebuild_roots()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Mark&nbsp;as&nbsp;loaded<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_skeleton_ptr.is_loaded&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_skel.bump_version()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
<br>
class&nbsp;_PendingSkinnedMesh:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Placeholder&nbsp;for&nbsp;skinned&nbsp;mesh&nbsp;that&nbsp;needs&nbsp;skeleton&nbsp;instance&nbsp;set&nbsp;later.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;entity:&nbsp;Entity,&nbsp;mesh:&nbsp;TcMesh,&nbsp;material):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.entity&nbsp;=&nbsp;entity<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.mesh&nbsp;=&nbsp;mesh<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.material&nbsp;=&nbsp;material<br>
<br>
<br>
def&nbsp;_create_entity_from_node(<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_index:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data:&nbsp;&quot;GLBSceneData&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;meshes:&nbsp;Dict[int,&nbsp;TcMesh],<br>
&nbsp;&nbsp;&nbsp;&nbsp;mesh_assets:&nbsp;Dict[str,&nbsp;&quot;MeshAsset&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;default_material,<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned_material,<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_to_entity:&nbsp;Optional[Dict[int,&nbsp;Entity]]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;pending_skinned:&nbsp;Optional[List[_PendingSkinnedMesh]]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene:&nbsp;Optional[&quot;Scene&quot;]&nbsp;=&nbsp;None,<br>
)&nbsp;-&gt;&nbsp;Entity:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Recursively&nbsp;create&nbsp;Entity&nbsp;hierarchy&nbsp;from&nbsp;GLBNodeData.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.scene&nbsp;import&nbsp;Scene<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;=&nbsp;scene_data.nodes[node_index]<br>
&nbsp;&nbsp;&nbsp;&nbsp;pose&nbsp;=&nbsp;GeneralPose3(lin=node.translation,&nbsp;ang=node.rotation,&nbsp;scale=node.scale)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;entity&nbsp;in&nbsp;scene's&nbsp;pool&nbsp;if&nbsp;scene&nbsp;provided,&nbsp;else&nbsp;standalone<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;=&nbsp;scene.create_entity(node.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity.transform.relocate(pose)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;=&nbsp;Entity(pose=pose,&nbsp;name=node.name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node_to_entity&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_to_entity[node_index]&nbsp;=&nbsp;entity<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Add&nbsp;renderer&nbsp;for&nbsp;each&nbsp;primitive&nbsp;in&nbsp;the&nbsp;referenced&nbsp;mesh<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.mesh_index&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;node.mesh_index&nbsp;in&nbsp;scene_data.mesh_index_map:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;our_mesh_indices&nbsp;=&nbsp;scene_data.mesh_index_map[node.mesh_index]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;mesh_idx&nbsp;in&nbsp;our_mesh_indices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glb_mesh&nbsp;=&nbsp;scene_data.meshes[mesh_idx]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh_idx&nbsp;not&nbsp;in&nbsp;meshes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;tc_mesh&nbsp;from&nbsp;MeshAsset&nbsp;by&nbsp;mesh&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_asset&nbsp;=&nbsp;mesh_assets.get(glb_mesh.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh_asset&nbsp;is&nbsp;None&nbsp;or&nbsp;mesh_asset.data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;MeshAsset&nbsp;for&nbsp;'{glb_mesh.name}'&nbsp;not&nbsp;found&nbsp;or&nbsp;not&nbsp;loaded&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tc_mesh&nbsp;=&nbsp;mesh_asset.data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;tc_mesh.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;TcMesh&nbsp;for&nbsp;'{glb_mesh.name}'&nbsp;is&nbsp;invalid&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meshes[mesh_idx]&nbsp;=&nbsp;tc_mesh<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tc_mesh&nbsp;=&nbsp;meshes[mesh_idx]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;glb_mesh.is_skinned&nbsp;and&nbsp;pending_skinned&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[glb_instantiator]&nbsp;pending&nbsp;skinned&nbsp;mesh={glb_mesh.name}&nbsp;tc_mesh.is_valid={tc_mesh.is_valid}&nbsp;uuid={tc_mesh.uuid}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pending_skinned.append(_PendingSkinnedMesh(entity,&nbsp;tc_mesh,&nbsp;skinned_material))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderer&nbsp;=&nbsp;MeshRenderer(mesh=tc_mesh,&nbsp;material=default_material)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity.add_component(renderer)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Recursively&nbsp;create&nbsp;children<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;child_index&nbsp;in&nbsp;node.children:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_entity&nbsp;=&nbsp;_create_entity_from_node(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_index,&nbsp;scene_data,&nbsp;meshes,&nbsp;mesh_assets,&nbsp;default_material,&nbsp;skinned_material,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_to_entity,&nbsp;pending_skinned,&nbsp;scene<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity.transform.add_child(child_entity.transform)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;entity<br>
<br>
<br>
class&nbsp;GLBInstantiateResult:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Result&nbsp;of&nbsp;GLB&nbsp;instantiation&nbsp;containing&nbsp;entity&nbsp;and&nbsp;resources.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity:&nbsp;Entity,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_controller:&nbsp;Optional[SkeletonController]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;animation_player:&nbsp;Optional[AnimationPlayer]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Debug:&nbsp;keep&nbsp;references&nbsp;to&nbsp;prevent&nbsp;premature&nbsp;destruction<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_bone_entities:&nbsp;Optional[List]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_clips:&nbsp;Optional[List]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.entity&nbsp;=&nbsp;entity<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.skeleton_controller&nbsp;=&nbsp;skeleton_controller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.animation_player&nbsp;=&nbsp;animation_player<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._bone_entities&nbsp;=&nbsp;_bone_entities<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._clips&nbsp;=&nbsp;_clips<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;skeleton_instance(self)&nbsp;-&gt;&nbsp;Optional[SkeletonInstance]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;skeleton&nbsp;instance&nbsp;from&nbsp;controller&nbsp;(for&nbsp;backwards&nbsp;compatibility).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.skeleton_controller&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.skeleton_controller.skeleton_instance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;instantiate_glb(<br>
&nbsp;&nbsp;&nbsp;&nbsp;glb_asset:&nbsp;&quot;GLBAsset&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene:&nbsp;Optional[&quot;Scene&quot;]&nbsp;=&nbsp;None,<br>
)&nbsp;-&gt;&nbsp;GLBInstantiateResult:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;Entity&nbsp;hierarchy&nbsp;from&nbsp;GLBAsset.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glb_asset:&nbsp;GLBAsset&nbsp;to&nbsp;instantiate&nbsp;(will&nbsp;be&nbsp;loaded&nbsp;if&nbsp;not&nbsp;already).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Optional&nbsp;name&nbsp;for&nbsp;the&nbsp;root&nbsp;entity.&nbsp;Defaults&nbsp;to&nbsp;asset&nbsp;name.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene:&nbsp;Optional&nbsp;Scene&nbsp;-&nbsp;if&nbsp;provided,&nbsp;entities&nbsp;are&nbsp;created&nbsp;directly&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene's&nbsp;pool&nbsp;(recommended).&nbsp;Otherwise&nbsp;entities&nbsp;are&nbsp;created&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;standalone&nbsp;pool&nbsp;and&nbsp;migrated&nbsp;when&nbsp;added&nbsp;to&nbsp;scene.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GLBInstantiateResult&nbsp;containing&nbsp;root&nbsp;Entity,&nbsp;SkeletonController,&nbsp;and&nbsp;AnimationPlayer.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.resources&nbsp;import&nbsp;ResourceManager<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.scene&nbsp;import&nbsp;Scene<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Access&nbsp;scene_data&nbsp;triggers&nbsp;lazy&nbsp;loading&nbsp;and&nbsp;populates&nbsp;child&nbsp;assets<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;glb_asset.scene_data<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene_data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;Failed&nbsp;to&nbsp;load&nbsp;GLBAsset&nbsp;'{glb_asset.name}'&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;mesh&nbsp;assets&nbsp;from&nbsp;GLBAsset<br>
&nbsp;&nbsp;&nbsp;&nbsp;mesh_assets&nbsp;=&nbsp;glb_asset.get_mesh_assets()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;name&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;glb_asset.name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;=&nbsp;ResourceManager.instance()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;materials&nbsp;(as&nbsp;assets&nbsp;for&nbsp;proper&nbsp;serialization)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;StandartMaterial&nbsp;for&nbsp;all&nbsp;meshes<br>
&nbsp;&nbsp;&nbsp;&nbsp;default_material_asset&nbsp;=&nbsp;rm.get_material_asset(&quot;StandartMaterial&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned_material_asset&nbsp;=&nbsp;rm.get_material_asset(&quot;StandartMaterial&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;default_material_asset&nbsp;is&nbsp;None&nbsp;or&nbsp;skinned_material_asset&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;[glb_instantiator]&nbsp;Builtin&nbsp;materials&nbsp;not&nbsp;registered:&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;DefaultMaterial={default_material_asset&nbsp;is&nbsp;not&nbsp;None},&nbsp;StandartMaterial={skinned_material_asset&nbsp;is&nbsp;not&nbsp;None}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;meshes:&nbsp;Dict[int,&nbsp;TcMesh]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_to_entity:&nbsp;Dict[int,&nbsp;Entity]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;pending_skinned:&nbsp;List[_PendingSkinnedMesh]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Helper&nbsp;to&nbsp;create&nbsp;entity&nbsp;in&nbsp;scene's&nbsp;pool&nbsp;or&nbsp;standalone<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;create_entity(entity_name:&nbsp;str)&nbsp;-&gt;&nbsp;Entity:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ent&nbsp;=&nbsp;scene.create_entity(entity_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ent.transform.relocate(Pose3.identity())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ent<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Entity(pose=Pose3.identity(),&nbsp;name=entity_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Step&nbsp;1:&nbsp;Create&nbsp;Entity&nbsp;hierarchy<br>
&nbsp;&nbsp;&nbsp;&nbsp;root_entity&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene_data.root_nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(scene_data.root_nodes)&nbsp;==&nbsp;1:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity&nbsp;=&nbsp;_create_entity_from_node(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.root_nodes[0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meshes,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_assets,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default_material_asset,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_material_asset,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_to_entity=node_to_entity,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pending_skinned=pending_skinned,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene=scene,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity&nbsp;=&nbsp;create_entity(name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;root_index&nbsp;in&nbsp;scene_data.root_nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_entity&nbsp;=&nbsp;_create_entity_from_node(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meshes,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_assets,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default_material_asset,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_material_asset,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_to_entity=node_to_entity,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pending_skinned=pending_skinned,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene=scene,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity.transform.add_child(child_entity.transform)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fallback:&nbsp;no&nbsp;node&nbsp;hierarchy,&nbsp;create&nbsp;entities&nbsp;for&nbsp;each&nbsp;mesh&nbsp;directly<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity&nbsp;=&nbsp;create_entity(name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;glb_mesh&nbsp;in&nbsp;enumerate(scene_data.meshes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_asset&nbsp;=&nbsp;mesh_assets.get(glb_mesh.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh_asset&nbsp;is&nbsp;None&nbsp;or&nbsp;mesh_asset.data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;MeshAsset&nbsp;for&nbsp;'{glb_mesh.name}'&nbsp;not&nbsp;found&nbsp;or&nbsp;not&nbsp;loaded&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tc_mesh&nbsp;=&nbsp;mesh_asset.data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;tc_mesh.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;TcMesh&nbsp;for&nbsp;'{glb_mesh.name}'&nbsp;is&nbsp;invalid&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meshes[i]&nbsp;=&nbsp;tc_mesh<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_entity&nbsp;=&nbsp;create_entity(glb_mesh.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderer&nbsp;=&nbsp;MeshRenderer(mesh=tc_mesh,&nbsp;material=default_material_asset)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_entity.add_component(renderer)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity.transform.add_child(mesh_entity.transform)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Step&nbsp;2:&nbsp;Create&nbsp;skeleton&nbsp;controller<br>
&nbsp;&nbsp;&nbsp;&nbsp;skeleton_controller:&nbsp;Optional[SkeletonController]&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;bone_entities:&nbsp;List[Entity]&nbsp;=&nbsp;[]&nbsp;&nbsp;#&nbsp;keep&nbsp;reference&nbsp;for&nbsp;debug<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene_data.skins:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin&nbsp;=&nbsp;scene_data.skins[0]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;skeleton&nbsp;from&nbsp;GLBAsset's&nbsp;child&nbsp;assets<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_assets&nbsp;=&nbsp;glb_asset.get_skeleton_assets()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_key&nbsp;=&nbsp;&quot;skeleton&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_asset&nbsp;=&nbsp;skeleton_assets.get(skeleton_key)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;skeleton_asset&nbsp;is&nbsp;None&nbsp;or&nbsp;skeleton_asset.skeleton_data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;Skeleton&nbsp;not&nbsp;found&nbsp;in&nbsp;GLBAsset&nbsp;'{glb_asset.name}'&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Collect&nbsp;bone&nbsp;entities<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node_idx&nbsp;in&nbsp;skin.joint_node_indices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;=&nbsp;node_to_entity.get(node_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;entity&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;=&nbsp;create_entity(f&quot;missing_bone_{node_idx}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_entities.append(entity)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Pass&nbsp;the&nbsp;TcSkeleton&nbsp;from&nbsp;the&nbsp;asset,&nbsp;not&nbsp;the&nbsp;asset&nbsp;itself<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tc_skeleton&nbsp;=&nbsp;skeleton_asset.data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;tc_skeleton&nbsp;is&nbsp;None&nbsp;or&nbsp;not&nbsp;tc_skeleton.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;RuntimeError(f&quot;[glb_instantiator]&nbsp;TcSkeleton&nbsp;is&nbsp;invalid&nbsp;for&nbsp;skeleton&nbsp;'{skeleton_key}'&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_controller&nbsp;=&nbsp;SkeletonController(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton=tc_skeleton,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_entities=bone_entities,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity.add_component(skeleton_controller)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Step&nbsp;3:&nbsp;Setup&nbsp;SkinnedMeshRenderers<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;pending&nbsp;in&nbsp;pending_skinned:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;skeleton_controller&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(f&quot;[glb_instantiator]&nbsp;creating&nbsp;SkinnedMeshRenderer&nbsp;mesh.is_valid={pending.mesh.is_valid}&nbsp;uuid={pending.mesh.uuid}&nbsp;name={pending.mesh.name}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderer&nbsp;=&nbsp;SkinnedMeshRenderer(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh=pending.mesh,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material=pending.material,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_controller=skeleton_controller,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pending.entity.add_component(renderer)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Step&nbsp;4:&nbsp;Setup&nbsp;animations&nbsp;from&nbsp;GLBAsset's&nbsp;child&nbsp;assets<br>
&nbsp;&nbsp;&nbsp;&nbsp;animation_player:&nbsp;Optional[AnimationPlayer]&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;clips:&nbsp;List[TcAnimationClip]&nbsp;=&nbsp;[]&nbsp;&nbsp;#&nbsp;keep&nbsp;reference&nbsp;for&nbsp;debug<br>
&nbsp;&nbsp;&nbsp;&nbsp;animation_assets&nbsp;=&nbsp;glb_asset.get_animation_assets()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;animation_assets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;animation_player&nbsp;=&nbsp;AnimationPlayer()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;anim_name,&nbsp;anim_asset&nbsp;in&nbsp;animation_assets.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clip&nbsp;=&nbsp;anim_asset.clip<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;clip&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;clip.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clips.append(clip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;animation_player.add_clip(clip)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;clips:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_entity.add_component(animation_player)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;GLBInstantiateResult(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity=root_entity,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skeleton_controller=skeleton_controller,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;animation_player=animation_player,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_bone_entities=bone_entities,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_clips=clips,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<!-- END SCAT CODE -->
</body>
</html>
