<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/loaders/stl_loader.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;termin/loaders/stl_loader.py<br>
&quot;&quot;&quot;Pure&nbsp;Python&nbsp;STL&nbsp;loader&nbsp;(binary&nbsp;and&nbsp;ASCII).&nbsp;No&nbsp;external&nbsp;dependencies.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;struct<br>
from&nbsp;pathlib&nbsp;import&nbsp;Path<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.loaders.mesh_spec&nbsp;import&nbsp;MeshSpec<br>
<br>
<br>
class&nbsp;STLMeshData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name,&nbsp;vertices,&nbsp;normals,&nbsp;indices):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.vertices&nbsp;=&nbsp;vertices&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(N,&nbsp;3)&nbsp;float32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.normals&nbsp;=&nbsp;normals&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(N,&nbsp;3)&nbsp;float32&nbsp;or&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.indices&nbsp;=&nbsp;indices&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;np.ndarray&nbsp;(M,)&nbsp;uint32<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.uvs&nbsp;=&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;STL&nbsp;format&nbsp;has&nbsp;no&nbsp;UV&nbsp;coordinates<br>
<br>
<br>
class&nbsp;STLSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.meshes&nbsp;=&nbsp;[]<br>
<br>
<br>
def&nbsp;load_stl_file(path,&nbsp;spec:&nbsp;&quot;MeshSpec&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;STLSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Load&nbsp;STL&nbsp;file&nbsp;(binary&nbsp;or&nbsp;ASCII),&nbsp;applying&nbsp;spec&nbsp;if&nbsp;provided.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;Path(path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;STLSceneData()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;open(path,&nbsp;&quot;rb&quot;)&nbsp;as&nbsp;f:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_bytes&nbsp;=&nbsp;f.read(80)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.seek(0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ASCII&nbsp;STL&nbsp;starts&nbsp;with&nbsp;&quot;solid&quot;&nbsp;and&nbsp;typically&nbsp;has&nbsp;no&nbsp;nulls&nbsp;in&nbsp;first&nbsp;line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_ascii&nbsp;=&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_bytes.strip().lower().startswith(b&quot;solid&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;b&quot;\x00&quot;&nbsp;not&nbsp;in&nbsp;first_bytes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_ascii:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;_load_ascii_stl(f,&nbsp;path.stem)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fallback&nbsp;to&nbsp;binary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.seek(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;_load_binary_stl(f,&nbsp;path.stem)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;_load_binary_stl(f,&nbsp;path.stem)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Apply&nbsp;spec&nbsp;transformations<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;spec&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.vertices&nbsp;=&nbsp;spec.apply_to_vertices(mesh.vertices)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.normals&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.normals&nbsp;=&nbsp;spec.apply_to_normals(mesh.normals)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data.meshes.append(mesh)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene_data<br>
<br>
<br>
def&nbsp;_load_binary_stl(f,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;STLMeshData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Load&nbsp;binary&nbsp;STL&nbsp;format.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skip&nbsp;80-byte&nbsp;header<br>
&nbsp;&nbsp;&nbsp;&nbsp;f.seek(80)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Read&nbsp;triangle&nbsp;count<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_triangles&nbsp;=&nbsp;struct.unpack(&quot;&lt;I&quot;,&nbsp;f.read(4))[0]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Pre-allocate&nbsp;lists<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Read&nbsp;triangles<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;_&nbsp;in&nbsp;range(num_triangles):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Normal&nbsp;(3&nbsp;floats)&nbsp;+&nbsp;3&nbsp;vertices&nbsp;(9&nbsp;floats)&nbsp;+&nbsp;attribute&nbsp;(2&nbsp;bytes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;f.read(50)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values&nbsp;=&nbsp;struct.unpack(&quot;&lt;12fH&quot;,&nbsp;data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nx,&nbsp;ny,&nbsp;nz&nbsp;=&nbsp;values[0:3]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;values[3:6]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;values[6:9]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;values[9:12]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices.extend([v1,&nbsp;v2,&nbsp;v3])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals.extend([(nx,&nbsp;ny,&nbsp;nz)]&nbsp;*&nbsp;3)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Convert&nbsp;to&nbsp;numpy<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices_np&nbsp;=&nbsp;np.array(vertices,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals_np&nbsp;=&nbsp;np.array(normals,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;indices_np&nbsp;=&nbsp;np.arange(len(vertices),&nbsp;dtype=np.uint32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;STLMeshData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=vertices_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals=normals_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices=indices_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
def&nbsp;_load_ascii_stl(f,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;STLMeshData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Load&nbsp;ASCII&nbsp;STL&nbsp;format.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;current_normal&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;line&nbsp;in&nbsp;f:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;=&nbsp;line.decode(&quot;utf-8&quot;,&nbsp;errors=&quot;ignore&quot;).strip()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lower&nbsp;=&nbsp;line.lower()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;lower.startswith(&quot;facet&nbsp;normal&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parts&nbsp;=&nbsp;line.split()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(parts)&nbsp;&gt;=&nbsp;5:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_normal&nbsp;=&nbsp;(float(parts[2]),&nbsp;float(parts[3]),&nbsp;float(parts[4]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;lower.startswith(&quot;vertex&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parts&nbsp;=&nbsp;line.split()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(parts)&nbsp;&gt;=&nbsp;4:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices.append((float(parts[1]),&nbsp;float(parts[2]),&nbsp;float(parts[3])))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;current_normal:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals.append(current_normal)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;vertices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;No&nbsp;vertices&nbsp;found&nbsp;in&nbsp;ASCII&nbsp;STL&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices_np&nbsp;=&nbsp;np.array(vertices,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;normals_np&nbsp;=&nbsp;np.array(normals,&nbsp;dtype=np.float32)&nbsp;if&nbsp;normals&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;indices_np&nbsp;=&nbsp;np.arange(len(vertices),&nbsp;dtype=np.uint32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;STLMeshData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=vertices_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals=normals_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices=indices_np,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<!-- END SCAT CODE -->
</body>
</html>
