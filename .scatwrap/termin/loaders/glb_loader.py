<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/loaders/glb_loader.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;termin/loaders/glb_loader.py<br>
&quot;&quot;&quot;GLB/glTF&nbsp;2.0&nbsp;loader.<br>
<br>
Pure&nbsp;Python&nbsp;implementation&nbsp;without&nbsp;external&nbsp;dependencies&nbsp;(except&nbsp;numpy).<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;json<br>
import&nbsp;struct<br>
from&nbsp;pathlib&nbsp;import&nbsp;Path<br>
from&nbsp;typing&nbsp;import&nbsp;List,&nbsp;Optional,&nbsp;Dict,&nbsp;Any<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin._native&nbsp;import&nbsp;log<br>
<br>
<br>
#&nbsp;----------&nbsp;DATA&nbsp;CLASSES&nbsp;----------<br>
<br>
class&nbsp;GLBMeshData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Mesh&nbsp;data&nbsp;extracted&nbsp;from&nbsp;GLB.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name:&nbsp;str,&nbsp;vertices:&nbsp;np.ndarray,&nbsp;normals:&nbsp;Optional[np.ndarray],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs:&nbsp;Optional[np.ndarray],&nbsp;indices:&nbsp;np.ndarray,&nbsp;material_index:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangents:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_indices:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_weights:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.vertices&nbsp;=&nbsp;vertices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.normals&nbsp;=&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.uvs&nbsp;=&nbsp;uvs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tangents&nbsp;=&nbsp;tangents&nbsp;&nbsp;#&nbsp;Per-vertex&nbsp;tangents&nbsp;(N,&nbsp;4)&nbsp;with&nbsp;w&nbsp;=&nbsp;handedness<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.indices&nbsp;=&nbsp;indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.material_index&nbsp;=&nbsp;material_index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skinning&nbsp;data&nbsp;(N,&nbsp;4)&nbsp;arrays<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.joint_indices&nbsp;=&nbsp;joint_indices&nbsp;&nbsp;#&nbsp;Bone&nbsp;indices&nbsp;per&nbsp;vertex<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.joint_weights&nbsp;=&nbsp;joint_weights&nbsp;&nbsp;#&nbsp;Blend&nbsp;weights&nbsp;per&nbsp;vertex<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;is_skinned(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;True&nbsp;if&nbsp;this&nbsp;mesh&nbsp;has&nbsp;skinning&nbsp;data.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.joint_indices&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;self.joint_weights&nbsp;is&nbsp;not&nbsp;None<br>
<br>
<br>
class&nbsp;GLBMaterialData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Material&nbsp;data&nbsp;extracted&nbsp;from&nbsp;GLB.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name:&nbsp;str,&nbsp;base_color:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color_texture:&nbsp;Optional[int]&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.base_color&nbsp;=&nbsp;base_color&nbsp;&nbsp;#&nbsp;RGBA<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.base_color_texture&nbsp;=&nbsp;base_color_texture&nbsp;&nbsp;#&nbsp;texture&nbsp;index<br>
<br>
<br>
class&nbsp;GLBTcTexture:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Texture&nbsp;data&nbsp;extracted&nbsp;from&nbsp;GLB.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name:&nbsp;str,&nbsp;data:&nbsp;bytes,&nbsp;mime_type:&nbsp;str):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data&nbsp;=&nbsp;data&nbsp;&nbsp;#&nbsp;Raw&nbsp;image&nbsp;bytes&nbsp;(PNG/JPEG)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.mime_type&nbsp;=&nbsp;mime_type<br>
<br>
<br>
class&nbsp;GLBAnimationChannel:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Animation&nbsp;channel&nbsp;for&nbsp;a&nbsp;single&nbsp;node.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;node_index:&nbsp;int,&nbsp;node_name:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos_keys:&nbsp;List,&nbsp;rot_keys:&nbsp;List,&nbsp;scale_keys:&nbsp;List):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.node_index&nbsp;=&nbsp;node_index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.node_name&nbsp;=&nbsp;node_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.pos_keys&nbsp;=&nbsp;pos_keys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[(time,&nbsp;[x,y,z]),&nbsp;...]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.rot_keys&nbsp;=&nbsp;rot_keys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[(time,&nbsp;[x,y,z,w]),&nbsp;...]&nbsp;quaternion<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.scale_keys&nbsp;=&nbsp;scale_keys&nbsp;&nbsp;#&nbsp;[(time,&nbsp;[x,y,z]),&nbsp;...]<br>
<br>
<br>
class&nbsp;GLBAnimationClip:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Animation&nbsp;clip&nbsp;containing&nbsp;multiple&nbsp;channels.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name:&nbsp;str,&nbsp;channels:&nbsp;List[GLBAnimationChannel],&nbsp;duration:&nbsp;float):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.channels&nbsp;=&nbsp;channels<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.duration&nbsp;=&nbsp;duration<br>
<br>
<br>
class&nbsp;GLBNodeData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Node&nbsp;in&nbsp;scene&nbsp;hierarchy.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;name:&nbsp;str,&nbsp;children:&nbsp;List[int],&nbsp;mesh_index:&nbsp;Optional[int],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;translation:&nbsp;np.ndarray,&nbsp;rotation:&nbsp;np.ndarray,&nbsp;scale:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin_index:&nbsp;Optional[int]&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.children&nbsp;=&nbsp;children<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.mesh_index&nbsp;=&nbsp;mesh_index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.skin_index&nbsp;=&nbsp;skin_index&nbsp;&nbsp;#&nbsp;Index&nbsp;into&nbsp;skins&nbsp;array<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.translation&nbsp;=&nbsp;translation&nbsp;&nbsp;#&nbsp;[x,&nbsp;y,&nbsp;z]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.rotation&nbsp;=&nbsp;rotation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[x,&nbsp;y,&nbsp;z,&nbsp;w]&nbsp;quaternion<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.scale&nbsp;=&nbsp;scale&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[x,&nbsp;y,&nbsp;z]<br>
<br>
<br>
class&nbsp;GLBSkinData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Skin&nbsp;(skeleton)&nbsp;data&nbsp;extracted&nbsp;from&nbsp;GLB.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_node_indices:&nbsp;List[int],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;armature_node_index:&nbsp;Optional[int]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Initialize&nbsp;skin&nbsp;data.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Skin&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_node_indices:&nbsp;List&nbsp;of&nbsp;node&nbsp;indices&nbsp;that&nbsp;are&nbsp;joints&nbsp;(bones)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices:&nbsp;(N,&nbsp;4,&nbsp;4)&nbsp;inverse&nbsp;bind&nbsp;matrices&nbsp;for&nbsp;each&nbsp;joint<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;armature_node_index:&nbsp;Node&nbsp;index&nbsp;of&nbsp;skeleton&nbsp;root&nbsp;(Armature&nbsp;in&nbsp;Blender)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.joint_node_indices&nbsp;=&nbsp;joint_node_indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.inverse_bind_matrices&nbsp;=&nbsp;inverse_bind_matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.armature_node_index&nbsp;=&nbsp;armature_node_index<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;joint_count(self)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Number&nbsp;of&nbsp;joints&nbsp;in&nbsp;this&nbsp;skin.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(self.joint_node_indices)<br>
<br>
<br>
class&nbsp;GLBSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Complete&nbsp;scene&nbsp;data&nbsp;from&nbsp;GLB&nbsp;file.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.meshes:&nbsp;List[GLBMeshData]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.materials:&nbsp;List[GLBMaterialData]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.textures:&nbsp;List[GLBTcTexture]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.animations:&nbsp;List[GLBAnimationClip]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.nodes:&nbsp;List[GLBNodeData]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.skins:&nbsp;List[GLBSkinData]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.root_nodes:&nbsp;List[int]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Map&nbsp;from&nbsp;glTF&nbsp;mesh&nbsp;index&nbsp;to&nbsp;list&nbsp;of&nbsp;our&nbsp;internal&nbsp;mesh&nbsp;indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(one&nbsp;glTF&nbsp;mesh&nbsp;can&nbsp;have&nbsp;multiple&nbsp;primitives)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.mesh_index_map:&nbsp;Dict[int,&nbsp;List[int]]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Scale&nbsp;factor&nbsp;from&nbsp;inverse&nbsp;bind&nbsp;matrices&nbsp;(for&nbsp;skinned&nbsp;meshes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.skin_scale:&nbsp;float&nbsp;=&nbsp;1.0<br>
<br>
<br>
#&nbsp;----------&nbsp;ACCESSOR&nbsp;HELPERS&nbsp;----------<br>
<br>
COMPONENT_TYPE_SIZE&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;5120:&nbsp;1,&nbsp;&nbsp;#&nbsp;BYTE<br>
&nbsp;&nbsp;&nbsp;&nbsp;5121:&nbsp;1,&nbsp;&nbsp;#&nbsp;UNSIGNED_BYTE<br>
&nbsp;&nbsp;&nbsp;&nbsp;5122:&nbsp;2,&nbsp;&nbsp;#&nbsp;SHORT<br>
&nbsp;&nbsp;&nbsp;&nbsp;5123:&nbsp;2,&nbsp;&nbsp;#&nbsp;UNSIGNED_SHORT<br>
&nbsp;&nbsp;&nbsp;&nbsp;5125:&nbsp;4,&nbsp;&nbsp;#&nbsp;UNSIGNED_INT<br>
&nbsp;&nbsp;&nbsp;&nbsp;5126:&nbsp;4,&nbsp;&nbsp;#&nbsp;FLOAT<br>
}<br>
<br>
COMPONENT_TYPE_DTYPE&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;5120:&nbsp;np.int8,<br>
&nbsp;&nbsp;&nbsp;&nbsp;5121:&nbsp;np.uint8,<br>
&nbsp;&nbsp;&nbsp;&nbsp;5122:&nbsp;np.int16,<br>
&nbsp;&nbsp;&nbsp;&nbsp;5123:&nbsp;np.uint16,<br>
&nbsp;&nbsp;&nbsp;&nbsp;5125:&nbsp;np.uint32,<br>
&nbsp;&nbsp;&nbsp;&nbsp;5126:&nbsp;np.float32,<br>
}<br>
<br>
TYPE_NUM_COMPONENTS&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;SCALAR&quot;:&nbsp;1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;VEC2&quot;:&nbsp;2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;VEC3&quot;:&nbsp;3,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;VEC4&quot;:&nbsp;4,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;MAT2&quot;:&nbsp;4,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;MAT3&quot;:&nbsp;9,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;MAT4&quot;:&nbsp;16,<br>
}<br>
<br>
<br>
def&nbsp;_read_accessor(gltf:&nbsp;dict,&nbsp;bin_data:&nbsp;bytes,&nbsp;accessor_index:&nbsp;int)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Read&nbsp;data&nbsp;from&nbsp;an&nbsp;accessor.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;accessor&nbsp;=&nbsp;gltf[&quot;accessors&quot;][accessor_index]<br>
&nbsp;&nbsp;&nbsp;&nbsp;buffer_view&nbsp;=&nbsp;gltf[&quot;bufferViews&quot;][accessor[&quot;bufferView&quot;]]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;component_type&nbsp;=&nbsp;accessor[&quot;componentType&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;accessor_type&nbsp;=&nbsp;accessor[&quot;type&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;=&nbsp;accessor[&quot;count&quot;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;dtype&nbsp;=&nbsp;COMPONENT_TYPE_DTYPE[component_type]<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_components&nbsp;=&nbsp;TYPE_NUM_COMPONENTS[accessor_type]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;byte_offset&nbsp;=&nbsp;buffer_view.get(&quot;byteOffset&quot;,&nbsp;0)&nbsp;+&nbsp;accessor.get(&quot;byteOffset&quot;,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;byte_stride&nbsp;=&nbsp;buffer_view.get(&quot;byteStride&quot;,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;element_size&nbsp;=&nbsp;COMPONENT_TYPE_SIZE[component_type]&nbsp;*&nbsp;num_components<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;byte_stride&nbsp;==&nbsp;0&nbsp;or&nbsp;byte_stride&nbsp;==&nbsp;element_size:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Tightly&nbsp;packed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;np.frombuffer(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bin_data,&nbsp;dtype=dtype,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset=byte_offset,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count=count&nbsp;*&nbsp;num_components<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;num_components&nbsp;&gt;&nbsp;1:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;data.reshape(count,&nbsp;num_components)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Strided&nbsp;data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;np.zeros((count,&nbsp;num_components),&nbsp;dtype=dtype)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(count):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;byte_offset&nbsp;+&nbsp;i&nbsp;*&nbsp;byte_stride<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;element&nbsp;=&nbsp;np.frombuffer(bin_data,&nbsp;dtype=dtype,&nbsp;offset=offset,&nbsp;count=num_components)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data[i]&nbsp;=&nbsp;element<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;data.astype(np.float32)&nbsp;if&nbsp;dtype&nbsp;!=&nbsp;np.float32&nbsp;else&nbsp;data<br>
<br>
<br>
#&nbsp;----------&nbsp;PARSING&nbsp;FUNCTIONS&nbsp;----------<br>
<br>
def&nbsp;_parse_meshes(gltf:&nbsp;dict,&nbsp;bin_data:&nbsp;bytes,&nbsp;scene_data:&nbsp;GLBSceneData):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;all&nbsp;meshes&nbsp;from&nbsp;glTF.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;mesh_idx,&nbsp;mesh&nbsp;in&nbsp;enumerate(gltf.get(&quot;meshes&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_name&nbsp;=&nbsp;mesh.get(&quot;name&quot;,&nbsp;f&quot;Mesh_{mesh_idx}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.mesh_index_map[mesh_idx]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;prim_idx,&nbsp;primitive&nbsp;in&nbsp;enumerate(mesh.get(&quot;primitives&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes&nbsp;=&nbsp;primitive.get(&quot;attributes&quot;,&nbsp;{})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Vertices&nbsp;(required)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;POSITION&quot;&nbsp;not&nbsp;in&nbsp;attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;attributes[&quot;POSITION&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Normals&nbsp;(optional)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;NORMAL&quot;&nbsp;in&nbsp;attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;attributes[&quot;NORMAL&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;UVs&nbsp;(optional)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;TEXCOORD_0&quot;&nbsp;in&nbsp;attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;attributes[&quot;TEXCOORD_0&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Tangents&nbsp;(optional)&nbsp;-&nbsp;vec4&nbsp;with&nbsp;w&nbsp;=&nbsp;handedness<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangents&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;TANGENT&quot;&nbsp;in&nbsp;attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangents&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;attributes[&quot;TANGENT&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skinning&nbsp;data&nbsp;(optional)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_indices&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_weights&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;JOINTS_0&quot;&nbsp;in&nbsp;attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_indices&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;attributes[&quot;JOINTS_0&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;WEIGHTS_0&quot;&nbsp;in&nbsp;attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_weights&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;attributes[&quot;WEIGHTS_0&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;indices&quot;&nbsp;in&nbsp;primitive:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;primitive[&quot;indices&quot;]).astype(np.uint32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;indices.ndim&nbsp;&gt;&nbsp;1:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices&nbsp;=&nbsp;indices.flatten()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;No&nbsp;indices&nbsp;-&nbsp;sequential<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices&nbsp;=&nbsp;np.arange(len(vertices),&nbsp;dtype=np.uint32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Material<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material_index&nbsp;=&nbsp;primitive.get(&quot;material&quot;,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;expanded&nbsp;vertex&nbsp;arrays&nbsp;(for&nbsp;compatibility&nbsp;with&nbsp;FBX&nbsp;loader&nbsp;output)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded_verts&nbsp;=&nbsp;vertices[indices]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded_normals&nbsp;=&nbsp;normals[indices]&nbsp;if&nbsp;normals&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded_uvs&nbsp;=&nbsp;uvs[indices]&nbsp;if&nbsp;uvs&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded_tangents&nbsp;=&nbsp;tangents[indices]&nbsp;if&nbsp;tangents&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded_joints&nbsp;=&nbsp;joint_indices[indices]&nbsp;if&nbsp;joint_indices&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded_weights&nbsp;=&nbsp;joint_weights[indices]&nbsp;if&nbsp;joint_weights&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prim_name&nbsp;=&nbsp;mesh_name&nbsp;if&nbsp;prim_idx&nbsp;==&nbsp;0&nbsp;else&nbsp;f&quot;{mesh_name}_{prim_idx}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;our_mesh_idx&nbsp;=&nbsp;len(scene_data.meshes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.mesh_index_map[mesh_idx].append(our_mesh_idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.meshes.append(GLBMeshData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=prim_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=expanded_verts.astype(np.float32),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals=expanded_normals.astype(np.float32)&nbsp;if&nbsp;expanded_normals&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs=expanded_uvs.astype(np.float32)&nbsp;if&nbsp;expanded_uvs&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indices=np.arange(len(expanded_verts),&nbsp;dtype=np.uint32),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material_index=material_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tangents=expanded_tangents.astype(np.float32)&nbsp;if&nbsp;expanded_tangents&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_indices=expanded_joints.astype(np.float32)&nbsp;if&nbsp;expanded_joints&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_weights=expanded_weights.astype(np.float32)&nbsp;if&nbsp;expanded_weights&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<br>
def&nbsp;_parse_materials(gltf:&nbsp;dict,&nbsp;scene_data:&nbsp;GLBSceneData):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;all&nbsp;materials&nbsp;from&nbsp;glTF.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;mat_idx,&nbsp;mat&nbsp;in&nbsp;enumerate(gltf.get(&quot;materials&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;mat.get(&quot;name&quot;,&nbsp;f&quot;Material_{mat_idx}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color_texture&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pbr&nbsp;=&nbsp;mat.get(&quot;pbrMetallicRoughness&quot;,&nbsp;{})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;baseColorFactor&quot;&nbsp;in&nbsp;pbr:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color&nbsp;=&nbsp;np.array(pbr[&quot;baseColorFactor&quot;],&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;baseColorTexture&quot;&nbsp;in&nbsp;pbr:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color_texture&nbsp;=&nbsp;pbr[&quot;baseColorTexture&quot;].get(&quot;index&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.materials.append(GLBMaterialData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color=base_color,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color_texture=base_color_texture,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<br>
def&nbsp;_parse_textures(gltf:&nbsp;dict,&nbsp;bin_data:&nbsp;bytes,&nbsp;scene_data:&nbsp;GLBSceneData):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;all&nbsp;textures/images&nbsp;from&nbsp;glTF.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;images&nbsp;=&nbsp;gltf.get(&quot;images&quot;,&nbsp;[])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;tex_idx,&nbsp;texture&nbsp;in&nbsp;enumerate(gltf.get(&quot;textures&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_idx&nbsp;=&nbsp;texture.get(&quot;source&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;source_idx&nbsp;is&nbsp;None&nbsp;or&nbsp;source_idx&nbsp;&gt;=&nbsp;len(images):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;image&nbsp;=&nbsp;images[source_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;image.get(&quot;name&quot;,&nbsp;f&quot;Texture_{tex_idx}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mime_type&nbsp;=&nbsp;image.get(&quot;mimeType&quot;,&nbsp;&quot;image/png&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;image&nbsp;data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;bufferView&quot;&nbsp;in&nbsp;image:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bv&nbsp;=&nbsp;gltf[&quot;bufferViews&quot;][image[&quot;bufferView&quot;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;bv.get(&quot;byteOffset&quot;,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length&nbsp;=&nbsp;bv[&quot;byteLength&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;bin_data[offset:offset&nbsp;+&nbsp;length]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;&quot;uri&quot;&nbsp;in&nbsp;image:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;External&nbsp;or&nbsp;data&nbsp;URI&nbsp;-&nbsp;skip&nbsp;for&nbsp;now<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;data:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.textures.append(GLBTcTexture(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data=data,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mime_type=mime_type,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<br>
def&nbsp;_parse_nodes(gltf:&nbsp;dict,&nbsp;scene_data:&nbsp;GLBSceneData):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;node&nbsp;hierarchy.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node_idx,&nbsp;node&nbsp;in&nbsp;enumerate(gltf.get(&quot;nodes&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;node.get(&quot;name&quot;,&nbsp;f&quot;Node_{node_idx}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;children&nbsp;=&nbsp;node.get(&quot;children&quot;,&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_index&nbsp;=&nbsp;node.get(&quot;mesh&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin_index&nbsp;=&nbsp;node.get(&quot;skin&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Transform<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;translation&nbsp;=&nbsp;np.array(node.get(&quot;translation&quot;,&nbsp;[0,&nbsp;0,&nbsp;0]),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rotation&nbsp;=&nbsp;np.array(node.get(&quot;rotation&quot;,&nbsp;[0,&nbsp;0,&nbsp;0,&nbsp;1]),&nbsp;dtype=np.float32)&nbsp;&nbsp;#&nbsp;xyzw<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale&nbsp;=&nbsp;np.array(node.get(&quot;scale&quot;,&nbsp;[1,&nbsp;1,&nbsp;1]),&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;matrix&nbsp;is&nbsp;provided,&nbsp;decompose&nbsp;it&nbsp;(simplified&nbsp;-&nbsp;just&nbsp;use&nbsp;TRS&nbsp;if&nbsp;available)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;matrix&quot;&nbsp;in&nbsp;node&nbsp;and&nbsp;&quot;translation&quot;&nbsp;not&nbsp;in&nbsp;node:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;TODO:&nbsp;decompose&nbsp;matrix&nbsp;if&nbsp;needed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.nodes.append(GLBNodeData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;children=children,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_index=mesh_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin_index=skin_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;translation=translation,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rotation=rotation,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale=scale,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Root&nbsp;nodes&nbsp;from&nbsp;default&nbsp;scene<br>
&nbsp;&nbsp;&nbsp;&nbsp;scenes&nbsp;=&nbsp;gltf.get(&quot;scenes&quot;,&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;default_scene&nbsp;=&nbsp;gltf.get(&quot;scene&quot;,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scenes&nbsp;and&nbsp;default_scene&nbsp;&lt;&nbsp;len(scenes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.root_nodes&nbsp;=&nbsp;scenes[default_scene].get(&quot;nodes&quot;,&nbsp;[])<br>
<br>
<br>
def&nbsp;_parse_skins(gltf:&nbsp;dict,&nbsp;bin_data:&nbsp;bytes,&nbsp;scene_data:&nbsp;GLBSceneData):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;skins&nbsp;(skeletons)&nbsp;from&nbsp;glTF.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;skin_idx,&nbsp;skin&nbsp;in&nbsp;enumerate(gltf.get(&quot;skins&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;skin.get(&quot;name&quot;,&nbsp;f&quot;Skin_{skin_idx}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_node_indices&nbsp;=&nbsp;skin.get(&quot;joints&quot;,&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;armature_node_index&nbsp;=&nbsp;skin.get(&quot;skeleton&quot;)&nbsp;&nbsp;#&nbsp;Armature&nbsp;node&nbsp;in&nbsp;Blender<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Read&nbsp;inverse&nbsp;bind&nbsp;matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;inverseBindMatrices&quot;&nbsp;in&nbsp;skin:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ibm_accessor_idx&nbsp;=&nbsp;skin[&quot;inverseBindMatrices&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ibm_data&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;ibm_accessor_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Reshape&nbsp;to&nbsp;(N,&nbsp;4,&nbsp;4)&nbsp;matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;glTF&nbsp;stores&nbsp;matrices&nbsp;in&nbsp;column-major&nbsp;order,&nbsp;so&nbsp;transpose&nbsp;each&nbsp;one<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices&nbsp;=&nbsp;ibm_data.reshape(-1,&nbsp;4,&nbsp;4).astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices&nbsp;=&nbsp;np.ascontiguousarray(inverse_bind_matrices.transpose(0,&nbsp;2,&nbsp;1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Default&nbsp;to&nbsp;identity&nbsp;matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n_joints&nbsp;=&nbsp;len(joint_node_indices)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices&nbsp;=&nbsp;np.zeros((n_joints,&nbsp;4,&nbsp;4),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n_joints):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices[i]&nbsp;=&nbsp;np.eye(4,&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.skins.append(GLBSkinData(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_node_indices=joint_node_indices,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inverse_bind_matrices=inverse_bind_matrices,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;armature_node_index=armature_node_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<br>
def&nbsp;_parse_animations(gltf:&nbsp;dict,&nbsp;bin_data:&nbsp;bytes,&nbsp;scene_data:&nbsp;GLBSceneData):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Parse&nbsp;animations&nbsp;from&nbsp;glTF.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes&nbsp;=&nbsp;gltf.get(&quot;nodes&quot;,&nbsp;[])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;anim_idx,&nbsp;anim&nbsp;in&nbsp;enumerate(gltf.get(&quot;animations&quot;,&nbsp;[])):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anim_name&nbsp;=&nbsp;anim.get(&quot;name&quot;,&nbsp;f&quot;Animation_{anim_idx}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Group&nbsp;channels&nbsp;by&nbsp;target&nbsp;node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_channels:&nbsp;Dict[int,&nbsp;Dict[str,&nbsp;Any]]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;channel&nbsp;in&nbsp;anim.get(&quot;channels&quot;,&nbsp;[]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sampler_idx&nbsp;=&nbsp;channel[&quot;sampler&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sampler&nbsp;=&nbsp;anim[&quot;samplers&quot;][sampler_idx]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;=&nbsp;channel[&quot;target&quot;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_idx&nbsp;=&nbsp;target.get(&quot;node&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;target.get(&quot;path&quot;)&nbsp;&nbsp;#&nbsp;translation,&nbsp;rotation,&nbsp;scale,&nbsp;weights<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node_idx&nbsp;is&nbsp;None&nbsp;or&nbsp;path&nbsp;not&nbsp;in&nbsp;(&quot;translation&quot;,&nbsp;&quot;rotation&quot;,&nbsp;&quot;scale&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Read&nbsp;input&nbsp;(times)&nbsp;and&nbsp;output&nbsp;(values)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;times&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;sampler[&quot;input&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values&nbsp;=&nbsp;_read_accessor(gltf,&nbsp;bin_data,&nbsp;sampler[&quot;output&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;times.ndim&nbsp;&gt;&nbsp;1:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;times&nbsp;=&nbsp;times.flatten()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node_idx&nbsp;not&nbsp;in&nbsp;node_channels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_channels[node_idx]&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pos_keys&quot;:&nbsp;[],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;rot_keys&quot;:&nbsp;[],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scale_keys&quot;:&nbsp;[],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;keyframe&nbsp;list&nbsp;(use&nbsp;lists,&nbsp;not&nbsp;tuples,&nbsp;for&nbsp;mutability&nbsp;in&nbsp;normalize_glb_scale)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keys&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;t&nbsp;in&nbsp;enumerate(times):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;values.ndim&nbsp;==&nbsp;1:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;values[i:i+1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;values[i]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keys.append([float(t),&nbsp;v.copy()])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;path&nbsp;==&nbsp;&quot;translation&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_channels[node_idx][&quot;pos_keys&quot;]&nbsp;=&nbsp;keys<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;path&nbsp;==&nbsp;&quot;rotation&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_channels[node_idx][&quot;rot_keys&quot;]&nbsp;=&nbsp;keys<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;path&nbsp;==&nbsp;&quot;scale&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_channels[node_idx][&quot;scale_keys&quot;]&nbsp;=&nbsp;keys<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;animation&nbsp;channels<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channels&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_time&nbsp;=&nbsp;0.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node_idx,&nbsp;ch_data&nbsp;in&nbsp;node_channels.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_name&nbsp;=&nbsp;nodes[node_idx].get(&quot;name&quot;,&nbsp;f&quot;Node_{node_idx}&quot;)&nbsp;if&nbsp;node_idx&nbsp;&lt;&nbsp;len(nodes)&nbsp;else&nbsp;f&quot;Node_{node_idx}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Track&nbsp;max&nbsp;time&nbsp;for&nbsp;duration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;keys&nbsp;in&nbsp;[ch_data[&quot;pos_keys&quot;],&nbsp;ch_data[&quot;rot_keys&quot;],&nbsp;ch_data[&quot;scale_keys&quot;]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_time&nbsp;=&nbsp;max(max_time,&nbsp;keys[-1][0])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channels.append(GLBAnimationChannel(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_index=node_idx,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_name=node_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos_keys=ch_data[&quot;pos_keys&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rot_keys=ch_data[&quot;rot_keys&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale_keys=ch_data[&quot;scale_keys&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;channels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data.animations.append(GLBAnimationClip(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=anim_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channels=channels,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration=max_time,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<br>
#&nbsp;----------&nbsp;PUBLIC&nbsp;API&nbsp;----------<br>
<br>
def&nbsp;load_glb_file(path:&nbsp;str&nbsp;|&nbsp;Path)&nbsp;-&gt;&nbsp;GLBSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Load&nbsp;a&nbsp;GLB&nbsp;file&nbsp;and&nbsp;return&nbsp;scene&nbsp;data.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;Path&nbsp;to&nbsp;.glb&nbsp;file<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GLBSceneData&nbsp;containing&nbsp;meshes,&nbsp;materials,&nbsp;textures,&nbsp;animations,&nbsp;nodes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;Path(path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;open(path,&nbsp;&quot;rb&quot;)&nbsp;as&nbsp;f:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;f.read()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;header<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(data)&nbsp;&lt;&nbsp;12:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;File&nbsp;too&nbsp;small&nbsp;to&nbsp;be&nbsp;valid&nbsp;GLB&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;magic&nbsp;=&nbsp;data[0:4]<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;magic&nbsp;!=&nbsp;b&quot;glTF&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Invalid&nbsp;GLB&nbsp;magic:&nbsp;{magic}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;version,&nbsp;length&nbsp;=&nbsp;struct.unpack(&quot;&lt;II&quot;,&nbsp;data[4:12])<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;version&nbsp;!=&nbsp;2:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Unsupported&nbsp;glTF&nbsp;version:&nbsp;{version}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;chunks<br>
&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;12<br>
&nbsp;&nbsp;&nbsp;&nbsp;json_data&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;bin_data&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;offset&nbsp;&lt;&nbsp;len(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;offset&nbsp;+&nbsp;8&nbsp;&gt;&nbsp;len(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_length,&nbsp;chunk_type&nbsp;=&nbsp;struct.unpack(&quot;&lt;II&quot;,&nbsp;data[offset:offset&nbsp;+&nbsp;8])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_data&nbsp;=&nbsp;data[offset&nbsp;+&nbsp;8:offset&nbsp;+&nbsp;8&nbsp;+&nbsp;chunk_length]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;chunk_type&nbsp;==&nbsp;0x4E4F534A:&nbsp;&nbsp;#&nbsp;JSON<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json_data&nbsp;=&nbsp;chunk_data.decode(&quot;utf-8&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;chunk_type&nbsp;==&nbsp;0x004E4942:&nbsp;&nbsp;#&nbsp;BIN<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bin_data&nbsp;=&nbsp;chunk_data<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Align&nbsp;to&nbsp;4&nbsp;bytes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;+=&nbsp;8&nbsp;+&nbsp;chunk_length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;(offset&nbsp;+&nbsp;3)&nbsp;&amp;&nbsp;~3<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;json_data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;No&nbsp;JSON&nbsp;chunk&nbsp;found&nbsp;in&nbsp;GLB&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gltf&nbsp;=&nbsp;json.loads(json_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;bin_data&nbsp;=&nbsp;bin_data&nbsp;or&nbsp;b&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;scene<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;GLBSceneData()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_nodes(gltf,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_materials(gltf,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_textures(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_meshes(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_skins(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_animations(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene_data<br>
<br>
<br>
def&nbsp;convert_y_up_to_z_up(scene_data:&nbsp;GLBSceneData)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Convert&nbsp;GLB&nbsp;data&nbsp;from&nbsp;glTF&nbsp;Y-up&nbsp;coordinate&nbsp;system&nbsp;to&nbsp;engine&nbsp;Z-up.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;glTF&nbsp;coordinate&nbsp;system:&nbsp;Y-up,&nbsp;-Z&nbsp;forward,&nbsp;X&nbsp;right<br>
&nbsp;&nbsp;&nbsp;&nbsp;Engine&nbsp;coordinate&nbsp;system:&nbsp;Z-up,&nbsp;Y&nbsp;forward,&nbsp;X&nbsp;right<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Conversion:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X_engine&nbsp;=&nbsp;X_gltf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y_engine&nbsp;=&nbsp;-Z_gltf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Z_engine&nbsp;=&nbsp;Y_gltf<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;modifies&nbsp;scene_data&nbsp;in&nbsp;place,&nbsp;converting:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Vertex&nbsp;positions&nbsp;and&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Node&nbsp;translations&nbsp;and&nbsp;rotations<br>
&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Inverse&nbsp;bind&nbsp;matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;Animation&nbsp;keyframes&nbsp;(positions&nbsp;and&nbsp;rotations)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data:&nbsp;GLBSceneData&nbsp;to&nbsp;convert&nbsp;(modified&nbsp;in&nbsp;place)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;convert_position(pos:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Convert&nbsp;position&nbsp;vector:&nbsp;(x,&nbsp;y,&nbsp;z)&nbsp;-&gt;&nbsp;(x,&nbsp;-z,&nbsp;y)&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array([pos[0],&nbsp;-pos[2],&nbsp;pos[1]],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;convert_positions_batch(positions:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Convert&nbsp;array&nbsp;of&nbsp;positions:&nbsp;(...,&nbsp;3)&nbsp;shape&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;np.empty_like(positions)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;0]&nbsp;=&nbsp;positions[...,&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;1]&nbsp;=&nbsp;-positions[...,&nbsp;2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;2]&nbsp;=&nbsp;positions[...,&nbsp;1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;convert_quaternion(q:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Convert&nbsp;quaternion&nbsp;from&nbsp;Y-up&nbsp;to&nbsp;Z-up.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quaternion&nbsp;(x,&nbsp;y,&nbsp;z,&nbsp;w)&nbsp;represents&nbsp;rotation&nbsp;around&nbsp;axis&nbsp;(x,&nbsp;y,&nbsp;z).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;need&nbsp;to&nbsp;convert&nbsp;the&nbsp;axis&nbsp;using&nbsp;the&nbsp;same&nbsp;coordinate&nbsp;transform.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;q&nbsp;=&nbsp;(x,&nbsp;y,&nbsp;z,&nbsp;w)&nbsp;-&gt;&nbsp;(x,&nbsp;-z,&nbsp;y,&nbsp;w)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array([q[0],&nbsp;-q[2],&nbsp;q[1],&nbsp;q[3]],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;convert_matrix(m:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Convert&nbsp;4x4&nbsp;transformation&nbsp;matrix&nbsp;from&nbsp;Y-up&nbsp;to&nbsp;Z-up.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;apply:&nbsp;M'&nbsp;=&nbsp;C&nbsp;@&nbsp;M&nbsp;@&nbsp;C^(-1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;C&nbsp;is&nbsp;the&nbsp;coordinate&nbsp;conversion&nbsp;matrix.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Conversion&nbsp;matrix:&nbsp;swaps&nbsp;Y&nbsp;and&nbsp;Z,&nbsp;negates&nbsp;new&nbsp;Y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[1&nbsp;&nbsp;0&nbsp;&nbsp;0&nbsp;&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[0&nbsp;&nbsp;0&nbsp;-1&nbsp;&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[0&nbsp;&nbsp;1&nbsp;&nbsp;0&nbsp;&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;[0&nbsp;&nbsp;0&nbsp;&nbsp;0&nbsp;&nbsp;1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1,&nbsp;0,&nbsp;0,&nbsp;0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;0,&nbsp;-1,&nbsp;0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;1,&nbsp;0,&nbsp;0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;0,&nbsp;0,&nbsp;1],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;C^(-1)&nbsp;is&nbsp;the&nbsp;transpose&nbsp;since&nbsp;it's&nbsp;orthogonal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c_inv&nbsp;=&nbsp;c.T<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;c&nbsp;@&nbsp;m&nbsp;@&nbsp;c_inv<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;convert_tangents_batch(tangents:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Convert&nbsp;array&nbsp;of&nbsp;tangents:&nbsp;(...,&nbsp;4)&nbsp;shape,&nbsp;preserving&nbsp;w&nbsp;(handedness).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;np.empty_like(tangents)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;0]&nbsp;=&nbsp;tangents[...,&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;1]&nbsp;=&nbsp;-tangents[...,&nbsp;2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;2]&nbsp;=&nbsp;tangents[...,&nbsp;1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[...,&nbsp;3]&nbsp;=&nbsp;tangents[...,&nbsp;3]&nbsp;&nbsp;#&nbsp;Keep&nbsp;w&nbsp;(handedness)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1.&nbsp;Convert&nbsp;vertex&nbsp;positions,&nbsp;normals,&nbsp;and&nbsp;tangents&nbsp;in&nbsp;all&nbsp;meshes<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;mesh&nbsp;in&nbsp;scene_data.meshes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.vertices&nbsp;=&nbsp;convert_positions_batch(mesh.vertices)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.normals&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.normals&nbsp;=&nbsp;convert_positions_batch(mesh.normals)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh.tangents&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.tangents&nbsp;=&nbsp;convert_tangents_batch(mesh.tangents)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2.&nbsp;Convert&nbsp;node&nbsp;transforms<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;scene_data.nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.translation&nbsp;=&nbsp;convert_position(node.translation)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.rotation&nbsp;=&nbsp;convert_quaternion(node.rotation)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Scale&nbsp;is&nbsp;scalar&nbsp;per-axis,&nbsp;doesn't&nbsp;change&nbsp;with&nbsp;coordinate&nbsp;system<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;but&nbsp;axes&nbsp;swap:&nbsp;(sx,&nbsp;sy,&nbsp;sz)&nbsp;-&gt;&nbsp;(sx,&nbsp;sz,&nbsp;sy)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.scale&nbsp;=&nbsp;np.array([node.scale[0],&nbsp;node.scale[2],&nbsp;node.scale[1]],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3.&nbsp;Convert&nbsp;inverse&nbsp;bind&nbsp;matrices<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;skin&nbsp;in&nbsp;scene_data.skins:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(skin.inverse_bind_matrices)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin.inverse_bind_matrices[i]&nbsp;=&nbsp;convert_matrix(skin.inverse_bind_matrices[i])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;4.&nbsp;Convert&nbsp;animation&nbsp;keyframes<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;anim&nbsp;in&nbsp;scene_data.animations:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;channel&nbsp;in&nbsp;anim.channels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Position&nbsp;keys<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;channel.pos_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.pos_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;convert_position(key[1])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Rotation&nbsp;keys<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;channel.rot_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.rot_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;convert_quaternion(key[1])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Scale&nbsp;keys&nbsp;-&nbsp;swap&nbsp;Y&nbsp;and&nbsp;Z<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;channel.scale_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.scale_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;key[1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;np.array([s[0],&nbsp;s[2],&nbsp;s[1]],&nbsp;dtype=np.float32)<br>
<br>
<br>
def&nbsp;normalize_glb_scale(scene_data:&nbsp;GLBSceneData)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Normalize&nbsp;root&nbsp;scale&nbsp;to&nbsp;1.0&nbsp;by&nbsp;applying&nbsp;inverse&nbsp;scale.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;root&nbsp;node&nbsp;has&nbsp;scale&nbsp;!=&nbsp;1.0,&nbsp;this&nbsp;function:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Sets&nbsp;root&nbsp;node&nbsp;scale&nbsp;to&nbsp;1.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Multiplies&nbsp;all&nbsp;IBM&nbsp;by&nbsp;scale&nbsp;matrix&nbsp;(compensates&nbsp;mesh)<br>
&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Multiplies&nbsp;translation&nbsp;of&nbsp;all&nbsp;child&nbsp;nodes&nbsp;by&nbsp;root_scale&nbsp;(compensates&nbsp;transforms)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data:&nbsp;GLBSceneData&nbsp;to&nbsp;normalize&nbsp;(modified&nbsp;in&nbsp;place)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;True&nbsp;if&nbsp;normalization&nbsp;was&nbsp;performed,&nbsp;False&nbsp;if&nbsp;already&nbsp;normalized<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;scene_data.root_nodes&nbsp;or&nbsp;not&nbsp;scene_data.nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;root_idx&nbsp;=&nbsp;scene_data.root_nodes[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;root_idx&nbsp;&gt;=&nbsp;len(scene_data.nodes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;root_node&nbsp;=&nbsp;scene_data.nodes[root_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;root_scale&nbsp;=&nbsp;root_node.scale<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;already&nbsp;normalized<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;np.allclose(root_scale,&nbsp;[1.0,&nbsp;1.0,&nbsp;1.0]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;uniform&nbsp;scale&nbsp;factor&nbsp;(assumes&nbsp;x&nbsp;==&nbsp;y&nbsp;==&nbsp;z)<br>
&nbsp;&nbsp;&nbsp;&nbsp;scale_factor&nbsp;=&nbsp;float(root_scale[0])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1.&nbsp;Set&nbsp;root&nbsp;node&nbsp;scale&nbsp;to&nbsp;1.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;root_node.scale&nbsp;=&nbsp;np.array([1.0,&nbsp;1.0,&nbsp;1.0],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2.&nbsp;Build&nbsp;scale&nbsp;matrix&nbsp;from&nbsp;root_scale&nbsp;for&nbsp;IBM&nbsp;compensation<br>
&nbsp;&nbsp;&nbsp;&nbsp;scale_matrix&nbsp;=&nbsp;np.diag([root_scale[0],&nbsp;root_scale[1],&nbsp;root_scale[2],&nbsp;1.0]).astype(np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;inverse_scale_matrix&nbsp;=&nbsp;np.diag([1.0&nbsp;/&nbsp;root_scale[0],&nbsp;1.0&nbsp;/&nbsp;root_scale[1],&nbsp;1.0&nbsp;/&nbsp;root_scale[2],&nbsp;1.0]).astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3.&nbsp;Compensate&nbsp;IBM:&nbsp;scale&nbsp;applies&nbsp;to&nbsp;input&nbsp;vertex&nbsp;coordinates<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;skin&nbsp;in&nbsp;scene_data.skins:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(skin.inverse_bind_matrices)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin.inverse_bind_matrices[i]&nbsp;=&nbsp;scale_matrix&nbsp;@&nbsp;skin.inverse_bind_matrices[i]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;4.&nbsp;Scale&nbsp;translation&nbsp;of&nbsp;all&nbsp;child&nbsp;nodes&nbsp;(recursive&nbsp;from&nbsp;root)<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;scale_children_translation(node_idx:&nbsp;int)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;=&nbsp;scene_data.nodes[node_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;child_idx&nbsp;in&nbsp;node.children:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_node&nbsp;=&nbsp;scene_data.nodes[child_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_node.translation&nbsp;=&nbsp;child_node.translation&nbsp;*&nbsp;scale_factor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale_children_translation(child_idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;scale_children_translation(root_idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;5.&nbsp;Scale&nbsp;animation&nbsp;translation&nbsp;keyframes<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;anim&nbsp;in&nbsp;scene_data.animations:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;channel&nbsp;in&nbsp;anim.channels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.pos_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;key&nbsp;=&nbsp;[time,&nbsp;[x,&nbsp;y,&nbsp;z]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;key[1]&nbsp;*&nbsp;scale_factor<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Store&nbsp;original&nbsp;scale&nbsp;for&nbsp;reference<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data.skin_scale&nbsp;=&nbsp;scale_factor<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
<br>
def&nbsp;_qmul(q1:&nbsp;np.ndarray,&nbsp;q2:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Multiply&nbsp;two&nbsp;quaternions&nbsp;(x,&nbsp;y,&nbsp;z,&nbsp;w).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;x1,&nbsp;y1,&nbsp;z1,&nbsp;w1&nbsp;=&nbsp;q1<br>
&nbsp;&nbsp;&nbsp;&nbsp;x2,&nbsp;y2,&nbsp;z2,&nbsp;w2&nbsp;=&nbsp;q2<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*x2&nbsp;+&nbsp;x1*w2&nbsp;+&nbsp;y1*z2&nbsp;-&nbsp;z1*y2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*y2&nbsp;-&nbsp;x1*z2&nbsp;+&nbsp;y1*w2&nbsp;+&nbsp;z1*x2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*z2&nbsp;+&nbsp;x1*y2&nbsp;-&nbsp;y1*x2&nbsp;+&nbsp;z1*w2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*w2&nbsp;-&nbsp;x1*x2&nbsp;-&nbsp;y1*y2&nbsp;-&nbsp;z1*z2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;dtype=np.float32)<br>
<br>
<br>
def&nbsp;apply_blender_z_up_fix(scene_data:&nbsp;GLBSceneData)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Fix&nbsp;Blender's&nbsp;-90X&nbsp;rotation&nbsp;on&nbsp;Armature&nbsp;when&nbsp;exporting&nbsp;to&nbsp;glTF.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Blender&nbsp;applies&nbsp;-90X&nbsp;rotation&nbsp;to&nbsp;the&nbsp;Armature&nbsp;node&nbsp;during&nbsp;export.<br>
&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;function&nbsp;compensates&nbsp;by:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Rotating&nbsp;root&nbsp;bone&nbsp;(Hips)&nbsp;by&nbsp;+90&nbsp;around&nbsp;X&nbsp;(and&nbsp;its&nbsp;keyframes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Rotating&nbsp;Armature&nbsp;node&nbsp;by&nbsp;-90&nbsp;around&nbsp;X<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene_data:&nbsp;GLBSceneData&nbsp;to&nbsp;fix&nbsp;(modified&nbsp;in&nbsp;place)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;+90&nbsp;around&nbsp;X:&nbsp;quaternion&nbsp;[sin(45),&nbsp;0,&nbsp;0,&nbsp;cos(45)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;rot_pos_90_x&nbsp;=&nbsp;np.array([0.70710678,&nbsp;0.0,&nbsp;0.0,&nbsp;0.70710678],&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;-90&nbsp;around&nbsp;X:&nbsp;quaternion&nbsp;[-sin(45),&nbsp;0,&nbsp;0,&nbsp;cos(45)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;rot_neg_90_x&nbsp;=&nbsp;np.array([-0.70710678,&nbsp;0.0,&nbsp;0.0,&nbsp;0.70710678],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Rotate&nbsp;root&nbsp;nodes&nbsp;of&nbsp;scene&nbsp;by&nbsp;-90&nbsp;X<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;root_idx&nbsp;in&nbsp;scene_data.root_nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;root_idx&nbsp;&lt;&nbsp;len(scene_data.nodes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_node&nbsp;=&nbsp;scene_data.nodes[root_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_node.rotation&nbsp;=&nbsp;_qmul(rot_neg_90_x,&nbsp;root_node.rotation)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Transform&nbsp;root&nbsp;bone&nbsp;(first&nbsp;joint,&nbsp;e.g.&nbsp;Hips)&nbsp;by&nbsp;+90&nbsp;X<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;is&nbsp;a&nbsp;full&nbsp;transform:&nbsp;rotation,&nbsp;translation,&nbsp;and&nbsp;scale<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;transform_pos_90_x(pos:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Apply&nbsp;+90&nbsp;X&nbsp;rotation&nbsp;to&nbsp;position:&nbsp;(x,&nbsp;y,&nbsp;z)&nbsp;-&gt;&nbsp;(x,&nbsp;-z,&nbsp;y)&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array([pos[0],&nbsp;-pos[2],&nbsp;pos[1]],&nbsp;dtype=pos.dtype)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;transform_scale_90_x(scale:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Apply&nbsp;+90&nbsp;X&nbsp;rotation&nbsp;to&nbsp;scale:&nbsp;(sx,&nbsp;sy,&nbsp;sz)&nbsp;-&gt;&nbsp;(sx,&nbsp;sz,&nbsp;sy)&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array([scale[0],&nbsp;scale[2],&nbsp;scale[1]],&nbsp;dtype=scale.dtype)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scene_data.skins:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skin&nbsp;=&nbsp;scene_data.skins[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;skin.joint_node_indices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_bone_idx&nbsp;=&nbsp;skin.joint_node_indices[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;root_bone_idx&nbsp;&lt;&nbsp;len(scene_data.nodes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_bone_node&nbsp;=&nbsp;scene_data.nodes[root_bone_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_bone_name&nbsp;=&nbsp;root_bone_node.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_bone_node.translation&nbsp;=&nbsp;transform_pos_90_x(root_bone_node.translation)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_bone_node.rotation&nbsp;=&nbsp;_qmul(rot_pos_90_x,&nbsp;root_bone_node.rotation)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_bone_node.scale&nbsp;=&nbsp;transform_scale_90_x(root_bone_node.scale)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Transform&nbsp;root&nbsp;bone&nbsp;animation&nbsp;keyframes&nbsp;by&nbsp;+90&nbsp;X<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;anim&nbsp;in&nbsp;scene_data.animations:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;channel&nbsp;in&nbsp;anim.channels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;channel.node_name&nbsp;==&nbsp;root_bone_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.pos_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;transform_pos_90_x(key[1])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.rot_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;_qmul(rot_pos_90_x,&nbsp;key[1])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;channel.scale_keys:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key[1]&nbsp;=&nbsp;transform_scale_90_x(key[1])<br>
<br>
<br>
def&nbsp;load_glb_file_normalized(<br>
&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;str&nbsp;|&nbsp;Path,<br>
&nbsp;&nbsp;&nbsp;&nbsp;normalize_scale:&nbsp;bool&nbsp;=&nbsp;False,<br>
&nbsp;&nbsp;&nbsp;&nbsp;convert_to_z_up:&nbsp;bool&nbsp;=&nbsp;True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;blender_z_up_fix:&nbsp;bool&nbsp;=&nbsp;False,<br>
)&nbsp;-&gt;&nbsp;GLBSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Load&nbsp;GLB&nbsp;file&nbsp;with&nbsp;optional&nbsp;transformations.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;Path&nbsp;to&nbsp;.glb&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normalize_scale:&nbsp;If&nbsp;True,&nbsp;normalize&nbsp;root&nbsp;scale&nbsp;to&nbsp;1.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert_to_z_up:&nbsp;If&nbsp;True,&nbsp;convert&nbsp;from&nbsp;glTF&nbsp;Y-up&nbsp;to&nbsp;engine&nbsp;Z-up&nbsp;(default&nbsp;True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blender_z_up_fix:&nbsp;If&nbsp;True,&nbsp;compensate&nbsp;for&nbsp;Blender's&nbsp;-90X&nbsp;rotation&nbsp;on&nbsp;Armature<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GLBSceneData&nbsp;(possibly&nbsp;transformed)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;load_glb_file(path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Coordinate&nbsp;conversion&nbsp;first&nbsp;(before&nbsp;scale&nbsp;normalization)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;convert_to_z_up:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert_y_up_to_z_up(scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Blender-specific&nbsp;fix&nbsp;(after&nbsp;coordinate&nbsp;conversion)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;blender_z_up_fix:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply_blender_z_up_fix(scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normalize_scale:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normalize_glb_scale(scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene_data<br>
<br>
<br>
def&nbsp;load_glb_file_from_buffer(<br>
&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;bytes,<br>
&nbsp;&nbsp;&nbsp;&nbsp;normalize_scale:&nbsp;bool&nbsp;=&nbsp;False,<br>
&nbsp;&nbsp;&nbsp;&nbsp;convert_to_z_up:&nbsp;bool&nbsp;=&nbsp;True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;blender_z_up_fix:&nbsp;bool&nbsp;=&nbsp;False,<br>
)&nbsp;-&gt;&nbsp;GLBSceneData:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Load&nbsp;GLB&nbsp;from&nbsp;binary&nbsp;buffer&nbsp;with&nbsp;optional&nbsp;transformations.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;Binary&nbsp;GLB&nbsp;data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normalize_scale:&nbsp;If&nbsp;True,&nbsp;normalize&nbsp;root&nbsp;scale&nbsp;to&nbsp;1.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert_to_z_up:&nbsp;If&nbsp;True,&nbsp;convert&nbsp;from&nbsp;glTF&nbsp;Y-up&nbsp;to&nbsp;engine&nbsp;Z-up&nbsp;(default&nbsp;True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blender_z_up_fix:&nbsp;If&nbsp;True,&nbsp;compensate&nbsp;for&nbsp;Blender's&nbsp;-90X&nbsp;rotation&nbsp;on&nbsp;Armature<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GLBSceneData&nbsp;(possibly&nbsp;transformed)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;header<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(data)&nbsp;&lt;&nbsp;12:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;Data&nbsp;too&nbsp;small&nbsp;to&nbsp;be&nbsp;valid&nbsp;GLB&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;magic&nbsp;=&nbsp;data[0:4]<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;magic&nbsp;!=&nbsp;b&quot;glTF&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Invalid&nbsp;GLB&nbsp;magic:&nbsp;{magic}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;version,&nbsp;length&nbsp;=&nbsp;struct.unpack(&quot;&lt;II&quot;,&nbsp;data[4:12])<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;version&nbsp;!=&nbsp;2:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Unsupported&nbsp;glTF&nbsp;version:&nbsp;{version}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;chunks<br>
&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;12<br>
&nbsp;&nbsp;&nbsp;&nbsp;json_data&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;bin_data&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;offset&nbsp;&lt;&nbsp;len(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;offset&nbsp;+&nbsp;8&nbsp;&gt;&nbsp;len(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_length,&nbsp;chunk_type&nbsp;=&nbsp;struct.unpack(&quot;&lt;II&quot;,&nbsp;data[offset:offset&nbsp;+&nbsp;8])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_data&nbsp;=&nbsp;data[offset&nbsp;+&nbsp;8:offset&nbsp;+&nbsp;8&nbsp;+&nbsp;chunk_length]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;chunk_type&nbsp;==&nbsp;0x4E4F534A:&nbsp;&nbsp;#&nbsp;JSON<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json_data&nbsp;=&nbsp;chunk_data.decode(&quot;utf-8&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;chunk_type&nbsp;==&nbsp;0x004E4942:&nbsp;&nbsp;#&nbsp;BIN<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bin_data&nbsp;=&nbsp;chunk_data<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Align&nbsp;to&nbsp;4&nbsp;bytes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;+=&nbsp;8&nbsp;+&nbsp;chunk_length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;(offset&nbsp;+&nbsp;3)&nbsp;&amp;&nbsp;~3<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;json_data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;No&nbsp;JSON&nbsp;chunk&nbsp;found&nbsp;in&nbsp;GLB&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gltf&nbsp;=&nbsp;json.loads(json_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;bin_data&nbsp;=&nbsp;bin_data&nbsp;or&nbsp;b&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Parse&nbsp;scene<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene_data&nbsp;=&nbsp;GLBSceneData()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_nodes(gltf,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_materials(gltf,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_textures(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_meshes(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_skins(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;_parse_animations(gltf,&nbsp;bin_data,&nbsp;scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Coordinate&nbsp;conversion&nbsp;first&nbsp;(before&nbsp;scale&nbsp;normalization)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;convert_to_z_up:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert_y_up_to_z_up(scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Blender-specific&nbsp;fix&nbsp;(after&nbsp;coordinate&nbsp;conversion)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;blender_z_up_fix:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply_blender_z_up_fix(scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normalize_scale:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normalize_glb_scale(scene_data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene_data<br>
<!-- END SCAT CODE -->
</body>
</html>
