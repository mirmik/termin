<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/serialization/kind.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Kind&nbsp;serialization&nbsp;system.<br>
<br>
Allows&nbsp;registering&nbsp;custom&nbsp;serializers/deserializers&nbsp;for&nbsp;specific&nbsp;field&nbsp;kinds.<br>
Each&nbsp;language&nbsp;(Python,&nbsp;C++,&nbsp;Rust)&nbsp;can&nbsp;register&nbsp;its&nbsp;own&nbsp;handlers&nbsp;independently.<br>
<br>
Usage:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.serialization.kind&nbsp;import&nbsp;register_kind,&nbsp;KindRegistry<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Register&nbsp;enum&nbsp;handler<br>
&nbsp;&nbsp;&nbsp;&nbsp;@register_kind(&quot;my_enum&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;MyEnumKind:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize(obj):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{&quot;value&quot;:&nbsp;obj.value}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MyEnum(data[&quot;value&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Or&nbsp;register&nbsp;manually<br>
&nbsp;&nbsp;&nbsp;&nbsp;KindRegistry.instance().register_python(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;my_handle&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serialize=lambda&nbsp;obj:&nbsp;obj.to_dict(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialize=lambda&nbsp;data:&nbsp;MyHandle.from_dict(data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;termin._native.kind&nbsp;import&nbsp;KindRegistry&nbsp;as&nbsp;_KindRegistry<br>
<br>
<br>
class&nbsp;KindRegistry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Registry&nbsp;for&nbsp;kind&nbsp;serialization&nbsp;handlers.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;instance()&nbsp;-&gt;&nbsp;_KindRegistry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;the&nbsp;singleton&nbsp;instance.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_KindRegistry.instance()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;register_python(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serialize=None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialize=None<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Register&nbsp;Python&nbsp;handlers&nbsp;for&nbsp;a&nbsp;kind.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Kind&nbsp;name&nbsp;(e.g.,&nbsp;&quot;mesh_handle&quot;,&nbsp;&quot;my_enum&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serialize:&nbsp;callable(obj)&nbsp;-&gt;&nbsp;dict<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialize:&nbsp;callable(dict)&nbsp;-&gt;&nbsp;obj<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_KindRegistry.instance().register_python(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serialize&nbsp;or&nbsp;(lambda&nbsp;x:&nbsp;None),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialize&nbsp;or&nbsp;(lambda&nbsp;x:&nbsp;None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize(kind:&nbsp;str,&nbsp;obj):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Serialize&nbsp;object&nbsp;using&nbsp;registered&nbsp;handler.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_KindRegistry.instance().serialize(kind,&nbsp;obj)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize(kind:&nbsp;str,&nbsp;data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Deserialize&nbsp;data&nbsp;using&nbsp;registered&nbsp;handler.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_KindRegistry.instance().deserialize(kind,&nbsp;data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;kinds():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;all&nbsp;registered&nbsp;kind&nbsp;names.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_KindRegistry.instance().kinds()<br>
<br>
<br>
def&nbsp;register_kind(name:&nbsp;str):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Decorator&nbsp;to&nbsp;register&nbsp;a&nbsp;kind&nbsp;handler&nbsp;class.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;class&nbsp;should&nbsp;have&nbsp;static&nbsp;methods:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;serialize(obj)&nbsp;-&gt;&nbsp;dict<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;deserialize(dict)&nbsp;-&gt;&nbsp;obj<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Example:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@register_kind(&quot;light_type&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;LightTypeKind:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize(obj):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;obj.value&nbsp;&nbsp;#&nbsp;enum&nbsp;to&nbsp;int<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.lighting&nbsp;import&nbsp;LightType<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;LightType(data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;decorator(cls):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serialize_fn&nbsp;=&nbsp;getattr(cls,&nbsp;'serialize',&nbsp;None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialize_fn&nbsp;=&nbsp;getattr(cls,&nbsp;'deserialize',&nbsp;None)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KindRegistry.register_python(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serialize=serialize_fn,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialize=deserialize_fn<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cls<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;decorator<br>
<br>
<br>
__all__&nbsp;=&nbsp;[&quot;KindRegistry&quot;,&nbsp;&quot;register_kind&quot;]<br>
<br>
<br>
#&nbsp;============================================================================<br>
#&nbsp;Builtin&nbsp;kind&nbsp;handlers<br>
#&nbsp;============================================================================<br>
<br>
@register_kind(&quot;layer_mask&quot;)<br>
class&nbsp;LayerMaskKind:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Handler&nbsp;for&nbsp;layer_mask&nbsp;kind&nbsp;(64-bit&nbsp;unsigned&nbsp;int&nbsp;as&nbsp;hex&nbsp;string).&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize(obj):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Serialize&nbsp;as&nbsp;hex&nbsp;string&nbsp;to&nbsp;handle&nbsp;values&nbsp;&gt;&nbsp;int64_t&nbsp;max<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(obj,&nbsp;str):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;obj&nbsp;&nbsp;#&nbsp;Already&nbsp;serialized<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hex(obj)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(data,&nbsp;str):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;int(data,&nbsp;16)&nbsp;if&nbsp;data.startswith(&quot;0x&quot;)&nbsp;else&nbsp;int(data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;int(data)<br>
<br>
<br>
@register_kind(&quot;navmesh_handle&quot;)<br>
class&nbsp;NavMeshHandleKind:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Handler&nbsp;for&nbsp;navmesh_handle&nbsp;kind.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize(obj):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.assets.navmesh_handle&nbsp;import&nbsp;NavMeshHandle<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(obj,&nbsp;NavMeshHandle):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;obj.serialize()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize(data):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.assets.navmesh_handle&nbsp;import&nbsp;NavMeshHandle<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(data,&nbsp;dict):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NavMeshHandle.deserialize(data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NavMeshHandle()<br>
<!-- END SCAT CODE -->
</body>
</html>
