<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/nodegraph/compiler.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Graph&nbsp;compiler&nbsp;-&nbsp;converts&nbsp;node&nbsp;graph&nbsp;to&nbsp;RenderPipeline.<br>
<br>
Responsibilities:<br>
-&nbsp;Generate&nbsp;unique&nbsp;resource&nbsp;names&nbsp;for&nbsp;connections<br>
-&nbsp;Resolve&nbsp;input/output&nbsp;resource&nbsp;mappings<br>
-&nbsp;Create&nbsp;FramePass&nbsp;instances&nbsp;with&nbsp;correct&nbsp;parameters<br>
-&nbsp;Infer&nbsp;ResourceSpec&nbsp;from&nbsp;FBO&nbsp;nodes&nbsp;and&nbsp;pass&nbsp;types<br>
-&nbsp;Assign&nbsp;viewport_name&nbsp;from&nbsp;ViewportFrames&nbsp;to&nbsp;contained&nbsp;passes<br>
-&nbsp;Topological&nbsp;sort&nbsp;and&nbsp;pipeline&nbsp;assembly<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;Any,&nbsp;Dict,&nbsp;List,&nbsp;Optional,&nbsp;Set,&nbsp;Tuple<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.scene&nbsp;import&nbsp;NodeGraphScene<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.node&nbsp;import&nbsp;GraphNode<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.connection&nbsp;import&nbsp;NodeConnection<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.socket&nbsp;import&nbsp;NodeSocket<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.viewport_frame&nbsp;import&nbsp;ViewportFrame<br>
<br>
<br>
class&nbsp;CompileError(Exception):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Error&nbsp;during&nbsp;graph&nbsp;compilation.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
<br>
def&nbsp;find_containing_frame(<br>
&nbsp;&nbsp;&nbsp;&nbsp;node:&nbsp;&quot;GraphNode&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport_frames:&nbsp;List[&quot;ViewportFrame&quot;],<br>
)&nbsp;-&gt;&nbsp;Optional[&quot;ViewportFrame&quot;]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Find&nbsp;the&nbsp;ViewportFrame&nbsp;that&nbsp;contains&nbsp;a&nbsp;node.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;node&nbsp;is&nbsp;considered&nbsp;&quot;inside&quot;&nbsp;a&nbsp;frame&nbsp;if&nbsp;its&nbsp;center&nbsp;is&nbsp;within&nbsp;the&nbsp;frame&nbsp;bounds.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ViewportFrame&nbsp;containing&nbsp;the&nbsp;node,&nbsp;or&nbsp;None&nbsp;if&nbsp;outside&nbsp;all&nbsp;frames.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;viewport_frames:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_rect&nbsp;=&nbsp;node.sceneBoundingRect()<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_center&nbsp;=&nbsp;node_rect.center()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;frame&nbsp;in&nbsp;viewport_frames:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame_rect&nbsp;=&nbsp;frame.sceneBoundingRect()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;frame_rect.contains(node_center):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;frame<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;build_node_viewport_map(<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes:&nbsp;List[&quot;GraphNode&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport_frames:&nbsp;List[&quot;ViewportFrame&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;debug:&nbsp;bool&nbsp;=&nbsp;False,<br>
)&nbsp;-&gt;&nbsp;Dict[&quot;GraphNode&quot;,&nbsp;str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Build&nbsp;a&nbsp;mapping&nbsp;from&nbsp;nodes&nbsp;to&nbsp;their&nbsp;viewport&nbsp;names.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dict&nbsp;mapping&nbsp;each&nbsp;node&nbsp;to&nbsp;its&nbsp;viewport_name&nbsp;(empty&nbsp;string&nbsp;if&nbsp;no&nbsp;frame).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;result:&nbsp;Dict[&quot;GraphNode&quot;,&nbsp;str]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;=&nbsp;find_containing_frame(node,&nbsp;viewport_frames)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;frame:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[node]&nbsp;=&nbsp;frame.viewport_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[node]&nbsp;=&nbsp;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;debug:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_rect&nbsp;=&nbsp;node.sceneBoundingRect()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;Node&nbsp;{node.title}:&nbsp;center=({node_rect.center().x():.0f},&nbsp;{node_rect.center().y():.0f})&nbsp;-&gt;&nbsp;viewport={result[node]&nbsp;or&nbsp;'(none)'}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;vf&nbsp;in&nbsp;viewport_frames:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vf_rect&nbsp;=&nbsp;vf.sceneBoundingRect()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;Frame&nbsp;'{vf.viewport_name}':&nbsp;({vf_rect.x():.0f},&nbsp;{vf_rect.y():.0f},&nbsp;{vf_rect.width():.0f}x{vf_rect.height():.0f})&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
<br>
def&nbsp;generate_resource_name(node:&nbsp;&quot;GraphNode&quot;,&nbsp;socket:&nbsp;&quot;NodeSocket&quot;,&nbsp;node_index:&nbsp;int)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Generate&nbsp;unique&nbsp;resource&nbsp;name&nbsp;for&nbsp;a&nbsp;socket.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;FBO&nbsp;resource&nbsp;nodes:&nbsp;use&nbsp;the&nbsp;configured&nbsp;name&nbsp;directly.<br>
&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;other&nbsp;nodes:&nbsp;&quot;{node_name}_{socket_name}&quot;&nbsp;or&nbsp;&quot;{node_type}_{index}_{socket_name}&quot;.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;FBO&nbsp;resource&nbsp;nodes&nbsp;use&nbsp;their&nbsp;instance&nbsp;name&nbsp;(from&nbsp;header)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.node_type&nbsp;==&nbsp;&quot;resource&quot;&nbsp;and&nbsp;node.data.get(&quot;resource_type&quot;)&nbsp;==&nbsp;&quot;fbo&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;node.name&nbsp;(instance&nbsp;name&nbsp;shown&nbsp;in&nbsp;header),&nbsp;not&nbsp;the&nbsp;&quot;name&quot;&nbsp;parameter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;node.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;no&nbsp;instance&nbsp;name,&nbsp;fall&nbsp;back&nbsp;to&nbsp;indexed&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;f&quot;fbo_{node_index}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;=&nbsp;node.name.replace(&quot;&nbsp;&quot;,&nbsp;&quot;_&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;=&nbsp;f&quot;{node.title}_{node_index}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;f&quot;{base}_{socket.name}&quot;<br>
<br>
<br>
def&nbsp;resolve_resource_names(<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes:&nbsp;List[&quot;GraphNode&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;connections:&nbsp;List[&quot;NodeConnection&quot;],<br>
)&nbsp;-&gt;&nbsp;Tuple[Dict[&quot;NodeSocket&quot;,&nbsp;str],&nbsp;Dict[str,&nbsp;str],&nbsp;Dict[str,&nbsp;str]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Assign&nbsp;resource&nbsp;names&nbsp;to&nbsp;all&nbsp;sockets&nbsp;based&nbsp;on&nbsp;connections.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Rules:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Connected&nbsp;sockets&nbsp;share&nbsp;the&nbsp;same&nbsp;resource&nbsp;name&nbsp;(from&nbsp;output&nbsp;socket)<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Unconnected&nbsp;output&nbsp;sockets&nbsp;get&nbsp;auto-generated&nbsp;names<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Unconnected&nbsp;input&nbsp;sockets&nbsp;get&nbsp;&quot;empty&quot;&nbsp;or&nbsp;special&nbsp;defaults<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Target&nbsp;sockets&nbsp;(X_target)&nbsp;create&nbsp;aliases&nbsp;between&nbsp;output&nbsp;and&nbsp;FBO<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tuple&nbsp;of:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Dict&nbsp;mapping&nbsp;each&nbsp;socket&nbsp;to&nbsp;its&nbsp;resource&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Dict&nbsp;mapping&nbsp;resource&nbsp;name&nbsp;to&nbsp;socket&nbsp;type&nbsp;(&quot;fbo&quot;,&nbsp;&quot;shadow&quot;,&nbsp;etc.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Dict&nbsp;mapping&nbsp;output_res&nbsp;name&nbsp;to&nbsp;FBO&nbsp;name&nbsp;(aliases&nbsp;from&nbsp;_target&nbsp;connections)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;node&nbsp;index&nbsp;map<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_to_index&nbsp;=&nbsp;{node:&nbsp;i&nbsp;for&nbsp;i,&nbsp;node&nbsp;in&nbsp;enumerate(nodes)}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Result:&nbsp;socket&nbsp;-&gt;&nbsp;resource_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;socket_names:&nbsp;Dict[&quot;NodeSocket&quot;,&nbsp;str]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Track&nbsp;resource&nbsp;types:&nbsp;resource_name&nbsp;-&gt;&nbsp;socket_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_types:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Track&nbsp;target&nbsp;aliases:&nbsp;output_res_name&nbsp;-&gt;&nbsp;fbo_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;target_aliases:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;First&nbsp;pass:&nbsp;assign&nbsp;names&nbsp;to&nbsp;all&nbsp;output&nbsp;sockets<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;node_to_index[node]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.output_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;generate_resource_name(node,&nbsp;socket,&nbsp;idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket_names[socket]&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_types[name]&nbsp;=&nbsp;socket.socket_type<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Second&nbsp;pass:&nbsp;initial&nbsp;propagation&nbsp;to&nbsp;get&nbsp;_target&nbsp;input&nbsp;names<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(We&nbsp;need&nbsp;to&nbsp;know&nbsp;what&nbsp;FBO&nbsp;is&nbsp;connected&nbsp;to&nbsp;_target&nbsp;before&nbsp;we&nbsp;can&nbsp;override&nbsp;output)<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;conn&nbsp;in&nbsp;connections:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;conn.start_socket&nbsp;is&nbsp;None&nbsp;or&nbsp;conn.end_socket&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_socket&nbsp;=&nbsp;conn.start_socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_socket&nbsp;=&nbsp;conn.end_socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;output_socket&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket_names[input_socket]&nbsp;=&nbsp;socket_names[output_socket]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Third&nbsp;pass:&nbsp;handle&nbsp;_target&nbsp;connections<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;When&nbsp;output_res_target&nbsp;is&nbsp;connected&nbsp;to&nbsp;an&nbsp;FBO,&nbsp;the&nbsp;output_res&nbsp;socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;should&nbsp;use&nbsp;the&nbsp;FBO's&nbsp;name&nbsp;instead&nbsp;of&nbsp;the&nbsp;auto-generated&nbsp;name.<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;map&nbsp;of&nbsp;output&nbsp;sockets&nbsp;by&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_socket_map:&nbsp;Dict[str,&nbsp;&quot;NodeSocket&quot;]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.output_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_socket_map[socket.name]&nbsp;=&nbsp;socket<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.input_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;socket.name.endswith(&quot;_target&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;this&nbsp;target&nbsp;is&nbsp;connected<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;socket&nbsp;not&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;the&nbsp;corresponding&nbsp;output&nbsp;socket&nbsp;name&nbsp;(remove&nbsp;_target&nbsp;suffix)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_name&nbsp;=&nbsp;socket.name[:-7]&nbsp;&nbsp;#&nbsp;len(&quot;_target&quot;)&nbsp;==&nbsp;7<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_socket&nbsp;=&nbsp;output_socket_map.get(output_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;output_socket&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;FBO&nbsp;name&nbsp;from&nbsp;the&nbsp;target&nbsp;connection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo_name&nbsp;=&nbsp;socket_names[socket]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Store&nbsp;the&nbsp;old&nbsp;output&nbsp;name&nbsp;for&nbsp;the&nbsp;alias<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old_output_name&nbsp;=&nbsp;socket_names.get(output_socket)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;old_output_name&nbsp;and&nbsp;fbo_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target_aliases[old_output_name]&nbsp;=&nbsp;fbo_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Update&nbsp;output&nbsp;socket&nbsp;to&nbsp;use&nbsp;the&nbsp;FBO&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;makes&nbsp;the&nbsp;pass&nbsp;output&nbsp;to&nbsp;the&nbsp;connected&nbsp;FBO&nbsp;resource<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket_names[output_socket]&nbsp;=&nbsp;fbo_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fourth&nbsp;pass:&nbsp;re-propagate&nbsp;names&nbsp;through&nbsp;connections<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Now&nbsp;that&nbsp;_target&nbsp;overrides&nbsp;are&nbsp;applied,&nbsp;downstream&nbsp;sockets&nbsp;get&nbsp;the&nbsp;correct&nbsp;names<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;conn&nbsp;in&nbsp;connections:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;conn.start_socket&nbsp;is&nbsp;None&nbsp;or&nbsp;conn.end_socket&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_socket&nbsp;=&nbsp;conn.start_socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_socket&nbsp;=&nbsp;conn.end_socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;output_socket&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket_names[input_socket]&nbsp;=&nbsp;socket_names[output_socket]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fifth&nbsp;pass:&nbsp;assign&nbsp;default&nbsp;names&nbsp;to&nbsp;unconnected&nbsp;input&nbsp;sockets<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;node_to_index[node]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.input_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;socket&nbsp;not&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Unconnected&nbsp;input&nbsp;-&nbsp;use&nbsp;&quot;empty&quot;&nbsp;prefix&nbsp;for&nbsp;auto-creation<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;f&quot;empty_{node.title}_{idx}_{socket.name}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket_names[socket]&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_types[name]&nbsp;=&nbsp;socket.socket_type<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;socket_names,&nbsp;resource_types,&nbsp;target_aliases<br>
<br>
<br>
def&nbsp;get_socket_resource_params(node:&nbsp;&quot;GraphNode&quot;,&nbsp;socket_names:&nbsp;Dict[&quot;NodeSocket&quot;,&nbsp;str])&nbsp;-&gt;&nbsp;Dict[str,&nbsp;str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;resource&nbsp;name&nbsp;parameters&nbsp;for&nbsp;a&nbsp;pass&nbsp;node.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Maps&nbsp;socket&nbsp;names&nbsp;to&nbsp;constructor&nbsp;parameter&nbsp;names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;input_res,&nbsp;output_res,&nbsp;shadow_res,&nbsp;etc.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;params&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.input_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;socket&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Socket&nbsp;name&nbsp;like&nbsp;&quot;input_res&quot;&nbsp;or&nbsp;&quot;shadow_res&quot;&nbsp;maps&nbsp;directly&nbsp;to&nbsp;param<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param_name&nbsp;=&nbsp;socket.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skip&nbsp;target&nbsp;sockets&nbsp;-&nbsp;they're&nbsp;just&nbsp;for&nbsp;UI&nbsp;visualization<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;param_name.endswith(&quot;_target&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params[param_name]&nbsp;=&nbsp;socket_names[socket]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.output_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;socket&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params[socket.name]&nbsp;=&nbsp;socket_names[socket]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;params<br>
<br>
<br>
def&nbsp;infer_resource_spec(<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_name:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbo_nodes:&nbsp;Dict[str,&nbsp;&quot;GraphNode&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;connected_passes:&nbsp;List[str],<br>
)&nbsp;-&gt;&nbsp;Dict[str,&nbsp;Any]&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Infer&nbsp;ResourceSpec&nbsp;parameters&nbsp;for&nbsp;a&nbsp;resource.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Priority:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Explicit&nbsp;FBO&nbsp;node&nbsp;with&nbsp;settings<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Heuristics&nbsp;based&nbsp;on&nbsp;connected&nbsp;pass&nbsp;types<br>
&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Defaults<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dict&nbsp;with&nbsp;ResourceSpec&nbsp;parameters,&nbsp;or&nbsp;None&nbsp;if&nbsp;defaults&nbsp;are&nbsp;OK.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;there's&nbsp;an&nbsp;FBO&nbsp;node&nbsp;providing&nbsp;this&nbsp;resource<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;resource_name&nbsp;in&nbsp;fbo_nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;=&nbsp;fbo_nodes[resource_name]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec&nbsp;=&nbsp;{&quot;resource&quot;:&nbsp;resource_name}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;parameters&nbsp;from&nbsp;FBO&nbsp;node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;=&nbsp;node.get_param(&quot;format&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fmt:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;format&quot;]&nbsp;=&nbsp;fmt<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;samples&nbsp;=&nbsp;node.get_param(&quot;samples&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;samples:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;samples&quot;]&nbsp;=&nbsp;int(samples)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ValueError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_mode&nbsp;=&nbsp;node.get_param(&quot;filter&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;filter_mode:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.render&nbsp;import&nbsp;TextureFilter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;filter&quot;]&nbsp;=&nbsp;TextureFilter.NEAREST&nbsp;if&nbsp;filter_mode&nbsp;==&nbsp;&quot;nearest&quot;&nbsp;else&nbsp;TextureFilter.LINEAR<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Size&nbsp;mode:&nbsp;viewport&nbsp;or&nbsp;fixed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_mode&nbsp;=&nbsp;node.get_param(&quot;size_mode&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;size_mode&nbsp;==&nbsp;&quot;fixed&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;explicit&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width&nbsp;=&nbsp;node.get_param(&quot;width&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height&nbsp;=&nbsp;node.get_param(&quot;height&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;width&nbsp;and&nbsp;height:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;size&quot;]&nbsp;=&nbsp;(int(width),&nbsp;int(height))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ValueError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Viewport&nbsp;mode&nbsp;-&nbsp;use&nbsp;scale<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale&nbsp;=&nbsp;node.get_param(&quot;scale&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scale:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale_value&nbsp;=&nbsp;float(scale)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;scale_value&nbsp;!=&nbsp;1.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;scale&quot;]&nbsp;=&nbsp;scale_value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ValueError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;color<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.get_param(&quot;clear_color&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;=&nbsp;node.get_param(&quot;clear_color_r&quot;)&nbsp;or&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;node.get_param(&quot;clear_color_g&quot;)&nbsp;or&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;node.get_param(&quot;clear_color_b&quot;)&nbsp;or&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;node.get_param(&quot;clear_color_a&quot;)&nbsp;or&nbsp;1.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;clear_color&quot;]&nbsp;=&nbsp;(float(r),&nbsp;float(g),&nbsp;float(b),&nbsp;float(a))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;depth<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.get_param(&quot;clear_depth&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_value&nbsp;=&nbsp;node.get_param(&quot;clear_depth_value&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;depth_value&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;clear_depth&quot;]&nbsp;=&nbsp;float(depth_value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;clear_depth&quot;]&nbsp;=&nbsp;1.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;spec<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Heuristics&nbsp;based&nbsp;on&nbsp;pass&nbsp;types<br>
&nbsp;&nbsp;&nbsp;&nbsp;hdr_passes&nbsp;=&nbsp;{&quot;PostProcessPass&quot;,&nbsp;&quot;BloomPass&quot;,&nbsp;&quot;TonemapPass&quot;,&nbsp;&quot;ColorPass&quot;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;msaa_passes&nbsp;=&nbsp;{&quot;ColorPass&quot;,&nbsp;&quot;DepthPass&quot;,&nbsp;&quot;SkyBoxPass&quot;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;needs_hdr&nbsp;=&nbsp;any(p&nbsp;in&nbsp;hdr_passes&nbsp;for&nbsp;p&nbsp;in&nbsp;connected_passes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;needs_msaa&nbsp;=&nbsp;any(p&nbsp;in&nbsp;msaa_passes&nbsp;for&nbsp;p&nbsp;in&nbsp;connected_passes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;needs_hdr&nbsp;or&nbsp;needs_msaa:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec&nbsp;=&nbsp;{&quot;resource&quot;:&nbsp;resource_name}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;needs_hdr:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;format&quot;]&nbsp;=&nbsp;&quot;rgba16f&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;needs_msaa:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec[&quot;samples&quot;]&nbsp;=&nbsp;4<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;spec<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
def&nbsp;collect_fbo_nodes(<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes:&nbsp;List[&quot;GraphNode&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;socket_names:&nbsp;Dict[&quot;NodeSocket&quot;,&nbsp;str],<br>
)&nbsp;-&gt;&nbsp;Dict[str,&nbsp;&quot;GraphNode&quot;]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Collect&nbsp;FBO&nbsp;resource&nbsp;nodes&nbsp;and&nbsp;map&nbsp;by&nbsp;their&nbsp;socket&nbsp;names.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Uses&nbsp;socket_names&nbsp;to&nbsp;get&nbsp;the&nbsp;actual&nbsp;resource&nbsp;name&nbsp;used&nbsp;in&nbsp;the&nbsp;pipeline,<br>
&nbsp;&nbsp;&nbsp;&nbsp;not&nbsp;the&nbsp;user-defined&nbsp;&quot;name&quot;&nbsp;parameter.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbo_nodes&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.node_type&nbsp;!=&nbsp;&quot;resource&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.data.get(&quot;resource_type&quot;)&nbsp;!=&nbsp;&quot;fbo&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;resource&nbsp;name&nbsp;from&nbsp;output&nbsp;socket&nbsp;(same&nbsp;as&nbsp;used&nbsp;in&nbsp;pipeline)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.output_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;socket&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo_nodes[socket_names[socket]]&nbsp;=&nbsp;node<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fbo_nodes<br>
<br>
<br>
def&nbsp;create_pass_instance(<br>
&nbsp;&nbsp;&nbsp;&nbsp;node:&nbsp;&quot;GraphNode&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_params:&nbsp;Dict[str,&nbsp;str],<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport_name:&nbsp;str&nbsp;=&nbsp;&quot;&quot;,<br>
)&nbsp;-&gt;&nbsp;Any:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;a&nbsp;FramePass&nbsp;instance&nbsp;from&nbsp;a&nbsp;graph&nbsp;node.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Creates&nbsp;pass&nbsp;via&nbsp;default&nbsp;constructor,&nbsp;then&nbsp;sets&nbsp;properties&nbsp;as&nbsp;attributes.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Works&nbsp;uniformly&nbsp;for&nbsp;Python&nbsp;and&nbsp;C++&nbsp;(nanobind)&nbsp;pass&nbsp;classes.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node:&nbsp;Graph&nbsp;node&nbsp;with&nbsp;pass_class&nbsp;in&nbsp;data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_params:&nbsp;Dict&nbsp;of&nbsp;resource&nbsp;name&nbsp;parameters&nbsp;(input_res,&nbsp;output_res,&nbsp;etc.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewport_name:&nbsp;Viewport&nbsp;name&nbsp;from&nbsp;containing&nbsp;ViewportFrame&nbsp;(empty&nbsp;=&nbsp;offscreen)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FramePass&nbsp;instance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.pass_registry&nbsp;import&nbsp;get_pass_class<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;class_name&nbsp;=&nbsp;node.data.get(&quot;pass_class&quot;,&nbsp;node.title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass_cls&nbsp;=&nbsp;get_pass_class(class_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;pass_cls&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;CompileError(f&quot;Unknown&nbsp;pass&nbsp;class:&nbsp;{class_name}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;instance&nbsp;via&nbsp;default&nbsp;constructor<br>
&nbsp;&nbsp;&nbsp;&nbsp;instance&nbsp;=&nbsp;pass_cls()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;pass_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;new_pass_name&nbsp;=&nbsp;node.name&nbsp;if&nbsp;node.name&nbsp;else&nbsp;node.title<br>
&nbsp;&nbsp;&nbsp;&nbsp;instance.pass_name&nbsp;=&nbsp;new_pass_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Also&nbsp;sync&nbsp;tc_pass&nbsp;name&nbsp;for&nbsp;Python&nbsp;passes<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;hasattr(instance,&nbsp;&quot;_tc_pass_handle&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance._tc_pass_handle.pass_name&nbsp;=&nbsp;new_pass_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Known&nbsp;resource&nbsp;params&nbsp;for&nbsp;standard&nbsp;passes<br>
&nbsp;&nbsp;&nbsp;&nbsp;known_resource_params&nbsp;=&nbsp;{&quot;input_res&quot;,&nbsp;&quot;output_res&quot;,&nbsp;&quot;shadow_res&quot;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;resource&nbsp;parameters<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key,&nbsp;value&nbsp;in&nbsp;resource_params.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;==&nbsp;&quot;viewport_name&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;in&nbsp;known_resource_params:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setattr(instance,&nbsp;key,&nbsp;value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;AttributeError&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;[compiler]&nbsp;setattr({class_name},&nbsp;{key},&nbsp;{value!r})&nbsp;failed:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Dynamic&nbsp;input&nbsp;-&nbsp;add&nbsp;as&nbsp;extra&nbsp;texture&nbsp;if&nbsp;supported<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;hasattr(instance,&nbsp;&quot;add_extra_texture&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.add_extra_texture(key,&nbsp;value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;UI&nbsp;parameters&nbsp;from&nbsp;node<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;param&nbsp;in&nbsp;node._params:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;=&nbsp;node._param_values.get(param.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;value&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;param.name&nbsp;not&nbsp;in&nbsp;resource_params:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setattr(instance,&nbsp;param.name,&nbsp;value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;AttributeError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass&nbsp;&nbsp;#&nbsp;Ignore&nbsp;unknown&nbsp;attributes<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;viewport_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;viewport_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.viewport_name&nbsp;=&nbsp;viewport_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;instance<br>
<br>
<br>
def&nbsp;build_canonical_resource_map(passes:&nbsp;List[Any])&nbsp;-&gt;&nbsp;Dict[str,&nbsp;str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Build&nbsp;a&nbsp;map&nbsp;from&nbsp;resource&nbsp;names&nbsp;to&nbsp;their&nbsp;canonical&nbsp;names.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Inplace&nbsp;passes&nbsp;create&nbsp;aliases:&nbsp;input&nbsp;and&nbsp;output&nbsp;refer&nbsp;to&nbsp;the&nbsp;same&nbsp;FBO.<br>
&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;need&nbsp;to&nbsp;track&nbsp;these&nbsp;and&nbsp;use&nbsp;only&nbsp;canonical&nbsp;names&nbsp;for&nbsp;ResourceSpecs.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dict&nbsp;mapping&nbsp;each&nbsp;resource&nbsp;name&nbsp;to&nbsp;its&nbsp;canonical&nbsp;name.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;canonical:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;p&nbsp;in&nbsp;passes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;inplace&nbsp;aliases&nbsp;from&nbsp;the&nbsp;pass<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace_aliases&nbsp;=&nbsp;p.get_inplace_aliases()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;src,&nbsp;dst&nbsp;in&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;canonical&nbsp;name&nbsp;for&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src_canon&nbsp;=&nbsp;canonical.get(src,&nbsp;src)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Assign&nbsp;same&nbsp;canonical&nbsp;to&nbsp;destination<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical[dst]&nbsp;=&nbsp;src_canon<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Also&nbsp;ensure&nbsp;source&nbsp;points&nbsp;to&nbsp;canonical<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical[src]&nbsp;=&nbsp;src_canon<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;canonical<br>
<br>
<br>
def&nbsp;compile_graph(scene:&nbsp;&quot;NodeGraphScene&quot;,&nbsp;debug:&nbsp;bool&nbsp;=&nbsp;False)&nbsp;-&gt;&nbsp;&quot;RenderPipeline&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Compile&nbsp;a&nbsp;node&nbsp;graph&nbsp;into&nbsp;a&nbsp;RenderPipeline.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Steps:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Collect&nbsp;pass&nbsp;nodes,&nbsp;FBO&nbsp;nodes,&nbsp;and&nbsp;viewport&nbsp;frames<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Build&nbsp;node-to-viewport&nbsp;mapping<br>
&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Resolve&nbsp;resource&nbsp;names&nbsp;from&nbsp;connections<br>
&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;Create&nbsp;pass&nbsp;instances&nbsp;with&nbsp;viewport_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;Use&nbsp;FrameGraph&nbsp;for&nbsp;topological&nbsp;sort<br>
&nbsp;&nbsp;&nbsp;&nbsp;6.&nbsp;Build&nbsp;canonical&nbsp;resource&nbsp;map&nbsp;(for&nbsp;inplace&nbsp;aliases)<br>
&nbsp;&nbsp;&nbsp;&nbsp;7.&nbsp;Infer&nbsp;ResourceSpecs&nbsp;with&nbsp;viewport_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;8.&nbsp;Assemble&nbsp;RenderPipeline<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene:&nbsp;NodeGraphScene&nbsp;to&nbsp;compile<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debug:&nbsp;Print&nbsp;debug&nbsp;info&nbsp;about&nbsp;viewport&nbsp;containment<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RenderPipeline&nbsp;ready&nbsp;for&nbsp;use<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.framegraph&nbsp;import&nbsp;RenderPipeline<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.framegraph.resource_spec&nbsp;import&nbsp;ResourceSpec<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.framegraph.core&nbsp;import&nbsp;FrameGraph<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes&nbsp;=&nbsp;scene.get_nodes()<br>
&nbsp;&nbsp;&nbsp;&nbsp;connections&nbsp;=&nbsp;scene.get_connections()<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport_frames&nbsp;=&nbsp;scene.get_viewport_frames()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Separate&nbsp;node&nbsp;types<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass_nodes&nbsp;=&nbsp;[n&nbsp;for&nbsp;n&nbsp;in&nbsp;nodes&nbsp;if&nbsp;n.node_type&nbsp;in&nbsp;(&quot;pass&quot;,&nbsp;&quot;effect&quot;)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;pass_nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;RenderPipeline(name=&quot;empty&quot;,&nbsp;_init_specs=[])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;node&nbsp;to&nbsp;viewport&nbsp;mapping<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_viewport_map&nbsp;=&nbsp;build_node_viewport_map(nodes,&nbsp;viewport_frames,&nbsp;debug=debug)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Resolve&nbsp;resource&nbsp;names,&nbsp;types,&nbsp;and&nbsp;target&nbsp;aliases<br>
&nbsp;&nbsp;&nbsp;&nbsp;socket_names,&nbsp;resource_types,&nbsp;target_aliases&nbsp;=&nbsp;resolve_resource_names(nodes,&nbsp;connections)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Collect&nbsp;FBO&nbsp;nodes&nbsp;mapped&nbsp;by&nbsp;their&nbsp;socket&nbsp;names<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbo_nodes_map&nbsp;=&nbsp;collect_fbo_nodes(nodes,&nbsp;socket_names)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;debug:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;DEBUG:&nbsp;fbo_nodes_map&nbsp;keys&nbsp;=&nbsp;{list(fbo_nodes_map.keys())}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;resource&nbsp;to&nbsp;viewport&nbsp;mapping&nbsp;from&nbsp;FBO&nbsp;nodes&nbsp;positions<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(viewport_name&nbsp;is&nbsp;determined&nbsp;by&nbsp;which&nbsp;ViewportFrame&nbsp;contains&nbsp;the&nbsp;FBO&nbsp;node)<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_to_viewport:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.node_type&nbsp;==&nbsp;&quot;resource&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;the&nbsp;resource&nbsp;name&nbsp;from&nbsp;the&nbsp;FBO&nbsp;node's&nbsp;output&nbsp;socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;socket&nbsp;in&nbsp;node.output_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;socket&nbsp;in&nbsp;socket_names:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res_name&nbsp;=&nbsp;socket_names[socket]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewport_name&nbsp;=&nbsp;node_viewport_map.get(node,&nbsp;&quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_to_viewport[res_name]&nbsp;=&nbsp;viewport_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;pass&nbsp;instances<br>
&nbsp;&nbsp;&nbsp;&nbsp;passes&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;resource_to_passes:&nbsp;Dict[str,&nbsp;List[str]]&nbsp;=&nbsp;{}&nbsp;&nbsp;#&nbsp;For&nbsp;spec&nbsp;inference<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node&nbsp;in&nbsp;pass_nodes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_params&nbsp;=&nbsp;get_socket_resource_params(node,&nbsp;socket_names)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewport_name&nbsp;=&nbsp;node_viewport_map.get(node,&nbsp;&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_instance&nbsp;=&nbsp;create_pass_instance(node,&nbsp;resource_params,&nbsp;viewport_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passes.append(pass_instance)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Track&nbsp;which&nbsp;passes&nbsp;use&nbsp;which&nbsp;resources<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class_name&nbsp;=&nbsp;node.data.get(&quot;pass_class&quot;,&nbsp;node.title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res_name&nbsp;in&nbsp;resource_params.values():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_to_passes.setdefault(res_name,&nbsp;[]).append(class_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;CompileError&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;Warning:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;FrameGraph&nbsp;for&nbsp;topological&nbsp;sort<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame_graph&nbsp;=&nbsp;FrameGraph(passes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_passes&nbsp;=&nbsp;frame_graph.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;canonical&nbsp;resource&nbsp;names&nbsp;from&nbsp;FrameGraph<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical_map&nbsp;=&nbsp;frame_graph._canonical_resources<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;Warning:&nbsp;Topological&nbsp;sort&nbsp;failed:&nbsp;{e},&nbsp;using&nbsp;original&nbsp;order&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_passes&nbsp;=&nbsp;passes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;our&nbsp;own&nbsp;canonical&nbsp;map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical_map&nbsp;=&nbsp;build_canonical_resource_map(passes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Infer&nbsp;ResourceSpecs&nbsp;only&nbsp;for&nbsp;canonical&nbsp;FBO&nbsp;resources<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skip&nbsp;shadow&nbsp;maps&nbsp;and&nbsp;other&nbsp;non-FBO&nbsp;resource&nbsp;types<br>
&nbsp;&nbsp;&nbsp;&nbsp;pipeline_specs&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;seen_canonical:&nbsp;Set[str]&nbsp;=&nbsp;set()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res_name,&nbsp;pass_classes&nbsp;in&nbsp;resource_to_passes.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skip&nbsp;non-FBO&nbsp;resources&nbsp;(shadow&nbsp;maps,&nbsp;etc.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res_type&nbsp;=&nbsp;resource_types.get(res_name,&nbsp;&quot;fbo&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;res_type&nbsp;!=&nbsp;&quot;fbo&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;canonical&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canon_name&nbsp;=&nbsp;canonical_map.get(res_name,&nbsp;res_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;canon_name&nbsp;in&nbsp;seen_canonical:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seen_canonical.add(canon_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;this&nbsp;resource&nbsp;has&nbsp;a&nbsp;_target&nbsp;alias&nbsp;to&nbsp;an&nbsp;FBO<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;so,&nbsp;use&nbsp;the&nbsp;FBO's&nbsp;name&nbsp;for&nbsp;ResourceSpec&nbsp;(input&nbsp;name&nbsp;of&nbsp;the&nbsp;resource)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;The&nbsp;output_res&nbsp;name&nbsp;is&nbsp;the&nbsp;&quot;output&nbsp;name&quot;&nbsp;used&nbsp;by&nbsp;downstream&nbsp;passes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo_name&nbsp;=&nbsp;target_aliases.get(res_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fbo_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Resource&nbsp;has&nbsp;FBO&nbsp;via&nbsp;_target&nbsp;-&nbsp;use&nbsp;FBO&nbsp;name&nbsp;for&nbsp;spec<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec_params&nbsp;=&nbsp;infer_resource_spec(fbo_name,&nbsp;fbo_nodes_map,&nbsp;pass_classes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;No&nbsp;_target&nbsp;connection&nbsp;-&nbsp;use&nbsp;auto-generated&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec_params&nbsp;=&nbsp;infer_resource_spec(canon_name,&nbsp;fbo_nodes_map,&nbsp;pass_classes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;debug:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;DEBUG:&nbsp;res_name={res_name},&nbsp;canon_name={canon_name},&nbsp;fbo_name={fbo_name},&nbsp;spec_params={spec_params}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;spec_params:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Add&nbsp;viewport_name&nbsp;to&nbsp;spec&nbsp;-&nbsp;check&nbsp;both&nbsp;the&nbsp;resource&nbsp;and&nbsp;its&nbsp;FBO&nbsp;alias<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewport_name&nbsp;=&nbsp;resource_to_viewport.get(res_name,&nbsp;&quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;viewport_name&nbsp;and&nbsp;fbo_name&nbsp;and&nbsp;fbo_name&nbsp;in&nbsp;resource_to_viewport:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewport_name&nbsp;=&nbsp;resource_to_viewport[fbo_name]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;viewport_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec_params[&quot;viewport_name&quot;]&nbsp;=&nbsp;viewport_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec&nbsp;=&nbsp;ResourceSpec(**spec_params)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pipeline_specs.append(spec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.error(f&quot;Failed&nbsp;to&nbsp;create&nbsp;ResourceSpec:&nbsp;{e},&nbsp;params={spec_params}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;RenderPipeline(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;compiled_graph&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_init_passes=sorted_passes,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_init_specs=pipeline_specs,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
def&nbsp;compile_graph_to_dict(scene:&nbsp;&quot;NodeGraphScene&quot;,&nbsp;debug:&nbsp;bool&nbsp;=&nbsp;False)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Compile&nbsp;graph&nbsp;and&nbsp;return&nbsp;serialized&nbsp;pipeline&nbsp;dict.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Convenient&nbsp;for&nbsp;debugging&nbsp;and&nbsp;display.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;pipeline&nbsp;=&nbsp;compile_graph(scene,&nbsp;debug=debug)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;pipeline.serialize()<br>
<!-- END SCAT CODE -->
</body>
</html>
