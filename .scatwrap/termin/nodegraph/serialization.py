<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/nodegraph/serialization.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Graph&nbsp;serialization&nbsp;for&nbsp;the&nbsp;pipeline&nbsp;editor.<br>
<br>
Extends&nbsp;the&nbsp;existing&nbsp;RenderPipeline&nbsp;format&nbsp;with&nbsp;visual&nbsp;graph&nbsp;information<br>
(node&nbsp;positions,&nbsp;connections,&nbsp;viewport&nbsp;frames).<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;Dict,&nbsp;List,&nbsp;Any<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.scene&nbsp;import&nbsp;NodeGraphScene<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.node&nbsp;import&nbsp;GraphNode<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.connection&nbsp;import&nbsp;NodeConnection<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.viewport_frame&nbsp;import&nbsp;ViewportFrame<br>
<br>
<br>
def&nbsp;serialize_graph(scene:&nbsp;&quot;NodeGraphScene&quot;)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Serialize&nbsp;the&nbsp;entire&nbsp;node&nbsp;graph&nbsp;to&nbsp;a&nbsp;dictionary.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Format&nbsp;is&nbsp;compatible&nbsp;with&nbsp;RenderPipeline&nbsp;but&nbsp;adds&nbsp;graph-specific&nbsp;data.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot;:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;nodes&quot;:&nbsp;[...],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;connections&quot;:&nbsp;[...],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;viewport_frames&quot;:&nbsp;[...],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes&nbsp;=&nbsp;scene.get_nodes()<br>
&nbsp;&nbsp;&nbsp;&nbsp;connections&nbsp;=&nbsp;scene.get_connections()<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport_frames&nbsp;=&nbsp;scene.get_viewport_frames()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;node&nbsp;index&nbsp;map&nbsp;for&nbsp;connections<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_to_index&nbsp;=&nbsp;{node:&nbsp;i&nbsp;for&nbsp;i,&nbsp;node&nbsp;in&nbsp;enumerate(nodes)}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot;:&nbsp;&quot;graph_pipeline&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;nodes&quot;:&nbsp;[_serialize_node(node)&nbsp;for&nbsp;node&nbsp;in&nbsp;nodes],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;connections&quot;:&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_serialize_connection(conn,&nbsp;node_to_index)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;conn&nbsp;in&nbsp;connections<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;viewport_frames&quot;:&nbsp;[_serialize_viewport_frame(frame)&nbsp;for&nbsp;frame&nbsp;in&nbsp;viewport_frames],<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
<br>
def&nbsp;_serialize_node(node:&nbsp;&quot;GraphNode&quot;)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Serialize&nbsp;a&nbsp;single&nbsp;node.&nbsp;Only&nbsp;saves&nbsp;data&nbsp;that&nbsp;can't&nbsp;be&nbsp;reconstructed.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;=&nbsp;node.pos()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Save&nbsp;all&nbsp;parameter&nbsp;values<br>
&nbsp;&nbsp;&nbsp;&nbsp;params&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;param&nbsp;in&nbsp;node._params:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;=&nbsp;node._param_values.get(param.name,&nbsp;param.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;value&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params[param.name]&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;:&nbsp;node.title,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;x&quot;:&nbsp;pos.x(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;y&quot;:&nbsp;pos.y(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Only&nbsp;include&nbsp;node_type&nbsp;if&nbsp;not&nbsp;&quot;pass&quot;&nbsp;(most&nbsp;common)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.node_type&nbsp;!=&nbsp;&quot;pass&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;node_type&quot;]&nbsp;=&nbsp;node.node_type<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Only&nbsp;include&nbsp;optional&nbsp;fields&nbsp;if&nbsp;they&nbsp;have&nbsp;values<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node.name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;name&quot;]&nbsp;=&nbsp;node.name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;params:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;params&quot;]&nbsp;=&nbsp;params<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Only&nbsp;save&nbsp;size&nbsp;if&nbsp;changed&nbsp;from&nbsp;default<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node._width&nbsp;!=&nbsp;node.DEFAULT_WIDTH:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;width&quot;]&nbsp;=&nbsp;node._width<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;node._height_override&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;height&quot;]&nbsp;=&nbsp;node._height_override<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Save&nbsp;dynamic&nbsp;input&nbsp;sockets&nbsp;for&nbsp;nodes&nbsp;with&nbsp;has_dynamic_inputs<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;ensures&nbsp;we&nbsp;can&nbsp;restore&nbsp;sockets&nbsp;before&nbsp;materials&nbsp;are&nbsp;loaded<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass_class&nbsp;=&nbsp;node.data.get(&quot;pass_class&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;pass_class&nbsp;==&nbsp;&quot;MaterialPass&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;dynamic&nbsp;sockets&nbsp;(exclude&nbsp;static&nbsp;ones&nbsp;like&nbsp;output_res_target)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_sockets&nbsp;=&nbsp;{&quot;output_res_target&quot;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_inputs&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;sock&nbsp;in&nbsp;node.input_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sock.name&nbsp;not&nbsp;in&nbsp;static_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_inputs.append((sock.name,&nbsp;sock.socket_type))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dynamic_inputs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;dynamic_inputs&quot;]&nbsp;=&nbsp;dynamic_inputs<br>
&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;pass_class&nbsp;==&nbsp;&quot;ColorPass&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;dynamic&nbsp;sockets&nbsp;(exclude&nbsp;static&nbsp;ones)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_sockets&nbsp;=&nbsp;{&quot;input_res&quot;,&nbsp;&quot;shadow_res&quot;,&nbsp;&quot;output_res_target&quot;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_inputs&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;sock&nbsp;in&nbsp;node.input_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sock.name&nbsp;not&nbsp;in&nbsp;static_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_inputs.append((sock.name,&nbsp;sock.socket_type))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dynamic_inputs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;dynamic_inputs&quot;]&nbsp;=&nbsp;dynamic_inputs<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
<br>
def&nbsp;_serialize_connection(conn:&nbsp;&quot;NodeConnection&quot;,&nbsp;node_to_index:&nbsp;dict)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Serialize&nbsp;a&nbsp;connection&nbsp;between&nbsp;nodes.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;=&nbsp;conn.start_socket<br>
&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;=&nbsp;conn.end_socket<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;start&nbsp;is&nbsp;None&nbsp;or&nbsp;end&nbsp;is&nbsp;None&nbsp;or&nbsp;start.node&nbsp;is&nbsp;None&nbsp;or&nbsp;end.node&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;from_index&nbsp;=&nbsp;node_to_index.get(start.node)<br>
&nbsp;&nbsp;&nbsp;&nbsp;to_index&nbsp;=&nbsp;node_to_index.get(end.node)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;from_index&nbsp;is&nbsp;None&nbsp;or&nbsp;to_index&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;from_node&quot;:&nbsp;from_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;from_socket&quot;:&nbsp;start.name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;to_node&quot;:&nbsp;to_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;to_socket&quot;:&nbsp;end.name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
<br>
def&nbsp;_serialize_viewport_frame(frame:&nbsp;&quot;ViewportFrame&quot;)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Serialize&nbsp;a&nbsp;viewport&nbsp;frame.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Combine&nbsp;pos()&nbsp;and&nbsp;rect()&nbsp;for&nbsp;absolute&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;=&nbsp;frame.pos()<br>
&nbsp;&nbsp;&nbsp;&nbsp;rect&nbsp;=&nbsp;frame.rect()<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;title&quot;:&nbsp;frame.title,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;viewport_name&quot;:&nbsp;frame.viewport_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;x&quot;:&nbsp;pos.x()&nbsp;+&nbsp;rect.x(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;y&quot;:&nbsp;pos.y()&nbsp;+&nbsp;rect.y(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;width&quot;:&nbsp;rect.width(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;height&quot;:&nbsp;rect.height(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
<br>
def&nbsp;deserialize_graph(data:&nbsp;dict,&nbsp;scene:&nbsp;&quot;NodeGraphScene&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Deserialize&nbsp;a&nbsp;graph&nbsp;from&nbsp;dictionary&nbsp;into&nbsp;a&nbsp;scene.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Clears&nbsp;the&nbsp;existing&nbsp;scene&nbsp;and&nbsp;populates&nbsp;it&nbsp;with&nbsp;deserialized&nbsp;nodes.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;Serialized&nbsp;graph&nbsp;data<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene:&nbsp;Target&nbsp;scene&nbsp;to&nbsp;populate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.nodes&nbsp;import&nbsp;create_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.viewport_frame&nbsp;import&nbsp;ViewportFrame<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.nodegraph.connection&nbsp;import&nbsp;NodeConnection<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;existing<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene.clear_graph()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;List&nbsp;of&nbsp;nodes&nbsp;by&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;nodes_list:&nbsp;List[&quot;GraphNode&quot;]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;viewport&nbsp;frames&nbsp;first<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;frame_data&nbsp;in&nbsp;data.get(&quot;viewport_frames&quot;,&nbsp;[]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;=&nbsp;ViewportFrame(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title=frame_data.get(&quot;title&quot;,&nbsp;&quot;Viewport&quot;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewport_name=frame_data.get(&quot;viewport_name&quot;,&nbsp;&quot;main&quot;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x=frame_data.get(&quot;x&quot;,&nbsp;0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y=frame_data.get(&quot;y&quot;,&nbsp;0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width=frame_data.get(&quot;width&quot;,&nbsp;600),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height=frame_data.get(&quot;height&quot;,&nbsp;400),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene.add_viewport_frame(frame)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;nodes<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;node_data&nbsp;in&nbsp;data.get(&quot;nodes&quot;,&nbsp;[]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_type&nbsp;=&nbsp;node_data.get(&quot;node_type&quot;,&nbsp;&quot;pass&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title&nbsp;=&nbsp;node_data.get(&quot;type&quot;,&nbsp;&quot;Node&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;node&nbsp;using&nbsp;factory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;=&nbsp;create_node(node_type,&nbsp;title)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Restore&nbsp;instance&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.name&nbsp;=&nbsp;node_data.get(&quot;name&quot;,&nbsp;&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.setPos(node_data.get(&quot;x&quot;,&nbsp;0),&nbsp;node_data.get(&quot;y&quot;,&nbsp;0))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;size&nbsp;if&nbsp;overridden<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width&nbsp;=&nbsp;node_data.get(&quot;width&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;width&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node._width&nbsp;=&nbsp;width<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height&nbsp;=&nbsp;node_data.get(&quot;height&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;height&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node._height_override&nbsp;=&nbsp;height<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node._update_height()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Restore&nbsp;dynamic&nbsp;inputs&nbsp;BEFORE&nbsp;setting&nbsp;params&nbsp;(to&nbsp;avoid&nbsp;material&nbsp;lookup)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;ensures&nbsp;sockets&nbsp;exist&nbsp;for&nbsp;connection&nbsp;restoration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_inputs&nbsp;=&nbsp;node_data.get(&quot;dynamic_inputs&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dynamic_inputs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Determine&nbsp;static&nbsp;sockets&nbsp;based&nbsp;on&nbsp;node&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_class&nbsp;=&nbsp;node.data.get(&quot;pass_class&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;pass_class&nbsp;==&nbsp;&quot;ColorPass&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keep_sockets&nbsp;=&nbsp;{&quot;input_res&quot;,&nbsp;&quot;shadow_res&quot;,&nbsp;&quot;output_res_target&quot;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keep_sockets&nbsp;=&nbsp;{&quot;output_res_target&quot;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;update_dynamic_inputs&nbsp;to&nbsp;create&nbsp;sockets<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.update_dynamic_inputs(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_inputs,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keep_sockets=keep_sockets,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Mark&nbsp;that&nbsp;we&nbsp;restored&nbsp;from&nbsp;serialization&nbsp;(skip&nbsp;material&nbsp;lookup)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node._dynamic_inputs_restored&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Set&nbsp;parameters<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params&nbsp;=&nbsp;node_data.get(&quot;params&quot;,&nbsp;{})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;name,&nbsp;value&nbsp;in&nbsp;params.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.set_param(name,&nbsp;value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;the&nbsp;flag&nbsp;after&nbsp;params&nbsp;are&nbsp;set<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;hasattr(node,&nbsp;&quot;_dynamic_inputs_restored&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del&nbsp;node._dynamic_inputs_restored<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene.add_node(node)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodes_list.append(node)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;connections<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;conn_data&nbsp;in&nbsp;data.get(&quot;connections&quot;,&nbsp;[]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;conn_data&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from_node_idx&nbsp;=&nbsp;conn_data.get(&quot;from_node&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from_socket_name&nbsp;=&nbsp;conn_data.get(&quot;from_socket&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_node_idx&nbsp;=&nbsp;conn_data.get(&quot;to_node&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_socket_name&nbsp;=&nbsp;conn_data.get(&quot;to_socket&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;nodes&nbsp;by&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;from_node_idx&nbsp;is&nbsp;None&nbsp;or&nbsp;to_node_idx&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;from_node_idx&nbsp;&gt;=&nbsp;len(nodes_list)&nbsp;or&nbsp;to_node_idx&nbsp;&gt;=&nbsp;len(nodes_list):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from_node&nbsp;=&nbsp;nodes_list[from_node_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_node&nbsp;=&nbsp;nodes_list[to_node_idx]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;sockets<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from_socket&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;sock&nbsp;in&nbsp;from_node.output_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sock.name&nbsp;==&nbsp;from_socket_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from_socket&nbsp;=&nbsp;sock<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_socket&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;sock&nbsp;in&nbsp;to_node.input_sockets:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sock.name&nbsp;==&nbsp;to_socket_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_socket&nbsp;=&nbsp;sock<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;from_socket&nbsp;is&nbsp;None&nbsp;or&nbsp;to_socket&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;connection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;NodeConnection()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn.set_start_socket(from_socket)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn.set_end_socket(to_socket)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene.add_connection(conn)<br>
<!-- END SCAT CODE -->
</body>
</html>
