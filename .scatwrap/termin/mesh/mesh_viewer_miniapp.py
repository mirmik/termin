<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/mesh/mesh_viewer_miniapp.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Minimal&nbsp;demo&nbsp;that&nbsp;renders&nbsp;a&nbsp;cube&nbsp;and&nbsp;allows&nbsp;orbiting&nbsp;camera&nbsp;controls.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.geombase&nbsp;import&nbsp;Pose3<br>
from&nbsp;termin.visualization&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;Entity,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Scene,<br>
&nbsp;&nbsp;&nbsp;&nbsp;Material,<br>
&nbsp;&nbsp;&nbsp;&nbsp;VisualizationWorld,<br>
&nbsp;&nbsp;&nbsp;&nbsp;PerspectiveCameraComponent,<br>
&nbsp;&nbsp;&nbsp;&nbsp;OrbitCameraController,<br>
)<br>
from&nbsp;termin.voxels.voxel_mesh&nbsp;import&nbsp;create_voxel_mesh<br>
from&nbsp;termin.visualization.render.components&nbsp;import&nbsp;MeshRenderer,&nbsp;LineRenderer<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
<br>
vert&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
layout(location&nbsp;=&nbsp;1)&nbsp;in&nbsp;vec3&nbsp;a_normal;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
out&nbsp;vec3&nbsp;v_normal;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;нормаль&nbsp;в&nbsp;мировом&nbsp;пространстве<br>
out&nbsp;vec3&nbsp;v_world_pos;&nbsp;&nbsp;//&nbsp;позиция&nbsp;в&nbsp;мировом&nbsp;пространстве<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;world&nbsp;=&nbsp;u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;world.xyz;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;нормальная&nbsp;матрица&nbsp;=&nbsp;mat3(transpose(inverse(u_model)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_normal&nbsp;=&nbsp;mat3(transpose(inverse(u_model)))&nbsp;*&nbsp;a_normal;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view&nbsp;*&nbsp;world;<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
frag&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
in&nbsp;vec3&nbsp;v_normal;<br>
in&nbsp;vec3&nbsp;v_world_pos;<br>
<br>
uniform&nbsp;vec4&nbsp;u_color;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;базовый&nbsp;цвет&nbsp;материала&nbsp;(RGBA)<br>
uniform&nbsp;vec3&nbsp;u_light_dir;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;направление&nbsp;от&nbsp;источника&nbsp;к&nbsp;объекту&nbsp;(world&nbsp;space)<br>
uniform&nbsp;vec3&nbsp;u_light_color;&nbsp;&nbsp;//&nbsp;цвет&nbsp;света<br>
uniform&nbsp;vec3&nbsp;u_view_pos;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;позиция&nbsp;камеры&nbsp;(world&nbsp;space)<br>
<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Нормаль<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;N&nbsp;=&nbsp;normalize(v_normal);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Направление&nbsp;на&nbsp;свет:&nbsp;если&nbsp;u_light_dir&nbsp;-&nbsp;направление&nbsp;*от*&nbsp;света,&nbsp;то&nbsp;на&nbsp;объект&nbsp;оно&nbsp;то&nbsp;же<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;L&nbsp;=&nbsp;normalize(-u_light_dir);&nbsp;//&nbsp;если&nbsp;задаёшь&nbsp;уже&nbsp;&quot;к&nbsp;объекту&quot;,&nbsp;убери&nbsp;минус<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Направление&nbsp;на&nbsp;камеру<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;V&nbsp;=&nbsp;normalize(u_view_pos&nbsp;-&nbsp;v_world_pos);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Полуунитектор&nbsp;(half-vector)&nbsp;для&nbsp;Blinn–Phong<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;H&nbsp;=&nbsp;normalize(L&nbsp;+&nbsp;V);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;---&nbsp;коэффициенты&nbsp;освещения&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;float&nbsp;ambientStrength&nbsp;&nbsp;=&nbsp;0.2;&nbsp;&nbsp;//&nbsp;эмбиент<br>
&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;float&nbsp;diffuseStrength&nbsp;&nbsp;=&nbsp;0.8;&nbsp;&nbsp;//&nbsp;диффуз<br>
&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;float&nbsp;specularStrength&nbsp;=&nbsp;0.4;&nbsp;&nbsp;//&nbsp;спекуляр<br>
&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;float&nbsp;shininess&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;32.0;&nbsp;//&nbsp;степень&nbsp;блеска<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Эмбиент<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;ambient&nbsp;=&nbsp;ambientStrength&nbsp;*&nbsp;u_color.rgb;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Диффуз&nbsp;(Ламберт)<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;ndotl&nbsp;=&nbsp;max(dot(N,&nbsp;L),&nbsp;0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;diffuse&nbsp;=&nbsp;diffuseStrength&nbsp;*&nbsp;ndotl&nbsp;*&nbsp;u_color.rgb;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Спекуляр&nbsp;(Blinn–Phong)<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;specFactor&nbsp;=&nbsp;0.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ndotl&nbsp;&gt;&nbsp;0.0)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;specFactor&nbsp;=&nbsp;pow(max(dot(N,&nbsp;H),&nbsp;0.0),&nbsp;shininess);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;specular&nbsp;=&nbsp;specularStrength&nbsp;*&nbsp;specFactor&nbsp;*&nbsp;u_light_color;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Итоговый&nbsp;цвет:&nbsp;модифицируем&nbsp;цвет&nbsp;материала&nbsp;цветом&nbsp;света<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;color&nbsp;=&nbsp;(ambient&nbsp;+&nbsp;diffuse)&nbsp;*&nbsp;u_light_color&nbsp;+&nbsp;specular;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Можно&nbsp;слегка&nbsp;ограничить,&nbsp;чтобы&nbsp;не&nbsp;улетало&nbsp;в&nbsp;дикий&nbsp;перегиб<br>
&nbsp;&nbsp;&nbsp;&nbsp;color&nbsp;=&nbsp;clamp(color,&nbsp;0.0,&nbsp;1.0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(color,&nbsp;u_color.a);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
def&nbsp;build_scene(world:&nbsp;VisualizationWorld,&nbsp;mesh:&nbsp;&quot;Mesh&quot;)&nbsp;-&gt;&nbsp;tuple[Scene,&nbsp;PerspectiveCameraComponent]:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene&nbsp;=&nbsp;Scene(name=&quot;mesh_viewer&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mesh_tc&nbsp;=&nbsp;create_voxel_mesh(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=mesh.vertices,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles=mesh.triangles,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_normals=mesh.vertex_normals&nbsp;if&nbsp;hasattr(mesh,&nbsp;'vertex_normals')&nbsp;else&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;mesh&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader_prog&nbsp;=&nbsp;TcShader.from_sources(vert,&nbsp;frag,&nbsp;&quot;&quot;,&nbsp;&quot;MeshViewerShader&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;material&nbsp;=&nbsp;Material(name=&quot;MeshViewerMaterial&quot;,&nbsp;shader=shader_prog,&nbsp;color=np.array([0.8,&nbsp;0.3,&nbsp;0.3,&nbsp;1.0],&nbsp;dtype=np.float32))<br>
&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;=&nbsp;Entity(pose=Pose3.identity(),&nbsp;name=&quot;cube&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;entity.add_component(MeshRenderer(mesh_tc,&nbsp;material))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene.add(entity)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;world.add_scene(scene)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;=&nbsp;10000.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;coord_lines&nbsp;=&nbsp;Entity(name=&quot;coord_lines&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;coord_lines.add_component(LineRenderer(points=[(0,0,-T),&nbsp;(0,0,T)],&nbsp;color=(1,0,0,1),&nbsp;width=2.0))&nbsp;&nbsp;#&nbsp;Z&nbsp;-&nbsp;красная<br>
&nbsp;&nbsp;&nbsp;&nbsp;coord_lines.add_component(LineRenderer(points=[(0,-T,0),&nbsp;(0,T,0)],&nbsp;color=(0,1,0,1),&nbsp;width=2.0))&nbsp;&nbsp;#&nbsp;Y&nbsp;-&nbsp;зелёная<br>
&nbsp;&nbsp;&nbsp;&nbsp;coord_lines.add_component(LineRenderer(points=[(-T,0,0),&nbsp;(T,0,0)],&nbsp;color=(0,0,1,1),&nbsp;width=2.0))&nbsp;&nbsp;#&nbsp;X&nbsp;-&nbsp;синяя<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene.add(coord_lines)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;camera_entity&nbsp;=&nbsp;Entity(name=&quot;camera&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;camera&nbsp;=&nbsp;PerspectiveCameraComponent()<br>
&nbsp;&nbsp;&nbsp;&nbsp;camera_entity.add_component(camera)<br>
&nbsp;&nbsp;&nbsp;&nbsp;camera_entity.add_component(OrbitCameraController())<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene.add(camera_entity)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;scene,&nbsp;camera<br>
<br>
<br>
def&nbsp;show_mesh_app(mesh:&nbsp;&quot;Mesh&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;world&nbsp;=&nbsp;VisualizationWorld()<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene,&nbsp;camera&nbsp;=&nbsp;build_scene(world,&nbsp;mesh)<br>
&nbsp;&nbsp;&nbsp;&nbsp;window&nbsp;=&nbsp;world.create_window(title=&quot;termin&nbsp;cube&nbsp;demo&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;window.add_viewport(scene,&nbsp;camera)<br>
&nbsp;&nbsp;&nbsp;&nbsp;world.run()<br>
<br>
<br>
if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;main()<br>
<!-- END SCAT CODE -->
</body>
</html>
