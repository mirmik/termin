<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/core/profiler.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Иерархический&nbsp;профайлер&nbsp;движка.<br>
<br>
Использование:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.core.profiler&nbsp;import&nbsp;Profiler<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;profiler&nbsp;=&nbsp;Profiler.instance()<br>
&nbsp;&nbsp;&nbsp;&nbsp;profiler.enabled&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;В&nbsp;игровом&nbsp;цикле:<br>
&nbsp;&nbsp;&nbsp;&nbsp;profiler.begin_frame()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Physics&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simulate()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Render&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Shadow&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Color&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;profiler.end_frame()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Получить&nbsp;результаты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;avg&nbsp;=&nbsp;profiler.average(60)<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;name,&nbsp;ms&nbsp;in&nbsp;avg.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;{name}:&nbsp;{ms:.2f}ms&quot;)<br>
<br>
Когда&nbsp;профайлер&nbsp;выключен&nbsp;(enabled=False),&nbsp;overhead&nbsp;минимален&nbsp;—<br>
одна&nbsp;проверка&nbsp;bool&nbsp;в&nbsp;начале&nbsp;каждого&nbsp;метода.<br>
<br>
Использует&nbsp;C&nbsp;ядро&nbsp;(TcProfiler)&nbsp;для&nbsp;минимального&nbsp;overhead.<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;contextlib&nbsp;import&nbsp;contextmanager<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass,&nbsp;field<br>
from&nbsp;typing&nbsp;import&nbsp;Dict,&nbsp;List,&nbsp;Iterator,&nbsp;NamedTuple<br>
<br>
from&nbsp;termin._native.profiler&nbsp;import&nbsp;TcProfiler<br>
<br>
<br>
class&nbsp;SectionStats(NamedTuple):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Статистика&nbsp;секции&nbsp;профилирования.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cpu_ms:&nbsp;float<br>
&nbsp;&nbsp;&nbsp;&nbsp;children_ms:&nbsp;float<br>
&nbsp;&nbsp;&nbsp;&nbsp;call_count:&nbsp;int<br>
<br>
<br>
@dataclass<br>
class&nbsp;SectionTiming:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Тайминг&nbsp;одной&nbsp;секции&nbsp;профилирования.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str<br>
&nbsp;&nbsp;&nbsp;&nbsp;cpu_ms:&nbsp;float&nbsp;=&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;children_ms:&nbsp;float&nbsp;=&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;call_count:&nbsp;int&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;children:&nbsp;Dict[str,&nbsp;&quot;SectionTiming&quot;]&nbsp;=&nbsp;field(default_factory=dict)<br>
<br>
<br>
@dataclass<br>
class&nbsp;FrameProfile:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Профиль&nbsp;одного&nbsp;кадра.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame_number:&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;total_ms:&nbsp;float&nbsp;=&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;sections:&nbsp;Dict[str,&nbsp;SectionTiming]&nbsp;=&nbsp;field(default_factory=dict)<br>
<br>
<br>
class&nbsp;Profiler:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Иерархический&nbsp;профайлер&nbsp;с&nbsp;минимальным&nbsp;overhead.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Singleton&nbsp;—&nbsp;используйте&nbsp;Profiler.instance()&nbsp;для&nbsp;получения&nbsp;экземпляра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Делегирует&nbsp;к&nbsp;C&nbsp;ядру&nbsp;TcProfiler&nbsp;для&nbsp;быстрого&nbsp;замера&nbsp;времени.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_instance:&nbsp;&quot;Profiler&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@classmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;instance(cls)&nbsp;-&gt;&nbsp;&quot;Profiler&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Возвращает&nbsp;singleton&nbsp;экземпляр&nbsp;профайлера.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cls._instance&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls._instance&nbsp;=&nbsp;cls()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cls._instance<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;history_size:&nbsp;int&nbsp;=&nbsp;120):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Инициализирует&nbsp;профайлер.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history_size:&nbsp;Количество&nbsp;кадров&nbsp;в&nbsp;истории&nbsp;(по&nbsp;умолчанию&nbsp;120&nbsp;=&nbsp;2&nbsp;секунды&nbsp;при&nbsp;60&nbsp;FPS).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc&nbsp;=&nbsp;TcProfiler.instance()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._history_size&nbsp;=&nbsp;history_size<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_current_frame(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Текущий&nbsp;кадр&nbsp;(None&nbsp;если&nbsp;не&nbsp;в&nbsp;процессе&nbsp;профилирования).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._tc.current_frame<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;enabled(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Включён&nbsp;ли&nbsp;профайлер.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._tc.enabled<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@enabled.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;enabled(self,&nbsp;value:&nbsp;bool)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Включает/выключает&nbsp;профайлер.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.enabled&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;detailed_rendering(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Включён&nbsp;ли&nbsp;детальный&nbsp;профайлинг&nbsp;рендеринга.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._tc.detailed_rendering<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@detailed_rendering.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;detailed_rendering(self,&nbsp;value:&nbsp;bool)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Включает/выключает&nbsp;детальный&nbsp;профайлинг&nbsp;рендеринга.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.detailed_rendering&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;history(self)&nbsp;-&gt;&nbsp;List[FrameProfile]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;История&nbsp;профилей&nbsp;кадров&nbsp;(конвертируется&nbsp;из&nbsp;C&nbsp;данных).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._convert_history()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear_history(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Очищает&nbsp;историю&nbsp;профилей.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.clear_history()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;begin_frame(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Начинает&nbsp;профилирование&nbsp;нового&nbsp;кадра.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Вызывайте&nbsp;в&nbsp;начале&nbsp;игрового&nbsp;цикла.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Идемпотентен&nbsp;—&nbsp;если&nbsp;frame&nbsp;уже&nbsp;начат,&nbsp;ничего&nbsp;не&nbsp;делает.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.begin_frame()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;end_frame(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Завершает&nbsp;профилирование&nbsp;кадра.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Вызывайте&nbsp;в&nbsp;конце&nbsp;игрового&nbsp;цикла.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.end_frame()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@contextmanager<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;section(self,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;Iterator[None]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;manager&nbsp;для&nbsp;измерения&nbsp;секции&nbsp;кода.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Секции&nbsp;могут&nbsp;быть&nbsp;вложенными:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Render&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Shadow&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;render_shadows()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;profiler.section(&quot;Color&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;render_color()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Имя&nbsp;секции&nbsp;для&nbsp;отображения&nbsp;в&nbsp;профайлере.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;self._tc.enabled:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.begin_section(name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finally:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc.end_section()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_convert_history(self)&nbsp;-&gt;&nbsp;List[FrameProfile]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Конвертирует&nbsp;C&nbsp;историю&nbsp;в&nbsp;Python&nbsp;FrameProfile&nbsp;объекты.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;c_frame&nbsp;in&nbsp;self._tc.history:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;=&nbsp;FrameProfile(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame_number=c_frame.frame_number,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total_ms=c_frame.total_ms,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;hierarchical&nbsp;sections&nbsp;from&nbsp;flat&nbsp;C&nbsp;array<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._build_sections(c_frame.sections,&nbsp;frame.sections)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.append(frame)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_build_sections(self,&nbsp;c_sections:&nbsp;list,&nbsp;out:&nbsp;Dict[str,&nbsp;SectionTiming],&nbsp;parent_idx:&nbsp;int&nbsp;=&nbsp;-1)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Рекурсивно&nbsp;строит&nbsp;иерархию&nbsp;секций&nbsp;из&nbsp;плоского&nbsp;C&nbsp;массива.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;s&nbsp;in&nbsp;enumerate(c_sections):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;s.parent_index&nbsp;==&nbsp;parent_idx:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timing&nbsp;=&nbsp;SectionTiming(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=s.name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpu_ms=s.cpu_ms,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;children_ms=s.children_ms,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call_count=s.call_count,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out[s.name]&nbsp;=&nbsp;timing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Recursively&nbsp;add&nbsp;children<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._build_sections(c_sections,&nbsp;timing.children,&nbsp;i)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;last_frame(self)&nbsp;-&gt;&nbsp;FrameProfile&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Возвращает&nbsp;последний&nbsp;завершённый&nbsp;профиль&nbsp;кадра.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history&nbsp;=&nbsp;self._convert_history()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;history[-1]&nbsp;if&nbsp;history&nbsp;else&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;average(self,&nbsp;frames:&nbsp;int&nbsp;=&nbsp;60)&nbsp;-&gt;&nbsp;Dict[str,&nbsp;float]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;усреднённые&nbsp;времена&nbsp;по&nbsp;секциям.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frames:&nbsp;Количество&nbsp;последних&nbsp;кадров&nbsp;для&nbsp;усреднения.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Словарь&nbsp;&quot;путь/секции&quot;&nbsp;-&gt;&nbsp;среднее&nbsp;время&nbsp;в&nbsp;мс.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Например:&nbsp;{&quot;Render&quot;:&nbsp;8.5,&nbsp;&quot;Render/Shadow&quot;:&nbsp;2.1,&nbsp;&quot;Render/Color&quot;:&nbsp;5.2}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;detailed&nbsp;=&nbsp;self.detailed_average(frames)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{name:&nbsp;stats.cpu_ms&nbsp;for&nbsp;name,&nbsp;stats&nbsp;in&nbsp;detailed.items()}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;detailed_average(self,&nbsp;frames:&nbsp;int&nbsp;=&nbsp;60)&nbsp;-&gt;&nbsp;Dict[str,&nbsp;SectionStats]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;детальную&nbsp;статистику&nbsp;по&nbsp;секциям.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frames:&nbsp;Количество&nbsp;последних&nbsp;кадров&nbsp;для&nbsp;усреднения.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Словарь&nbsp;&quot;путь/секции&quot;&nbsp;-&gt;&nbsp;SectionStats(cpu_ms,&nbsp;call_count).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call_count&nbsp;—&nbsp;среднее&nbsp;количество&nbsp;вызовов&nbsp;за&nbsp;кадр.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history&nbsp;=&nbsp;self._convert_history()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;history:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recent&nbsp;=&nbsp;history[-frames:]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;totals:&nbsp;Dict[str,&nbsp;List[tuple]]&nbsp;=&nbsp;{}&nbsp;&nbsp;#&nbsp;path&nbsp;-&gt;&nbsp;[(cpu_ms,&nbsp;children_ms,&nbsp;call_count),&nbsp;...]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;collect(sections:&nbsp;Dict[str,&nbsp;SectionTiming],&nbsp;prefix:&nbsp;str&nbsp;=&nbsp;&quot;&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;name,&nbsp;timing&nbsp;in&nbsp;sections.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;full_path&nbsp;=&nbsp;f&quot;{prefix}{name}&quot;&nbsp;if&nbsp;prefix&nbsp;else&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;totals.setdefault(full_path,&nbsp;[]).append((timing.cpu_ms,&nbsp;timing.children_ms,&nbsp;timing.call_count))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collect(timing.children,&nbsp;f&quot;{full_path}/&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;frame&nbsp;in&nbsp;recent:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collect(frame.sections)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;name,&nbsp;samples&nbsp;in&nbsp;totals.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;avg_ms&nbsp;=&nbsp;sum(s[0]&nbsp;for&nbsp;s&nbsp;in&nbsp;samples)&nbsp;/&nbsp;len(samples)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;avg_children_ms&nbsp;=&nbsp;sum(s[1]&nbsp;for&nbsp;s&nbsp;in&nbsp;samples)&nbsp;/&nbsp;len(samples)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;avg_count&nbsp;=&nbsp;sum(s[2]&nbsp;for&nbsp;s&nbsp;in&nbsp;samples)&nbsp;/&nbsp;len(samples)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[name]&nbsp;=&nbsp;SectionStats(cpu_ms=avg_ms,&nbsp;children_ms=avg_children_ms,&nbsp;call_count=round(avg_count))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;print_report(self,&nbsp;frames:&nbsp;int&nbsp;=&nbsp;60)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Печатает&nbsp;отчёт&nbsp;профилирования&nbsp;в&nbsp;консоль.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frames:&nbsp;Количество&nbsp;кадров&nbsp;для&nbsp;усреднения.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;detailed&nbsp;=&nbsp;self.detailed_average(frames)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;detailed:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;No&nbsp;profiling&nbsp;data&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history&nbsp;=&nbsp;self._convert_history()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Сортируем:&nbsp;сначала&nbsp;по&nbsp;глубине,&nbsp;потом&nbsp;по&nbsp;времени&nbsp;внутри&nbsp;уровня<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_sections&nbsp;=&nbsp;sorted(detailed.items(),&nbsp;key=lambda&nbsp;x:&nbsp;(x[0].count(&quot;/&quot;),&nbsp;-x[1].cpu_ms))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Считаем&nbsp;общее&nbsp;время&nbsp;(только&nbsp;root&nbsp;секции)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total&nbsp;=&nbsp;sum(stats.cpu_ms&nbsp;for&nbsp;name,&nbsp;stats&nbsp;in&nbsp;sorted_sections&nbsp;if&nbsp;&quot;/&quot;&nbsp;not&nbsp;in&nbsp;name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;\n===&nbsp;Profiler&nbsp;Report&nbsp;(avg&nbsp;{min(frames,&nbsp;len(history))}&nbsp;frames)&nbsp;===&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;total&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;Total:&nbsp;{total:.2f}ms&nbsp;({1000/total:.0f}&nbsp;FPS)&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;name,&nbsp;stats&nbsp;in&nbsp;sorted_sections:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indent&nbsp;=&nbsp;&quot;&nbsp;&nbsp;&quot;&nbsp;*&nbsp;name.count(&quot;/&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_name&nbsp;=&nbsp;name.split(&quot;/&quot;)[-1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pct&nbsp;=&nbsp;(stats.cpu_ms&nbsp;/&nbsp;total&nbsp;*&nbsp;100)&nbsp;if&nbsp;total&nbsp;&gt;&nbsp;0&nbsp;else&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bar&nbsp;=&nbsp;&quot;█&quot;&nbsp;*&nbsp;int(pct&nbsp;/&nbsp;5)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count_str&nbsp;=&nbsp;f&quot;x{stats.call_count}&quot;&nbsp;if&nbsp;stats.call_count&nbsp;&gt;&nbsp;1&nbsp;else&nbsp;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;{indent}{base_name:20}&nbsp;{stats.cpu_ms:6.2f}ms&nbsp;{pct:5.1f}%&nbsp;{count_str:&gt;5}&nbsp;{bar}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print()<br>
<!-- END SCAT CODE -->
</body>
</html>
