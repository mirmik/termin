<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/_dll_setup.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
DLL&nbsp;search&nbsp;path&nbsp;setup&nbsp;for&nbsp;Windows.<br>
<br>
This&nbsp;module&nbsp;must&nbsp;be&nbsp;imported&nbsp;BEFORE&nbsp;any&nbsp;native&nbsp;extension&nbsp;imports.<br>
It&nbsp;configures&nbsp;os.add_dll_directory()&nbsp;so&nbsp;that&nbsp;entity_lib.dll&nbsp;and&nbsp;other<br>
dependencies&nbsp;can&nbsp;be&nbsp;found.<br>
<br>
Usage:<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;At&nbsp;the&nbsp;top&nbsp;of&nbsp;any&nbsp;__init__.py&nbsp;that&nbsp;imports&nbsp;native&nbsp;extensions:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin&nbsp;import&nbsp;_dll_setup&nbsp;&nbsp;#&nbsp;noqa:&nbsp;F401<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;._native_module&nbsp;import&nbsp;...<br>
&quot;&quot;&quot;<br>
<br>
import&nbsp;os<br>
import&nbsp;sys<br>
<br>
_initialized&nbsp;=&nbsp;False<br>
<br>
<br>
def&nbsp;_setup_dll_paths():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Configure&nbsp;DLL&nbsp;search&nbsp;paths&nbsp;on&nbsp;Windows.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_initialized<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_initialized:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;_initialized&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sys.platform&nbsp;!=&nbsp;&quot;win32&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Directory&nbsp;containing&nbsp;termin&nbsp;package&nbsp;(where&nbsp;DLLs&nbsp;are&nbsp;located)<br>
&nbsp;&nbsp;&nbsp;&nbsp;dll_dir&nbsp;=&nbsp;os.path.dirname(os.path.abspath(__file__))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Python&nbsp;3.8+&nbsp;requires&nbsp;explicit&nbsp;DLL&nbsp;directory&nbsp;registration<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;hasattr(os,&nbsp;&quot;add_dll_directory&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.add_dll_directory(dll_dir)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Also&nbsp;prepend&nbsp;to&nbsp;PATH&nbsp;for&nbsp;compatibility<br>
&nbsp;&nbsp;&nbsp;&nbsp;os.environ[&quot;PATH&quot;]&nbsp;=&nbsp;dll_dir&nbsp;+&nbsp;os.pathsep&nbsp;+&nbsp;os.environ.get(&quot;PATH&quot;,&nbsp;&quot;&quot;)<br>
<br>
<br>
#&nbsp;Run&nbsp;setup&nbsp;on&nbsp;import<br>
_setup_dll_paths()<br>
<br>
<br>
def&nbsp;_preload_native_modules_DISABLED():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Preload&nbsp;native&nbsp;modules&nbsp;that&nbsp;register&nbsp;kind&nbsp;handlers.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;must&nbsp;be&nbsp;loaded&nbsp;BEFORE&nbsp;_native&nbsp;module&nbsp;to&nbsp;ensure&nbsp;kind&nbsp;handlers<br>
&nbsp;&nbsp;&nbsp;&nbsp;are&nbsp;registered&nbsp;when&nbsp;components&nbsp;are&nbsp;deserialized.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Import&nbsp;using&nbsp;importlib&nbsp;to&nbsp;avoid&nbsp;triggering&nbsp;package&nbsp;__init__.py&nbsp;files<br>
&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;may&nbsp;have&nbsp;circular&nbsp;dependencies.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;importlib.util<br>
&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;os<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;base_dir&nbsp;=&nbsp;os.path.dirname(os.path.abspath(__file__))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;List&nbsp;of&nbsp;native&nbsp;modules&nbsp;to&nbsp;preload&nbsp;(relative&nbsp;paths&nbsp;from&nbsp;termin/)<br>
&nbsp;&nbsp;&nbsp;&nbsp;modules_to_preload&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&quot;skeleton._skeleton_native&quot;,&nbsp;os.path.join(base_dir,&nbsp;&quot;skeleton&quot;)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&quot;visualization.animation._animation_native&quot;,&nbsp;os.path.join(base_dir,&nbsp;&quot;visualization&quot;,&nbsp;&quot;animation&quot;)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;sys<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;module_name,&nbsp;module_dir&nbsp;in&nbsp;modules_to_preload:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;full_name&nbsp;=&nbsp;f&quot;termin.{module_name}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skip&nbsp;if&nbsp;already&nbsp;loaded<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;full_name&nbsp;in&nbsp;sys.modules:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;the&nbsp;.pyd&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;fname&nbsp;in&nbsp;os.listdir(module_dir):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fname.startswith(&quot;_&quot;)&nbsp;and&nbsp;fname.endswith(&quot;.pyd&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short_name&nbsp;=&nbsp;module_name.split(&quot;.&quot;)[-1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fname.startswith(short_name):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pyd_path&nbsp;=&nbsp;os.path.join(module_dir,&nbsp;fname)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec&nbsp;=&nbsp;importlib.util.spec_from_file_location(full_name,&nbsp;pyd_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;spec&nbsp;and&nbsp;spec.loader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;module&nbsp;=&nbsp;importlib.util.module_from_spec(spec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.modules[full_name]&nbsp;=&nbsp;module<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spec.loader.exec_module(module)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Preloaded&nbsp;successfully<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass&nbsp;&nbsp;#&nbsp;Failed&nbsp;to&nbsp;preload,&nbsp;will&nbsp;be&nbsp;loaded&nbsp;later<br>
<br>
<br>
#&nbsp;_preload_native_modules()&nbsp;&nbsp;#&nbsp;Disabled&nbsp;for&nbsp;debugging<br>
<!-- END SCAT CODE -->
</body>
</html>
