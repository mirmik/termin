<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/skybox.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;skybox.py<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.geombase.pose3&nbsp;import&nbsp;Pose3<br>
<br>
from&nbsp;termin.mesh.mesh&nbsp;import&nbsp;Mesh3<br>
from&nbsp;.entity&nbsp;import&nbsp;Entity<br>
from&nbsp;.mesh&nbsp;import&nbsp;MeshDrawable<br>
from&nbsp;.material&nbsp;import&nbsp;Material<br>
from&nbsp;.shader&nbsp;import&nbsp;ShaderProgram<br>
from&nbsp;.components&nbsp;import&nbsp;SkyboxRenderer<br>
<br>
<br>
SKYBOX_VERTEX_SHADER&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
out&nbsp;vec3&nbsp;v_dir;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Убираем&nbsp;трансляцию&nbsp;камеры&nbsp;—&nbsp;skybox&nbsp;не&nbsp;должен&nbsp;двигаться<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat4&nbsp;view_no_translation&nbsp;=&nbsp;mat4(mat3(u_view));<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_dir&nbsp;=&nbsp;a_position;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;view_no_translation&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
SKYBOX_FRAGMENT_SHADER&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
in&nbsp;vec3&nbsp;v_dir;<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Простой&nbsp;вертикальный&nbsp;градиент&nbsp;неба<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;t&nbsp;=&nbsp;normalize(v_dir).y&nbsp;*&nbsp;0.5&nbsp;+&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;top&nbsp;=&nbsp;vec3(0.05,&nbsp;0.1,&nbsp;0.25);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;bottom&nbsp;=&nbsp;vec3(0.3,&nbsp;0.3,&nbsp;0.35);<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(mix(bottom,&nbsp;top,&nbsp;t),&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;_skybox_cube():<br>
&nbsp;&nbsp;&nbsp;&nbsp;F&nbsp;=&nbsp;1.0&nbsp;&nbsp;#&nbsp;большой&nbsp;размер&nbsp;куба<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-F,&nbsp;-F,&nbsp;-F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;F,&nbsp;-F,&nbsp;-F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;F,&nbsp;&nbsp;F,&nbsp;-F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-F,&nbsp;&nbsp;F,&nbsp;-F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-F,&nbsp;-F,&nbsp;&nbsp;F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;F,&nbsp;-F,&nbsp;&nbsp;F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;F,&nbsp;&nbsp;F,&nbsp;&nbsp;F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-F,&nbsp;&nbsp;F,&nbsp;&nbsp;F],<br>
&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;1,&nbsp;2],&nbsp;[0,&nbsp;2,&nbsp;3],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;back<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[4,&nbsp;6,&nbsp;5],&nbsp;[4,&nbsp;7,&nbsp;6],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;front<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;4,&nbsp;5],&nbsp;[0,&nbsp;5,&nbsp;1],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;bottom<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[3,&nbsp;2,&nbsp;6],&nbsp;[3,&nbsp;6,&nbsp;7],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;top<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1,&nbsp;5,&nbsp;6],&nbsp;[1,&nbsp;6,&nbsp;2],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;right<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;3,&nbsp;7],&nbsp;[0,&nbsp;7,&nbsp;4],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;left<br>
&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;dtype=np.uint32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vertices,&nbsp;triangles<br>
<br>
<br>
class&nbsp;SkyBoxEntity(Entity):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Небесный&nbsp;куб,&nbsp;который&nbsp;всегда&nbsp;окружает&nbsp;камеру.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Не&nbsp;использует&nbsp;освещение,&nbsp;цвет&nbsp;и&nbsp;прочее&nbsp;—&nbsp;отдельный&nbsp;шейдер.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;size:&nbsp;float&nbsp;=&nbsp;1.0):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verts,&nbsp;tris&nbsp;=&nbsp;_skybox_cube()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;MeshDrawable(Mesh3(vertices=verts,&nbsp;triangles=tris))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;ShaderProgram(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source=SKYBOX_VERTEX_SHADER,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source=SKYBOX_FRAGMENT_SHADER<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material&nbsp;=&nbsp;Material(shader=shader)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material.color&nbsp;=&nbsp;None&nbsp;&nbsp;#&nbsp;skybox&nbsp;не&nbsp;использует&nbsp;u_color<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pose=Pose3.identity(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale=size,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;skybox&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;priority=-100,&nbsp;&nbsp;#&nbsp;рисуем&nbsp;в&nbsp;самом&nbsp;начале<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pickable=False,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectable=False,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.renderer&nbsp;=&nbsp;self.add_component(SkyboxRenderer(mesh,&nbsp;material))<br>
<!-- END SCAT CODE -->
</body>
</html>
