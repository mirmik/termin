<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/platform/backends/qt.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;PyQt6-based&nbsp;window&nbsp;backend&nbsp;using&nbsp;QOpenGLWidget.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Callable,&nbsp;Optional,&nbsp;Any<br>
<br>
from&nbsp;PyQt6&nbsp;import&nbsp;QtCore,&nbsp;QtGui,&nbsp;QtWidgets<br>
from&nbsp;PyQt6.QtOpenGLWidgets&nbsp;import&nbsp;QOpenGLWidget<br>
<br>
from&nbsp;.base&nbsp;import&nbsp;Action,&nbsp;BackendWindow,&nbsp;Key,&nbsp;MouseButton,&nbsp;WindowBackend<br>
<br>
from&nbsp;termin.graphics&nbsp;import&nbsp;OpenGLGraphicsBackend<br>
<br>
<br>
<br>
def&nbsp;_qt_app()&nbsp;-&gt;&nbsp;QtWidgets.QApplication:<br>
&nbsp;&nbsp;&nbsp;&nbsp;app&nbsp;=&nbsp;QtWidgets.QApplication.instance()<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;app&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app&nbsp;=&nbsp;QtWidgets.QApplication([])<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;app<br>
<br>
<br>
def&nbsp;_translate_mouse(button:&nbsp;QtCore.Qt.MouseButton)&nbsp;-&gt;&nbsp;MouseButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;button&nbsp;==&nbsp;QtCore.Qt.MouseButton.LeftButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.LEFT<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;button&nbsp;==&nbsp;QtCore.Qt.MouseButton.RightButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.RIGHT<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;button&nbsp;==&nbsp;QtCore.Qt.MouseButton.MiddleButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.MIDDLE<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.LEFT<br>
<br>
<br>
def&nbsp;_translate_action(action:&nbsp;bool)&nbsp;-&gt;&nbsp;Action:<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Action.PRESS&nbsp;if&nbsp;action&nbsp;else&nbsp;Action.RELEASE<br>
<br>
<br>
def&nbsp;_translate_key(key:&nbsp;int)&nbsp;-&gt;&nbsp;Key:<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;==&nbsp;QtCore.Qt.Key.Key_Escape:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key.ESCAPE<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;==&nbsp;QtCore.Qt.Key.Key_Space:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key.SPACE<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key(key)<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ValueError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key.UNKNOWN<br>
<br>
<br>
def&nbsp;_translate_qt_mods(qt_mods:&nbsp;int)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Translate&nbsp;Qt&nbsp;modifier&nbsp;flags&nbsp;to&nbsp;GLFW-compatible&nbsp;flags.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Qt:&nbsp;ShiftModifier=0x02000000,&nbsp;ControlModifier=0x04000000,&nbsp;AltModifier=0x08000000<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;GLFW:&nbsp;SHIFT=0x0001,&nbsp;CTRL=0x0002,&nbsp;ALT=0x0004,&nbsp;SUPER=0x0008<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;qt_mods&nbsp;&amp;&nbsp;0x02000000:&nbsp;&nbsp;#&nbsp;ShiftModifier<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;|=&nbsp;0x0001&nbsp;&nbsp;#&nbsp;MOD_SHIFT<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;qt_mods&nbsp;&amp;&nbsp;0x04000000:&nbsp;&nbsp;#&nbsp;ControlModifier<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;|=&nbsp;0x0002&nbsp;&nbsp;#&nbsp;MOD_CONTROL<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;qt_mods&nbsp;&amp;&nbsp;0x08000000:&nbsp;&nbsp;#&nbsp;AltModifier<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;|=&nbsp;0x0004&nbsp;&nbsp;#&nbsp;MOD_ALT<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
<br>
class&nbsp;_QtGLWidget(QOpenGLWidget):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;owner:&nbsp;&quot;QtGLWindowHandle&quot;,&nbsp;parent=None,&nbsp;vsync:&nbsp;bool&nbsp;=&nbsp;True):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(parent)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._owner&nbsp;=&nbsp;owner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setFocusPolicy(QtCore.Qt.FocusPolicy.StrongFocus)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setUpdateBehavior(QOpenGLWidget.UpdateBehavior.PartialUpdate)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setMouseTracking(True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Configure&nbsp;swap&nbsp;interval&nbsp;(vsync)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;=&nbsp;QtGui.QSurfaceFormat()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.setSwapInterval(1&nbsp;if&nbsp;vsync&nbsp;else&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setFormat(fmt)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;События&nbsp;мыши&nbsp;/&nbsp;клавиатуры&nbsp;--------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mousePressEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._mouse_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_mouse(event.button()),&nbsp;Action.PRESS,&nbsp;event.modifiers().value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mouseReleaseEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._mouse_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_mouse(event.button()),&nbsp;Action.RELEASE,&nbsp;event.modifiers().value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mouseMoveEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._cursor_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;=&nbsp;event.position()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;float(pos.x()),&nbsp;float(pos.y()))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;wheelEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;angle&nbsp;=&nbsp;event.angleDelta()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._scroll_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mods&nbsp;=&nbsp;_translate_qt_mods(event.modifiers().value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;angle.x()&nbsp;/&nbsp;120.0,&nbsp;angle.y()&nbsp;/&nbsp;120.0,&nbsp;mods)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;keyPressEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._key_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_key(event.key()),&nbsp;event.nativeScanCode(),&nbsp;Action.PRESS,&nbsp;event.modifiers().value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;keyReleaseEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._key_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_key(event.key()),&nbsp;event.nativeScanCode(),&nbsp;Action.RELEASE,&nbsp;event.modifiers().value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Рендер&nbsp;----------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;paintGL(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Тут&nbsp;есть&nbsp;активный&nbsp;GL-контекст&nbsp;—&nbsp;выполняем&nbsp;рендер&nbsp;движка<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window_obj&nbsp;=&nbsp;self._owner._user_ptr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;window_obj&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window_obj.render(from_backend=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;resizeGL(self,&nbsp;w,&nbsp;h):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._framebuffer_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;w,&nbsp;h)<br>
<br>
<br>
class&nbsp;QtGLWindowHandle(BackendWindow):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share=None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent=None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics:&nbsp;Optional[OpenGLGraphicsBackend]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vsync:&nbsp;bool&nbsp;=&nbsp;False,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app&nbsp;=&nbsp;_qt_app()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget&nbsp;=&nbsp;_QtGLWidget(self,&nbsp;parent=parent,&nbsp;vsync=vsync)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.setMinimumSize(50,&nbsp;50)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.resize(width,&nbsp;height)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.show()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._closed&nbsp;=&nbsp;False<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._user_ptr&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._graphics&nbsp;=&nbsp;graphics<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._window_fb_handle&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Callbacks<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._framebuffer_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cursor_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._scroll_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._mouse_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._key_callback&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;BackendWindow&nbsp;API&nbsp;----------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;close(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._closed:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._closed&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;should_close(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._closed&nbsp;or&nbsp;not&nbsp;self._widget.isVisible()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;make_current(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;QOpenGLWidget&nbsp;сам&nbsp;делает&nbsp;makeCurrent()&nbsp;прямо&nbsp;перед&nbsp;paintGL<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;но&nbsp;движок&nbsp;может&nbsp;вызвать&nbsp;это&nbsp;—&nbsp;тогда&nbsp;просто&nbsp;делегируем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.makeCurrent()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;swap_buffers(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;QOpenGLWidget&nbsp;сам&nbsp;вызывает&nbsp;swapBuffers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;framebuffer_size(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ratio&nbsp;=&nbsp;self._widget.devicePixelRatioF()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;int(self._widget.width()&nbsp;*&nbsp;ratio),&nbsp;int(self._widget.height()&nbsp;*&nbsp;ratio)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;window_size(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._widget.width(),&nbsp;self._widget.height()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_cursor_pos(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;=&nbsp;self._widget.mapFromGlobal(QtGui.QCursor.pos())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;float(pos.x()),&nbsp;float(pos.y())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_should_close(self,&nbsp;flag:&nbsp;bool):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;flag:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_user_pointer(self,&nbsp;ptr):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._user_ptr&nbsp;=&nbsp;ptr<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;callback&nbsp;setters&nbsp;-----------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_framebuffer_size_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._framebuffer_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_cursor_pos_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cursor_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_scroll_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._scroll_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_mouse_button_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._mouse_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_key_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._key_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Чтобы&nbsp;движок&nbsp;понимал&nbsp;push-модель&nbsp;Qt&nbsp;----------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;drives_render(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;widget(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._widget<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;request_update(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ask&nbsp;Qt&nbsp;to&nbsp;repaint&nbsp;the&nbsp;widget&nbsp;(this&nbsp;will&nbsp;call&nbsp;paintGL)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.update()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_window_framebuffer(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo_id&nbsp;=&nbsp;int(self._widget.defaultFramebufferObject())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width,&nbsp;height&nbsp;=&nbsp;self.framebuffer_size()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._window_fb_handle&nbsp;is&nbsp;None&nbsp;and&nbsp;self._graphics&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._window_fb_handle&nbsp;=&nbsp;self._graphics.create_external_framebuffer(fbo_id,&nbsp;width,&nbsp;height)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;self._window_fb_handle&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._window_fb_handle.set_external_target(fbo_id,&nbsp;width,&nbsp;height)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._window_fb_handle<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_graphics(self,&nbsp;graphics:&nbsp;OpenGLGraphicsBackend)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Set&nbsp;graphics&nbsp;backend&nbsp;for&nbsp;framebuffer&nbsp;creation.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._graphics&nbsp;=&nbsp;graphics<br>
<br>
<br>
<br>
<br>
class&nbsp;QtWindowBackend(WindowBackend):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Window&nbsp;backend&nbsp;using&nbsp;QOpenGLWidget&nbsp;and&nbsp;Qt&nbsp;event&nbsp;loop.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app:&nbsp;Optional[QtWidgets.QApplication]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics:&nbsp;Optional[OpenGLGraphicsBackend]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vsync:&nbsp;bool&nbsp;=&nbsp;False,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app&nbsp;=&nbsp;app&nbsp;or&nbsp;_qt_app()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._graphics&nbsp;=&nbsp;graphics<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._vsync&nbsp;=&nbsp;vsync<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_graphics(self,&nbsp;graphics:&nbsp;OpenGLGraphicsBackend)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Set&nbsp;graphics&nbsp;backend&nbsp;for&nbsp;new&nbsp;windows.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._graphics&nbsp;=&nbsp;graphics<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;create_window(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share:&nbsp;Optional[BackendWindow]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent:&nbsp;Optional[QtWidgets.QWidget]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vsync:&nbsp;Optional[bool]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;QtGLWindowHandle:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;QtGLWindowHandle(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width,&nbsp;height,&nbsp;title,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share=share,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent=parent,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics=self._graphics,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vsync=vsync&nbsp;if&nbsp;vsync&nbsp;is&nbsp;not&nbsp;None&nbsp;else&nbsp;self._vsync,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;poll_events(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app.processEvents()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;terminate(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app.quit()<br>
<!-- END SCAT CODE -->
</body>
</html>
