<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/platform/backends/qt.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;PyQt5-based&nbsp;window&nbsp;backend&nbsp;using&nbsp;QOpenGLWindow.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Callable,&nbsp;Optional,&nbsp;Any<br>
<br>
from&nbsp;PyQt5&nbsp;import&nbsp;QtCore,&nbsp;QtGui,&nbsp;QtWidgets<br>
<br>
from&nbsp;.base&nbsp;import&nbsp;Action,&nbsp;BackendWindow,&nbsp;Key,&nbsp;MouseButton,&nbsp;WindowBackend<br>
<br>
from&nbsp;OpenGL&nbsp;import&nbsp;GL<br>
from&nbsp;OpenGL&nbsp;import&nbsp;GL&nbsp;as&nbsp;gl<br>
<br>
<br>
<br>
def&nbsp;_qt_app()&nbsp;-&gt;&nbsp;QtWidgets.QApplication:<br>
&nbsp;&nbsp;&nbsp;&nbsp;app&nbsp;=&nbsp;QtWidgets.QApplication.instance()<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;app&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app&nbsp;=&nbsp;QtWidgets.QApplication([])<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;app<br>
<br>
<br>
def&nbsp;_translate_mouse(button:&nbsp;QtCore.Qt.MouseButton)&nbsp;-&gt;&nbsp;MouseButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;button&nbsp;==&nbsp;QtCore.Qt.LeftButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.LEFT<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;button&nbsp;==&nbsp;QtCore.Qt.RightButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.RIGHT<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;button&nbsp;==&nbsp;QtCore.Qt.MiddleButton:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.MIDDLE<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MouseButton.LEFT<br>
<br>
<br>
def&nbsp;_translate_action(action:&nbsp;bool)&nbsp;-&gt;&nbsp;Action:<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Action.PRESS&nbsp;if&nbsp;action&nbsp;else&nbsp;Action.RELEASE<br>
<br>
<br>
def&nbsp;_translate_key(key:&nbsp;int)&nbsp;-&gt;&nbsp;Key:<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;==&nbsp;QtCore.Qt.Key_Escape:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key.ESCAPE<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;==&nbsp;QtCore.Qt.Key_Space:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key.SPACE<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key(key)<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ValueError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Key.UNKNOWN<br>
<br>
<br>
class&nbsp;_QtGLWidget(QtWidgets.QOpenGLWidget):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;owner:&nbsp;&quot;QtGLWindowHandle&quot;,&nbsp;parent=None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(parent)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._owner&nbsp;=&nbsp;owner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setFocusPolicy(QtCore.Qt.StrongFocus)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setUpdateBehavior(QtWidgets.QOpenGLWidget.PartialUpdate)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.setMouseTracking(True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;События&nbsp;мыши&nbsp;/&nbsp;клавиатуры&nbsp;--------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mousePressEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._mouse_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_mouse(event.button()),&nbsp;Action.PRESS,&nbsp;int(event.modifiers()))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mouseReleaseEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._mouse_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_mouse(event.button()),&nbsp;Action.RELEASE,&nbsp;int(event.modifiers()))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mouseMoveEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._cursor_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;float(event.x()),&nbsp;float(event.y()))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;wheelEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;angle&nbsp;=&nbsp;event.angleDelta()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._scroll_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;angle.x()&nbsp;/&nbsp;120.0,&nbsp;angle.y()&nbsp;/&nbsp;120.0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;keyPressEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._key_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_key(event.key()),&nbsp;event.nativeScanCode(),&nbsp;Action.PRESS,&nbsp;int(event.modifiers()))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;keyReleaseEvent(self,&nbsp;event):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._key_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;_translate_key(event.key()),&nbsp;event.nativeScanCode(),&nbsp;Action.RELEASE,&nbsp;int(event.modifiers()))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Рендер&nbsp;----------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;paintGL(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Тут&nbsp;есть&nbsp;активный&nbsp;GL-контекст&nbsp;—&nbsp;выполняем&nbsp;рендер&nbsp;движка<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window_obj&nbsp;=&nbsp;self._owner._user_ptr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;window_obj&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window_obj.render(from_backend=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;resizeGL(self,&nbsp;w,&nbsp;h):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;=&nbsp;self._owner._framebuffer_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cb:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(self._owner,&nbsp;w,&nbsp;h)<br>
<br>
<br>
class&nbsp;QtGLWindowHandle(BackendWindow):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;width,&nbsp;height,&nbsp;title,&nbsp;share=None,&nbsp;parent=None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app&nbsp;=&nbsp;_qt_app()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget&nbsp;=&nbsp;_QtGLWidget(self,&nbsp;parent=parent)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.setMinimumSize(50,&nbsp;50)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.resize(width,&nbsp;height)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.show()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._closed&nbsp;=&nbsp;False<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._user_ptr&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Все&nbsp;callback-и&nbsp;окна&nbsp;(их&nbsp;вызывает&nbsp;Window)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._framebuffer_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cursor_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._scroll_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._mouse_callback&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._key_callback&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;BackendWindow&nbsp;API&nbsp;----------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;close(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._closed:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._closed&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;should_close(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._closed&nbsp;or&nbsp;not&nbsp;self._widget.isVisible()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;make_current(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;QOpenGLWidget&nbsp;сам&nbsp;делает&nbsp;makeCurrent()&nbsp;прямо&nbsp;перед&nbsp;paintGL<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;но&nbsp;движок&nbsp;может&nbsp;вызвать&nbsp;это&nbsp;—&nbsp;тогда&nbsp;просто&nbsp;делегируем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.makeCurrent()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;swap_buffers(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;QOpenGLWidget&nbsp;сам&nbsp;вызывает&nbsp;swapBuffers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;framebuffer_size(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ratio&nbsp;=&nbsp;self._widget.devicePixelRatioF()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;int(self._widget.width()&nbsp;*&nbsp;ratio),&nbsp;int(self._widget.height()&nbsp;*&nbsp;ratio)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;window_size(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._widget.width(),&nbsp;self._widget.height()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_cursor_pos(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;=&nbsp;self._widget.mapFromGlobal(QtGui.QCursor.pos())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;float(pos.x()),&nbsp;float(pos.y())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_should_close(self,&nbsp;flag:&nbsp;bool):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;flag:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_user_pointer(self,&nbsp;ptr):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._user_ptr&nbsp;=&nbsp;ptr<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;callback&nbsp;setters&nbsp;-----------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_framebuffer_size_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._framebuffer_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_cursor_pos_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cursor_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_scroll_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._scroll_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_mouse_button_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._mouse_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_key_callback(self,&nbsp;cb):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._key_callback&nbsp;=&nbsp;cb<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Чтобы&nbsp;движок&nbsp;понимал&nbsp;push-модель&nbsp;Qt&nbsp;----------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;drives_render(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;widget(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._widget<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;request_update(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Просим&nbsp;Qt&nbsp;перерисовать&nbsp;виджет&nbsp;(это&nbsp;вызовет&nbsp;paintGL)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._widget.update()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_window_framebuffer(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo_id&nbsp;=&nbsp;int(self._widget.defaultFramebufferObject())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width,&nbsp;height&nbsp;=&nbsp;self.framebuffer_size()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.opengl.backends&nbsp;import&nbsp;OpenGLFramebufferHandle<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb&nbsp;=&nbsp;getattr(self,&nbsp;&quot;_window_fb_handle&quot;,&nbsp;None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fb&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb&nbsp;=&nbsp;OpenGLFramebufferHandle((width,&nbsp;height),&nbsp;fbo_id=fbo_id,&nbsp;owns_attachments=False)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._window_fb_handle&nbsp;=&nbsp;fb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb.set_external_target(fbo_id,&nbsp;(width,&nbsp;height))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fb<br>
<br>
<br>
<br>
<br>
class&nbsp;QtWindowBackend(WindowBackend):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Window&nbsp;backend,&nbsp;использующий&nbsp;QOpenGLWindow&nbsp;и&nbsp;Qt&nbsp;event&nbsp;loop.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;app:&nbsp;Optional[QtWidgets.QApplication]&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app&nbsp;=&nbsp;app&nbsp;or&nbsp;_qt_app()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;create_window(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share:&nbsp;Optional[BackendWindow]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent:&nbsp;Optional[QtWidgets.QWidget]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;QtGLWindowHandle:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;QtGLWindowHandle(width,&nbsp;height,&nbsp;title,&nbsp;share=share,&nbsp;parent=parent)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;poll_events(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Обрабатываем&nbsp;накопившиеся&nbsp;Qt-события<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app.processEvents()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;terminate(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.app.quit()<br>
<!-- END SCAT CODE -->
</body>
</html>
