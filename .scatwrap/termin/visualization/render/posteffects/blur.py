<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/posteffects/blur.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
from&nbsp;..postprocess&nbsp;import&nbsp;PostEffect<br>
from&nbsp;termin.editor.inspect_field&nbsp;import&nbsp;InspectField<br>
<br>
#&nbsp;================================================================<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TWO-PASS&nbsp;GAUSSIAN&nbsp;BLUR&nbsp;(H&nbsp;+&nbsp;V)<br>
#&nbsp;================================================================<br>
<br>
GAUSS_VERT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
layout(location=0)&nbsp;in&nbsp;vec2&nbsp;a_pos;<br>
layout(location=1)&nbsp;in&nbsp;vec2&nbsp;a_uv;<br>
out&nbsp;vec2&nbsp;v_uv;<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_uv&nbsp;=&nbsp;a_uv;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vec4(a_pos,&nbsp;0.0,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
GAUSS_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
in&nbsp;vec2&nbsp;v_uv;<br>
<br>
uniform&nbsp;sampler2D&nbsp;u_texture;<br>
uniform&nbsp;vec2&nbsp;u_direction;&nbsp;&nbsp;&nbsp;//&nbsp;(1,0)&nbsp;for&nbsp;horizontal,&nbsp;(0,1)&nbsp;for&nbsp;vertical<br>
uniform&nbsp;vec2&nbsp;u_texel_size;&nbsp;&nbsp;//&nbsp;1.0&nbsp;/&nbsp;resolution<br>
<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
//&nbsp;5-tap&nbsp;gaussian&nbsp;weights&nbsp;(approx&nbsp;sigma=2)<br>
const&nbsp;float&nbsp;w0&nbsp;=&nbsp;0.227027;<br>
const&nbsp;float&nbsp;w1&nbsp;=&nbsp;0.316216;<br>
const&nbsp;float&nbsp;w2&nbsp;=&nbsp;0.070270;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec2&nbsp;ts&nbsp;=&nbsp;u_texel_size;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec2&nbsp;dir&nbsp;=&nbsp;u_direction;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;c&nbsp;=&nbsp;texture(u_texture,&nbsp;v_uv).rgb&nbsp;*&nbsp;w0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;+=&nbsp;texture(u_texture,&nbsp;v_uv&nbsp;+&nbsp;dir&nbsp;*&nbsp;ts&nbsp;*&nbsp;1.0).rgb&nbsp;*&nbsp;w1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;+=&nbsp;texture(u_texture,&nbsp;v_uv&nbsp;-&nbsp;dir&nbsp;*&nbsp;ts&nbsp;*&nbsp;1.0).rgb&nbsp;*&nbsp;w1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;+=&nbsp;texture(u_texture,&nbsp;v_uv&nbsp;+&nbsp;dir&nbsp;*&nbsp;ts&nbsp;*&nbsp;2.0).rgb&nbsp;*&nbsp;w2;<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;+=&nbsp;texture(u_texture,&nbsp;v_uv&nbsp;-&nbsp;dir&nbsp;*&nbsp;ts&nbsp;*&nbsp;2.0).rgb&nbsp;*&nbsp;w2;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(c,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
#&nbsp;Lazy-loaded&nbsp;shared&nbsp;shader<br>
_blur_shader:&nbsp;TcShader&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
def&nbsp;_get_blur_shader()&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_blur_shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_blur_shader&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_blur_shader&nbsp;=&nbsp;TcShader.from_sources(GAUSS_VERT,&nbsp;GAUSS_FRAG,&nbsp;&quot;&quot;,&nbsp;&quot;GaussianBlur&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_blur_shader<br>
<br>
<br>
class&nbsp;GaussianBlurPass(PostEffect):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Один&nbsp;проход:&nbsp;горизонтальный&nbsp;или&nbsp;вертикальный.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;&quot;gaussian_blur&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;inspect_fields&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;direction&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;direction&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Direction&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;enum&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;choices=[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((1.0,&nbsp;0.0),&nbsp;&quot;Horizontal&quot;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((0.0,&nbsp;1.0),&nbsp;&quot;Vertical&quot;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;direction=(1.0,&nbsp;0.0)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.direction&nbsp;=&nbsp;np.array(direction,&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw(self,&nbsp;gfx,&nbsp;color_tex,&nbsp;extra_textures,&nbsp;size,&nbsp;target_fbo=None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;texel_size&nbsp;=&nbsp;(1.0&nbsp;/&nbsp;max(1,&nbsp;w),&nbsp;1.0&nbsp;/&nbsp;max(1,&nbsp;h))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;_get_blur_shader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.ensure_ready()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.use()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color_tex.bind(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_texture&quot;,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec2(&quot;u_texel_size&quot;,&nbsp;texel_size[0],&nbsp;texel_size[1])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec2(&quot;u_direction&quot;,&nbsp;float(self.direction[0]),&nbsp;float(self.direction[1]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_test(False)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_cull_face(False)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_blend(False)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.draw_ui_textured_quad()<br>
<!-- END SCAT CODE -->
</body>
</html>
