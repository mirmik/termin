<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/posteffects/fog.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.visualization.render.postprocess&nbsp;import&nbsp;PostEffect<br>
from&nbsp;termin.visualization.render.shader&nbsp;import&nbsp;ShaderProgram<br>
<br>
FOG_VERT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec2&nbsp;a_pos;<br>
layout(location&nbsp;=&nbsp;1)&nbsp;in&nbsp;vec2&nbsp;a_uv;<br>
out&nbsp;vec2&nbsp;v_uv;<br>
<br>
void&nbsp;main()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_uv&nbsp;=&nbsp;a_uv;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vec4(a_pos,&nbsp;0.0,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
FOG_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
in&nbsp;vec2&nbsp;v_uv;<br>
<br>
uniform&nbsp;sampler2D&nbsp;u_color;&nbsp;&nbsp;&nbsp;//&nbsp;основной&nbsp;цветной&nbsp;рендер&nbsp;(после&nbsp;ColorPass)<br>
uniform&nbsp;sampler2D&nbsp;u_depth;&nbsp;&nbsp;&nbsp;//&nbsp;depth-карта,&nbsp;сгенерированная&nbsp;DepthPass<br>
<br>
uniform&nbsp;vec3&nbsp;&nbsp;u_fog_color;&nbsp;&nbsp;&nbsp;//&nbsp;цвет&nbsp;тумана<br>
uniform&nbsp;float&nbsp;u_fog_start;&nbsp;&nbsp;&nbsp;//&nbsp;нормализованная&nbsp;глубина,&nbsp;с&nbsp;которой&nbsp;начинается&nbsp;туман<br>
uniform&nbsp;float&nbsp;u_fog_end;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;нормализованная&nbsp;глубина,&nbsp;где&nbsp;туман&nbsp;максимален<br>
<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
void&nbsp;main()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;base_color&nbsp;=&nbsp;texture(u_color,&nbsp;v_uv);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;depth&nbsp;=&nbsp;texture(u_depth,&nbsp;v_uv).r;&nbsp;//&nbsp;0..1&nbsp;линейная&nbsp;глубина<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Вычисляем&nbsp;степень&nbsp;тумана:&nbsp;0&nbsp;-&gt;&nbsp;нет,&nbsp;1&nbsp;-&gt;&nbsp;полностью&nbsp;туман<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;fog_factor&nbsp;=&nbsp;0.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(u_fog_end&nbsp;&gt;&nbsp;u_fog_start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_factor&nbsp;=&nbsp;(depth&nbsp;-&nbsp;u_fog_start)&nbsp;/&nbsp;(u_fog_end&nbsp;-&nbsp;u_fog_start);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_factor&nbsp;=&nbsp;clamp(fog_factor,&nbsp;0.0,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;fogged&nbsp;=&nbsp;mix(base_color.rgb,&nbsp;u_fog_color,&nbsp;fog_factor);<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(fogged,&nbsp;base_color.a);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FogEffect(PostEffect):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Простой&nbsp;пост-эффект&nbsp;тумана,&nbsp;использующий&nbsp;depth-карту.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;depth-карта&nbsp;—&nbsp;это&nbsp;ресурс&nbsp;FrameGraph&nbsp;с&nbsp;именем,&nbsp;например,&nbsp;&quot;depth&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;который&nbsp;пишет&nbsp;DepthPass.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;&quot;fog&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_color=(0.6,&nbsp;0.7,&nbsp;0.8),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_start:&nbsp;float&nbsp;=&nbsp;0.2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_end:&nbsp;float&nbsp;=&nbsp;1.0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_start&nbsp;/&nbsp;fog_end&nbsp;—&nbsp;в&nbsp;диапазоне&nbsp;[0,&nbsp;1]&nbsp;по&nbsp;линейной&nbsp;глубине:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.0&nbsp;&nbsp;-&gt;&nbsp;около&nbsp;near<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.0&nbsp;&nbsp;-&gt;&nbsp;около&nbsp;far<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;При&nbsp;depth&nbsp;&lt;&nbsp;fog_start&nbsp;тумана&nbsp;нет,&nbsp;при&nbsp;depth&nbsp;&gt;&nbsp;fog_end&nbsp;—&nbsp;туман&nbsp;максимален.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._fog_color&nbsp;=&nbsp;fog_color<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._fog_start&nbsp;=&nbsp;float(fog_start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._fog_end&nbsp;=&nbsp;float(fog_end)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._shader:&nbsp;ShaderProgram&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;required_resources(self)&nbsp;-&gt;&nbsp;set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Нужен&nbsp;ресурс&nbsp;&quot;depth&quot;,&nbsp;который&nbsp;заполняет&nbsp;DepthPass<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{&quot;depth&quot;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_get_shader(self)&nbsp;-&gt;&nbsp;ShaderProgram:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._shader&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._shader&nbsp;=&nbsp;ShaderProgram(FOG_VERT,&nbsp;FOG_FRAG)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._shader<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw(self,&nbsp;gfx,&nbsp;context_key,&nbsp;color_tex,&nbsp;extra_textures,&nbsp;size):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_tex&nbsp;=&nbsp;extra_textures.get(&quot;depth&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;depth&nbsp;нет&nbsp;—&nbsp;на&nbsp;всякий&nbsp;случай&nbsp;просто&nbsp;пробрасываем&nbsp;цвет<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;depth_tex&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;self._get_shader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.ensure_ready(gfx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.use()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color_tex.bind(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_color&quot;,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;заглушки<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;u_fog_color&quot;,&nbsp;np.array(self._fog_color,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(&quot;u_fog_start&quot;,&nbsp;1.0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(&quot;u_fog_end&quot;,&nbsp;1.0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.draw_ui_textured_quad(context_key)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;self._get_shader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.ensure_ready(gfx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.use()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Основной&nbsp;цвет<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color_tex.bind(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_color&quot;,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;depth-карта<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_tex.bind(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_depth&quot;,&nbsp;1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fog_color_vec&nbsp;=&nbsp;np.array(self._fog_color,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(&quot;u_fog_color&quot;,&nbsp;fog_color_vec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(&quot;u_fog_start&quot;,&nbsp;self._fog_start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(&quot;u_fog_end&quot;,&nbsp;self._fog_end)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.draw_ui_textured_quad(context_key)<br>
<!-- END SCAT CODE -->
</body>
</html>
