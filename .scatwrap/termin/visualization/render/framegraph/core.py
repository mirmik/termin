<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/framegraph/core.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass,&nbsp;field<br>
from&nbsp;typing&nbsp;import&nbsp;Dict,&nbsp;Iterable,&nbsp;List,&nbsp;Set,&nbsp;Tuple,&nbsp;Tuple<br>
from&nbsp;collections&nbsp;import&nbsp;deque<br>
<br>
<br>
@dataclass<br>
class&nbsp;FramePass:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Логический&nbsp;проход&nbsp;кадра.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;reads&nbsp;&nbsp;–&nbsp;какие&nbsp;ресурсы&nbsp;этот&nbsp;проход&nbsp;читает&nbsp;(по&nbsp;именам).<br>
&nbsp;&nbsp;&nbsp;&nbsp;writes&nbsp;–&nbsp;какие&nbsp;ресурсы&nbsp;он&nbsp;пишет.<br>
&nbsp;&nbsp;&nbsp;&nbsp;enabled&nbsp;–&nbsp;включён&nbsp;ли&nbsp;проход;&nbsp;отключённые&nbsp;пассы&nbsp;игнорируются&nbsp;при&nbsp;построении&nbsp;графа.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Inplace-семантика&nbsp;определяется&nbsp;через&nbsp;get_inplace_aliases():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Если&nbsp;метод&nbsp;возвращает&nbsp;непустой&nbsp;список&nbsp;пар&nbsp;[(read,&nbsp;write),&nbsp;...],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;то&nbsp;пасс&nbsp;считается&nbsp;inplace&nbsp;—&nbsp;он&nbsp;читает&nbsp;и&nbsp;пишет&nbsp;один&nbsp;и&nbsp;тот&nbsp;же<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;физический&nbsp;ресурс&nbsp;под&nbsp;разными&nbsp;именами.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Внутренние&nbsp;точки&nbsp;(internal&nbsp;debug&nbsp;points):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Некоторые&nbsp;пассы&nbsp;могут&nbsp;объявлять&nbsp;«внутренние»&nbsp;точки&nbsp;наблюдения,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;связанные&nbsp;с&nbsp;их&nbsp;внутренними&nbsp;сущностями&nbsp;(например,&nbsp;отдельные&nbsp;меши,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;стадии&nbsp;рендера&nbsp;и&nbsp;т.п.).&nbsp;По&nbsp;умолчанию&nbsp;проход&nbsp;не&nbsp;имеет&nbsp;таких&nbsp;точек.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass_name:&nbsp;str<br>
&nbsp;&nbsp;&nbsp;&nbsp;reads:&nbsp;Set[str]&nbsp;=&nbsp;field(default_factory=set)<br>
&nbsp;&nbsp;&nbsp;&nbsp;writes:&nbsp;Set[str]&nbsp;=&nbsp;field(default_factory=set)<br>
&nbsp;&nbsp;&nbsp;&nbsp;enabled:&nbsp;bool&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Конфигурация&nbsp;внутренней&nbsp;точки&nbsp;дебага&nbsp;(символ&nbsp;и&nbsp;целевой&nbsp;ресурс).<br>
&nbsp;&nbsp;&nbsp;&nbsp;debug_internal_symbol:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;debug_internal_output:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__repr__(self)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;f&quot;FramePass({self.pass_name!r})&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----&nbsp;API&nbsp;inplace-алиасов&nbsp;---------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_inplace_aliases(self)&nbsp;-&gt;&nbsp;List[Tuple[str,&nbsp;str]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;список&nbsp;пар&nbsp;алиасов&nbsp;для&nbsp;inplace-операций.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Каждая&nbsp;пара&nbsp;(read_name,&nbsp;write_name)&nbsp;означает,&nbsp;что&nbsp;пасс<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;читает&nbsp;ресурс&nbsp;read_name&nbsp;и&nbsp;пишет&nbsp;в&nbsp;write_name,&nbsp;но&nbsp;физически<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;это&nbsp;один&nbsp;и&nbsp;тот&nbsp;же&nbsp;ресурс&nbsp;(буфер).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Пример:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorPass&nbsp;читает&nbsp;&quot;empty&quot;&nbsp;и&nbsp;пишет&nbsp;&quot;color&quot;&nbsp;inplace:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[(&quot;empty&quot;,&nbsp;&quot;color&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Пустой&nbsp;список&nbsp;означает,&nbsp;что&nbsp;пасс&nbsp;не&nbsp;является&nbsp;inplace.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;inplace(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Является&nbsp;ли&nbsp;пасс&nbsp;inplace.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Вычисляется&nbsp;динамически&nbsp;на&nbsp;основе&nbsp;get_inplace_aliases().<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(self.get_inplace_aliases())&nbsp;&gt;&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----&nbsp;API&nbsp;внутренних&nbsp;точек&nbsp;---------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_internal_symbols(self)&nbsp;-&gt;&nbsp;List[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;список&nbsp;доступных&nbsp;внутренних&nbsp;символов/точек&nbsp;для&nbsp;этого&nbsp;пасса.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Базовая&nbsp;реализация&nbsp;ничего&nbsp;не&nbsp;знает&nbsp;о&nbsp;внутренних&nbsp;точках&nbsp;и<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;возвращает&nbsp;пустой&nbsp;список.&nbsp;Конкретные&nbsp;реализации&nbsp;пассов&nbsp;могут<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;переопределять&nbsp;метод&nbsp;и&nbsp;формировать&nbsp;список&nbsp;динамически.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_debug_internal_point(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;symbol:&nbsp;str&nbsp;|&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_res:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Устанавливает&nbsp;(или&nbsp;сбрасывает)&nbsp;активную&nbsp;внутреннюю&nbsp;точку&nbsp;дебага.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;symbol:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Имя&nbsp;внутреннего&nbsp;символа,&nbsp;на&nbsp;который&nbsp;следует&nbsp;«подписаться».<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;None&nbsp;—&nbsp;сброс&nbsp;настройки.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_res:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Имя&nbsp;ресурса&nbsp;(FBO),&nbsp;в&nbsp;который&nbsp;пасс&nbsp;при&nbsp;необходимости<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;должен&nbsp;выводить&nbsp;состояние&nbsp;для&nbsp;выбранного&nbsp;символа.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;При&nbsp;установке&nbsp;output_res&nbsp;он&nbsp;добавляется&nbsp;в&nbsp;writes&nbsp;пасса,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;при&nbsp;сбросе&nbsp;—&nbsp;удаляется.&nbsp;Это&nbsp;позволяет&nbsp;framegraph&nbsp;корректно<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;учитывать&nbsp;debug-ресурс&nbsp;при&nbsp;построении&nbsp;графа&nbsp;зависимостей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Удаляем&nbsp;старый&nbsp;debug_internal_output&nbsp;из&nbsp;writes,&nbsp;если&nbsp;он&nbsp;был<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.debug_internal_output&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.writes.discard(self.debug_internal_output)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.debug_internal_symbol&nbsp;=&nbsp;symbol<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.debug_internal_output&nbsp;=&nbsp;output_res<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Добавляем&nbsp;новый&nbsp;debug_internal_output&nbsp;в&nbsp;writes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;output_res&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.writes.add(output_res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_debug_internal_point(self)&nbsp;-&gt;&nbsp;tuple[str&nbsp;|&nbsp;None,&nbsp;str&nbsp;|&nbsp;None]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Текущая&nbsp;конфигурация&nbsp;внутренней&nbsp;точки&nbsp;дебага:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(symbol,&nbsp;output_res).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.debug_internal_symbol,&nbsp;self.debug_internal_output<br>
<br>
<br>
class&nbsp;FrameGraphError(Exception):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Базовая&nbsp;ошибка&nbsp;графа&nbsp;кадра.&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FrameGraphMultiWriterError(FrameGraphError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Один&nbsp;и&nbsp;тот&nbsp;же&nbsp;ресурс&nbsp;пишут&nbsp;несколько&nbsp;пассов.&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FrameGraphCycleError(FrameGraphError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;В&nbsp;графе&nbsp;зависимостей&nbsp;обнаружен&nbsp;цикл.&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FrameGraph:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Простейший&nbsp;frame&nbsp;graph:&nbsp;на&nbsp;вход&nbsp;–&nbsp;набор&nbsp;FramePass,<br>
&nbsp;&nbsp;&nbsp;&nbsp;на&nbsp;выход&nbsp;–&nbsp;топологически&nbsp;отсортированный&nbsp;список&nbsp;пассов.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Пассы&nbsp;с&nbsp;enabled=False&nbsp;игнорируются&nbsp;при&nbsp;построении&nbsp;графа&nbsp;и<br>
&nbsp;&nbsp;&nbsp;&nbsp;не&nbsp;попадают&nbsp;в&nbsp;итоговое&nbsp;расписание.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;passes:&nbsp;Iterable[FramePass]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._all_passes:&nbsp;List[FramePass]&nbsp;=&nbsp;list(passes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Фильтруем&nbsp;только&nbsp;включённые&nbsp;пассы&nbsp;для&nbsp;построения&nbsp;графа<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._passes:&nbsp;List[FramePass]&nbsp;=&nbsp;[p&nbsp;for&nbsp;p&nbsp;in&nbsp;self._all_passes&nbsp;if&nbsp;p.enabled]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;карта&nbsp;&quot;ресурс&nbsp;-&gt;&nbsp;каноническое&nbsp;имя&quot;&nbsp;(на&nbsp;будущее&nbsp;—&nbsp;для&nbsp;дебага&nbsp;/&nbsp;инспекции)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._canonical_resources:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ВНУТРЕННЕЕ&nbsp;ПРЕДСТАВЛЕНИЕ&nbsp;ГРАФА&nbsp;ЗАВИСИМОСТЕЙ<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Всё&nbsp;строим&nbsp;на&nbsp;ИНДЕКСАХ&nbsp;пассов&nbsp;(0..N-1),&nbsp;а&nbsp;не&nbsp;на&nbsp;самих&nbsp;объектах,<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;чтобы&nbsp;вообще&nbsp;не&nbsp;зависеть&nbsp;от&nbsp;их&nbsp;hash/eq.<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_build_dependency_graph(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Строит&nbsp;граф&nbsp;зависимостей&nbsp;между&nbsp;пассами.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency:&nbsp;dict[int,&nbsp;list[int]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;для&nbsp;каждого&nbsp;индекса&nbsp;пасса&nbsp;–&nbsp;список&nbsp;индексов&nbsp;пассов,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;которые&nbsp;зависят&nbsp;от&nbsp;него&nbsp;(есть&nbsp;ребро&nbsp;writer&nbsp;-&gt;&nbsp;reader).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree:&nbsp;dict[int,&nbsp;int]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;количество&nbsp;входящих&nbsp;рёбер&nbsp;для&nbsp;каждого&nbsp;пасса.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer_for:&nbsp;Dict[str,&nbsp;int]&nbsp;=&nbsp;{}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ресурс&nbsp;-&gt;&nbsp;индекс&nbsp;писателя<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readers_for:&nbsp;Dict[str,&nbsp;List[int]]&nbsp;=&nbsp;{}&nbsp;&nbsp;&nbsp;#&nbsp;ресурс&nbsp;-&gt;&nbsp;список&nbsp;индексов&nbsp;читателей<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;для&nbsp;in-place&nbsp;логики<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modified_inputs:&nbsp;Set[str]&nbsp;=&nbsp;set()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;какие&nbsp;имена&nbsp;уже&nbsp;были&nbsp;входом&nbsp;inplace-пасса<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;локальная&nbsp;карта&nbsp;канонических&nbsp;имён<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;len(self._passes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1)&nbsp;собираем&nbsp;writer-ов,&nbsp;reader-ов&nbsp;и&nbsp;валидируем&nbsp;inplace-пассы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;idx,&nbsp;p&nbsp;in&nbsp;enumerate(self._passes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;валидация&nbsp;inplace-пассов&nbsp;через&nbsp;get_inplace_aliases&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace_aliases&nbsp;=&nbsp;p.get_inplace_aliases()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Валидируем&nbsp;каждый&nbsp;алиас<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;src,&nbsp;dst&nbsp;in&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;src&nbsp;not&nbsp;in&nbsp;p.reads:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Inplace&nbsp;alias&nbsp;source&nbsp;{src!r}&nbsp;not&nbsp;in&nbsp;reads&nbsp;of&nbsp;pass&nbsp;{p.pass_name!r}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dst&nbsp;not&nbsp;in&nbsp;p.writes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Inplace&nbsp;alias&nbsp;target&nbsp;{dst!r}&nbsp;not&nbsp;in&nbsp;writes&nbsp;of&nbsp;pass&nbsp;{p.pass_name!r}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;src&nbsp;in&nbsp;modified_inputs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Resource&nbsp;{src!r}&nbsp;is&nbsp;already&nbsp;modified&nbsp;by&nbsp;another&nbsp;inplace&nbsp;pass&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modified_inputs.add(src)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;writer-ы&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res&nbsp;in&nbsp;p.writes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;res&nbsp;in&nbsp;writer_for:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_idx&nbsp;=&nbsp;writer_for[res]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;=&nbsp;self._passes[other_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphMultiWriterError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Resource&nbsp;{res!r}&nbsp;is&nbsp;written&nbsp;by&nbsp;multiple&nbsp;passes:&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;{other.pass_name!r}&nbsp;and&nbsp;{p.pass_name!r}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer_for[res]&nbsp;=&nbsp;idx<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;каноническое&nbsp;имя:&nbsp;первое&nbsp;появление&nbsp;ресурса&nbsp;как&nbsp;writer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical.setdefault(res,&nbsp;res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;reader-ы&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res&nbsp;in&nbsp;p.reads:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lst&nbsp;=&nbsp;readers_for.setdefault(res,&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;idx&nbsp;not&nbsp;in&nbsp;lst:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lst.append(idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;если&nbsp;ресурс&nbsp;нигде&nbsp;не&nbsp;писали,&nbsp;но&nbsp;читают&nbsp;—&nbsp;считаем&nbsp;внешним&nbsp;входом<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical.setdefault(res,&nbsp;res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2)&nbsp;обработка&nbsp;алиасов&nbsp;для&nbsp;inplace-пассов&nbsp;из&nbsp;get_inplace_aliases<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;p&nbsp;in&nbsp;self._passes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace_aliases&nbsp;=&nbsp;p.get_inplace_aliases()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;src,&nbsp;dst&nbsp;in&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src_canon&nbsp;=&nbsp;canonical.get(src,&nbsp;src)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;выходу&nbsp;назначаем&nbsp;каноническое&nbsp;имя&nbsp;входа<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical[dst]&nbsp;=&nbsp;src_canon<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;сохраним&nbsp;карту&nbsp;канонических&nbsp;имён<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._canonical_resources&nbsp;=&nbsp;canonical<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3)&nbsp;adjacency&nbsp;и&nbsp;in_degree&nbsp;по&nbsp;индексам<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency:&nbsp;Dict[int,&nbsp;List[int]]&nbsp;=&nbsp;{i:&nbsp;[]&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n)}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree:&nbsp;Dict[int,&nbsp;int]&nbsp;=&nbsp;{i:&nbsp;0&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n)}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Для&nbsp;каждого&nbsp;ресурса:&nbsp;writer&nbsp;-&gt;&nbsp;все&nbsp;его&nbsp;reader-ы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res,&nbsp;w_idx&nbsp;in&nbsp;writer_for.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;r_idx&nbsp;in&nbsp;readers_for.get(res,&nbsp;()):&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;r_idx&nbsp;==&nbsp;w_idx:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue&nbsp;&nbsp;#&nbsp;на&nbsp;всякий&nbsp;случай,&nbsp;не&nbsp;создаём&nbsp;петли&nbsp;writer-&gt;writer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;r_idx&nbsp;not&nbsp;in&nbsp;adjacency[w_idx]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency[w_idx].append(r_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree[r_idx]&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;adjacency,&nbsp;in_degree<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ТОПОЛОГИЧЕСКАЯ&nbsp;СОРТИРОВКА&nbsp;(Kahn&nbsp;с&nbsp;приоритетом&nbsp;обычных&nbsp;пассов)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;build_schedule(self)&nbsp;-&gt;&nbsp;List[FramePass]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;список&nbsp;пассов&nbsp;в&nbsp;порядке&nbsp;выполнения,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;учитывая&nbsp;зависимости&nbsp;read-after-write.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Бросает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FrameGraphMultiWriterError,&nbsp;если&nbsp;один&nbsp;ресурс&nbsp;пишут&nbsp;несколько&nbsp;пассов.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FrameGraphCycleError,&nbsp;если&nbsp;обнаружен&nbsp;цикл.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FrameGraphError,&nbsp;если&nbsp;нарушены&nbsp;правила&nbsp;inplace-пассов.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency,&nbsp;in_degree&nbsp;=&nbsp;self._build_dependency_graph()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;len(self._passes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_inplace&nbsp;=&nbsp;[p.inplace&nbsp;for&nbsp;p&nbsp;in&nbsp;self._passes]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;две&nbsp;очереди:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;обычные&nbsp;пассы&nbsp;—&nbsp;в&nbsp;ready_normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;inplace-пассы&nbsp;—&nbsp;в&nbsp;ready_inplace<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_normal:&nbsp;deque[int]&nbsp;=&nbsp;deque()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_inplace:&nbsp;deque[int]&nbsp;=&nbsp;deque()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;in_degree[i]&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_inplace[i]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_inplace.append(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_normal.append(i)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_indices:&nbsp;List[int]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;ready_normal&nbsp;or&nbsp;ready_inplace:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;приоритет&nbsp;обычных&nbsp;пассов<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;ready_normal:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;ready_normal.popleft()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;ready_inplace.popleft()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_indices.append(idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;dep&nbsp;in&nbsp;adjacency[idx]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree[dep]&nbsp;-=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;in_degree[dep]&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_inplace[dep]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_inplace.append(dep)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_normal.append(dep)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(schedule_indices)&nbsp;!=&nbsp;n:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Остались&nbsp;вершины&nbsp;с&nbsp;in_degree&nbsp;&gt;&nbsp;0&nbsp;→&nbsp;цикл<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;problematic&nbsp;=&nbsp;[self._passes[i].pass_name&nbsp;for&nbsp;i,&nbsp;deg&nbsp;in&nbsp;in_degree.items()&nbsp;if&nbsp;deg&nbsp;&gt;&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphCycleError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Frame&nbsp;graph&nbsp;contains&nbsp;a&nbsp;dependency&nbsp;cycle&nbsp;involving&nbsp;passes:&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&quot;,&nbsp;&quot;.join(problematic)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Конвертируем&nbsp;индексы&nbsp;обратно&nbsp;в&nbsp;реальные&nbsp;пассы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[self._passes[i]&nbsp;for&nbsp;i&nbsp;in&nbsp;schedule_indices]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;опционально&nbsp;—&nbsp;геттер&nbsp;канонического&nbsp;имени&nbsp;ресурса&nbsp;(на&nbsp;будущее)<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;canonical_resource(self,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._canonical_resources.get(name,&nbsp;name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;fbo_alias_groups(self)&nbsp;-&gt;&nbsp;Dict[str,&nbsp;Set[str]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Группы&nbsp;синонимов&nbsp;ресурсов&nbsp;по&nbsp;каноническим&nbsp;именам.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;канон&nbsp;-&gt;&nbsp;множество&nbsp;всех&nbsp;имён,&nbsp;которые&nbsp;к&nbsp;нему&nbsp;сводятся.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups:&nbsp;Dict[str,&nbsp;Set[str]]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res,&nbsp;canon&nbsp;in&nbsp;self._canonical_resources.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups.setdefault(canon,&nbsp;set()).add(res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;groups<br>
<!-- END SCAT CODE -->
</body>
</html>
