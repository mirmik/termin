<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/framegraph/core.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Any,&nbsp;Callable,&nbsp;Dict,&nbsp;Iterable,&nbsp;List,&nbsp;Set,&nbsp;Tuple,&nbsp;TYPE_CHECKING<br>
from&nbsp;collections&nbsp;import&nbsp;deque<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;TcPass,<br>
&nbsp;&nbsp;&nbsp;&nbsp;TcPassRef,<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_pass_registry_register_python,<br>
&nbsp;&nbsp;&nbsp;&nbsp;tc_pass_registry_has,<br>
)<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.platform.backends.base&nbsp;import&nbsp;FramebufferHandle<br>
<br>
<br>
class&nbsp;FramePass:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Логический&nbsp;проход&nbsp;кадра.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;reads&nbsp;&nbsp;–&nbsp;какие&nbsp;ресурсы&nbsp;этот&nbsp;проход&nbsp;читает&nbsp;(по&nbsp;именам).&nbsp;Вычисляется&nbsp;динамически.<br>
&nbsp;&nbsp;&nbsp;&nbsp;writes&nbsp;–&nbsp;какие&nbsp;ресурсы&nbsp;он&nbsp;пишет.&nbsp;Вычисляется&nbsp;динамически.<br>
&nbsp;&nbsp;&nbsp;&nbsp;enabled&nbsp;–&nbsp;включён&nbsp;ли&nbsp;проход;&nbsp;отключённые&nbsp;пассы&nbsp;полностью&nbsp;игнорируются<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;при&nbsp;построении&nbsp;графа&nbsp;(не&nbsp;участвуют&nbsp;в&nbsp;зависимостях,&nbsp;не&nbsp;вызывают&nbsp;конфликтов).<br>
&nbsp;&nbsp;&nbsp;&nbsp;passthrough&nbsp;–&nbsp;если&nbsp;True,&nbsp;пасс&nbsp;остаётся&nbsp;в&nbsp;графе,&nbsp;но&nbsp;просто&nbsp;копирует&nbsp;input&nbsp;→&nbsp;output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;без&nbsp;реальной&nbsp;обработки&nbsp;(используется&nbsp;для&nbsp;временного&nbsp;отключения&nbsp;эффектов).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Inplace-семантика&nbsp;определяется&nbsp;через&nbsp;get_inplace_aliases():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Если&nbsp;метод&nbsp;возвращает&nbsp;непустой&nbsp;список&nbsp;пар&nbsp;[(read,&nbsp;write),&nbsp;...],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;то&nbsp;пасс&nbsp;считается&nbsp;inplace&nbsp;—&nbsp;он&nbsp;читает&nbsp;и&nbsp;пишет&nbsp;один&nbsp;и&nbsp;тот&nbsp;же<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;физический&nbsp;ресурс&nbsp;под&nbsp;разными&nbsp;именами.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Внутренние&nbsp;точки&nbsp;(internal&nbsp;debug&nbsp;points):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Некоторые&nbsp;пассы&nbsp;могут&nbsp;объявлять&nbsp;«внутренние»&nbsp;точки&nbsp;наблюдения,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;связанные&nbsp;с&nbsp;их&nbsp;внутренними&nbsp;сущностями&nbsp;(например,&nbsp;отдельные&nbsp;меши,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;стадии&nbsp;рендера&nbsp;и&nbsp;т.п.).&nbsp;По&nbsp;умолчанию&nbsp;проход&nbsp;не&nbsp;имеет&nbsp;таких&nbsp;точек.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Поля&nbsp;для&nbsp;редактирования&nbsp;в&nbsp;инспекторе&nbsp;(подклассы&nbsp;переопределяют)<br>
&nbsp;&nbsp;&nbsp;&nbsp;inspect_fields:&nbsp;dict&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Категория&nbsp;пасса&nbsp;для&nbsp;организации&nbsp;в&nbsp;меню&nbsp;редактора&nbsp;пайплайна<br>
&nbsp;&nbsp;&nbsp;&nbsp;category:&nbsp;str&nbsp;=&nbsp;&quot;Other&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Входы&nbsp;и&nbsp;выходы&nbsp;для&nbsp;node&nbsp;editor:&nbsp;список&nbsp;кортежей&nbsp;(name,&nbsp;socket_type)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;socket_type:&nbsp;&quot;fbo&quot;,&nbsp;&quot;texture&quot;,&nbsp;&quot;shadow&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_inputs:&nbsp;list&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_outputs:&nbsp;list&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Inplace&nbsp;пары:&nbsp;список&nbsp;кортежей&nbsp;(input_name,&nbsp;output_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Для&nbsp;этих&nbsp;пар&nbsp;input&nbsp;и&nbsp;output&nbsp;используют&nbsp;один&nbsp;и&nbsp;тот&nbsp;же&nbsp;FBO<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_inplace_pairs:&nbsp;list&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;pass_name:&nbsp;str&nbsp;=&nbsp;&quot;FramePass&quot;,&nbsp;viewport_name:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.pass_name&nbsp;=&nbsp;pass_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.enabled&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.passthrough&nbsp;=&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Viewport&nbsp;name&nbsp;for&nbsp;resolution&nbsp;and&nbsp;camera&nbsp;context<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;None&nbsp;=&nbsp;offscreen&nbsp;pass&nbsp;(uses&nbsp;explicit&nbsp;resolution&nbsp;from&nbsp;ResourceSpec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.viewport_name&nbsp;=&nbsp;viewport_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Конфигурация&nbsp;внутренней&nbsp;точки&nbsp;дебага.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.debug_internal_symbol:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;SDL&nbsp;окно&nbsp;дебаггера&nbsp;для&nbsp;блита&nbsp;промежуточного&nbsp;состояния.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._debugger_window:&nbsp;Any&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Callback&nbsp;для&nbsp;передачи&nbsp;depth&nbsp;buffer&nbsp;дебаггеру:&nbsp;(numpy_array)&nbsp;-&gt;&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._depth_capture_callback:&nbsp;&quot;Callable[[Any],&nbsp;None]&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Callback&nbsp;для&nbsp;сообщения&nbsp;об&nbsp;ошибке&nbsp;чтения&nbsp;depth:&nbsp;(str)&nbsp;-&gt;&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._depth_error_callback:&nbsp;&quot;Callable[[str],&nbsp;None]&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;C&nbsp;handle&nbsp;for&nbsp;tc_pass&nbsp;system&nbsp;(TcPass&nbsp;owns&nbsp;tc_pass,&nbsp;frees&nbsp;it&nbsp;in&nbsp;destructor)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc_pass_handle:&nbsp;&quot;TcPass&quot;&nbsp;=&nbsp;TcPass(self,&nbsp;self.__class__.__name__)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tc_pass_handle.pass_name&nbsp;=&nbsp;pass_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_tc_pass(self)&nbsp;-&gt;&nbsp;&quot;TcPassRef&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Return&nbsp;TcPassRef&nbsp;for&nbsp;C&nbsp;interop.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._tc_pass_handle.ref()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----&nbsp;reads/writes&nbsp;как&nbsp;вычисляемые&nbsp;свойства&nbsp;--------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;reads(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Ресурсы&nbsp;которые&nbsp;пасс&nbsp;читает.&nbsp;Вычисляется&nbsp;динамически.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.compute_reads()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;writes(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Ресурсы&nbsp;которые&nbsp;пасс&nbsp;пишет.&nbsp;Вычисляется&nbsp;динамически.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.compute_writes()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;compute_reads(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Вычисляет&nbsp;множество&nbsp;читаемых&nbsp;ресурсов.&nbsp;Подклассы&nbsp;переопределяют.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;set()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;compute_writes(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Вычисляет&nbsp;множество&nbsp;записываемых&nbsp;ресурсов.&nbsp;Подклассы&nbsp;переопределяют.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;set()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init_subclass__(cls,&nbsp;**kwargs):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Register&nbsp;subclass&nbsp;in&nbsp;InspectRegistry&nbsp;and&nbsp;pass&nbsp;type&nbsp;registry.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init_subclass__(**kwargs)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Don't&nbsp;register&nbsp;base&nbsp;classes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cls.__name__&nbsp;in&nbsp;(&quot;FramePass&quot;,&nbsp;&quot;RenderFramePass&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Register&nbsp;pass&nbsp;type&nbsp;in&nbsp;C&nbsp;registry&nbsp;with&nbsp;class&nbsp;for&nbsp;factory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;tc_pass_registry_has(cls.__name__):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tc_pass_registry_register_python(cls.__name__,&nbsp;cls)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.inspect&nbsp;import&nbsp;InspectRegistry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;registry&nbsp;=&nbsp;InspectRegistry.instance()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Register&nbsp;only&nbsp;own&nbsp;fields&nbsp;(not&nbsp;inherited)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;own_fields&nbsp;=&nbsp;cls.__dict__.get('inspect_fields',&nbsp;{})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;own_fields:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;registry.register_python_fields(cls.__name__,&nbsp;own_fields)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;parent&nbsp;type&nbsp;and&nbsp;register&nbsp;inheritance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_name&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;klass&nbsp;in&nbsp;cls.__mro__[1:]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;klass.__name__&nbsp;in&nbsp;(&quot;FramePass&quot;,&nbsp;&quot;RenderFramePass&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_name&nbsp;=&nbsp;klass.__name__<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'inspect_fields'&nbsp;in&nbsp;klass.__dict__:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_name&nbsp;=&nbsp;klass.__name__<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;parent_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;registry.set_type_parent(cls.__name__,&nbsp;parent_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ImportError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__repr__(self)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;f&quot;FramePass({self.pass_name!r})&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----&nbsp;API&nbsp;inplace-алиасов&nbsp;---------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_inplace_aliases(self)&nbsp;-&gt;&nbsp;List[Tuple[str,&nbsp;str]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;список&nbsp;пар&nbsp;алиасов&nbsp;для&nbsp;inplace-операций.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Каждая&nbsp;пара&nbsp;(read_name,&nbsp;write_name)&nbsp;означает,&nbsp;что&nbsp;пасс<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;читает&nbsp;ресурс&nbsp;read_name&nbsp;и&nbsp;пишет&nbsp;в&nbsp;write_name,&nbsp;но&nbsp;физически<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;это&nbsp;один&nbsp;и&nbsp;тот&nbsp;же&nbsp;ресурс&nbsp;(буфер).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Пример:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorPass&nbsp;читает&nbsp;&quot;empty&quot;&nbsp;и&nbsp;пишет&nbsp;&quot;color&quot;&nbsp;inplace:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[(&quot;empty&quot;,&nbsp;&quot;color&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Пустой&nbsp;список&nbsp;означает,&nbsp;что&nbsp;пасс&nbsp;не&nbsp;является&nbsp;inplace.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;inplace(self)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Является&nbsp;ли&nbsp;пасс&nbsp;inplace.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Вычисляется&nbsp;динамически&nbsp;на&nbsp;основе&nbsp;get_inplace_aliases().<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(self.get_inplace_aliases())&nbsp;&gt;&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----&nbsp;API&nbsp;внутренних&nbsp;точек&nbsp;---------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_internal_symbols(self)&nbsp;-&gt;&nbsp;List[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;список&nbsp;доступных&nbsp;внутренних&nbsp;символов/точек&nbsp;для&nbsp;этого&nbsp;пасса.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Базовая&nbsp;реализация&nbsp;ничего&nbsp;не&nbsp;знает&nbsp;о&nbsp;внутренних&nbsp;точках&nbsp;и<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;возвращает&nbsp;пустой&nbsp;список.&nbsp;Конкретные&nbsp;реализации&nbsp;пассов&nbsp;могут<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;переопределять&nbsp;метод&nbsp;и&nbsp;формировать&nbsp;список&nbsp;динамически.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_debug_internal_point(self,&nbsp;symbol:&nbsp;str&nbsp;|&nbsp;None)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Устанавливает&nbsp;(или&nbsp;сбрасывает)&nbsp;активную&nbsp;внутреннюю&nbsp;точку&nbsp;дебага.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;symbol:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Имя&nbsp;внутреннего&nbsp;символа,&nbsp;на&nbsp;который&nbsp;следует&nbsp;«подписаться».<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;None&nbsp;—&nbsp;сброс&nbsp;настройки.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Когда&nbsp;установлен&nbsp;символ&nbsp;и&nbsp;_capture_fbo,&nbsp;пасс&nbsp;при&nbsp;отрисовке<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;этого&nbsp;символа&nbsp;будет&nbsp;блитить&nbsp;текущее&nbsp;состояние&nbsp;в&nbsp;capture&nbsp;FBO.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.debug_internal_symbol&nbsp;=&nbsp;symbol<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_debug_internal_point(self)&nbsp;-&gt;&nbsp;str&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Возвращает&nbsp;текущий&nbsp;символ&nbsp;внутренней&nbsp;точки&nbsp;дебага.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.debug_internal_symbol<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_debugger_window(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_callback:&nbsp;Callable[[Any],&nbsp;None]&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_error_callback:&nbsp;Callable[[str],&nbsp;None]&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Устанавливает&nbsp;SDL&nbsp;окно&nbsp;дебаггера&nbsp;для&nbsp;блита&nbsp;промежуточного&nbsp;состояния.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window:&nbsp;SDL&nbsp;окно&nbsp;дебаггера.&nbsp;None&nbsp;—&nbsp;отключить.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_callback:&nbsp;Callback&nbsp;для&nbsp;передачи&nbsp;depth&nbsp;buffer&nbsp;(numpy&nbsp;array).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_error_callback:&nbsp;Callback&nbsp;для&nbsp;сообщения&nbsp;об&nbsp;ошибке&nbsp;чтения&nbsp;depth.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._debugger_window&nbsp;=&nbsp;window<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._depth_capture_callback&nbsp;=&nbsp;depth_callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._depth_error_callback&nbsp;=&nbsp;depth_error_callback<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_debugger_window(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Возвращает&nbsp;SDL&nbsp;окно&nbsp;дебаггера&nbsp;или&nbsp;None.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._debugger_window<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----&nbsp;Сериализация&nbsp;---------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize_data(self)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Сериализует&nbsp;данные&nbsp;пасса&nbsp;через&nbsp;InspectRegistry.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Использует&nbsp;тот&nbsp;же&nbsp;механизм,&nbsp;что&nbsp;и&nbsp;PythonComponent&nbsp;-&nbsp;kind&nbsp;handlers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;применяются&nbsp;для&nbsp;enum,&nbsp;handles&nbsp;и&nbsp;т.д.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.inspect&nbsp;import&nbsp;InspectRegistry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;InspectRegistry.instance().serialize_all(self)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize_data(self,&nbsp;data:&nbsp;dict)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Десериализует&nbsp;данные&nbsp;пасса&nbsp;через&nbsp;InspectRegistry.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Использует&nbsp;тот&nbsp;же&nbsp;механизм,&nbsp;что&nbsp;и&nbsp;PythonComponent&nbsp;-&nbsp;kind&nbsp;handlers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;применяются&nbsp;для&nbsp;enum,&nbsp;handles&nbsp;и&nbsp;т.д.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;data:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.inspect&nbsp;import&nbsp;InspectRegistry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InspectRegistry.instance().deserialize_all(self,&nbsp;data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;serialize(self)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Сериализует&nbsp;FramePass&nbsp;в&nbsp;словарь.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Использует&nbsp;InspectRegistry&nbsp;для&nbsp;сериализации&nbsp;полей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;:&nbsp;self.__class__.__name__,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pass_name&quot;:&nbsp;self.pass_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;enabled&quot;:&nbsp;self.enabled,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;passthrough&quot;:&nbsp;self.passthrough,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;data&quot;:&nbsp;self.serialize_data(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.viewport_name&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[&quot;viewport_name&quot;]&nbsp;=&nbsp;self.viewport_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@classmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deserialize(cls,&nbsp;data:&nbsp;dict,&nbsp;resource_manager=None)&nbsp;-&gt;&nbsp;&quot;FramePass&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Десериализует&nbsp;FramePass&nbsp;из&nbsp;словаря.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Использует&nbsp;ResourceManager&nbsp;для&nbsp;поиска&nbsp;зарегистрированного<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;класса&nbsp;по&nbsp;имени&nbsp;типа.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;Словарь&nbsp;с&nbsp;сериализованными&nbsp;данными<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_manager:&nbsp;ResourceManager&nbsp;для&nbsp;поиска&nbsp;класса<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Экземпляр&nbsp;FramePass<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Raises:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValueError:&nbsp;если&nbsp;тип&nbsp;не&nbsp;найден&nbsp;или&nbsp;данные&nbsp;некорректны<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_type&nbsp;=&nbsp;data.get(&quot;type&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;pass_type&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;Missing&nbsp;'type'&nbsp;in&nbsp;FramePass&nbsp;data&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Получаем&nbsp;класс&nbsp;из&nbsp;ResourceManager<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;resource_manager&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.resources&nbsp;import&nbsp;ResourceManager<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource_manager&nbsp;=&nbsp;ResourceManager.instance()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_cls&nbsp;=&nbsp;resource_manager.get_frame_pass(pass_type)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;pass_cls&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Unknown&nbsp;FramePass&nbsp;type:&nbsp;{pass_type}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Создаём&nbsp;экземпляр&nbsp;и&nbsp;десериализуем&nbsp;данные<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance&nbsp;=&nbsp;pass_cls._deserialize_instance(data,&nbsp;resource_manager)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Восстанавливаем&nbsp;базовые&nbsp;поля<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.enabled&nbsp;=&nbsp;data.get(&quot;enabled&quot;,&nbsp;True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.passthrough&nbsp;=&nbsp;data.get(&quot;passthrough&quot;,&nbsp;False)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.viewport_name&nbsp;=&nbsp;data.get(&quot;viewport_name&quot;,&nbsp;&quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Десериализуем&nbsp;данные&nbsp;через&nbsp;TcPassRef&nbsp;(unified&nbsp;for&nbsp;C++&nbsp;and&nbsp;Python&nbsp;passes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance._tc_pass.deserialize_data(data.get(&quot;data&quot;,&nbsp;{}))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;instance<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@classmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_deserialize_instance(cls,&nbsp;data:&nbsp;dict,&nbsp;resource_manager=None)&nbsp;-&gt;&nbsp;&quot;FramePass&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Создаёт&nbsp;экземпляр&nbsp;из&nbsp;сериализованных&nbsp;данных.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Подклассы&nbsp;должны&nbsp;переопределить&nbsp;этот&nbsp;метод&nbsp;для&nbsp;правильной<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;инициализации&nbsp;с&nbsp;их&nbsp;специфическими&nbsp;параметрами.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Базовая&nbsp;реализация&nbsp;создаёт&nbsp;экземпляр&nbsp;с&nbsp;pass_name.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cls(pass_name=data.get(&quot;pass_name&quot;,&nbsp;&quot;unnamed&quot;))<br>
<br>
<br>
class&nbsp;FrameGraphError(Exception):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Базовая&nbsp;ошибка&nbsp;графа&nbsp;кадра.&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FrameGraphMultiWriterError(FrameGraphError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Один&nbsp;и&nbsp;тот&nbsp;же&nbsp;ресурс&nbsp;пишут&nbsp;несколько&nbsp;пассов.&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FrameGraphCycleError(FrameGraphError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;В&nbsp;графе&nbsp;зависимостей&nbsp;обнаружен&nbsp;цикл.&quot;&quot;&quot;<br>
<br>
<br>
class&nbsp;FrameGraph:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;DEPRECATED:&nbsp;Используйте&nbsp;tc_frame_graph&nbsp;из&nbsp;termin._native.render.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Текущая&nbsp;версия&nbsp;RenderEngine&nbsp;использует&nbsp;C&nbsp;реализацию&nbsp;(tc_frame_graph).<br>
&nbsp;&nbsp;&nbsp;&nbsp;Этот&nbsp;класс&nbsp;оставлен&nbsp;для&nbsp;обратной&nbsp;совместимости&nbsp;с&nbsp;framegraph_debugger,<br>
&nbsp;&nbsp;&nbsp;&nbsp;pipeline_runner&nbsp;и&nbsp;nodegraph/compiler.&nbsp;Будет&nbsp;удалён&nbsp;после&nbsp;их&nbsp;миграции.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;---<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Простейший&nbsp;frame&nbsp;graph:&nbsp;на&nbsp;вход&nbsp;–&nbsp;набор&nbsp;FramePass,<br>
&nbsp;&nbsp;&nbsp;&nbsp;на&nbsp;выход&nbsp;–&nbsp;топологически&nbsp;отсортированный&nbsp;список&nbsp;пассов.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Флаг&nbsp;enabled&nbsp;обрабатывается&nbsp;каждым&nbsp;пассом&nbsp;самостоятельно&nbsp;в&nbsp;execute().<br>
&nbsp;&nbsp;&nbsp;&nbsp;Inplace-пассы&nbsp;могут&nbsp;просто&nbsp;вернуться&nbsp;без&nbsp;действий&nbsp;(ресурс&nbsp;пройдёт&nbsp;насквозь).<br>
&nbsp;&nbsp;&nbsp;&nbsp;Non-inplace&nbsp;пассы&nbsp;могут&nbsp;блитить&nbsp;вход&nbsp;в&nbsp;выход&nbsp;или&nbsp;использовать&nbsp;другую&nbsp;логику.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;passes:&nbsp;Iterable[FramePass]):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._passes:&nbsp;List[FramePass]&nbsp;=&nbsp;list(passes)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;карта&nbsp;&quot;ресурс&nbsp;-&gt;&nbsp;каноническое&nbsp;имя&quot;&nbsp;(на&nbsp;будущее&nbsp;—&nbsp;для&nbsp;дебага&nbsp;/&nbsp;инспекции)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._canonical_resources:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ВНУТРЕННЕЕ&nbsp;ПРЕДСТАВЛЕНИЕ&nbsp;ГРАФА&nbsp;ЗАВИСИМОСТЕЙ<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Всё&nbsp;строим&nbsp;на&nbsp;ИНДЕКСАХ&nbsp;пассов&nbsp;(0..N-1),&nbsp;а&nbsp;не&nbsp;на&nbsp;самих&nbsp;объектах,<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;чтобы&nbsp;вообще&nbsp;не&nbsp;зависеть&nbsp;от&nbsp;их&nbsp;hash/eq.<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_build_dependency_graph(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Строит&nbsp;граф&nbsp;зависимостей&nbsp;между&nbsp;пассами.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency:&nbsp;dict[int,&nbsp;list[int]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;для&nbsp;каждого&nbsp;индекса&nbsp;пасса&nbsp;–&nbsp;список&nbsp;индексов&nbsp;пассов,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;которые&nbsp;зависят&nbsp;от&nbsp;него&nbsp;(есть&nbsp;ребро&nbsp;writer&nbsp;-&gt;&nbsp;reader).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree:&nbsp;dict[int,&nbsp;int]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;количество&nbsp;входящих&nbsp;рёбер&nbsp;для&nbsp;каждого&nbsp;пасса.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer_for:&nbsp;Dict[str,&nbsp;int]&nbsp;=&nbsp;{}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ресурс&nbsp;-&gt;&nbsp;индекс&nbsp;писателя<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readers_for:&nbsp;Dict[str,&nbsp;List[int]]&nbsp;=&nbsp;{}&nbsp;&nbsp;&nbsp;#&nbsp;ресурс&nbsp;-&gt;&nbsp;список&nbsp;индексов&nbsp;читателей<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;для&nbsp;in-place&nbsp;логики<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modified_inputs:&nbsp;Set[str]&nbsp;=&nbsp;set()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;какие&nbsp;имена&nbsp;уже&nbsp;были&nbsp;входом&nbsp;inplace-пасса<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical:&nbsp;Dict[str,&nbsp;str]&nbsp;=&nbsp;{}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;локальная&nbsp;карта&nbsp;канонических&nbsp;имён<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;len(self._passes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1)&nbsp;собираем&nbsp;writer-ов,&nbsp;reader-ов&nbsp;и&nbsp;валидируем&nbsp;inplace-пассы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;idx,&nbsp;p&nbsp;in&nbsp;enumerate(self._passes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Пропускаем&nbsp;отключённые&nbsp;пассы&nbsp;—&nbsp;они&nbsp;не&nbsp;участвуют&nbsp;в&nbsp;графе<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;p.enabled:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;валидация&nbsp;inplace-пассов&nbsp;через&nbsp;get_inplace_aliases&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace_aliases&nbsp;=&nbsp;p.get_inplace_aliases()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Валидируем&nbsp;каждый&nbsp;алиас<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;src,&nbsp;dst&nbsp;in&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;src&nbsp;not&nbsp;in&nbsp;p.reads:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Inplace&nbsp;alias&nbsp;source&nbsp;{src!r}&nbsp;not&nbsp;in&nbsp;reads&nbsp;of&nbsp;pass&nbsp;{p.pass_name!r}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dst&nbsp;not&nbsp;in&nbsp;p.writes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Inplace&nbsp;alias&nbsp;target&nbsp;{dst!r}&nbsp;not&nbsp;in&nbsp;writes&nbsp;of&nbsp;pass&nbsp;{p.pass_name!r}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;src&nbsp;in&nbsp;modified_inputs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Resource&nbsp;{src!r}&nbsp;is&nbsp;already&nbsp;modified&nbsp;by&nbsp;another&nbsp;inplace&nbsp;pass&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modified_inputs.add(src)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;writer-ы&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res&nbsp;in&nbsp;p.writes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;res&nbsp;in&nbsp;writer_for:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_idx&nbsp;=&nbsp;writer_for[res]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;=&nbsp;self._passes[other_idx]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphMultiWriterError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;Resource&nbsp;{res!r}&nbsp;is&nbsp;written&nbsp;by&nbsp;multiple&nbsp;passes:&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;{other.pass_name!r}&nbsp;and&nbsp;{p.pass_name!r}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer_for[res]&nbsp;=&nbsp;idx<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;каноническое&nbsp;имя:&nbsp;первое&nbsp;появление&nbsp;ресурса&nbsp;как&nbsp;writer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical.setdefault(res,&nbsp;res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;reader-ы&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res&nbsp;in&nbsp;p.reads:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lst&nbsp;=&nbsp;readers_for.setdefault(res,&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;idx&nbsp;not&nbsp;in&nbsp;lst:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lst.append(idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;если&nbsp;ресурс&nbsp;нигде&nbsp;не&nbsp;писали,&nbsp;но&nbsp;читают&nbsp;—&nbsp;считаем&nbsp;внешним&nbsp;входом<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical.setdefault(res,&nbsp;res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2)&nbsp;обработка&nbsp;алиасов&nbsp;для&nbsp;inplace-пассов&nbsp;из&nbsp;get_inplace_aliases<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;p&nbsp;in&nbsp;self._passes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;p.enabled:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace_aliases&nbsp;=&nbsp;p.get_inplace_aliases()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;src,&nbsp;dst&nbsp;in&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src_canon&nbsp;=&nbsp;canonical.get(src,&nbsp;src)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;выходу&nbsp;назначаем&nbsp;каноническое&nbsp;имя&nbsp;входа<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;canonical[dst]&nbsp;=&nbsp;src_canon<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;сохраним&nbsp;карту&nbsp;канонических&nbsp;имён<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._canonical_resources&nbsp;=&nbsp;canonical<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3)&nbsp;adjacency&nbsp;и&nbsp;in_degree&nbsp;по&nbsp;индексам<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency:&nbsp;Dict[int,&nbsp;List[int]]&nbsp;=&nbsp;{i:&nbsp;[]&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n)}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree:&nbsp;Dict[int,&nbsp;int]&nbsp;=&nbsp;{i:&nbsp;0&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n)}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Для&nbsp;каждого&nbsp;ресурса:&nbsp;writer&nbsp;-&gt;&nbsp;все&nbsp;его&nbsp;reader-ы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res,&nbsp;w_idx&nbsp;in&nbsp;writer_for.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;r_idx&nbsp;in&nbsp;readers_for.get(res,&nbsp;()):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;r_idx&nbsp;==&nbsp;w_idx:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue&nbsp;&nbsp;#&nbsp;на&nbsp;всякий&nbsp;случай,&nbsp;не&nbsp;создаём&nbsp;петли&nbsp;writer-&gt;writer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;r_idx&nbsp;not&nbsp;in&nbsp;adjacency[w_idx]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency[w_idx].append(r_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree[r_idx]&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;4)&nbsp;Inplace&nbsp;пассы&nbsp;должны&nbsp;ждать&nbsp;всех&nbsp;других&nbsp;читателей&nbsp;своего&nbsp;input'а.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;Иначе&nbsp;inplace&nbsp;пасс&nbsp;&quot;испортит&quot;&nbsp;ресурс&nbsp;до&nbsp;того,&nbsp;как&nbsp;другие&nbsp;его&nbsp;прочитают.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;idx,&nbsp;p&nbsp;in&nbsp;enumerate(self._passes):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;p.enabled:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace_aliases&nbsp;=&nbsp;p.get_inplace_aliases()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;src,&nbsp;_dst&nbsp;in&nbsp;inplace_aliases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Все&nbsp;читатели&nbsp;src&nbsp;(кроме&nbsp;самого&nbsp;inplace&nbsp;пасса)&nbsp;должны&nbsp;выполниться&nbsp;до&nbsp;него<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;other_idx&nbsp;in&nbsp;readers_for.get(src,&nbsp;()):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;other_idx&nbsp;==&nbsp;idx:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;other_idx&nbsp;-&gt;&nbsp;idx&nbsp;(other&nbsp;должен&nbsp;выполниться&nbsp;до&nbsp;inplace)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;idx&nbsp;not&nbsp;in&nbsp;adjacency[other_idx]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency[other_idx].append(idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree[idx]&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;adjacency,&nbsp;in_degree<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ТОПОЛОГИЧЕСКАЯ&nbsp;СОРТИРОВКА&nbsp;(Kahn&nbsp;с&nbsp;приоритетом&nbsp;обычных&nbsp;пассов)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------------&nbsp;#<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;build_schedule(self)&nbsp;-&gt;&nbsp;List[FramePass]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;список&nbsp;пассов&nbsp;в&nbsp;порядке&nbsp;выполнения,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;учитывая&nbsp;зависимости&nbsp;read-after-write.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Бросает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FrameGraphMultiWriterError,&nbsp;если&nbsp;один&nbsp;ресурс&nbsp;пишут&nbsp;несколько&nbsp;пассов.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FrameGraphCycleError,&nbsp;если&nbsp;обнаружен&nbsp;цикл.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FrameGraphError,&nbsp;если&nbsp;нарушены&nbsp;правила&nbsp;inplace-пассов.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjacency,&nbsp;in_degree&nbsp;=&nbsp;self._build_dependency_graph()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;len(self._passes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Индексы&nbsp;только&nbsp;включённых&nbsp;пассов<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enabled_indices&nbsp;=&nbsp;{i&nbsp;for&nbsp;i,&nbsp;p&nbsp;in&nbsp;enumerate(self._passes)&nbsp;if&nbsp;p.enabled}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_inplace&nbsp;=&nbsp;[p.inplace&nbsp;for&nbsp;p&nbsp;in&nbsp;self._passes]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;две&nbsp;очереди:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;обычные&nbsp;пассы&nbsp;—&nbsp;в&nbsp;ready_normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;inplace-пассы&nbsp;—&nbsp;в&nbsp;ready_inplace<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_normal:&nbsp;deque[int]&nbsp;=&nbsp;deque()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_inplace:&nbsp;deque[int]&nbsp;=&nbsp;deque()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;not&nbsp;in&nbsp;enabled_indices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;in_degree[i]&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_inplace[i]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_inplace.append(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_normal.append(i)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_indices:&nbsp;List[int]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;ready_normal&nbsp;or&nbsp;ready_inplace:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;приоритет&nbsp;обычных&nbsp;пассов<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;ready_normal:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;ready_normal.popleft()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;ready_inplace.popleft()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_indices.append(idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;dep&nbsp;in&nbsp;adjacency[idx]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_degree[dep]&nbsp;-=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;in_degree[dep]&nbsp;==&nbsp;0&nbsp;and&nbsp;dep&nbsp;in&nbsp;enabled_indices:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;is_inplace[dep]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_inplace.append(dep)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready_normal.append(dep)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(schedule_indices)&nbsp;!=&nbsp;len(enabled_indices):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Остались&nbsp;вершины&nbsp;с&nbsp;in_degree&nbsp;&gt;&nbsp;0&nbsp;→&nbsp;цикл<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;problematic&nbsp;=&nbsp;[self._passes[i].pass_name&nbsp;for&nbsp;i,&nbsp;deg&nbsp;in&nbsp;in_degree.items()&nbsp;if&nbsp;deg&nbsp;&gt;&nbsp;0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;FrameGraphCycleError(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Frame&nbsp;graph&nbsp;contains&nbsp;a&nbsp;dependency&nbsp;cycle&nbsp;involving&nbsp;passes:&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&quot;,&nbsp;&quot;.join(problematic)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Конвертируем&nbsp;индексы&nbsp;обратно&nbsp;в&nbsp;реальные&nbsp;пассы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[self._passes[i]&nbsp;for&nbsp;i&nbsp;in&nbsp;schedule_indices]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;опционально&nbsp;—&nbsp;геттер&nbsp;канонического&nbsp;имени&nbsp;ресурса&nbsp;(на&nbsp;будущее)<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;canonical_resource(self,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._canonical_resources.get(name,&nbsp;name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;fbo_alias_groups(self)&nbsp;-&gt;&nbsp;Dict[str,&nbsp;Set[str]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Группы&nbsp;синонимов&nbsp;ресурсов&nbsp;по&nbsp;каноническим&nbsp;именам.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;канон&nbsp;-&gt;&nbsp;множество&nbsp;всех&nbsp;имён,&nbsp;которые&nbsp;к&nbsp;нему&nbsp;сводятся.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups:&nbsp;Dict[str,&nbsp;Set[str]]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;res,&nbsp;canon&nbsp;in&nbsp;self._canonical_resources.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups.setdefault(canon,&nbsp;set()).add(res)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;groups<br>
<!-- END SCAT CODE -->
</body>
</html>
