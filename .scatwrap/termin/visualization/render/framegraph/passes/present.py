<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/framegraph/passes/present.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Set,&nbsp;TYPE_CHECKING<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader,&nbsp;PresentToScreenPass<br>
from&nbsp;termin.visualization.render.framegraph.passes.base&nbsp;import&nbsp;RenderFramePass<br>
from&nbsp;termin.editor.inspect_field&nbsp;import&nbsp;InspectField<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.framegraph.execute_context&nbsp;import&nbsp;ExecuteContext<br>
<br>
#&nbsp;Re-export&nbsp;C++&nbsp;PresentToScreenPass<br>
__all__&nbsp;=&nbsp;[&quot;PresentToScreenPass&quot;,&nbsp;&quot;BlitPass&quot;,&nbsp;&quot;ResolvePass&quot;,&nbsp;&quot;blit_fbo_to_fbo&quot;]<br>
<br>
<br>
def&nbsp;_get_texture_from_resource(resource,&nbsp;shadow_map_index:&nbsp;int&nbsp;=&nbsp;0):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Извлекает&nbsp;текстуру&nbsp;из&nbsp;ресурса&nbsp;framegraph&nbsp;для&nbsp;отображения.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Поддерживает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;SingleFBO:&nbsp;возвращает&nbsp;color_texture()<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;ShadowMapArrayResource:&nbsp;возвращает&nbsp;текстуру&nbsp;из&nbsp;первого&nbsp;entry&nbsp;(или&nbsp;по&nbsp;индексу)<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;FramebufferHandle&nbsp;(C++):&nbsp;возвращает&nbsp;color_texture()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource:&nbsp;объект&nbsp;ресурса&nbsp;(SingleFBO,&nbsp;ShadowMapArrayResource,&nbsp;FramebufferHandle)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadow_map_index:&nbsp;индекс&nbsp;shadow&nbsp;map&nbsp;для&nbsp;ShadowMapArrayResource<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GPUTextureHandle&nbsp;или&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;resource&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.framegraph.resource&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SingleFBO,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShadowMapArrayResource,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.graphics&nbsp;import&nbsp;FramebufferHandle<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(resource,&nbsp;ShadowMapArrayResource):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(resource)&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;=&nbsp;min(shadow_map_index,&nbsp;len(resource)&nbsp;-&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry&nbsp;=&nbsp;resource[index]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;entry.texture()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(resource,&nbsp;SingleFBO):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;resource.color_texture()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(resource,&nbsp;FramebufferHandle):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;resource.color_texture()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
<br>
FSQ_VERT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec2&nbsp;a_pos;<br>
layout(location&nbsp;=&nbsp;1)&nbsp;in&nbsp;vec2&nbsp;a_uv;<br>
<br>
out&nbsp;vec2&nbsp;v_uv;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_uv&nbsp;=&nbsp;a_uv;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vec4(a_pos,&nbsp;0.0,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
FSQ_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
in&nbsp;vec2&nbsp;v_uv;<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
uniform&nbsp;sampler2D&nbsp;u_tex;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;texture(u_tex,&nbsp;v_uv);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
_blit_shader:&nbsp;TcShader&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
<br>
def&nbsp;_get_blit_shader()&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;or&nbsp;create&nbsp;the&nbsp;fullscreen&nbsp;quad&nbsp;shader&nbsp;for&nbsp;blitting.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_blit_shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_blit_shader&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_blit_shader&nbsp;=&nbsp;TcShader.from_sources(FSQ_VERT,&nbsp;FSQ_FRAG,&nbsp;&quot;&quot;,&nbsp;&quot;BlitShader&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_blit_shader<br>
<br>
<br>
def&nbsp;blit_fbo_to_fbo(<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx:&nbsp;&quot;GraphicsBackend&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;src_fb,<br>
&nbsp;&nbsp;&nbsp;&nbsp;dst_fb,<br>
&nbsp;&nbsp;&nbsp;&nbsp;size:&nbsp;tuple[int,&nbsp;int],<br>
):<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.platform.backends.nop_graphics&nbsp;import&nbsp;NOPGraphicsBackend<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Для&nbsp;NOP&nbsp;бэкенда&nbsp;пропускаем&nbsp;реальные&nbsp;OpenGL&nbsp;операции<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(gfx,&nbsp;NOPGraphicsBackend):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;size<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;целевой&nbsp;FBO<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.bind_framebuffer(dst_fb)<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_viewport(0,&nbsp;0,&nbsp;w,&nbsp;h)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;глубина&nbsp;нам&nbsp;не&nbsp;нужна<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_test(False)<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_mask(False)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;берём&nbsp;фуллскрин-квад-программу<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;_get_blit_shader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.ensure_ready()<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.use()<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_tex&quot;,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Извлекаем&nbsp;текстуру&nbsp;с&nbsp;учетом&nbsp;типа&nbsp;ресурса<br>
&nbsp;&nbsp;&nbsp;&nbsp;tex&nbsp;=&nbsp;_get_texture_from_resource(src_fb)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;tex&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;не&nbsp;удалось&nbsp;получить&nbsp;текстуру,&nbsp;ничего&nbsp;не&nbsp;делаем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_test(True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_mask(True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;tex.bind(0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.draw_ui_textured_quad()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_test(True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;gfx.set_depth_mask(True)<br>
<br>
<br>
class&nbsp;BlitPass(RenderFramePass):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Копирует&nbsp;color-текстуру&nbsp;из&nbsp;одного&nbsp;FBO&nbsp;в&nbsp;другой&nbsp;через&nbsp;фуллскрин-квад.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Источник&nbsp;задаётся&nbsp;колбэком&nbsp;get_source_res,&nbsp;чтобы&nbsp;его&nbsp;можно&nbsp;было<br>
&nbsp;&nbsp;&nbsp;&nbsp;динамически&nbsp;переключать&nbsp;из&nbsp;редактора/дебагера.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Для&nbsp;отключения&nbsp;пасса&nbsp;используйте&nbsp;enabled=False.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Note:&nbsp;get_source_res&nbsp;—&nbsp;runtime&nbsp;callback,&nbsp;не&nbsp;сериализуется.<br>
&nbsp;&nbsp;&nbsp;&nbsp;При&nbsp;десериализации&nbsp;нужно&nbsp;задать&nbsp;его&nbsp;отдельно.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;category&nbsp;=&nbsp;&quot;Output&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_inputs&nbsp;=&nbsp;[(&quot;input_res&quot;,&nbsp;&quot;fbo&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_outputs&nbsp;=&nbsp;[(&quot;output_res&quot;,&nbsp;&quot;fbo&quot;)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_source_res=None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_res:&nbsp;str&nbsp;=&nbsp;&quot;debug&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_name:&nbsp;str&nbsp;=&nbsp;&quot;Blit&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(pass_name=pass_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._get_source_res&nbsp;=&nbsp;get_source_res<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output_res&nbsp;=&nbsp;output_res<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._current_src_name:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;compute_reads(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._get_source_res&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;set()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src_name&nbsp;=&nbsp;self._get_source_res()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;src_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._current_src_name&nbsp;=&nbsp;src_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{src_name}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._current_src_name&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;set()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;compute_writes(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{self.output_res}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;required_resources(self)&nbsp;-&gt;&nbsp;set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;set(self.reads)&nbsp;|&nbsp;set(self.writes)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;execute(self,&nbsp;ctx:&nbsp;&quot;ExecuteContext&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;px,&nbsp;py,&nbsp;pw,&nbsp;ph&nbsp;=&nbsp;ctx.rect<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._get_source_res&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src_name&nbsp;=&nbsp;self._get_source_res()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;src_name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb_in&nbsp;=&nbsp;ctx.reads_fbos.get(src_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fb_in&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb_out&nbsp;=&nbsp;ctx.writes_fbos.get(self.output_res)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fb_out&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blit_fbo_to_fbo(ctx.graphics,&nbsp;fb_in,&nbsp;fb_out,&nbsp;(pw,&nbsp;ph))<br>
<br>
<br>
class&nbsp;ResolvePass(RenderFramePass):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Resolve&nbsp;MSAA&nbsp;FBO&nbsp;в&nbsp;обычный&nbsp;FBO&nbsp;через&nbsp;glBlitFramebuffer.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Необходим&nbsp;перед&nbsp;любым&nbsp;pass'ом,&nbsp;который&nbsp;сэмплирует&nbsp;текстуру&nbsp;(PostProcess&nbsp;и&nbsp;др.),<br>
&nbsp;&nbsp;&nbsp;&nbsp;если&nbsp;источник&nbsp;—&nbsp;MSAA&nbsp;FBO.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;category&nbsp;=&nbsp;&quot;Output&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_inputs&nbsp;=&nbsp;[(&quot;input_res&quot;,&nbsp;&quot;fbo&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;node_outputs&nbsp;=&nbsp;[(&quot;output_res&quot;,&nbsp;&quot;fbo&quot;)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;inspect_fields&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;input_res&quot;:&nbsp;InspectField(path=&quot;input_res&quot;,&nbsp;label=&quot;Input&nbsp;Resource&quot;,&nbsp;kind=&quot;string&quot;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;output_res&quot;:&nbsp;InspectField(path=&quot;output_res&quot;,&nbsp;label=&quot;Output&nbsp;Resource&quot;,&nbsp;kind=&quot;string&quot;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_res:&nbsp;str&nbsp;=&nbsp;&quot;color&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_res:&nbsp;str&nbsp;=&nbsp;&quot;resolved&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_name:&nbsp;str&nbsp;=&nbsp;&quot;Resolve&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(pass_name=pass_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.input_res&nbsp;=&nbsp;input_res<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output_res&nbsp;=&nbsp;output_res<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;compute_reads(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{self.input_res}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;compute_writes(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{self.output_res}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;execute(self,&nbsp;ctx:&nbsp;&quot;ExecuteContext&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.platform.backends.nop_graphics&nbsp;import&nbsp;NOPGraphicsBackend<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.graphics&nbsp;import&nbsp;FramebufferHandle<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(ctx.graphics,&nbsp;NOPGraphicsBackend):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;px,&nbsp;py,&nbsp;pw,&nbsp;ph&nbsp;=&nbsp;ctx.rect<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb_in&nbsp;=&nbsp;ctx.reads_fbos.get(self.input_res)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb_out&nbsp;=&nbsp;ctx.writes_fbos.get(self.output_res)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fb_in&nbsp;is&nbsp;None&nbsp;or&nbsp;fb_out&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.warn(f&quot;[ResolvePass]&nbsp;Missing&nbsp;FBO:&nbsp;input={fb_in&nbsp;is&nbsp;not&nbsp;None},&nbsp;output={fb_out&nbsp;is&nbsp;not&nbsp;None},&nbsp;input_res='{self.input_res}',&nbsp;output_res='{self.output_res}'&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;type&nbsp;-&nbsp;skip&nbsp;if&nbsp;not&nbsp;a&nbsp;FramebufferHandle<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;isinstance(fb_in,&nbsp;FramebufferHandle):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.warn(f&quot;[ResolvePass]&nbsp;input&nbsp;'{self.input_res}'&nbsp;is&nbsp;{type(fb_in).__name__},&nbsp;not&nbsp;FramebufferHandle&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;isinstance(fb_out,&nbsp;FramebufferHandle):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.warn(f&quot;[ResolvePass]&nbsp;output&nbsp;'{self.output_res}'&nbsp;is&nbsp;{type(fb_out).__name__},&nbsp;not&nbsp;FramebufferHandle&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src_size&nbsp;=&nbsp;fb_in.get_size()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctx.graphics.blit_framebuffer(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb_in,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fb_out,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(0,&nbsp;0,&nbsp;src_size[0],&nbsp;src_size[1]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(0,&nbsp;0,&nbsp;pw,&nbsp;ph),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
<br>
#&nbsp;PresentToScreenPass&nbsp;is&nbsp;now&nbsp;imported&nbsp;from&nbsp;C++&nbsp;(termin._native.render.PresentToScreenPass)<br>
#&nbsp;Add&nbsp;_get_shader&nbsp;static&nbsp;method&nbsp;for&nbsp;compatibility&nbsp;with&nbsp;blit&nbsp;code<br>
PresentToScreenPass._get_shader&nbsp;=&nbsp;staticmethod(_get_blit_shader)<br>
<!-- END SCAT CODE -->
</body>
</html>
