<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/system_shaders.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
System&nbsp;shaders&nbsp;registry.<br>
<br>
Simple&nbsp;shaders&nbsp;used&nbsp;by&nbsp;render&nbsp;passes&nbsp;(pick,&nbsp;etc.)<br>
that&nbsp;don't&nbsp;need&nbsp;material&nbsp;phases.<br>
<br>
These&nbsp;are&nbsp;compiled&nbsp;lazily&nbsp;on&nbsp;first&nbsp;use&nbsp;and&nbsp;cached.<br>
<br>
Note:&nbsp;Shadow&nbsp;shader&nbsp;is&nbsp;now&nbsp;in&nbsp;C++&nbsp;(shadow_pass.cpp).<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Dict<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;Shader&nbsp;Sources<br>
#&nbsp;============================================================<br>
<br>
PICK_VERT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(location=0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
layout(location=1)&nbsp;in&nbsp;vec3&nbsp;a_normal;<br>
layout(location=2)&nbsp;in&nbsp;vec2&nbsp;a_texcoord;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view&nbsp;*&nbsp;u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
PICK_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
uniform&nbsp;vec3&nbsp;u_pickColor;<br>
out&nbsp;vec4&nbsp;fragColor;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;fragColor&nbsp;=&nbsp;vec4(u_pickColor,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
#&nbsp;============================================================<br>
#&nbsp;Registry<br>
#&nbsp;============================================================<br>
<br>
class&nbsp;SystemShaderRegistry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Registry&nbsp;for&nbsp;system&nbsp;shaders.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Shaders&nbsp;are&nbsp;created&nbsp;lazily&nbsp;and&nbsp;cached.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_instance:&nbsp;&quot;SystemShaderRegistry&nbsp;|&nbsp;None&quot;&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Shader&nbsp;definitions:&nbsp;name&nbsp;-&gt;&nbsp;(vert_source,&nbsp;frag_source)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._definitions:&nbsp;Dict[str,&nbsp;tuple[str,&nbsp;str]]&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pick&quot;:&nbsp;(PICK_VERT,&nbsp;PICK_FRAG),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Compiled&nbsp;shaders:&nbsp;name&nbsp;-&gt;&nbsp;TcShader<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._shaders:&nbsp;Dict[str,&nbsp;TcShader]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@classmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;instance(cls)&nbsp;-&gt;&nbsp;&quot;SystemShaderRegistry&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;singleton&nbsp;instance.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cls._instance&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls._instance&nbsp;=&nbsp;cls()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cls._instance<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get(self,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;a&nbsp;system&nbsp;shader&nbsp;by&nbsp;name,&nbsp;compiling&nbsp;if&nbsp;necessary.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Shader&nbsp;name&nbsp;(&quot;pick&quot;,&nbsp;etc.)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcShader&nbsp;ready&nbsp;for&nbsp;use<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;name&nbsp;not&nbsp;in&nbsp;self._shaders:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;name&nbsp;not&nbsp;in&nbsp;self._definitions:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;KeyError(f&quot;Unknown&nbsp;system&nbsp;shader:&nbsp;{name}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vert,&nbsp;frag&nbsp;=&nbsp;self._definitions[name]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;TcShader.from_sources(vert,&nbsp;frag,&nbsp;&quot;&quot;,&nbsp;f&quot;system:{name}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.ensure_ready()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._shaders[name]&nbsp;=&nbsp;shader<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._shaders[name]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;register(self,&nbsp;name:&nbsp;str,&nbsp;vert_source:&nbsp;str,&nbsp;frag_source:&nbsp;str)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Register&nbsp;a&nbsp;new&nbsp;system&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Shader&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vert_source:&nbsp;Vertex&nbsp;shader&nbsp;GLSL&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frag_source:&nbsp;Fragment&nbsp;shader&nbsp;GLSL&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._definitions[name]&nbsp;=&nbsp;(vert_source,&nbsp;frag_source)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;cached&nbsp;shader&nbsp;for&nbsp;this&nbsp;name&nbsp;(will&nbsp;be&nbsp;recompiled&nbsp;on&nbsp;next&nbsp;get)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;name&nbsp;in&nbsp;self._shaders:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del&nbsp;self._shaders[name]<br>
<br>
<br>
def&nbsp;get_system_shader(name:&nbsp;str)&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Convenience&nbsp;function&nbsp;to&nbsp;get&nbsp;a&nbsp;system&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Shader&nbsp;name&nbsp;(&quot;pick&quot;,&nbsp;etc.)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcShader&nbsp;ready&nbsp;for&nbsp;use<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SystemShaderRegistry.instance().get(name)<br>
<!-- END SCAT CODE -->
</body>
</html>
