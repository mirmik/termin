<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/materials/shadow_material.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Материал&nbsp;для&nbsp;генерации&nbsp;shadow&nbsp;map.<br>
<br>
Пишет&nbsp;глубину&nbsp;в&nbsp;стандартный&nbsp;depth&nbsp;buffer,&nbsp;без&nbsp;линеаризации&nbsp;—<br>
используется&nbsp;нативная&nbsp;нелинейная&nbsp;глубина&nbsp;OpenGL&nbsp;для&nbsp;shadow&nbsp;mapping.<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcMaterial,&nbsp;TcRenderState<br>
<br>
<br>
SHADOW_VERT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
void&nbsp;main()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view&nbsp;*&nbsp;u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
SHADOW_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
void&nbsp;main()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Depth-only&nbsp;pass:&nbsp;глубина&nbsp;пишется&nbsp;автоматически&nbsp;в&nbsp;depth&nbsp;buffer.<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Никакого&nbsp;color&nbsp;output&nbsp;-&nbsp;shadow&nbsp;FBO&nbsp;не&nbsp;имеет&nbsp;color&nbsp;attachment.<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;create_shadow_material(name:&nbsp;str&nbsp;=&nbsp;&quot;ShadowMaterial&quot;)&nbsp;-&gt;&nbsp;TcMaterial:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Create&nbsp;a&nbsp;shadow&nbsp;pass&nbsp;material.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat&nbsp;=&nbsp;TcMaterial.create(name,&nbsp;&quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat.shader_name&nbsp;=&nbsp;&quot;ShadowShader&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;TcRenderState.opaque()<br>
&nbsp;&nbsp;&nbsp;&nbsp;phase&nbsp;=&nbsp;mat.add_phase_from_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source=SHADOW_VERT,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source=SHADOW_FRAG,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_source=&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader_name=&quot;ShadowShader&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase_mark=&quot;shadow&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;priority=0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state=state,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mat<br>
<br>
<br>
class&nbsp;ShadowMaterial(TcMaterial):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Минимальный&nbsp;материал&nbsp;для&nbsp;shadow&nbsp;pass.&nbsp;Returns&nbsp;TcMaterial.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Рендерит&nbsp;геометрию&nbsp;без&nbsp;освещения&nbsp;и&nbsp;текстур&nbsp;—&nbsp;только&nbsp;позиции.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Глубина&nbsp;записывается&nbsp;в&nbsp;depth&nbsp;buffer&nbsp;средствами&nbsp;OpenGL.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__new__(cls)&nbsp;-&gt;&nbsp;TcMaterial:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;create_shadow_material()<br>
<!-- END SCAT CODE -->
</body>
</html>
