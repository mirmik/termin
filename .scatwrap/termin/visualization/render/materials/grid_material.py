<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/materials/grid_material.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Grid/calibration&nbsp;material&nbsp;-&nbsp;draws&nbsp;grid&nbsp;lines&nbsp;parallel&nbsp;to&nbsp;XY,&nbsp;YZ,&nbsp;ZX&nbsp;planes.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcMaterial,&nbsp;TcRenderState<br>
<br>
<br>
GRID_VERT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
layout(location&nbsp;=&nbsp;1)&nbsp;in&nbsp;vec3&nbsp;a_normal;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
out&nbsp;vec3&nbsp;v_world_pos;<br>
out&nbsp;vec3&nbsp;v_normal;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Pass&nbsp;world&nbsp;position&nbsp;for&nbsp;grid&nbsp;calculation<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;(u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0)).xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_normal&nbsp;=&nbsp;mat3(transpose(inverse(u_model)))&nbsp;*&nbsp;a_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view&nbsp;*&nbsp;u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
GRID_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
in&nbsp;vec3&nbsp;v_world_pos;<br>
in&nbsp;vec3&nbsp;v_normal;<br>
<br>
uniform&nbsp;vec4&nbsp;u_color;<br>
uniform&nbsp;float&nbsp;u_grid_spacing;&nbsp;&nbsp;//&nbsp;Grid&nbsp;cell&nbsp;size&nbsp;in&nbsp;world&nbsp;units&nbsp;(default&nbsp;1.0)<br>
uniform&nbsp;float&nbsp;u_line_width;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Line&nbsp;width&nbsp;in&nbsp;world&nbsp;units&nbsp;(default&nbsp;0.02)<br>
<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
float&nbsp;grid_line(float&nbsp;coord,&nbsp;float&nbsp;line_width)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Distance&nbsp;to&nbsp;nearest&nbsp;grid&nbsp;line<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;d&nbsp;=&nbsp;abs(fract(coord&nbsp;+&nbsp;0.5)&nbsp;-&nbsp;0.5);<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Smooth&nbsp;step&nbsp;based&nbsp;on&nbsp;line&nbsp;width<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;half_width&nbsp;=&nbsp;line_width&nbsp;*&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1.0&nbsp;-&nbsp;smoothstep(0.0,&nbsp;half_width,&nbsp;d);<br>
}<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;spacing&nbsp;=&nbsp;u_grid_spacing&nbsp;&gt;&nbsp;0.0&nbsp;?&nbsp;u_grid_spacing&nbsp;:&nbsp;1.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;line_width&nbsp;=&nbsp;u_line_width&nbsp;&gt;&nbsp;0.0&nbsp;?&nbsp;u_line_width&nbsp;:&nbsp;0.02;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;world&nbsp;position&nbsp;scaled&nbsp;by&nbsp;grid&nbsp;spacing<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p&nbsp;=&nbsp;v_world_pos&nbsp;/&nbsp;spacing;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Calculate&nbsp;grid&nbsp;lines&nbsp;for&nbsp;each&nbsp;axis&nbsp;(in&nbsp;world&nbsp;space)<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Lines&nbsp;parallel&nbsp;to&nbsp;X&nbsp;axis&nbsp;(in&nbsp;YZ&nbsp;plane&nbsp;at&nbsp;integer&nbsp;X)<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;line_x&nbsp;=&nbsp;max(grid_line(p.y,&nbsp;line_width),&nbsp;grid_line(p.z,&nbsp;line_width));<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Lines&nbsp;parallel&nbsp;to&nbsp;Y&nbsp;axis&nbsp;(in&nbsp;XZ&nbsp;plane&nbsp;at&nbsp;integer&nbsp;Y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;line_y&nbsp;=&nbsp;max(grid_line(p.x,&nbsp;line_width),&nbsp;grid_line(p.z,&nbsp;line_width));<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Lines&nbsp;parallel&nbsp;to&nbsp;Z&nbsp;axis&nbsp;(in&nbsp;XY&nbsp;plane&nbsp;at&nbsp;integer&nbsp;Z)<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;line_z&nbsp;=&nbsp;max(grid_line(p.x,&nbsp;line_width),&nbsp;grid_line(p.y,&nbsp;line_width));<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Combine&nbsp;all&nbsp;grid&nbsp;lines<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;grid&nbsp;=&nbsp;max(max(line_x,&nbsp;line_y),&nbsp;line_z);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Simple&nbsp;lighting<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;n&nbsp;=&nbsp;normalize(v_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;ndotl&nbsp;=&nbsp;max(dot(n,&nbsp;normalize(vec3(0.2,&nbsp;0.6,&nbsp;0.5))),&nbsp;0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;light&nbsp;=&nbsp;0.3&nbsp;+&nbsp;0.7&nbsp;*&nbsp;ndotl;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Base&nbsp;color&nbsp;with&nbsp;grid&nbsp;overlay<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;base_color&nbsp;=&nbsp;u_color.rgb&nbsp;*&nbsp;light;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;grid_color&nbsp;=&nbsp;vec3(0.0,&nbsp;0.0,&nbsp;0.0);&nbsp;&nbsp;//&nbsp;Black&nbsp;grid&nbsp;lines<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;final_color&nbsp;=&nbsp;mix(base_color,&nbsp;grid_color,&nbsp;grid&nbsp;*&nbsp;0.8);<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(final_color,&nbsp;u_color.a);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;create_grid_material(<br>
&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;tuple[float,&nbsp;float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(0.8,&nbsp;0.8,&nbsp;0.8,&nbsp;1.0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;grid_spacing:&nbsp;float&nbsp;=&nbsp;1.0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;line_width:&nbsp;float&nbsp;=&nbsp;0.02,<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str&nbsp;=&nbsp;&quot;GridMaterial&quot;,<br>
)&nbsp;-&gt;&nbsp;TcMaterial:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;a&nbsp;grid/calibration&nbsp;material.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Grid&nbsp;lines&nbsp;are&nbsp;drawn&nbsp;at&nbsp;integer&nbsp;intervals&nbsp;in&nbsp;local&nbsp;object&nbsp;space.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;Base&nbsp;color&nbsp;(r,&nbsp;g,&nbsp;b,&nbsp;a)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grid_spacing:&nbsp;Distance&nbsp;between&nbsp;grid&nbsp;lines&nbsp;(default&nbsp;1.0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_width:&nbsp;Width&nbsp;of&nbsp;grid&nbsp;lines&nbsp;in&nbsp;local&nbsp;units&nbsp;(default&nbsp;0.02)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Material&nbsp;name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcMaterial&nbsp;with&nbsp;grid&nbsp;shader.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat&nbsp;=&nbsp;TcMaterial.create(name,&nbsp;&quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat.shader_name&nbsp;=&nbsp;&quot;GridShader&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;TcRenderState.opaque()<br>
&nbsp;&nbsp;&nbsp;&nbsp;phase&nbsp;=&nbsp;mat.add_phase_from_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source=GRID_VERT,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source=GRID_FRAG,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_source=&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader_name=&quot;GridShader&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase_mark=&quot;opaque&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;priority=0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state=state,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;phase&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_color(color[0],&nbsp;color[1],&nbsp;color[2],&nbsp;color[3])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_uniform_float(&quot;u_grid_spacing&quot;,&nbsp;grid_spacing)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_uniform_float(&quot;u_line_width&quot;,&nbsp;line_width)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mat<br>
<br>
<br>
#&nbsp;Legacy&nbsp;alias&nbsp;for&nbsp;backward&nbsp;compatibility<br>
def&nbsp;grid_shader():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Deprecated:&nbsp;Use&nbsp;create_grid_material()&nbsp;instead.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;NotImplementedError(&quot;grid_shader()&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;create_grid_material()&nbsp;instead.&quot;)<br>
<br>
<br>
class&nbsp;GridMaterial(TcMaterial):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Calibration&nbsp;material&nbsp;that&nbsp;draws&nbsp;grid&nbsp;lines&nbsp;parallel&nbsp;to&nbsp;XY,&nbsp;YZ,&nbsp;ZX&nbsp;planes.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Grid&nbsp;lines&nbsp;are&nbsp;drawn&nbsp;at&nbsp;integer&nbsp;intervals&nbsp;in&nbsp;local&nbsp;object&nbsp;space.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;TcMaterial.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__new__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;tuple[float,&nbsp;float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(0.8,&nbsp;0.8,&nbsp;0.8,&nbsp;1.0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grid_spacing:&nbsp;float&nbsp;=&nbsp;1.0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_width:&nbsp;float&nbsp;=&nbsp;0.02,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;TcMaterial:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;create_grid_material(color=color,&nbsp;grid_spacing=grid_spacing,&nbsp;line_width=line_width)<br>
<!-- END SCAT CODE -->
</body>
</html>
