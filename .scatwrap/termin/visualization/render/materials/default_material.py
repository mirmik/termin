<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/materials/default_material.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;termin.visualization.core.material&nbsp;import&nbsp;Material<br>
from&nbsp;termin.visualization.render.shader&nbsp;import&nbsp;ShaderProgram<br>
<br>
#&nbsp;Матрицы&nbsp;работают&nbsp;в&nbsp;однородных&nbsp;координатах:&nbsp;gl_Position&nbsp;=&nbsp;P&nbsp;*&nbsp;V&nbsp;*&nbsp;M&nbsp;*&nbsp;[x,&nbsp;y,&nbsp;z,&nbsp;1]^T<br>
DEFAULT_VERT&nbsp;=&nbsp;&quot;&quot;&quot;#version&nbsp;330&nbsp;core<br>
<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
layout(location&nbsp;=&nbsp;1)&nbsp;in&nbsp;vec3&nbsp;a_normal;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
out&nbsp;vec3&nbsp;v_world_pos;<br>
out&nbsp;vec3&nbsp;v_normal;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;world&nbsp;=&nbsp;u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;world.xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_normal&nbsp;=&nbsp;mat3(transpose(inverse(u_model)))&nbsp;*&nbsp;a_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view&nbsp;*&nbsp;world;<br>
}<br>
&quot;&quot;&quot;<br>
<br>
DEFAULT_FRAG&nbsp;=&nbsp;&quot;&quot;&quot;#version&nbsp;330&nbsp;core<br>
<br>
in&nbsp;vec3&nbsp;v_world_pos;<br>
in&nbsp;vec3&nbsp;v_normal;<br>
<br>
uniform&nbsp;vec4&nbsp;u_color;&nbsp;//&nbsp;RGBA&nbsp;базового&nbsp;материала<br>
<br>
const&nbsp;int&nbsp;LIGHT_TYPE_DIRECTIONAL&nbsp;=&nbsp;0;<br>
const&nbsp;int&nbsp;LIGHT_TYPE_POINT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1;<br>
const&nbsp;int&nbsp;LIGHT_TYPE_SPOT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2;<br>
const&nbsp;int&nbsp;LIGHT_TYPE_AMBIENT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3;<br>
<br>
const&nbsp;int&nbsp;MAX_LIGHTS&nbsp;=&nbsp;8;<br>
<br>
uniform&nbsp;int&nbsp;&nbsp;&nbsp;u_light_count;<br>
uniform&nbsp;int&nbsp;&nbsp;&nbsp;u_light_type[MAX_LIGHTS];<br>
uniform&nbsp;vec3&nbsp;&nbsp;u_light_color[MAX_LIGHTS];<br>
uniform&nbsp;float&nbsp;u_light_intensity[MAX_LIGHTS];<br>
uniform&nbsp;vec3&nbsp;&nbsp;u_light_direction[MAX_LIGHTS];<br>
uniform&nbsp;vec3&nbsp;&nbsp;u_light_position[MAX_LIGHTS];<br>
uniform&nbsp;float&nbsp;u_light_range[MAX_LIGHTS];<br>
uniform&nbsp;vec3&nbsp;&nbsp;u_light_attenuation[MAX_LIGHTS];&nbsp;//&nbsp;(constant,&nbsp;linear,&nbsp;quadratic)<br>
uniform&nbsp;float&nbsp;u_light_inner_angle[MAX_LIGHTS];<br>
uniform&nbsp;float&nbsp;u_light_outer_angle[MAX_LIGHTS];<br>
<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
float&nbsp;compute_distance_attenuation(int&nbsp;idx,&nbsp;float&nbsp;dist)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;att&nbsp;=&nbsp;u_light_attenuation[idx];<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;denom&nbsp;=&nbsp;att.x&nbsp;+&nbsp;att.y&nbsp;*&nbsp;dist&nbsp;+&nbsp;att.z&nbsp;*&nbsp;dist&nbsp;*&nbsp;dist;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(denom&nbsp;&lt;=&nbsp;0.0)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;w&nbsp;=&nbsp;1.0&nbsp;/&nbsp;denom;<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;range&nbsp;=&nbsp;u_light_range[idx];<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(range&nbsp;&gt;&nbsp;0.0&nbsp;&amp;&amp;&nbsp;dist&nbsp;&gt;&nbsp;range)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w&nbsp;=&nbsp;0.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;w;<br>
}<br>
<br>
float&nbsp;compute_spot_weight(int&nbsp;idx,&nbsp;vec3&nbsp;L)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;cos_theta&nbsp;=&nbsp;dot(u_light_direction[idx],&nbsp;-L);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;cos_outer&nbsp;=&nbsp;cos(u_light_outer_angle[idx]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;cos_inner&nbsp;=&nbsp;cos(u_light_inner_angle[idx]);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(cos_theta&nbsp;&lt;=&nbsp;cos_outer)&nbsp;return&nbsp;0.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(cos_theta&nbsp;&gt;=&nbsp;cos_inner)&nbsp;return&nbsp;1.0;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;t&nbsp;=&nbsp;(cos_theta&nbsp;-&nbsp;cos_outer)&nbsp;/&nbsp;(cos_inner&nbsp;-&nbsp;cos_outer);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;t&nbsp;*&nbsp;t&nbsp;*&nbsp;(3.0&nbsp;-&nbsp;2.0&nbsp;*&nbsp;t);&nbsp;//&nbsp;smoothstep<br>
}<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;N&nbsp;=&nbsp;normalize(v_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;base_color&nbsp;=&nbsp;u_color.rgb;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;result&nbsp;=&nbsp;vec3(0.0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;u_light_count;&nbsp;++i)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;type&nbsp;=&nbsp;u_light_type[i];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;radiance&nbsp;=&nbsp;u_light_color[i]&nbsp;*&nbsp;u_light_intensity[i];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(type&nbsp;==&nbsp;LIGHT_TYPE_AMBIENT)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;+=&nbsp;base_color&nbsp;*&nbsp;radiance;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;L;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;dist;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;weight&nbsp;=&nbsp;1.0;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(type&nbsp;==&nbsp;LIGHT_TYPE_DIRECTIONAL)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L&nbsp;=&nbsp;normalize(-u_light_direction[i]);&nbsp;//&nbsp;направление&nbsp;на&nbsp;свет<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;1e9;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;to_light&nbsp;=&nbsp;u_light_position[i]&nbsp;-&nbsp;v_world_pos;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist&nbsp;=&nbsp;length(to_light);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dist&nbsp;&gt;&nbsp;0.0001)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L&nbsp;=&nbsp;to_light&nbsp;/&nbsp;dist;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L&nbsp;=&nbsp;vec3(0.0,&nbsp;1.0,&nbsp;0.0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;*=&nbsp;compute_distance_attenuation(i,&nbsp;dist);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(type&nbsp;==&nbsp;LIGHT_TYPE_SPOT)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;*=&nbsp;compute_spot_weight(i,&nbsp;L);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;ndotl&nbsp;=&nbsp;max(dot(N,&nbsp;L),&nbsp;0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;diffuse&nbsp;=&nbsp;base_color&nbsp;*&nbsp;ndotl;&nbsp;//&nbsp;Ламбертовский&nbsp;диффуз:&nbsp;L_d&nbsp;=&nbsp;c&nbsp;*&nbsp;max(N·L,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;V&nbsp;=&nbsp;normalize(-v_world_pos);&nbsp;//&nbsp;камера&nbsp;в&nbsp;(0,0,0)&nbsp;для&nbsp;простоты<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;H&nbsp;=&nbsp;normalize(L&nbsp;+&nbsp;V);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;ndoth&nbsp;=&nbsp;max(dot(N,&nbsp;H),&nbsp;0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;shininess&nbsp;=&nbsp;16.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;spec&nbsp;=&nbsp;pow(ndoth,&nbsp;shininess);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;specular_color&nbsp;=&nbsp;vec3(1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;specular&nbsp;=&nbsp;spec&nbsp;*&nbsp;specular_color;&nbsp;//&nbsp;Блик&nbsp;Фонга:&nbsp;L_s&nbsp;=&nbsp;(max(N·H,&nbsp;0))^n<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;+=&nbsp;(diffuse&nbsp;+&nbsp;specular)&nbsp;*&nbsp;radiance&nbsp;*&nbsp;weight;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(result,&nbsp;u_color.a);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;default_shader()&nbsp;-&gt;&nbsp;ShaderProgram:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Создает&nbsp;шейдер&nbsp;по&nbsp;умолчанию&nbsp;с&nbsp;комбинированным&nbsp;диффузным&nbsp;и&nbsp;бликовым&nbsp;освещением.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ShaderProgram(vertex_source=DEFAULT_VERT,&nbsp;fragment_source=DEFAULT_FRAG)<br>
<br>
<br>
class&nbsp;DefaultMaterial(Material):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Базовый&nbsp;материал&nbsp;сцены.&nbsp;Диффузная&nbsp;часть&nbsp;следует&nbsp;модели&nbsp;Ламберта,&nbsp;блик&nbsp;—&nbsp;Фонга.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;color:&nbsp;tuple[float,&nbsp;float,&nbsp;float,&nbsp;float]&nbsp;|&nbsp;None&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;default_shader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(shader=shader,&nbsp;color=color)<br>
<!-- END SCAT CODE -->
</body>
</html>
