<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/shadow/shadow_map_array.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
ShadowMapArray&nbsp;—&nbsp;ресурс&nbsp;конвейера&nbsp;для&nbsp;передачи&nbsp;shadow&nbsp;maps&nbsp;между&nbsp;пассами.<br>
<br>
Содержит&nbsp;массив&nbsp;shadow&nbsp;map'ов&nbsp;для&nbsp;всех&nbsp;источников&nbsp;света,&nbsp;отбрасывающих&nbsp;тени.<br>
Каждый&nbsp;элемент&nbsp;связывает&nbsp;текстуру&nbsp;с&nbsp;матрицей&nbsp;light-space&nbsp;и&nbsp;индексом&nbsp;источника.<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass,&nbsp;field<br>
from&nbsp;typing&nbsp;import&nbsp;List,&nbsp;TYPE_CHECKING<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.platform.backends.base&nbsp;import&nbsp;TextureHandle,&nbsp;FramebufferHandle<br>
<br>
<br>
@dataclass<br>
class&nbsp;ShadowMapEntry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Данные&nbsp;одного&nbsp;shadow&nbsp;map&nbsp;для&nbsp;одного&nbsp;источника&nbsp;света.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Атрибуты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo:&nbsp;FBO,&nbsp;в&nbsp;который&nbsp;рендерится&nbsp;shadow&nbsp;map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_space_matrix:&nbsp;матрица&nbsp;P&nbsp;*&nbsp;V&nbsp;для&nbsp;преобразования&nbsp;мировых&nbsp;координат<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;в&nbsp;clip-пространство&nbsp;источника&nbsp;света<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_index:&nbsp;индекс&nbsp;источника&nbsp;в&nbsp;scene.lights&nbsp;(для&nbsp;соответствия&nbsp;uniform'ам)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Формула&nbsp;преобразования&nbsp;точки&nbsp;p&nbsp;в&nbsp;shadow&nbsp;map&nbsp;координаты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_light_clip&nbsp;=&nbsp;light_space_matrix&nbsp;@&nbsp;[p.x,&nbsp;p.y,&nbsp;p.z,&nbsp;1]^T<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uv&nbsp;=&nbsp;(p_light_clip.xy&nbsp;/&nbsp;p_light_clip.w)&nbsp;*&nbsp;0.5&nbsp;+&nbsp;0.5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_from_light&nbsp;=&nbsp;p_light_clip.z&nbsp;/&nbsp;p_light_clip.w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbo:&nbsp;&quot;FramebufferHandle&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;light_space_matrix:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;light_index:&nbsp;int<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;texture(self)&nbsp;-&gt;&nbsp;&quot;TextureHandle&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Возвращает&nbsp;color-текстуру&nbsp;FBO&nbsp;(содержит&nbsp;глубину&nbsp;в&nbsp;RGB).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.fbo.color_texture()<br>
<br>
<br>
@dataclass<br>
class&nbsp;ShadowMapArray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Массив&nbsp;shadow&nbsp;maps&nbsp;для&nbsp;всех&nbsp;источников&nbsp;света&nbsp;с&nbsp;тенями.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Это&nbsp;ресурс&nbsp;конвейера&nbsp;(framegraph&nbsp;resource),&nbsp;который&nbsp;ShadowPass<br>
&nbsp;&nbsp;&nbsp;&nbsp;создаёт&nbsp;и&nbsp;записывает,&nbsp;а&nbsp;ColorPass&nbsp;читает.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Атрибуты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries:&nbsp;список&nbsp;ShadowMapEntry,&nbsp;по&nbsp;одному&nbsp;на&nbsp;источник&nbsp;света<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resolution:&nbsp;разрешение&nbsp;каждого&nbsp;shadow&nbsp;map&nbsp;(квадратное)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;entries:&nbsp;List[ShadowMapEntry]&nbsp;=&nbsp;field(default_factory=list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;resolution:&nbsp;int&nbsp;=&nbsp;1024<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__len__(self)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(self.entries)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__getitem__(self,&nbsp;index:&nbsp;int)&nbsp;-&gt;&nbsp;ShadowMapEntry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.entries[index]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__iter__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;iter(self.entries)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_entry(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo:&nbsp;&quot;FramebufferHandle&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_space_matrix:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_index:&nbsp;int,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Добавляет&nbsp;запись&nbsp;для&nbsp;нового&nbsp;источника&nbsp;света.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.entries.append(ShadowMapEntry(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbo=fbo,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_space_matrix=light_space_matrix,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_index=light_index,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Очищает&nbsp;массив&nbsp;(FBO&nbsp;не&nbsp;удаляются,&nbsp;только&nbsp;ссылки).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.entries.clear()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_by_light_index(self,&nbsp;light_index:&nbsp;int)&nbsp;-&gt;&nbsp;ShadowMapEntry&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Находит&nbsp;entry&nbsp;по&nbsp;индексу&nbsp;источника&nbsp;света.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;entry&nbsp;in&nbsp;self.entries:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;entry.light_index&nbsp;==&nbsp;light_index:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;entry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<!-- END SCAT CODE -->
</body>
</html>
