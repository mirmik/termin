<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/shadow/shadow_camera.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Shadow&nbsp;camera&nbsp;implementation&nbsp;for&nbsp;directional&nbsp;light&nbsp;shadow&nbsp;mapping.<br>
<br>
Core&nbsp;math&nbsp;functions&nbsp;are&nbsp;implemented&nbsp;in&nbsp;C++.&nbsp;This&nbsp;module&nbsp;provides<br>
a&nbsp;convenience&nbsp;wrapper&nbsp;for&nbsp;Camera&nbsp;integration.<br>
<br>
Coordinate&nbsp;convention:&nbsp;Y-forward,&nbsp;Z-up&nbsp;(same&nbsp;as&nbsp;main&nbsp;engine)<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
#&nbsp;Re-export&nbsp;C++&nbsp;implementations<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;ShadowCameraParams,<br>
&nbsp;&nbsp;&nbsp;&nbsp;build_shadow_view_matrix,<br>
&nbsp;&nbsp;&nbsp;&nbsp;build_shadow_projection_matrix,<br>
&nbsp;&nbsp;&nbsp;&nbsp;compute_light_space_matrix,<br>
&nbsp;&nbsp;&nbsp;&nbsp;compute_frustum_corners,<br>
&nbsp;&nbsp;&nbsp;&nbsp;fit_shadow_frustum_to_camera&nbsp;as&nbsp;_fit_shadow_frustum_to_camera,<br>
)<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.camera&nbsp;import&nbsp;Camera<br>
<br>
__all__&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;ShadowCameraParams&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;build_shadow_view_matrix&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;build_shadow_projection_matrix&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;compute_light_space_matrix&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;compute_frustum_corners&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;fit_shadow_frustum_to_camera&quot;,<br>
]<br>
<br>
<br>
def&nbsp;_limit_projection_far(<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;camera:&nbsp;&quot;Camera&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_distance:&nbsp;float,<br>
)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;a&nbsp;copy&nbsp;of&nbsp;projection&nbsp;matrix&nbsp;with&nbsp;limited&nbsp;far&nbsp;plane.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Handles&nbsp;both&nbsp;perspective&nbsp;and&nbsp;orthographic&nbsp;projections&nbsp;(Y-forward&nbsp;convention).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;proj.copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;near&nbsp;=&nbsp;camera.near<br>
&nbsp;&nbsp;&nbsp;&nbsp;far&nbsp;=&nbsp;min(camera.far,&nbsp;max_distance)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;far&nbsp;&lt;=&nbsp;near:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;far&nbsp;=&nbsp;near&nbsp;+&nbsp;1.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;projection&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;projection_type&nbsp;=&nbsp;getattr(camera,&nbsp;'projection_type',&nbsp;'perspective')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;projection_type&nbsp;==&nbsp;&quot;orthographic&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;For&nbsp;Y-forward&nbsp;orthographic&nbsp;projection:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;proj[2,1]&nbsp;=&nbsp;2.0&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;proj[2,3]&nbsp;=&nbsp;-(far&nbsp;+&nbsp;near)&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj[2,&nbsp;1]&nbsp;=&nbsp;2.0&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj[2,&nbsp;3]&nbsp;=&nbsp;-(far&nbsp;+&nbsp;near)&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;For&nbsp;Y-forward&nbsp;perspective&nbsp;projection:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;proj[2,1]&nbsp;=&nbsp;(far&nbsp;+&nbsp;near)&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;proj[2,3]&nbsp;=&nbsp;-2&nbsp;*&nbsp;far&nbsp;*&nbsp;near&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj[2,&nbsp;1]&nbsp;=&nbsp;(far&nbsp;+&nbsp;near)&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj[2,&nbsp;3]&nbsp;=&nbsp;-2.0&nbsp;*&nbsp;far&nbsp;*&nbsp;near&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;proj<br>
<br>
<br>
def&nbsp;fit_shadow_frustum_to_camera(<br>
&nbsp;&nbsp;&nbsp;&nbsp;camera:&nbsp;&quot;Camera&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;light_direction:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;padding:&nbsp;float&nbsp;=&nbsp;1.0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_shadow_distance:&nbsp;float&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;shadow_map_resolution:&nbsp;int&nbsp;=&nbsp;1024,<br>
&nbsp;&nbsp;&nbsp;&nbsp;stabilize:&nbsp;bool&nbsp;=&nbsp;True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;caster_offset:&nbsp;float&nbsp;=&nbsp;50.0,<br>
)&nbsp;-&gt;&nbsp;ShadowCameraParams:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Compute&nbsp;shadow&nbsp;camera&nbsp;parameters&nbsp;that&nbsp;cover&nbsp;the&nbsp;camera's&nbsp;view&nbsp;frustum.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Algorithm:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Compute&nbsp;8&nbsp;frustum&nbsp;corners&nbsp;in&nbsp;world&nbsp;space<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Transform&nbsp;to&nbsp;light&nbsp;space&nbsp;(light&nbsp;orientation)<br>
&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Find&nbsp;AABB&nbsp;in&nbsp;light&nbsp;space<br>
&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;Use&nbsp;AABB&nbsp;as&nbsp;orthographic&nbsp;projection&nbsp;bounds<br>
&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;(Optional)&nbsp;Stabilize&nbsp;bounds&nbsp;to&nbsp;prevent&nbsp;shadow&nbsp;jittering<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parameters:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;camera:&nbsp;Main&nbsp;scene&nbsp;camera<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_direction:&nbsp;Directional&nbsp;light&nbsp;direction<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;padding:&nbsp;Extra&nbsp;padding&nbsp;around&nbsp;frustum<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_shadow_distance:&nbsp;Max&nbsp;shadow&nbsp;distance&nbsp;(None&nbsp;=&nbsp;use&nbsp;camera&nbsp;far&nbsp;plane)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadow_map_resolution:&nbsp;Shadow&nbsp;map&nbsp;resolution&nbsp;(for&nbsp;stabilization)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stabilize:&nbsp;Enable&nbsp;texel&nbsp;snapping&nbsp;to&nbsp;prevent&nbsp;shadow&nbsp;jittering<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;caster_offset:&nbsp;Distance&nbsp;behind&nbsp;camera&nbsp;to&nbsp;capture&nbsp;shadow&nbsp;casters<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShadowCameraParams&nbsp;with&nbsp;fitted&nbsp;frustum<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;light_direction&nbsp;=&nbsp;np.asarray(light_direction,&nbsp;dtype=np.float64)<br>
&nbsp;&nbsp;&nbsp;&nbsp;norm&nbsp;=&nbsp;np.linalg.norm(light_direction)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;norm&nbsp;&gt;&nbsp;1e-6:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_direction&nbsp;=&nbsp;light_direction&nbsp;/&nbsp;norm<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;view&nbsp;=&nbsp;camera.get_view_matrix().to_numpy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;camera.get_projection_matrix().to_numpy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;max_shadow_distance&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;_limit_projection_far(proj,&nbsp;camera,&nbsp;max_shadow_distance)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_fit_shadow_frustum_to_camera(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_direction,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;padding,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadow_map_resolution,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stabilize,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;caster_offset,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<!-- END SCAT CODE -->
</body>
</html>
