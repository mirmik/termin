<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/shadow/shadow_camera.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Вычисление&nbsp;view/projection&nbsp;матриц&nbsp;для&nbsp;shadow&nbsp;mapping.<br>
<br>
Для&nbsp;directional&nbsp;light&nbsp;используется&nbsp;ортографическая&nbsp;проекция,<br>
охватывающая&nbsp;view&nbsp;frustum&nbsp;основной&nbsp;камеры&nbsp;(frustum&nbsp;fitting).<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass<br>
from&nbsp;typing&nbsp;import&nbsp;Tuple<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
<br>
@dataclass<br>
class&nbsp;ShadowCameraParams:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Параметры&nbsp;теневой&nbsp;камеры&nbsp;для&nbsp;directional&nbsp;light.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Атрибуты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_direction:&nbsp;нормализованное&nbsp;направление&nbsp;света&nbsp;(из&nbsp;источника&nbsp;в&nbsp;сцену)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ortho_size:&nbsp;половина&nbsp;размера&nbsp;ортографического&nbsp;бокса&nbsp;(ширина&nbsp;=&nbsp;высота&nbsp;=&nbsp;2&nbsp;*&nbsp;ortho_size)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;near:&nbsp;ближняя&nbsp;плоскость&nbsp;отсечения<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;far:&nbsp;дальняя&nbsp;плоскость&nbsp;отсечения<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;center:&nbsp;центр&nbsp;теневого&nbsp;бокса&nbsp;в&nbsp;мировых&nbsp;координатах<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;light_direction:&nbsp;np.ndarray<br>
&nbsp;&nbsp;&nbsp;&nbsp;ortho_size:&nbsp;float&nbsp;=&nbsp;20.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;near:&nbsp;float&nbsp;=&nbsp;0.1<br>
&nbsp;&nbsp;&nbsp;&nbsp;far:&nbsp;float&nbsp;=&nbsp;100.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;center:&nbsp;np.ndarray&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__post_init__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.light_direction&nbsp;=&nbsp;np.asarray(self.light_direction,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm&nbsp;=&nbsp;np.linalg.norm(self.light_direction)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;norm&nbsp;&gt;&nbsp;1e-6:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.light_direction&nbsp;=&nbsp;self.light_direction&nbsp;/&nbsp;norm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.light_direction&nbsp;=&nbsp;np.array([0.0,&nbsp;-1.0,&nbsp;0.0],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.center&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.center&nbsp;=&nbsp;np.zeros(3,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.center&nbsp;=&nbsp;np.asarray(self.center,&nbsp;dtype=np.float32)<br>
<br>
<br>
def&nbsp;build_shadow_view_matrix(params:&nbsp;ShadowCameraParams)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Строит&nbsp;view-матрицу&nbsp;для&nbsp;теневой&nbsp;камеры.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Камера&nbsp;располагается&nbsp;на&nbsp;расстоянии&nbsp;far&nbsp;от&nbsp;центра&nbsp;сцены<br>
&nbsp;&nbsp;&nbsp;&nbsp;в&nbsp;направлении,&nbsp;противоположном&nbsp;свету,&nbsp;и&nbsp;смотрит&nbsp;вдоль&nbsp;света.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Формула:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eye&nbsp;=&nbsp;center&nbsp;-&nbsp;light_direction&nbsp;*&nbsp;far<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;=&nbsp;center<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;up&nbsp;=&nbsp;выбирается&nbsp;ортогонально&nbsp;light_direction<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4x4&nbsp;view&nbsp;matrix&nbsp;(float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;direction&nbsp;=&nbsp;params.light_direction<br>
&nbsp;&nbsp;&nbsp;&nbsp;center&nbsp;=&nbsp;params.center<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Позиция&nbsp;камеры&nbsp;—&nbsp;отступаем&nbsp;от&nbsp;центра&nbsp;против&nbsp;направления&nbsp;света<br>
&nbsp;&nbsp;&nbsp;&nbsp;eye&nbsp;=&nbsp;center&nbsp;-&nbsp;direction&nbsp;*&nbsp;params.far<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Выбираем&nbsp;up-вектор,&nbsp;ортогональный&nbsp;направлению<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;свет&nbsp;смотрит&nbsp;вдоль&nbsp;Y,&nbsp;берём&nbsp;Z&nbsp;как&nbsp;временный<br>
&nbsp;&nbsp;&nbsp;&nbsp;world_up&nbsp;=&nbsp;np.array([0.0,&nbsp;1.0,&nbsp;0.0],&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(np.dot(direction,&nbsp;world_up))&nbsp;&gt;&nbsp;0.99:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;world_up&nbsp;=&nbsp;np.array([0.0,&nbsp;0.0,&nbsp;1.0],&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Правый&nbsp;вектор<br>
&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;np.cross(direction,&nbsp;world_up)<br>
&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;right&nbsp;/&nbsp;np.linalg.norm(right)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Истинный&nbsp;up<br>
&nbsp;&nbsp;&nbsp;&nbsp;up&nbsp;=&nbsp;np.cross(right,&nbsp;direction)<br>
&nbsp;&nbsp;&nbsp;&nbsp;up&nbsp;=&nbsp;up&nbsp;/&nbsp;np.linalg.norm(up)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Строим&nbsp;view-матрицу&nbsp;(look-at)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;View&nbsp;=&nbsp;R&nbsp;*&nbsp;T,&nbsp;где&nbsp;R&nbsp;—&nbsp;поворот,&nbsp;T&nbsp;—&nbsp;трансляция<br>
&nbsp;&nbsp;&nbsp;&nbsp;view&nbsp;=&nbsp;np.eye(4,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Строки&nbsp;0,1,2&nbsp;—&nbsp;оси&nbsp;камеры&nbsp;(right,&nbsp;up,&nbsp;-forward)<br>
&nbsp;&nbsp;&nbsp;&nbsp;view[0,&nbsp;0:3]&nbsp;=&nbsp;right<br>
&nbsp;&nbsp;&nbsp;&nbsp;view[1,&nbsp;0:3]&nbsp;=&nbsp;up<br>
&nbsp;&nbsp;&nbsp;&nbsp;view[2,&nbsp;0:3]&nbsp;=&nbsp;-direction&nbsp;&nbsp;#&nbsp;камера&nbsp;смотрит&nbsp;вдоль&nbsp;-Z&nbsp;в&nbsp;своём&nbsp;пространстве<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Трансляция<br>
&nbsp;&nbsp;&nbsp;&nbsp;view[0,&nbsp;3]&nbsp;=&nbsp;-np.dot(right,&nbsp;eye)<br>
&nbsp;&nbsp;&nbsp;&nbsp;view[1,&nbsp;3]&nbsp;=&nbsp;-np.dot(up,&nbsp;eye)<br>
&nbsp;&nbsp;&nbsp;&nbsp;view[2,&nbsp;3]&nbsp;=&nbsp;np.dot(direction,&nbsp;eye)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;view<br>
<br>
<br>
def&nbsp;build_shadow_projection_matrix(params:&nbsp;ShadowCameraParams)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Строит&nbsp;ортографическую&nbsp;projection-матрицу&nbsp;для&nbsp;теневой&nbsp;камеры.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Параметры:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;-ortho_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;+ortho_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom&nbsp;=&nbsp;-ortho_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top&nbsp;=&nbsp;+ortho_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;near,&nbsp;far&nbsp;—&nbsp;из&nbsp;params<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Формула&nbsp;ортографической&nbsp;проекции:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[2/(r-l),&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;-(r+l)/(r-l)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;2/(t-b),&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;-(t+b)/(t-b)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;-2/(f-n),&nbsp;-(f+n)/(f-n)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4x4&nbsp;projection&nbsp;matrix&nbsp;(float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;size&nbsp;=&nbsp;params.ortho_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;near&nbsp;=&nbsp;params.near<br>
&nbsp;&nbsp;&nbsp;&nbsp;far&nbsp;=&nbsp;params.far<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;=&nbsp;-size<br>
&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;=&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;bottom&nbsp;=&nbsp;-size<br>
&nbsp;&nbsp;&nbsp;&nbsp;top&nbsp;=&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;np.zeros((4,&nbsp;4),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[0,&nbsp;0]&nbsp;=&nbsp;2.0&nbsp;/&nbsp;(right&nbsp;-&nbsp;left)<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[1,&nbsp;1]&nbsp;=&nbsp;2.0&nbsp;/&nbsp;(top&nbsp;-&nbsp;bottom)<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[2,&nbsp;2]&nbsp;=&nbsp;-2.0&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[0,&nbsp;3]&nbsp;=&nbsp;-(right&nbsp;+&nbsp;left)&nbsp;/&nbsp;(right&nbsp;-&nbsp;left)<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[1,&nbsp;3]&nbsp;=&nbsp;-(top&nbsp;+&nbsp;bottom)&nbsp;/&nbsp;(top&nbsp;-&nbsp;bottom)<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[2,&nbsp;3]&nbsp;=&nbsp;-(far&nbsp;+&nbsp;near)&nbsp;/&nbsp;(far&nbsp;-&nbsp;near)<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj[3,&nbsp;3]&nbsp;=&nbsp;1.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;proj<br>
<br>
<br>
def&nbsp;compute_light_space_matrix(params:&nbsp;ShadowCameraParams)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Вычисляет&nbsp;матрицу&nbsp;преобразования&nbsp;из&nbsp;мирового&nbsp;пространства<br>
&nbsp;&nbsp;&nbsp;&nbsp;в&nbsp;clip-пространство&nbsp;теневой&nbsp;камеры.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;light_space_matrix&nbsp;=&nbsp;projection&nbsp;*&nbsp;view<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Эта&nbsp;матрица&nbsp;используется&nbsp;в&nbsp;основном&nbsp;шейдере&nbsp;для&nbsp;трансформации<br>
&nbsp;&nbsp;&nbsp;&nbsp;фрагмента&nbsp;и&nbsp;сравнения&nbsp;с&nbsp;shadow&nbsp;map.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4x4&nbsp;matrix&nbsp;(float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;view&nbsp;=&nbsp;build_shadow_view_matrix(params)<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj&nbsp;=&nbsp;build_shadow_projection_matrix(params)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;proj&nbsp;@&nbsp;view<br>
<!-- END SCAT CODE -->
</body>
</html>
