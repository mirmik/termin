<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/state.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
ViewportRenderState&nbsp;—&nbsp;контейнер&nbsp;GPU&nbsp;ресурсов&nbsp;для&nbsp;viewport.<br>
<br>
Хранит:<br>
-&nbsp;output_fbo:&nbsp;финальный&nbsp;результат&nbsp;рендера&nbsp;viewport&nbsp;(для&nbsp;blit&nbsp;на&nbsp;дисплей)<br>
-&nbsp;fbos:&nbsp;deprecated,&nbsp;используется&nbsp;только&nbsp;Python&nbsp;RenderEngine&nbsp;(streaming,&nbsp;mesh&nbsp;preview)<br>
<br>
Pipeline&nbsp;и&nbsp;FBO&nbsp;pool&nbsp;для&nbsp;основного&nbsp;рендера&nbsp;хранятся&nbsp;в&nbsp;RenderPipeline&nbsp;(C++).<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass,&nbsp;field<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;Dict,&nbsp;Optional,&nbsp;Tuple<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.platform.backends.base&nbsp;import&nbsp;FramebufferHandle,&nbsp;GraphicsBackend<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.framegraph.resource&nbsp;import&nbsp;ShadowMapArrayResource<br>
<br>
<br>
@dataclass<br>
class&nbsp;ViewportRenderState:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;GPU&nbsp;ресурсы&nbsp;для&nbsp;viewport.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Управляет&nbsp;output&nbsp;FBO&nbsp;для&nbsp;финального&nbsp;результата&nbsp;рендера.<br>
&nbsp;&nbsp;&nbsp;&nbsp;FBO&nbsp;pool&nbsp;для&nbsp;основного&nbsp;рендера&nbsp;хранится&nbsp;в&nbsp;RenderPipeline&nbsp;(C++).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Атрибуты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_fbo:&nbsp;FBO&nbsp;с&nbsp;финальным&nbsp;результатом&nbsp;рендера&nbsp;(для&nbsp;blit&nbsp;на&nbsp;дисплей).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbos:&nbsp;DEPRECATED&nbsp;-&nbsp;используется&nbsp;только&nbsp;Python&nbsp;RenderEngine.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadow_map_arrays:&nbsp;DEPRECATED&nbsp;-&nbsp;используется&nbsp;только&nbsp;Python&nbsp;RenderEngine.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Output&nbsp;FBO&nbsp;-&nbsp;финальный&nbsp;результат&nbsp;рендера&nbsp;viewport<br>
&nbsp;&nbsp;&nbsp;&nbsp;output_fbo:&nbsp;Optional[&quot;FramebufferHandle&quot;]&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;_output_size:&nbsp;Tuple[int,&nbsp;int]&nbsp;=&nbsp;(0,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;DEPRECATED:&nbsp;используется&nbsp;только&nbsp;Python&nbsp;RenderEngine&nbsp;(streaming,&nbsp;mesh&nbsp;preview)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Основной&nbsp;рендер&nbsp;использует&nbsp;RenderPipeline.fbo_pool()&nbsp;(C++)<br>
&nbsp;&nbsp;&nbsp;&nbsp;fbos:&nbsp;Dict[str,&nbsp;&quot;FramebufferHandle&quot;]&nbsp;=&nbsp;field(default_factory=dict)<br>
&nbsp;&nbsp;&nbsp;&nbsp;shadow_map_arrays:&nbsp;Dict[str,&nbsp;&quot;ShadowMapArrayResource&quot;]&nbsp;=&nbsp;field(default_factory=dict)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;ensure_output_fbo(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics:&nbsp;&quot;GraphicsBackend&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size:&nbsp;Tuple[int,&nbsp;int],<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;&quot;FramebufferHandle&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Создаёт&nbsp;или&nbsp;ресайзит&nbsp;output&nbsp;FBO&nbsp;под&nbsp;нужный&nbsp;размер.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Output&nbsp;FBO&nbsp;используется&nbsp;для&nbsp;финального&nbsp;результата&nbsp;рендера&nbsp;viewport.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;После&nbsp;рендеринга&nbsp;содержимое&nbsp;блитается&nbsp;на&nbsp;дисплей.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Параметры:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics:&nbsp;GraphicsBackend&nbsp;для&nbsp;создания&nbsp;FBO.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size:&nbsp;Требуемый&nbsp;размер&nbsp;(width,&nbsp;height).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FramebufferHandle&nbsp;нужного&nbsp;размера.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.output_fbo&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output_fbo&nbsp;=&nbsp;graphics.create_framebuffer(size,&nbsp;samples=1,&nbsp;format=&quot;rgba16f&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._output_size&nbsp;=&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;self._output_size&nbsp;!=&nbsp;size:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output_fbo.resize(size)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._output_size&nbsp;=&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.output_fbo<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;DEPRECATED&nbsp;methods&nbsp;for&nbsp;Python&nbsp;RenderEngine&nbsp;compatibility<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_shadow_map_array(self,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;Optional[&quot;ShadowMapArrayResource&quot;]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;DEPRECATED:&nbsp;используется&nbsp;только&nbsp;Python&nbsp;RenderEngine.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.shadow_map_arrays.get(name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_shadow_map_array(self,&nbsp;name:&nbsp;str,&nbsp;resource:&nbsp;&quot;ShadowMapArrayResource&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;DEPRECATED:&nbsp;используется&nbsp;только&nbsp;Python&nbsp;RenderEngine.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.shadow_map_arrays[name]&nbsp;=&nbsp;resource<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear_all(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Освобождает&nbsp;все&nbsp;ресурсы&nbsp;включая&nbsp;output_fbo.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Вызывайте&nbsp;при&nbsp;удалении&nbsp;viewport.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;deprecated&nbsp;fbos<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;name,&nbsp;resource&nbsp;in&nbsp;self.fbos.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;resource&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource.delete()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.warn(f&quot;[ViewportRenderState]&nbsp;Failed&nbsp;to&nbsp;delete&nbsp;FBO&nbsp;'{name}':&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.fbos.clear()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.shadow_map_arrays.clear()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;output_fbo<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.output_fbo&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output_fbo.delete()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.warn(f&quot;[ViewportRenderState]&nbsp;Failed&nbsp;to&nbsp;delete&nbsp;output_fbo:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output_fbo&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._output_size&nbsp;=&nbsp;(0,&nbsp;0)<br>
<!-- END SCAT CODE -->
</body>
</html>
