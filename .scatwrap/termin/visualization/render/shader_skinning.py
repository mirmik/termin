<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/shader_skinning.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Shader&nbsp;skinning&nbsp;injection&nbsp;-&nbsp;automatically&nbsp;adds&nbsp;skeletal&nbsp;animation&nbsp;support&nbsp;to&nbsp;any&nbsp;shader.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;re<br>
from&nbsp;typing&nbsp;import&nbsp;Tuple,&nbsp;TYPE_CHECKING<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
<br>
<br>
#&nbsp;Skinning&nbsp;inputs&nbsp;to&nbsp;inject&nbsp;after&nbsp;existing&nbsp;layout&nbsp;declarations<br>
SKINNING_INPUTS&nbsp;=&nbsp;&quot;&quot;&quot;<br>
//&nbsp;===&nbsp;Skinning&nbsp;inputs&nbsp;(injected)&nbsp;===<br>
layout(location&nbsp;=&nbsp;3)&nbsp;in&nbsp;vec4&nbsp;a_joints;<br>
layout(location&nbsp;=&nbsp;4)&nbsp;in&nbsp;vec4&nbsp;a_weights;<br>
<br>
const&nbsp;int&nbsp;MAX_BONES&nbsp;=&nbsp;128;<br>
uniform&nbsp;mat4&nbsp;u_bone_matrices[MAX_BONES];<br>
uniform&nbsp;int&nbsp;u_bone_count;<br>
&quot;&quot;&quot;<br>
<br>
#&nbsp;Skinning&nbsp;function&nbsp;to&nbsp;inject&nbsp;before&nbsp;main()&nbsp;-&nbsp;full&nbsp;version&nbsp;with&nbsp;normals<br>
SKINNING_FUNCTION&nbsp;=&nbsp;&quot;&quot;&quot;<br>
//&nbsp;===&nbsp;Skinning&nbsp;function&nbsp;(injected)&nbsp;===<br>
void&nbsp;_applySkinning(inout&nbsp;vec3&nbsp;position,&nbsp;inout&nbsp;vec3&nbsp;normal)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(u_bone_count&nbsp;&lt;=&nbsp;0)&nbsp;return;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;skinned_pos&nbsp;=&nbsp;vec4(0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;skinned_norm&nbsp;=&nbsp;vec3(0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;total_weight&nbsp;=&nbsp;0.0;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;4;&nbsp;++i)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;idx&nbsp;=&nbsp;int(a_joints[i]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;w&nbsp;=&nbsp;a_weights[i];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(w&nbsp;&gt;&nbsp;0.0&nbsp;&amp;&amp;&nbsp;idx&nbsp;&lt;&nbsp;u_bone_count)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mat4&nbsp;bone&nbsp;=&nbsp;u_bone_matrices[idx];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_pos&nbsp;+=&nbsp;w&nbsp;*&nbsp;(bone&nbsp;*&nbsp;vec4(position,&nbsp;1.0));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_norm&nbsp;+=&nbsp;w&nbsp;*&nbsp;(mat3(bone)&nbsp;*&nbsp;normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total_weight&nbsp;+=&nbsp;w;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Only&nbsp;apply&nbsp;skinning&nbsp;if&nbsp;we&nbsp;had&nbsp;valid&nbsp;weights&nbsp;(preserves&nbsp;bind&nbsp;pose&nbsp;otherwise)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(total_weight&nbsp;&gt;&nbsp;0.0)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;=&nbsp;skinned_pos.xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal&nbsp;=&nbsp;skinned_norm;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
&quot;&quot;&quot;<br>
<br>
#&nbsp;Skinning&nbsp;function&nbsp;-&nbsp;position&nbsp;only&nbsp;(for&nbsp;shaders&nbsp;without&nbsp;normals)<br>
SKINNING_FUNCTION_POS_ONLY&nbsp;=&nbsp;&quot;&quot;&quot;<br>
//&nbsp;===&nbsp;Skinning&nbsp;function&nbsp;(injected,&nbsp;position&nbsp;only)&nbsp;===<br>
void&nbsp;_applySkinning(inout&nbsp;vec3&nbsp;position)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(u_bone_count&nbsp;&lt;=&nbsp;0)&nbsp;return;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;skinned_pos&nbsp;=&nbsp;vec4(0.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;total_weight&nbsp;=&nbsp;0.0;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;4;&nbsp;++i)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;idx&nbsp;=&nbsp;int(a_joints[i]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;w&nbsp;=&nbsp;a_weights[i];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(w&nbsp;&gt;&nbsp;0.0&nbsp;&amp;&amp;&nbsp;idx&nbsp;&lt;&nbsp;u_bone_count)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mat4&nbsp;bone&nbsp;=&nbsp;u_bone_matrices[idx];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_pos&nbsp;+=&nbsp;w&nbsp;*&nbsp;(bone&nbsp;*&nbsp;vec4(position,&nbsp;1.0));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total_weight&nbsp;+=&nbsp;w;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Only&nbsp;apply&nbsp;skinning&nbsp;if&nbsp;we&nbsp;had&nbsp;valid&nbsp;weights&nbsp;(preserves&nbsp;bind&nbsp;pose&nbsp;otherwise)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(total_weight&nbsp;&gt;&nbsp;0.0)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;=&nbsp;skinned_pos.xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
&quot;&quot;&quot;<br>
<br>
#&nbsp;Call&nbsp;to&nbsp;add&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main()&nbsp;-&nbsp;full&nbsp;version<br>
SKINNING_CALL&nbsp;=&nbsp;&quot;&quot;&quot;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;===&nbsp;Apply&nbsp;skinning&nbsp;(injected)&nbsp;===<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;_skinned_position&nbsp;=&nbsp;a_position;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;_skinned_normal&nbsp;=&nbsp;a_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;_applySkinning(_skinned_position,&nbsp;_skinned_normal);<br>
&quot;&quot;&quot;<br>
<br>
#&nbsp;Call&nbsp;-&nbsp;position&nbsp;only&nbsp;version<br>
SKINNING_CALL_POS_ONLY&nbsp;=&nbsp;&quot;&quot;&quot;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;===&nbsp;Apply&nbsp;skinning&nbsp;(injected,&nbsp;position&nbsp;only)&nbsp;===<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;_skinned_position&nbsp;=&nbsp;a_position;<br>
&nbsp;&nbsp;&nbsp;&nbsp;_applySkinning(_skinned_position);<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;_find_last_layout_line(source:&nbsp;str)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Find&nbsp;the&nbsp;line&nbsp;number&nbsp;after&nbsp;the&nbsp;last&nbsp;layout(...)&nbsp;in&nbsp;declaration.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;=&nbsp;source.split('\n')<br>
&nbsp;&nbsp;&nbsp;&nbsp;last_layout_line&nbsp;=&nbsp;-1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Match&nbsp;layout&nbsp;declarations&nbsp;(not&nbsp;in&nbsp;functions)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;re.match(r'\s*layout\s*\(',&nbsp;line):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_layout_line&nbsp;=&nbsp;i<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;last_layout_line<br>
<br>
<br>
def&nbsp;_find_main_function(source:&nbsp;str)&nbsp;-&gt;&nbsp;Tuple[int,&nbsp;int]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Find&nbsp;void&nbsp;main()&nbsp;function.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(line_of_void_main,&nbsp;line_of_opening_brace)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;=&nbsp;source.split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;re.match(r'\s*void\s+main\s*\(\s*\)',&nbsp;line):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;{&nbsp;is&nbsp;on&nbsp;the&nbsp;same&nbsp;line&nbsp;or&nbsp;next&nbsp;line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'{'&nbsp;in&nbsp;line:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;i,&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;i&nbsp;+&nbsp;1&nbsp;&lt;&nbsp;len(lines)&nbsp;and&nbsp;'{'&nbsp;in&nbsp;lines[i&nbsp;+&nbsp;1]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;i,&nbsp;i&nbsp;+&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1,&nbsp;-1<br>
<br>
<br>
def&nbsp;inject_skinning_into_vertex_shader(vertex_source:&nbsp;str)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Inject&nbsp;skinning&nbsp;code&nbsp;into&nbsp;a&nbsp;vertex&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Transforms:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Adds&nbsp;a_joints,&nbsp;a_weights&nbsp;inputs<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Adds&nbsp;u_bone_matrices,&nbsp;u_bone_count&nbsp;uniforms<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Adds&nbsp;_applySkinning()&nbsp;function<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Replaces&nbsp;a_position&nbsp;(and&nbsp;a_normal&nbsp;if&nbsp;present)&nbsp;with&nbsp;skinned&nbsp;versions<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source:&nbsp;Original&nbsp;vertex&nbsp;shader&nbsp;source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Modified&nbsp;vertex&nbsp;shader&nbsp;with&nbsp;skinning&nbsp;support<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;already&nbsp;has&nbsp;skinning<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'u_bone_matrices'&nbsp;in&nbsp;vertex_source:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vertex_source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;=&nbsp;source_lines&nbsp;=&nbsp;vertex_source.split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;shader&nbsp;has&nbsp;a_normal&nbsp;(some&nbsp;shaders&nbsp;like&nbsp;shadow/pick&nbsp;don't&nbsp;need&nbsp;normals)<br>
&nbsp;&nbsp;&nbsp;&nbsp;has_normal&nbsp;=&nbsp;bool(re.search(r'\ba_normal\b',&nbsp;vertex_source))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1.&nbsp;Find&nbsp;insertion&nbsp;points<br>
&nbsp;&nbsp;&nbsp;&nbsp;last_layout&nbsp;=&nbsp;_find_last_layout_line(vertex_source)<br>
&nbsp;&nbsp;&nbsp;&nbsp;main_decl,&nbsp;main_brace&nbsp;=&nbsp;_find_main_function(vertex_source)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;main_decl&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(&quot;Could&nbsp;not&nbsp;find&nbsp;void&nbsp;main()&nbsp;in&nbsp;vertex&nbsp;shader&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2.&nbsp;Insert&nbsp;skinning&nbsp;inputs&nbsp;after&nbsp;last&nbsp;layout&nbsp;(or&nbsp;after&nbsp;#version&nbsp;if&nbsp;no&nbsp;layouts)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;last_layout&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_inputs_at&nbsp;=&nbsp;last_layout&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;#version&nbsp;line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;line.strip().startswith('#version'):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_inputs_at&nbsp;=&nbsp;i&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_inputs_at&nbsp;=&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3.&nbsp;Insert&nbsp;skinning&nbsp;function&nbsp;before&nbsp;main()<br>
&nbsp;&nbsp;&nbsp;&nbsp;insert_func_at&nbsp;=&nbsp;main_decl<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;4.&nbsp;Insert&nbsp;skinning&nbsp;call&nbsp;after&nbsp;opening&nbsp;brace&nbsp;of&nbsp;main()<br>
&nbsp;&nbsp;&nbsp;&nbsp;insert_call_at&nbsp;=&nbsp;main_brace&nbsp;+&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;new&nbsp;source&nbsp;(work&nbsp;backwards&nbsp;to&nbsp;preserve&nbsp;line&nbsp;numbers)<br>
&nbsp;&nbsp;&nbsp;&nbsp;result_lines&nbsp;=&nbsp;list(lines)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Choose&nbsp;version&nbsp;based&nbsp;on&nbsp;whether&nbsp;shader&nbsp;uses&nbsp;normals<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_normal:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinning_call_lines&nbsp;=&nbsp;SKINNING_CALL.rstrip('\n').split('\n')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinning_func_lines&nbsp;=&nbsp;SKINNING_FUNCTION.strip().split('\n')<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinning_call_lines&nbsp;=&nbsp;SKINNING_CALL_POS_ONLY.rstrip('\n').split('\n')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinning_func_lines&nbsp;=&nbsp;SKINNING_FUNCTION_POS_ONLY.strip().split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Insert&nbsp;inputs&nbsp;after&nbsp;layouts<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinning_input_lines&nbsp;=&nbsp;SKINNING_INPUTS.strip().split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Calculate&nbsp;offsets<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;We&nbsp;need&nbsp;to&nbsp;insert&nbsp;in&nbsp;reverse&nbsp;order&nbsp;to&nbsp;keep&nbsp;indices&nbsp;valid<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;First,&nbsp;build&nbsp;the&nbsp;new&nbsp;source&nbsp;by&nbsp;sections<br>
&nbsp;&nbsp;&nbsp;&nbsp;new_lines&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Add&nbsp;inputs&nbsp;after&nbsp;last&nbsp;layout<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;==&nbsp;insert_inputs_at:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.extend(skinning_input_lines)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.append('')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Add&nbsp;function&nbsp;before&nbsp;main<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;==&nbsp;insert_func_at:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.append('')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.extend(skinning_func_lines)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.append('')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.append(line)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Add&nbsp;call&nbsp;after&nbsp;opening&nbsp;brace<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;==&nbsp;main_brace:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.extend(skinning_call_lines)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;'\n'.join(new_lines)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;5.&nbsp;Replace&nbsp;a_position&nbsp;and&nbsp;a_normal&nbsp;with&nbsp;skinned&nbsp;versions&nbsp;in&nbsp;main()&nbsp;body<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;We&nbsp;need&nbsp;to&nbsp;be&nbsp;careful&nbsp;to&nbsp;only&nbsp;replace&nbsp;within&nbsp;main(),&nbsp;not&nbsp;in&nbsp;declarations<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;main()&nbsp;body&nbsp;boundaries&nbsp;in&nbsp;the&nbsp;new&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;new_main_decl,&nbsp;new_main_brace&nbsp;=&nbsp;_find_main_function(result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;new_main_brace&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;new_lines&nbsp;=&nbsp;result.split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;closing&nbsp;brace&nbsp;of&nbsp;main&nbsp;(simple&nbsp;brace&nbsp;counting)<br>
&nbsp;&nbsp;&nbsp;&nbsp;brace_count&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;main_start&nbsp;=&nbsp;new_main_brace<br>
&nbsp;&nbsp;&nbsp;&nbsp;main_end&nbsp;=&nbsp;len(new_lines)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(new_main_brace,&nbsp;len(new_lines)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;=&nbsp;new_lines[i]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;brace_count&nbsp;+=&nbsp;line.count('{')&nbsp;-&nbsp;line.count('}')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;brace_count&nbsp;==&nbsp;0&nbsp;and&nbsp;i&nbsp;&gt;&nbsp;new_main_brace:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;main_end&nbsp;=&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Replace&nbsp;a_position&nbsp;and&nbsp;a_normal&nbsp;only&nbsp;within&nbsp;main()&nbsp;body<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Skip&nbsp;the&nbsp;skinning&nbsp;call&nbsp;lines&nbsp;we&nbsp;just&nbsp;inserted<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinning_call_end&nbsp;=&nbsp;main_start&nbsp;+&nbsp;len(skinning_call_lines)&nbsp;+&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(skinning_call_end,&nbsp;main_end&nbsp;+&nbsp;1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;&lt;&nbsp;len(new_lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Replace&nbsp;a_position&nbsp;with&nbsp;_skinned_position<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines[i]&nbsp;=&nbsp;re.sub(r'\ba_position\b',&nbsp;'_skinned_position',&nbsp;new_lines[i])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Replace&nbsp;a_normal&nbsp;with&nbsp;_skinned_normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines[i]&nbsp;=&nbsp;re.sub(r'\ba_normal\b',&nbsp;'_skinned_normal',&nbsp;new_lines[i])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;'\n'.join(new_lines)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
<br>
def&nbsp;get_skinned_shader(shader:&nbsp;&quot;TcShader&quot;)&nbsp;-&gt;&nbsp;&quot;TcShader&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;or&nbsp;create&nbsp;a&nbsp;skinned&nbsp;variant&nbsp;of&nbsp;a&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Uses&nbsp;source-hash&nbsp;based&nbsp;registry&nbsp;for&nbsp;caching.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader:&nbsp;Original&nbsp;shader&nbsp;(TcShader)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Shader&nbsp;with&nbsp;skinning&nbsp;support&nbsp;injected<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;already&nbsp;has&nbsp;skinning&nbsp;(avoid&nbsp;double-injection)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'u_bone_matrices'&nbsp;in&nbsp;shader.vertex_source:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;shader<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.shader_variants&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_variant_registry,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShaderVariantOp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;registry&nbsp;=&nbsp;get_variant_registry()<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;registry.get_variant(shader,&nbsp;ShaderVariantOp.SKINNING)<br>
<br>
<br>
def&nbsp;get_skinned_shader_handle(original_handle):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;or&nbsp;create&nbsp;a&nbsp;skinned&nbsp;variant&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Called&nbsp;from&nbsp;C++&nbsp;SkinnedMeshRenderer::override_shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;original_handle:&nbsp;tc_shader_handle&nbsp;of&nbsp;original&nbsp;shader<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcShader&nbsp;of&nbsp;skinned&nbsp;variant,&nbsp;or&nbsp;None&nbsp;if&nbsp;injection&nbsp;fails<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader,&nbsp;ShaderVariantOp<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.glsl_preprocessor&nbsp;import&nbsp;preprocess_glsl,&nbsp;has_includes<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native&nbsp;import&nbsp;log<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;TcShader&nbsp;from&nbsp;handle<br>
&nbsp;&nbsp;&nbsp;&nbsp;original&nbsp;=&nbsp;TcShader(original_handle)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;original.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;already&nbsp;has&nbsp;skinning<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'u_bone_matrices'&nbsp;in&nbsp;original.vertex_source:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;original<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;and&nbsp;preprocess&nbsp;sources<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertex_source&nbsp;=&nbsp;original.vertex_source<br>
&nbsp;&nbsp;&nbsp;&nbsp;fragment_source&nbsp;=&nbsp;original.fragment_source<br>
&nbsp;&nbsp;&nbsp;&nbsp;geometry_source&nbsp;=&nbsp;original.geometry_source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader_name&nbsp;=&nbsp;original.name&nbsp;or&nbsp;&quot;Unknown&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Preprocess&nbsp;includes&nbsp;if&nbsp;present<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_includes(vertex_source):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source&nbsp;=&nbsp;preprocess_glsl(vertex_source,&nbsp;f&quot;{shader_name}/vertex&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_includes(fragment_source):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source&nbsp;=&nbsp;preprocess_glsl(fragment_source,&nbsp;f&quot;{shader_name}/fragment&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;geometry_source&nbsp;and&nbsp;has_includes(geometry_source):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_source&nbsp;=&nbsp;preprocess_glsl(geometry_source,&nbsp;f&quot;{shader_name}/geometry&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Inject&nbsp;skinning&nbsp;into&nbsp;vertex&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_vertex&nbsp;=&nbsp;inject_skinning_into_vertex_shader(vertex_source)<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;or&nbsp;find&nbsp;skinned&nbsp;variant&nbsp;in&nbsp;registry<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned_name&nbsp;=&nbsp;f&quot;{original.name}_Skinned&quot;&nbsp;if&nbsp;original.name&nbsp;else&nbsp;f&quot;Skinned_{original.uuid[:8]}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned&nbsp;=&nbsp;TcShader.from_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_vertex,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_source&nbsp;or&nbsp;&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;original.source_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;skinned.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.error(f&quot;[get_skinned_shader_handle]&nbsp;Failed&nbsp;to&nbsp;create&nbsp;skinned&nbsp;shader&nbsp;for&nbsp;'{original.name}'&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Copy&nbsp;features&nbsp;from&nbsp;original&nbsp;shader&nbsp;(e.g.,&nbsp;lighting_ubo)<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned.set_features(original.features)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Mark&nbsp;as&nbsp;variant<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned.set_variant_info(original,&nbsp;ShaderVariantOp.SKINNING)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;skinned<br>
<br>
<br>
#&nbsp;Cache&nbsp;for&nbsp;skinned&nbsp;TcShader&nbsp;objects&nbsp;to&nbsp;keep&nbsp;them&nbsp;alive&nbsp;(prevent&nbsp;refcount&nbsp;drop&nbsp;to&nbsp;0)<br>
#&nbsp;Key:&nbsp;original&nbsp;handle&nbsp;as&nbsp;tuple&nbsp;(index,&nbsp;generation)<br>
_skinned_tc_shader_cache:&nbsp;dict[tuple[int,&nbsp;int],&nbsp;&quot;TcShader&quot;]&nbsp;=&nbsp;{}<br>
<br>
<br>
def&nbsp;clear_skinning_cache()&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Clear&nbsp;all&nbsp;cached&nbsp;skinned&nbsp;variants.&nbsp;Call&nbsp;when&nbsp;shaders&nbsp;are&nbsp;reloaded.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.shader_variants&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_variant_registry,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShaderVariantOp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;shader&nbsp;variants&nbsp;from&nbsp;registry<br>
&nbsp;&nbsp;&nbsp;&nbsp;registry&nbsp;=&nbsp;get_variant_registry()<br>
&nbsp;&nbsp;&nbsp;&nbsp;registry.clear_operation(ShaderVariantOp.SKINNING)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;TcShader&nbsp;cache<br>
&nbsp;&nbsp;&nbsp;&nbsp;_skinned_tc_shader_cache.clear()<br>
<!-- END SCAT CODE -->
</body>
</html>
