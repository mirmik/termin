<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/lighting/shading.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Аналитические&nbsp;помощники&nbsp;шейдинга&nbsp;(Ламберт&nbsp;+&nbsp;Блинн–Фонг).&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.visualization.core.lighting.light&nbsp;import&nbsp;LightSample<br>
<br>
<br>
def&nbsp;_normalize(vec:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;norm&nbsp;=&nbsp;np.linalg.norm(vec)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;norm&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vec<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vec&nbsp;/&nbsp;norm<br>
<br>
<br>
def&nbsp;lambert_diffuse(normal:&nbsp;np.ndarray,&nbsp;sample:&nbsp;LightSample,&nbsp;albedo:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Диффузная&nbsp;составляющая&nbsp;по&nbsp;закону&nbsp;Ламберта.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Косинус&nbsp;``max(dot(N,&nbsp;L),&nbsp;0)``&nbsp;появляется&nbsp;из&nbsp;проекции&nbsp;падающего&nbsp;облучения<br>
&nbsp;&nbsp;&nbsp;&nbsp;на&nbsp;поверхность.&nbsp;Физически&nbsp;нормированный&nbsp;Ламберт-коэффициент&nbsp;—&nbsp;это<br>
&nbsp;&nbsp;&nbsp;&nbsp;``albedo&nbsp;/&nbsp;pi``;&nbsp;здесь&nbsp;``pi``&nbsp;оставляем&nbsp;вне&nbsp;формулы&nbsp;для&nbsp;удобства&nbsp;настройки.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;=&nbsp;_normalize(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;L&nbsp;=&nbsp;_normalize(sample.L)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ndotl&nbsp;=&nbsp;max(float(np.dot(N,&nbsp;L)),&nbsp;0.0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;albedo&nbsp;*&nbsp;ndotl&nbsp;*&nbsp;sample.radiance<br>
<br>
<br>
def&nbsp;fresnel_schlick(cos_theta:&nbsp;float,&nbsp;f0:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Аппроксимация&nbsp;Френеля&nbsp;по&nbsp;Шлику:<br>
&nbsp;&nbsp;&nbsp;&nbsp;``F&nbsp;=&nbsp;F0&nbsp;+&nbsp;(1&nbsp;-&nbsp;F0)&nbsp;(1&nbsp;-&nbsp;cos(theta))^5``.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;f0&nbsp;+&nbsp;(1.0&nbsp;-&nbsp;f0)&nbsp;*&nbsp;((1.0&nbsp;-&nbsp;cos_theta)&nbsp;**&nbsp;5)<br>
<br>
<br>
def&nbsp;blinn_phong_specular(<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;view_dir:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;sample:&nbsp;LightSample,<br>
&nbsp;&nbsp;&nbsp;&nbsp;shininess:&nbsp;float,<br>
&nbsp;&nbsp;&nbsp;&nbsp;f0:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Блик&nbsp;Блинна–Фонга&nbsp;с&nbsp;опциональным&nbsp;весом&nbsp;Френеля.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Подсветка&nbsp;использует&nbsp;``H&nbsp;=&nbsp;normalize(L&nbsp;+&nbsp;V)``&nbsp;и&nbsp;``spec&nbsp;=&nbsp;max(dot(N,&nbsp;H),&nbsp;0)^s``.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Если&nbsp;задан&nbsp;``f0``,&nbsp;аппроксимация&nbsp;Шлика&nbsp;модифицирует&nbsp;лобу,&nbsp;имитируя<br>
&nbsp;&nbsp;&nbsp;&nbsp;перераспределение&nbsp;энергии&nbsp;между&nbsp;диффузной&nbsp;и&nbsp;зеркальной&nbsp;составляющими.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;=&nbsp;_normalize(normal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;L&nbsp;=&nbsp;_normalize(sample.L)<br>
&nbsp;&nbsp;&nbsp;&nbsp;V&nbsp;=&nbsp;_normalize(view_dir)<br>
&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;=&nbsp;_normalize(L&nbsp;+&nbsp;V)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ndoth&nbsp;=&nbsp;max(float(np.dot(N,&nbsp;H)),&nbsp;0.0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;spec&nbsp;=&nbsp;(ndoth&nbsp;**&nbsp;shininess)&nbsp;if&nbsp;shininess&nbsp;&gt;&nbsp;0.0&nbsp;else&nbsp;0.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;f0&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cos_theta&nbsp;=&nbsp;max(float(np.dot(H,&nbsp;V)),&nbsp;0.0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;specular_color&nbsp;=&nbsp;fresnel_schlick(cos_theta,&nbsp;np.asarray(f0,&nbsp;dtype=np.float32))<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;specular_color&nbsp;=&nbsp;1.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;specular_color&nbsp;*&nbsp;spec&nbsp;*&nbsp;sample.radiance<br>
<!-- END SCAT CODE -->
</body>
</html>
