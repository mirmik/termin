<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/lighting/upload.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Загрузка&nbsp;параметров&nbsp;источников&nbsp;света&nbsp;в&nbsp;GLSL-шейдер.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Sequence<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.lighting&nbsp;import&nbsp;Light,&nbsp;LightType<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
<br>
#&nbsp;Максимальное&nbsp;число&nbsp;источников,&nbsp;поддерживаемых&nbsp;дефолтным&nbsp;forward-проходом.<br>
MAX_LIGHTS&nbsp;=&nbsp;8<br>
<br>
<br>
def&nbsp;_light_type_to_int(light_type:&nbsp;LightType)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.DIRECTIONAL:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.POINT:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.SPOT:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Unknown&nbsp;LightType:&nbsp;{light_type}&quot;)<br>
<br>
<br>
def&nbsp;_attenuation_vector(light:&nbsp;Light)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Собираем&nbsp;коэффициенты&nbsp;затухания&nbsp;``w(d)&nbsp;=&nbsp;1&nbsp;/&nbsp;(k_c&nbsp;+&nbsp;k_l&nbsp;d&nbsp;+&nbsp;k_q&nbsp;d^2)``.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Они&nbsp;напрямую&nbsp;падают&nbsp;в&nbsp;шейдер.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;coeffs&nbsp;=&nbsp;light.attenuation<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[coeffs.constant,&nbsp;coeffs.linear,&nbsp;coeffs.quadratic],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtype=np.float32,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
_DEBUG_LIGHTS&nbsp;=&nbsp;False&nbsp;&nbsp;#&nbsp;TODO:&nbsp;убрать&nbsp;после&nbsp;отладки<br>
_debug_frame_counter&nbsp;=&nbsp;0<br>
<br>
<br>
def&nbsp;upload_lights_to_shader(shader:&nbsp;TcShader,&nbsp;lights:&nbsp;Sequence[Light])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Передать&nbsp;массив&nbsp;источников&nbsp;в&nbsp;uniform-пакет.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Геометрия&nbsp;источников&nbsp;задаётся&nbsp;явными&nbsp;векторами&nbsp;``position``&nbsp;и&nbsp;``direction``&nbsp;—<br>
&nbsp;&nbsp;&nbsp;&nbsp;никаких&nbsp;getattr&nbsp;и&nbsp;магии,&nbsp;только&nbsp;строгие&nbsp;поля.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_debug_frame_counter<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;=&nbsp;min(len(lights),&nbsp;MAX_LIGHTS)<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_light_count&quot;,&nbsp;count)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;=&nbsp;&quot;u_light_&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Debug:&nbsp;выводим&nbsp;первые&nbsp;10&nbsp;вызовов<br>
&nbsp;&nbsp;&nbsp;&nbsp;should_debug&nbsp;=&nbsp;_DEBUG_LIGHTS&nbsp;and&nbsp;(_debug_frame_counter&nbsp;&lt;=&nbsp;10)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;should_debug:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;\n===&nbsp;upload_lights_to_shader&nbsp;(call&nbsp;#{_debug_frame_counter})&nbsp;===&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;shader:&nbsp;{shader}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;light_count:&nbsp;{count}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;index&nbsp;in&nbsp;range(count):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light&nbsp;=&nbsp;lights[index]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_type_int&nbsp;=&nbsp;_light_type_to_int(light.type)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(f&quot;{prefix}type[{index}]&quot;,&nbsp;light_type_int)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color&nbsp;=&nbsp;light.color<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}color[{index}]&quot;,&nbsp;float(color[0]),&nbsp;float(color[1]),&nbsp;float(color[2]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}intensity[{index}]&quot;,&nbsp;float(light.intensity))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;direction&nbsp;=&nbsp;light.direction<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}direction[{index}]&quot;,&nbsp;float(direction[0]),&nbsp;float(direction[1]),&nbsp;float(direction[2]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;=&nbsp;light.position<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}position[{index}]&quot;,&nbsp;float(position[0]),&nbsp;float(position[1]),&nbsp;float(position[2]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_range&nbsp;=&nbsp;1e9&nbsp;if&nbsp;light.range&nbsp;is&nbsp;None&nbsp;else&nbsp;float(light.range)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}range[{index}]&quot;,&nbsp;light_range)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn&nbsp;=&nbsp;_attenuation_vector(light)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}attenuation[{index}]&quot;,&nbsp;float(attn[0]),&nbsp;float(attn[1]),&nbsp;float(attn[2]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}inner_angle[{index}]&quot;,&nbsp;float(light.inner_angle))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}outer_angle[{index}]&quot;,&nbsp;float(light.outer_angle))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;should_debug:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;Light[{index}]:&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;type:&nbsp;{light.type}&nbsp;-&gt;&nbsp;int={light_type_int}&nbsp;(0=DIR,&nbsp;1=POINT,&nbsp;2=SPOT)&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;color:&nbsp;{light.color}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;intensity:&nbsp;{light.intensity}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;direction:&nbsp;{light.direction}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;position:&nbsp;{light.position}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;range:&nbsp;{light_range}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;&nbsp;&nbsp;&nbsp;&nbsp;attenuation:&nbsp;{_attenuation_vector(light)}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;should_debug:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;===&nbsp;end&nbsp;===\n&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_debug_frame_counter&nbsp;+=&nbsp;1<br>
<br>
<br>
def&nbsp;upload_ambient_to_shader(<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader:&nbsp;TcShader,<br>
&nbsp;&nbsp;&nbsp;&nbsp;ambient_color:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;ambient_intensity:&nbsp;float,<br>
)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Upload&nbsp;scene-level&nbsp;ambient&nbsp;lighting&nbsp;uniforms.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ac&nbsp;=&nbsp;ambient_color<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(&quot;u_ambient_color&quot;,&nbsp;float(ac[0]),&nbsp;float(ac[1]),&nbsp;float(ac[2]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(&quot;u_ambient_intensity&quot;,&nbsp;float(ambient_intensity))<br>
<!-- END SCAT CODE -->
</body>
</html>
