<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/lighting/upload.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Загрузка&nbsp;параметров&nbsp;источников&nbsp;света&nbsp;в&nbsp;GLSL-шейдер.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Sequence<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.visualization.core.lighting.light&nbsp;import&nbsp;Light,&nbsp;LightType<br>
from&nbsp;termin.visualization.render.shader&nbsp;import&nbsp;ShaderProgram<br>
<br>
#&nbsp;Максимальное&nbsp;число&nbsp;источников,&nbsp;поддерживаемых&nbsp;дефолтным&nbsp;forward-проходом.<br>
MAX_LIGHTS&nbsp;=&nbsp;8<br>
<br>
<br>
def&nbsp;_light_type_to_int(light_type:&nbsp;LightType)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.DIRECTIONAL:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.POINT:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.SPOT:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;light_type&nbsp;==&nbsp;LightType.AMBIENT:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;Unknown&nbsp;LightType:&nbsp;{light_type}&quot;)<br>
<br>
<br>
def&nbsp;_attenuation_vector(light:&nbsp;Light)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Собираем&nbsp;коэффициенты&nbsp;затухания&nbsp;``w(d)&nbsp;=&nbsp;1&nbsp;/&nbsp;(k_c&nbsp;+&nbsp;k_l&nbsp;d&nbsp;+&nbsp;k_q&nbsp;d^2)``.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Они&nbsp;напрямую&nbsp;падают&nbsp;в&nbsp;шейдер.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;coeffs&nbsp;=&nbsp;light.attenuation<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;np.array(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[coeffs.constant,&nbsp;coeffs.linear,&nbsp;coeffs.quadratic],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtype=np.float32,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<br>
def&nbsp;upload_lights_to_shader(shader:&nbsp;ShaderProgram,&nbsp;lights:&nbsp;Sequence[Light])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Передать&nbsp;массив&nbsp;источников&nbsp;в&nbsp;uniform-пакет.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Геометрия&nbsp;источников&nbsp;задаётся&nbsp;явными&nbsp;векторами&nbsp;``position``&nbsp;и&nbsp;``direction``&nbsp;—<br>
&nbsp;&nbsp;&nbsp;&nbsp;никаких&nbsp;getattr&nbsp;и&nbsp;магии,&nbsp;только&nbsp;строгие&nbsp;поля.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;=&nbsp;min(len(lights),&nbsp;MAX_LIGHTS)<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(&quot;u_light_count&quot;,&nbsp;count)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;=&nbsp;&quot;u_light_&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;index&nbsp;in&nbsp;range(count):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light&nbsp;=&nbsp;lights[index]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_int(f&quot;{prefix}type[{index}]&quot;,&nbsp;_light_type_to_int(light.type))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}color[{index}]&quot;,&nbsp;np.asarray(light.color,&nbsp;dtype=np.float32))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}intensity[{index}]&quot;,&nbsp;float(light.intensity))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}direction[{index}]&quot;,&nbsp;np.asarray(light.direction,&nbsp;dtype=np.float32))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}position[{index}]&quot;,&nbsp;np.asarray(light.position,&nbsp;dtype=np.float32))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;light_range&nbsp;=&nbsp;1e9&nbsp;if&nbsp;light.range&nbsp;is&nbsp;None&nbsp;else&nbsp;float(light.range)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}range[{index}]&quot;,&nbsp;light_range)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_vec3(f&quot;{prefix}attenuation[{index}]&quot;,&nbsp;_attenuation_vector(light))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}inner_angle[{index}]&quot;,&nbsp;float(light.inner_angle))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader.set_uniform_float(f&quot;{prefix}outer_angle[{index}]&quot;,&nbsp;float(light.outer_angle))<br>
<!-- END SCAT CODE -->
</body>
</html>
