<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/shader_line_ribbon.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Shader&nbsp;line&nbsp;ribbon&nbsp;injection&nbsp;-&nbsp;converts&nbsp;lines&nbsp;to&nbsp;world-space&nbsp;ribbons&nbsp;via&nbsp;geometry&nbsp;shader.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;re<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcMaterial,&nbsp;TcRenderState<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
<br>
<br>
#&nbsp;Geometry&nbsp;shader&nbsp;that&nbsp;expands&nbsp;lines&nbsp;into&nbsp;billboard&nbsp;quads&nbsp;facing&nbsp;camera<br>
#&nbsp;with&nbsp;round&nbsp;caps&nbsp;at&nbsp;segment&nbsp;ends&nbsp;for&nbsp;smooth&nbsp;joints<br>
LINE_RIBBON_GEOMETRY_SHADER&nbsp;=&nbsp;&quot;&quot;&quot;<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(lines)&nbsp;in;<br>
//&nbsp;4&nbsp;for&nbsp;quad&nbsp;+&nbsp;2&nbsp;circles&nbsp;*&nbsp;6&nbsp;segments&nbsp;*&nbsp;3&nbsp;vertices&nbsp;=&nbsp;4&nbsp;+&nbsp;36&nbsp;=&nbsp;40<br>
layout(triangle_strip,&nbsp;max_vertices&nbsp;=&nbsp;48)&nbsp;out;<br>
<br>
in&nbsp;vec3&nbsp;v_world_pos[];<br>
<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
uniform&nbsp;float&nbsp;u_line_width;<br>
<br>
const&nbsp;int&nbsp;CIRCLE_SEGMENTS&nbsp;=&nbsp;6;<br>
const&nbsp;float&nbsp;PI&nbsp;=&nbsp;3.14159265359;<br>
<br>
//&nbsp;Extract&nbsp;camera&nbsp;position&nbsp;from&nbsp;view&nbsp;matrix<br>
vec3&nbsp;get_camera_pos(mat4&nbsp;view)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat3&nbsp;rot&nbsp;=&nbsp;mat3(view);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;d&nbsp;=&nbsp;vec3(view[3]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-d&nbsp;*&nbsp;rot;<br>
}<br>
<br>
//&nbsp;Draw&nbsp;a&nbsp;circle&nbsp;at&nbsp;joint&nbsp;point&nbsp;(as&nbsp;separate&nbsp;triangles)<br>
void&nbsp;emit_circle(vec3&nbsp;center,&nbsp;vec3&nbsp;perp,&nbsp;vec3&nbsp;tangent,&nbsp;float&nbsp;radius,&nbsp;mat4&nbsp;vp)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;CIRCLE_SEGMENTS;&nbsp;i++)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;a0&nbsp;=&nbsp;float(i)&nbsp;/&nbsp;float(CIRCLE_SEGMENTS)&nbsp;*&nbsp;2.0&nbsp;*&nbsp;PI;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;a1&nbsp;=&nbsp;float(i&nbsp;+&nbsp;1)&nbsp;/&nbsp;float(CIRCLE_SEGMENTS)&nbsp;*&nbsp;2.0&nbsp;*&nbsp;PI;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p0&nbsp;=&nbsp;center&nbsp;+&nbsp;(perp&nbsp;*&nbsp;cos(a0)&nbsp;+&nbsp;tangent&nbsp;*&nbsp;sin(a0))&nbsp;*&nbsp;radius;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p1&nbsp;=&nbsp;center&nbsp;+&nbsp;(perp&nbsp;*&nbsp;cos(a1)&nbsp;+&nbsp;tangent&nbsp;*&nbsp;sin(a1))&nbsp;*&nbsp;radius;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Triangle:&nbsp;center&nbsp;-&gt;&nbsp;p0&nbsp;-&gt;&nbsp;p1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(center,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(p0,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(p1,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndPrimitive();<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p0&nbsp;=&nbsp;v_world_pos[0];<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p1&nbsp;=&nbsp;v_world_pos[1];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;camera_pos&nbsp;=&nbsp;get_camera_pos(u_view);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Line&nbsp;direction<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;line_dir&nbsp;=&nbsp;normalize(p1&nbsp;-&nbsp;p0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Direction&nbsp;to&nbsp;camera&nbsp;(average&nbsp;for&nbsp;both&nbsp;ends)<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;mid&nbsp;=&nbsp;(p0&nbsp;+&nbsp;p1)&nbsp;*&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;to_camera&nbsp;=&nbsp;normalize(camera_pos&nbsp;-&nbsp;mid);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Perpendicular&nbsp;to&nbsp;line&nbsp;in&nbsp;plane&nbsp;facing&nbsp;camera&nbsp;(billboard)<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;perp&nbsp;=&nbsp;normalize(cross(line_dir,&nbsp;to_camera));<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;half_width&nbsp;=&nbsp;u_line_width&nbsp;*&nbsp;0.5;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat4&nbsp;vp&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Main&nbsp;quad<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v0&nbsp;=&nbsp;p0&nbsp;-&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v1&nbsp;=&nbsp;p0&nbsp;+&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v2&nbsp;=&nbsp;p1&nbsp;-&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v3&nbsp;=&nbsp;p1&nbsp;+&nbsp;perp&nbsp;*&nbsp;half_width;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v0,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v1,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v2,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v3,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;EndPrimitive();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Round&nbsp;caps&nbsp;at&nbsp;both&nbsp;ends&nbsp;for&nbsp;smooth&nbsp;joints<br>
&nbsp;&nbsp;&nbsp;&nbsp;emit_circle(p0,&nbsp;perp,&nbsp;line_dir,&nbsp;half_width,&nbsp;vp);<br>
&nbsp;&nbsp;&nbsp;&nbsp;emit_circle(p1,&nbsp;perp,&nbsp;line_dir,&nbsp;half_width,&nbsp;vp);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
#&nbsp;Output&nbsp;declaration&nbsp;to&nbsp;add&nbsp;to&nbsp;vertex&nbsp;shader<br>
LINE_RIBBON_VS_OUTPUT&nbsp;=&nbsp;&quot;&quot;&quot;<br>
//&nbsp;===&nbsp;Line&nbsp;ribbon&nbsp;output&nbsp;(injected)&nbsp;===<br>
out&nbsp;vec3&nbsp;v_world_pos;<br>
&quot;&quot;&quot;<br>
<br>
#&nbsp;Code&nbsp;to&nbsp;add&nbsp;at&nbsp;beginning&nbsp;of&nbsp;vertex&nbsp;shader&nbsp;main()<br>
LINE_RIBBON_VS_CALL&nbsp;=&nbsp;&quot;&quot;&quot;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;===&nbsp;Compute&nbsp;world&nbsp;position&nbsp;for&nbsp;line&nbsp;ribbon&nbsp;(injected)&nbsp;===<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;(u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0)).xyz;<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;_inject_line_ribbon_into_vertex_shader(vertex_source:&nbsp;str)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Inject&nbsp;line&nbsp;ribbon&nbsp;output&nbsp;into&nbsp;vertex&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Adds:<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;out&nbsp;vec3&nbsp;v_world_pos&nbsp;declaration<br>
&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;v_world_pos&nbsp;computation&nbsp;in&nbsp;main()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;if&nbsp;already&nbsp;has&nbsp;line&nbsp;ribbon&nbsp;injection<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'v_world_pos'&nbsp;in&nbsp;vertex_source:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vertex_source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;=&nbsp;vertex_source.split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;last&nbsp;layout&nbsp;line<br>
&nbsp;&nbsp;&nbsp;&nbsp;last_layout_line&nbsp;=&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;re.match(r'\s*layout\s*\(',&nbsp;line):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_layout_line&nbsp;=&nbsp;i<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Find&nbsp;main()&nbsp;opening&nbsp;brace<br>
&nbsp;&nbsp;&nbsp;&nbsp;main_brace_line&nbsp;=&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;re.match(r'\s*void\s+main\s*\(\s*\)',&nbsp;line):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;'{'&nbsp;in&nbsp;line:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;main_brace_line&nbsp;=&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;i&nbsp;+&nbsp;1&nbsp;&lt;&nbsp;len(lines)&nbsp;and&nbsp;'{'&nbsp;in&nbsp;lines[i&nbsp;+&nbsp;1]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;main_brace_line&nbsp;=&nbsp;i&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;main_brace_line&nbsp;&lt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vertex_source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Insert&nbsp;output&nbsp;declaration&nbsp;after&nbsp;last&nbsp;layout&nbsp;(or&nbsp;after&nbsp;#version)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;last_layout_line&nbsp;&gt;=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_decl_at&nbsp;=&nbsp;last_layout_line&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_decl_at&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;line.strip().startswith('#version'):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_decl_at&nbsp;=&nbsp;i&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;new&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;new_lines&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;decl_lines&nbsp;=&nbsp;LINE_RIBBON_VS_OUTPUT.strip().split('\n')<br>
&nbsp;&nbsp;&nbsp;&nbsp;call_lines&nbsp;=&nbsp;LINE_RIBBON_VS_CALL.rstrip('\n').split('\n')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;line&nbsp;in&nbsp;enumerate(lines):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;==&nbsp;insert_decl_at:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.extend(decl_lines)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.append('')<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.append(line)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;i&nbsp;==&nbsp;main_brace_line:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_lines.extend(call_lines)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;'\n'.join(new_lines)<br>
<br>
<br>
def&nbsp;create_line_ribbon_shader_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertex_source:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;fragment_source:&nbsp;str,<br>
&nbsp;&nbsp;&nbsp;&nbsp;geometry_source:&nbsp;str,<br>
)&nbsp;-&gt;&nbsp;tuple[str,&nbsp;str,&nbsp;str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;shader&nbsp;sources&nbsp;with&nbsp;line&nbsp;ribbon&nbsp;geometry&nbsp;shader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Modifies&nbsp;vertex&nbsp;shader&nbsp;to&nbsp;output&nbsp;world&nbsp;position,&nbsp;and&nbsp;adds&nbsp;geometry<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;that&nbsp;expands&nbsp;GL_LINES&nbsp;into&nbsp;world-space&nbsp;quads.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source:&nbsp;Original&nbsp;vertex&nbsp;shader&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source:&nbsp;Original&nbsp;fragment&nbsp;shader&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_source:&nbsp;Original&nbsp;geometry&nbsp;shader&nbsp;source&nbsp;(may&nbsp;be&nbsp;empty)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tuple&nbsp;of&nbsp;(modified_vert,&nbsp;fragment,&nbsp;geometry)&nbsp;sources<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Don't&nbsp;inject&nbsp;if&nbsp;shader&nbsp;already&nbsp;has&nbsp;a&nbsp;geometry&nbsp;shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;geometry_source:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vertex_source,&nbsp;fragment_source,&nbsp;geometry_source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Modify&nbsp;vertex&nbsp;shader&nbsp;to&nbsp;output&nbsp;world&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;modified_vert&nbsp;=&nbsp;_inject_line_ribbon_into_vertex_shader(vertex_source)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;modified_vert,&nbsp;fragment_source,&nbsp;LINE_RIBBON_GEOMETRY_SHADER<br>
<br>
<br>
#&nbsp;Cache&nbsp;for&nbsp;line&nbsp;ribbon&nbsp;materials&nbsp;(keyed&nbsp;by&nbsp;material&nbsp;uuid)<br>
_line_ribbon_material_cache:&nbsp;dict[str,&nbsp;TcMaterial]&nbsp;=&nbsp;{}<br>
<br>
<br>
def&nbsp;get_line_ribbon_material(material:&nbsp;TcMaterial)&nbsp;-&gt;&nbsp;TcMaterial:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;or&nbsp;create&nbsp;a&nbsp;line&nbsp;ribbon&nbsp;variant&nbsp;of&nbsp;a&nbsp;TcMaterial.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material:&nbsp;Original&nbsp;TcMaterial<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcMaterial&nbsp;with&nbsp;line&nbsp;ribbon&nbsp;geometry&nbsp;shader&nbsp;in&nbsp;all&nbsp;phases<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat_uuid&nbsp;=&nbsp;material.uuid<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mat_uuid&nbsp;in&nbsp;_line_ribbon_material_cache:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_line_ribbon_material_cache[mat_uuid]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;new&nbsp;material&nbsp;with&nbsp;line&nbsp;ribbon&nbsp;phases<br>
&nbsp;&nbsp;&nbsp;&nbsp;ribbon_mat&nbsp;=&nbsp;TcMaterial.create(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=f&quot;{material.name}_LineRibbon&quot;&nbsp;if&nbsp;material.name&nbsp;else&nbsp;&quot;LineRibbon&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uuid_hint=&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ribbon_mat.shader_name&nbsp;=&nbsp;material.shader_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;ribbon_mat.source_path&nbsp;=&nbsp;material.source_path<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Copy&nbsp;phases&nbsp;with&nbsp;modified&nbsp;shaders<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(material.phase_count):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase&nbsp;=&nbsp;material.get_phase(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;phase&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;material.get_phase_shader(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;shader&nbsp;is&nbsp;None&nbsp;or&nbsp;not&nbsp;shader.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;original&nbsp;sources<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orig_vert&nbsp;=&nbsp;shader.vertex_source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orig_frag&nbsp;=&nbsp;shader.fragment_source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orig_geom&nbsp;=&nbsp;shader.geometry_source<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;ribbon&nbsp;variant&nbsp;sources<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vert,&nbsp;frag,&nbsp;geom&nbsp;=&nbsp;create_line_ribbon_shader_sources(orig_vert,&nbsp;orig_frag,&nbsp;orig_geom)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Create&nbsp;new&nbsp;phase&nbsp;with&nbsp;ribbon&nbsp;shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;material.get_phase_render_state(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_phase&nbsp;=&nbsp;ribbon_mat.add_phase_from_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_source=vert,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_source=frag,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_source=geom,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader_name=f&quot;{material.shader_name}_LineRibbon&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase_mark=phase.phase_mark,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;priority=phase.priority,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state=state,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;new_phase&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Copy&nbsp;uniforms&nbsp;from&nbsp;original&nbsp;phase<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Phase&nbsp;uniforms&nbsp;are&nbsp;applied&nbsp;via&nbsp;TcMaterial&nbsp;methods<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass&nbsp;&nbsp;#&nbsp;Uniforms&nbsp;will&nbsp;be&nbsp;applied&nbsp;by&nbsp;LineRenderer&nbsp;before&nbsp;draw<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_line_ribbon_material_cache[mat_uuid]&nbsp;=&nbsp;ribbon_mat<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ribbon_mat<br>
<br>
<br>
def&nbsp;clear_line_ribbon_cache()&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Clear&nbsp;all&nbsp;cached&nbsp;line&nbsp;ribbon&nbsp;variants.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;_line_ribbon_material_cache.clear()<br>
<!-- END SCAT CODE -->
</body>
</html>
