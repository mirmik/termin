<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/shader_variants.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Shader&nbsp;variant&nbsp;registry&nbsp;-&nbsp;caches&nbsp;compiled&nbsp;shader&nbsp;variants&nbsp;by&nbsp;source&nbsp;hash.<br>
<br>
Allows&nbsp;different&nbsp;components&nbsp;to&nbsp;request&nbsp;the&nbsp;same&nbsp;shader&nbsp;variant&nbsp;without<br>
recompiling&nbsp;it.&nbsp;For&nbsp;example,&nbsp;multiple&nbsp;SkinnedMeshRenderers&nbsp;can&nbsp;share<br>
the&nbsp;same&nbsp;skinned&nbsp;variant&nbsp;of&nbsp;a&nbsp;shadow&nbsp;shader.<br>
<br>
Usage:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.shader_variants&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShaderVariantRegistry,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShaderVariantOp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_variant_registry,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;registry&nbsp;=&nbsp;get_variant_registry()<br>
&nbsp;&nbsp;&nbsp;&nbsp;skinned_shader&nbsp;=&nbsp;registry.get_variant(original_shader,&nbsp;ShaderVariantOp.SKINNING)<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Callable,&nbsp;Dict,&nbsp;Tuple<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader,&nbsp;ShaderVariantOp&nbsp;as&nbsp;NativeShaderVariantOp<br>
<br>
<br>
#&nbsp;Re-export&nbsp;variant&nbsp;op&nbsp;for&nbsp;consistency<br>
ShaderVariantOp&nbsp;=&nbsp;NativeShaderVariantOp<br>
<br>
<br>
#&nbsp;Type&nbsp;alias&nbsp;for&nbsp;variant&nbsp;transform&nbsp;functions<br>
#&nbsp;Takes&nbsp;original&nbsp;shader,&nbsp;returns&nbsp;transformed&nbsp;shader<br>
VariantTransformFunc&nbsp;=&nbsp;Callable[[TcShader],&nbsp;TcShader]<br>
<br>
<br>
class&nbsp;ShaderVariantRegistry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Registry&nbsp;for&nbsp;caching&nbsp;shader&nbsp;variants&nbsp;by&nbsp;source&nbsp;hash.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Maps&nbsp;(source_hash,&nbsp;operation)&nbsp;-&gt;&nbsp;TcShader.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;allows&nbsp;multiple&nbsp;components&nbsp;to&nbsp;share&nbsp;the&nbsp;same&nbsp;shader&nbsp;variant<br>
&nbsp;&nbsp;&nbsp;&nbsp;without&nbsp;recompiling.&nbsp;For&nbsp;example,&nbsp;if&nbsp;two&nbsp;SkinnedMeshRenderers<br>
&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;need&nbsp;a&nbsp;skinned&nbsp;version&nbsp;of&nbsp;the&nbsp;shadow&nbsp;shader,&nbsp;only&nbsp;one<br>
&nbsp;&nbsp;&nbsp;&nbsp;compilation&nbsp;happens.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Map&nbsp;(hash,&nbsp;op)&nbsp;-&gt;&nbsp;TcShader<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cache:&nbsp;Dict[Tuple[str,&nbsp;ShaderVariantOp],&nbsp;TcShader]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Map&nbsp;op&nbsp;-&gt;&nbsp;transform&nbsp;function<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._transforms:&nbsp;Dict[ShaderVariantOp,&nbsp;VariantTransformFunc]&nbsp;=&nbsp;{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;register_transform(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op:&nbsp;ShaderVariantOp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transform:&nbsp;VariantTransformFunc,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Register&nbsp;a&nbsp;transform&nbsp;function&nbsp;for&nbsp;a&nbsp;variant&nbsp;operation.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op:&nbsp;The&nbsp;variant&nbsp;operation&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transform:&nbsp;Function&nbsp;that&nbsp;takes&nbsp;a&nbsp;shader&nbsp;and&nbsp;returns&nbsp;transformed&nbsp;shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._transforms[op]&nbsp;=&nbsp;transform<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_variant(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader:&nbsp;TcShader,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op:&nbsp;ShaderVariantOp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;or&nbsp;create&nbsp;a&nbsp;shader&nbsp;variant.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;variant&nbsp;already&nbsp;exists&nbsp;in&nbsp;cache,&nbsp;returns&nbsp;cached&nbsp;version.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;applies&nbsp;the&nbsp;transform&nbsp;and&nbsp;caches&nbsp;the&nbsp;result.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader:&nbsp;Original&nbsp;shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op:&nbsp;Variant&nbsp;operation&nbsp;to&nbsp;apply<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Transformed&nbsp;shader<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Raises:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValueError:&nbsp;If&nbsp;no&nbsp;transform&nbsp;is&nbsp;registered&nbsp;for&nbsp;the&nbsp;operation<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Use&nbsp;source_hash&nbsp;from&nbsp;shader&nbsp;(already&nbsp;computed&nbsp;by&nbsp;C&nbsp;core)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_hash&nbsp;=&nbsp;shader.source_hash<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_key&nbsp;=&nbsp;(source_hash,&nbsp;op)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;cache<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cache_key&nbsp;in&nbsp;self._cache:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._cache[cache_key]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;transform&nbsp;function<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transform&nbsp;=&nbsp;self._transforms.get(op)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;transform&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f&quot;No&nbsp;transform&nbsp;registered&nbsp;for&nbsp;operation:&nbsp;{op}&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Apply&nbsp;transform&nbsp;and&nbsp;cache<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variant&nbsp;=&nbsp;transform(shader)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cache[cache_key]&nbsp;=&nbsp;variant<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;variant<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;has_variant(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader:&nbsp;TcShader,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op:&nbsp;ShaderVariantOp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;bool:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Check&nbsp;if&nbsp;a&nbsp;variant&nbsp;exists&nbsp;in&nbsp;cache&nbsp;without&nbsp;creating&nbsp;it.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_hash&nbsp;=&nbsp;shader.source_hash<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(source_hash,&nbsp;op)&nbsp;in&nbsp;self._cache<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Clear&nbsp;all&nbsp;cached&nbsp;variants.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cache.clear()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear_operation(self,&nbsp;op:&nbsp;ShaderVariantOp)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Clear&nbsp;cached&nbsp;variants&nbsp;for&nbsp;a&nbsp;specific&nbsp;operation.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keys_to_remove&nbsp;=&nbsp;[k&nbsp;for&nbsp;k&nbsp;in&nbsp;self._cache&nbsp;if&nbsp;k[1]&nbsp;==&nbsp;op]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key&nbsp;in&nbsp;keys_to_remove:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del&nbsp;self._cache[key]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;cache_size(self)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Number&nbsp;of&nbsp;cached&nbsp;variants.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(self._cache)<br>
<br>
<br>
#&nbsp;Global&nbsp;singleton&nbsp;registry<br>
_global_registry:&nbsp;ShaderVariantRegistry&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
<br>
def&nbsp;get_variant_registry()&nbsp;-&gt;&nbsp;ShaderVariantRegistry:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;the&nbsp;global&nbsp;shader&nbsp;variant&nbsp;registry.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_global_registry<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_global_registry&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_global_registry&nbsp;=&nbsp;ShaderVariantRegistry()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_register_default_transforms(_global_registry)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_global_registry<br>
<br>
<br>
def&nbsp;_register_default_transforms(registry:&nbsp;ShaderVariantRegistry)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Register&nbsp;default&nbsp;variant&nbsp;transforms.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Import&nbsp;here&nbsp;to&nbsp;avoid&nbsp;circular&nbsp;imports<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.shader_skinning&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inject_skinning_into_vertex_shader,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;skinning_transform(shader:&nbsp;TcShader)&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Transform&nbsp;shader&nbsp;to&nbsp;add&nbsp;skinning&nbsp;support.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skinned_vert&nbsp;=&nbsp;inject_skinning_into_vertex_shader(shader.vertex_source)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variant&nbsp;=&nbsp;TcShader.from_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex=skinned_vert,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment=shader.fragment_source,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry=shader.geometry_source,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=f&quot;{shader.name}_skinned&quot;&nbsp;if&nbsp;shader.name&nbsp;else&nbsp;&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_path=f&quot;{shader.source_path}:skinned&quot;&nbsp;if&nbsp;shader.source_path&nbsp;else&nbsp;&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variant.set_variant_info(shader,&nbsp;ShaderVariantOp.SKINNING)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;variant<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;registry.register_transform(ShaderVariantOp.SKINNING,&nbsp;skinning_transform)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Note:&nbsp;LINE_RIBBON&nbsp;is&nbsp;now&nbsp;handled&nbsp;at&nbsp;material&nbsp;level&nbsp;via&nbsp;get_line_ribbon_material()<br>
<br>
<br>
def&nbsp;clear_variant_cache()&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Clear&nbsp;all&nbsp;cached&nbsp;shader&nbsp;variants.&nbsp;Call&nbsp;when&nbsp;shaders&nbsp;are&nbsp;reloaded.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_global_registry<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_global_registry&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_global_registry.clear()<br>
<!-- END SCAT CODE -->
</body>
</html>
