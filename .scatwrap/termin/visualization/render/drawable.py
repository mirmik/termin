<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/visualization/render/drawable.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Drawable&nbsp;protocol&nbsp;—&nbsp;унифицированный&nbsp;интерфейс&nbsp;для&nbsp;рендеринга.<br>
<br>
Позволяет&nbsp;ColorPass,&nbsp;ShadowPass,&nbsp;IdPass&nbsp;и&nbsp;другим&nbsp;пассам&nbsp;единообразно<br>
работать&nbsp;с&nbsp;разными&nbsp;типами&nbsp;рендереров&nbsp;(MeshRenderer,&nbsp;LineRenderer,&nbsp;IconRenderer&nbsp;и&nbsp;т.д.).<br>
<br>
Разделение&nbsp;ответственности:<br>
-&nbsp;FramePass&nbsp;отвечает&nbsp;за&nbsp;привязку&nbsp;шейдера/материала<br>
-&nbsp;Drawable&nbsp;отвечает&nbsp;за&nbsp;отрисовку&nbsp;геометрии<br>
<br>
Использование:<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ColorPass&nbsp;спрашивает&nbsp;фазы&nbsp;у&nbsp;Drawable,&nbsp;применяет&nbsp;их&nbsp;и&nbsp;рисует<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;drawable&nbsp;in&nbsp;drawables:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;draw_call&nbsp;in&nbsp;drawable.get_geometry_draws(phase_mark):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphics.apply_render_state(draw_call.phase.state)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;material.apply(model,&nbsp;view,&nbsp;projection)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drawable.draw_geometry(context,&nbsp;draw_call.geometry_id)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ShadowPass&nbsp;использует&nbsp;свой&nbsp;шейдер<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;drawable&nbsp;in&nbsp;drawables:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&quot;shadow&quot;&nbsp;in&nbsp;drawable.phase_marks:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadow_shader.use()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;...&nbsp;setup&nbsp;uniforms&nbsp;...<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drawable.draw_geometry(context)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;IdPass&nbsp;использует&nbsp;свой&nbsp;шейдер&nbsp;с&nbsp;pick_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;drawable&nbsp;in&nbsp;drawables:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_shader.use()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_shader.set_uniform(&quot;u_pick_color&quot;,&nbsp;encode_pick_id(entity.pick_id))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drawable.draw_geometry(context)<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;dataclasses&nbsp;import&nbsp;dataclass<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;List,&nbsp;Protocol,&nbsp;Set,&nbsp;runtime_checkable<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin._native.render&nbsp;import&nbsp;TcMaterialPhase<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.render_context&nbsp;import&nbsp;RenderContext<br>
<br>
<br>
#&nbsp;Идентификатор&nbsp;геометрии&nbsp;по&nbsp;умолчанию<br>
DEFAULT_GEOMETRY_ID&nbsp;=&nbsp;0<br>
<br>
<br>
@dataclass<br>
class&nbsp;GeometryDrawCall:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Описание&nbsp;одного&nbsp;запроса&nbsp;на&nbsp;отрисовку&nbsp;геометрии.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Связывает&nbsp;TcMaterialPhase&nbsp;с&nbsp;идентификатором&nbsp;геометрии.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Позволяет&nbsp;Drawable&nbsp;рисовать&nbsp;разную&nbsp;геометрию&nbsp;с&nbsp;разными&nbsp;материалами<br>
&nbsp;&nbsp;&nbsp;&nbsp;в&nbsp;одной&nbsp;фазе&nbsp;рендеринга.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Атрибуты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase:&nbsp;Фаза&nbsp;материала&nbsp;(шейдер,&nbsp;render&nbsp;state,&nbsp;uniforms).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_id:&nbsp;Идентификатор&nbsp;геометрии&nbsp;для&nbsp;draw_geometry.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;=&nbsp;основная&nbsp;геометрия.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;phase:&nbsp;&quot;TcMaterialPhase&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;geometry_id:&nbsp;int&nbsp;=&nbsp;DEFAULT_GEOMETRY_ID<br>
<br>
<br>
@runtime_checkable<br>
class&nbsp;Drawable(Protocol):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Протокол&nbsp;для&nbsp;компонентов,&nbsp;которые&nbsp;умеют&nbsp;рисовать&nbsp;геометрию.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Атрибуты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase_marks:&nbsp;Множество&nbsp;фаз,&nbsp;в&nbsp;которых&nbsp;участвует&nbsp;этот&nbsp;drawable.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Например:&nbsp;{&quot;opaque&quot;,&nbsp;&quot;shadow&quot;},&nbsp;{&quot;editor&quot;},&nbsp;{&quot;transparent&quot;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;shadow&quot;&nbsp;означает,&nbsp;что&nbsp;объект&nbsp;отбрасывает&nbsp;тень.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Используется&nbsp;пассами&nbsp;для&nbsp;фильтрации.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Методы:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;draw_geometry:&nbsp;Рисует&nbsp;геометрию&nbsp;(шейдер&nbsp;уже&nbsp;привязан&nbsp;пассом).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_geometry_draws:&nbsp;Возвращает&nbsp;GeometryDrawCalls&nbsp;для&nbsp;ColorPass.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;phase_marks:&nbsp;Set[str]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw_geometry(self,&nbsp;context:&nbsp;&quot;RenderContext&quot;,&nbsp;geometry_id:&nbsp;int&nbsp;=&nbsp;DEFAULT_GEOMETRY_ID)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Рисует&nbsp;геометрию.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Шейдер&nbsp;и&nbsp;материал&nbsp;уже&nbsp;привязаны&nbsp;пассом&nbsp;перед&nbsp;вызовом.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Drawable&nbsp;должен&nbsp;просто&nbsp;отрисовать&nbsp;свою&nbsp;геометрию&nbsp;(mesh,&nbsp;lines,&nbsp;etc.)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Параметры:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context:&nbsp;Контекст&nbsp;рендеринга.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.model&nbsp;содержит&nbsp;матрицу&nbsp;модели&nbsp;(для&nbsp;VAO&nbsp;binding).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;geometry_id:&nbsp;Идентификатор&nbsp;геометрии&nbsp;для&nbsp;отрисовки.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;=&nbsp;основная/единственная&nbsp;геометрия.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_geometry_draws(self,&nbsp;phase_mark:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;List[GeometryDrawCall]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;GeometryDrawCalls&nbsp;для&nbsp;этого&nbsp;drawable.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Используется&nbsp;ColorPass&nbsp;для&nbsp;получения&nbsp;материалов&nbsp;и&nbsp;геометрий.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShadowPass&nbsp;и&nbsp;IdPass&nbsp;игнорируют&nbsp;этот&nbsp;метод&nbsp;и&nbsp;используют&nbsp;свои&nbsp;шейдеры.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Параметры:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase_mark:&nbsp;Фильтр&nbsp;по&nbsp;метке&nbsp;фазы&nbsp;(&quot;opaque&quot;,&nbsp;&quot;transparent&quot;,&nbsp;&quot;editor&quot;,&nbsp;etc.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Если&nbsp;None,&nbsp;возвращает&nbsp;все&nbsp;фазы.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Список&nbsp;GeometryDrawCall,&nbsp;отсортированный&nbsp;по&nbsp;priority.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
<!-- END SCAT CODE -->
</body>
</html>
