<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/robot/hqsolver.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
from&nbsp;typing&nbsp;import&nbsp;List,&nbsp;Optional,&nbsp;Tuple<br>
from&nbsp;termin.linalg.solve&nbsp;import&nbsp;solve_qp_active_set<br>
from&nbsp;termin.linalg.subspaces&nbsp;import&nbsp;nullspace_basis_qr<br>
<br>
<br>
#&nbsp;=========&nbsp;ТИПЫ&nbsp;ЗАДАЧ&nbsp;================================================<br>
<br>
class&nbsp;QuadraticTask:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Задача&nbsp;вида:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min&nbsp;||&nbsp;J&nbsp;x&nbsp;-&nbsp;v&nbsp;||_W^2<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Дает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;=&nbsp;J^T&nbsp;W&nbsp;J<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;-J^T&nbsp;W&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;J:&nbsp;np.ndarray,&nbsp;v:&nbsp;np.ndarray,&nbsp;W:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.J&nbsp;=&nbsp;J.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.v&nbsp;=&nbsp;v.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.W&nbsp;=&nbsp;np.eye(J.shape[0])&nbsp;if&nbsp;W&nbsp;is&nbsp;None&nbsp;else&nbsp;W.copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;build_H_g(self)&nbsp;-&gt;&nbsp;Tuple[np.ndarray,&nbsp;np.ndarray]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;=&nbsp;self.J.T&nbsp;@&nbsp;self.W&nbsp;@&nbsp;self.J<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;-self.J.T&nbsp;@&nbsp;self.W&nbsp;@&nbsp;self.v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;H,&nbsp;g<br>
<br>
<br>
class&nbsp;EqualityConstraint:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Жёсткое&nbsp;равенство&nbsp;A&nbsp;x&nbsp;=&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;A:&nbsp;np.ndarray,&nbsp;b:&nbsp;np.ndarray):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.A&nbsp;=&nbsp;A.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.b&nbsp;=&nbsp;b.copy()<br>
<br>
<br>
class&nbsp;InequalityConstraint:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Неравенство&nbsp;C&nbsp;x&nbsp;&lt;=&nbsp;d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;C:&nbsp;np.ndarray,&nbsp;d:&nbsp;np.ndarray):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.C&nbsp;=&nbsp;C.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.d&nbsp;=&nbsp;d.copy()<br>
<br>
<br>
#&nbsp;=========&nbsp;УРОВЕНЬ&nbsp;HQP&nbsp;===============================================<br>
<br>
class&nbsp;Level:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;priority:&nbsp;int):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.priority&nbsp;=&nbsp;priority<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tasks:&nbsp;List[QuadraticTask]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.equalities:&nbsp;List[EqualityConstraint]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.inequalities:&nbsp;List[InequalityConstraint]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_task(self,&nbsp;task:&nbsp;QuadraticTask):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tasks.append(task)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_equality(self,&nbsp;eq:&nbsp;EqualityConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.equalities.append(eq)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_inequality(self,&nbsp;ineq:&nbsp;InequalityConstraint):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.inequalities.append(ineq)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;build_qp(self,&nbsp;n_vars:&nbsp;int):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;&nbsp;Формируем&nbsp;агрегированную&nbsp;задачу&nbsp;уровня:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_x&nbsp;½&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x^T&nbsp;H&nbsp;x&nbsp;+&nbsp;g^T&nbsp;x&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;при&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_eq&nbsp;x&nbsp;=&nbsp;b_eq,&nbsp;&nbsp;C&nbsp;x&nbsp;≤&nbsp;d,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;где&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;=&nbsp;Σ_i&nbsp;J_i^T&nbsp;W_i&nbsp;J_i&nbsp;и&nbsp;g&nbsp;=&nbsp;Σ_i&nbsp;(-J_i^T&nbsp;W_i&nbsp;v_i).&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;=&nbsp;np.zeros((n_vars,&nbsp;n_vars))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;np.zeros(n_vars)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.tasks:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_stack&nbsp;=&nbsp;np.vstack([t.J&nbsp;for&nbsp;t&nbsp;in&nbsp;self.tasks])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_stack&nbsp;=&nbsp;np.zeros((0,&nbsp;n_vars))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;t&nbsp;in&nbsp;self.tasks:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H_t,&nbsp;g_t&nbsp;=&nbsp;t.build_H_g()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;+=&nbsp;H_t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;+=&nbsp;g_t<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.equalities:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_eq&nbsp;=&nbsp;np.vstack([e.A&nbsp;for&nbsp;e&nbsp;in&nbsp;self.equalities])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b_eq&nbsp;=&nbsp;np.concatenate([e.b&nbsp;for&nbsp;e&nbsp;in&nbsp;self.equalities])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_eq&nbsp;=&nbsp;np.zeros((0,&nbsp;n_vars))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b_eq&nbsp;=&nbsp;np.zeros(0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.inequalities:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;=&nbsp;np.vstack([c.C&nbsp;for&nbsp;c&nbsp;in&nbsp;self.inequalities])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;np.concatenate([c.d&nbsp;for&nbsp;c&nbsp;in&nbsp;self.inequalities])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;=&nbsp;np.zeros((0,&nbsp;n_vars))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;np.zeros(0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;H,&nbsp;g,&nbsp;A_eq,&nbsp;b_eq,&nbsp;C,&nbsp;d,&nbsp;J_stack<br>
<br>
<br>
#&nbsp;=========&nbsp;ИЕРАРХИЧЕСКИЙ&nbsp;РЕШАТЕЛЬ&nbsp;===================================<br>
<br>
class&nbsp;HQPSolver:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;n_vars:&nbsp;int):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.n_vars&nbsp;=&nbsp;n_vars<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.levels:&nbsp;List[Level]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_level(self,&nbsp;level:&nbsp;Level):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.levels.append(level)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.levels.sort(key=lambda&nbsp;L:&nbsp;L.priority)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_transform_qp_to_nullspace(H,&nbsp;g,&nbsp;A_eq,&nbsp;b_eq,&nbsp;C,&nbsp;d,&nbsp;x_base,&nbsp;N):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H_z&nbsp;=&nbsp;N.T&nbsp;@&nbsp;H&nbsp;@&nbsp;N<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_z&nbsp;=&nbsp;N.T&nbsp;@&nbsp;(H&nbsp;@&nbsp;x_base&nbsp;+&nbsp;g)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;A_eq.size&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_eq_z&nbsp;=&nbsp;A_eq&nbsp;@&nbsp;N<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b_eq_z&nbsp;=&nbsp;b_eq&nbsp;-&nbsp;A_eq&nbsp;@&nbsp;x_base<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_eq_z&nbsp;=&nbsp;np.zeros((0,&nbsp;N.shape[1]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b_eq_z&nbsp;=&nbsp;np.zeros(0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;C.size&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_z&nbsp;=&nbsp;C&nbsp;@&nbsp;N<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_z&nbsp;=&nbsp;d&nbsp;-&nbsp;C&nbsp;@&nbsp;x_base<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_z&nbsp;=&nbsp;np.zeros((0,&nbsp;N.shape[1]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_z&nbsp;=&nbsp;np.zeros(0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;H_z,&nbsp;g_z,&nbsp;A_eq_z,&nbsp;b_eq_z,&nbsp;C_z,&nbsp;d_z<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;solve(self,&nbsp;x0:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;self.n_vars<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;np.zeros(n)&nbsp;if&nbsp;x0&nbsp;is&nbsp;None&nbsp;else&nbsp;x0.copy()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;=&nbsp;np.eye(n)&nbsp;&nbsp;#&nbsp;Базис&nbsp;допустимых&nbsp;направлений&nbsp;после&nbsp;предыдущих&nbsp;уровней&nbsp;(изначально&nbsp;всё&nbsp;пространство)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;level&nbsp;in&nbsp;self.levels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,&nbsp;g,&nbsp;A_eq,&nbsp;b_eq,&nbsp;C,&nbsp;d,&nbsp;J_stack&nbsp;=&nbsp;level.build_qp(n)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;N.shape[1]&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break&nbsp;&nbsp;#&nbsp;Нет&nbsp;свободных&nbsp;степеней:&nbsp;последующие&nbsp;уровни&nbsp;ничего&nbsp;не&nbsp;добавят<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проецируем&nbsp;текущий&nbsp;QP&nbsp;в&nbsp;координаты&nbsp;z,&nbsp;живущие&nbsp;в&nbsp;столбцовом&nbsp;пространстве&nbsp;N.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H_z,&nbsp;g_z,&nbsp;A_eq_z,&nbsp;b_eq_z,&nbsp;C_z,&nbsp;d_z&nbsp;=&nbsp;self._transform_qp_to_nullspace(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,&nbsp;g,&nbsp;A_eq,&nbsp;b_eq,&nbsp;C,&nbsp;d,&nbsp;x,&nbsp;N<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Решаем&nbsp;QP&nbsp;текущего&nbsp;уровня&nbsp;в&nbsp;координатах&nbsp;z.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;z,&nbsp;lam_eq,&nbsp;lam_ineq,&nbsp;active_set,&nbsp;iters&nbsp;=&nbsp;solve_qp_active_set(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H_z,&nbsp;g_z,&nbsp;A_eq_z,&nbsp;b_eq_z,&nbsp;C_z,&nbsp;d_z,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0=None,&nbsp;active0=None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Возвращаемся&nbsp;в&nbsp;исходное&nbsp;пространство:&nbsp;x&nbsp;←&nbsp;x&nbsp;+&nbsp;N&nbsp;z.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;x&nbsp;+&nbsp;N&nbsp;@&nbsp;z<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grad&nbsp;=&nbsp;H&nbsp;@&nbsp;x&nbsp;+&nbsp;g&nbsp;&nbsp;#&nbsp;Градиент&nbsp;уровня&nbsp;нужен,&nbsp;чтобы&nbsp;закрепить&nbsp;найденное&nbsp;решение&nbsp;при&nbsp;переходе&nbsp;выше.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Формируем&nbsp;совокупный&nbsp;якобиан&nbsp;ограничений&nbsp;текущего&nbsp;уровня,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;действующих&nbsp;внутри&nbsp;текущего&nbsp;nullspace.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_prior_blocks&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;A_eq.size&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_prior_blocks.append(A_eq)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;J_stack.size&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_prior_blocks.append(J_stack)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;np.linalg.norm(grad)&nbsp;&gt;&nbsp;1e-12:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_prior_blocks.append(grad[None,&nbsp;:])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;J_prior_blocks:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_prior&nbsp;=&nbsp;np.vstack(J_prior_blocks)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J_prior&nbsp;=&nbsp;np.zeros((0,&nbsp;n))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;J_prior.size&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;N.shape[1]&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_red&nbsp;=&nbsp;J_prior&nbsp;@&nbsp;N<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Столбцы&nbsp;nullspace_basis_qr(A_red)&nbsp;образуют&nbsp;базис&nbsp;ker(A_red)&nbsp;=&nbsp;V⊥,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;где&nbsp;V&nbsp;=&nbsp;rowspace(A_red)&nbsp;—&nbsp;ограничения&nbsp;текущего&nbsp;уровня&nbsp;внутри&nbsp;подпространства&nbsp;N.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N_red&nbsp;=&nbsp;nullspace_basis_qr(A_red)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Обновляем&nbsp;глобальный&nbsp;базис&nbsp;допустимых&nbsp;направлений:&nbsp;следующий&nbsp;уровень&nbsp;живёт&nbsp;в&nbsp;подпространстве&nbsp;N&nbsp;@&nbsp;N_red.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;=&nbsp;N&nbsp;@&nbsp;N_red<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;x<br>
<!-- END SCAT CODE -->
</body>
</html>
