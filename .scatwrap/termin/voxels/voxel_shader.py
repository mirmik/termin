<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/voxels/voxel_shader.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;Voxel&nbsp;display&nbsp;shaders&nbsp;with&nbsp;slice&nbsp;clipping.&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;termin._native.render&nbsp;import&nbsp;TcShader<br>
<br>
<br>
VOXEL_VERTEX_SHADER&nbsp;=&nbsp;&quot;&quot;&quot;#version&nbsp;330&nbsp;core<br>
<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
layout(location&nbsp;=&nbsp;1)&nbsp;in&nbsp;vec3&nbsp;a_normal;<br>
layout(location&nbsp;=&nbsp;2)&nbsp;in&nbsp;vec2&nbsp;a_uv;<br>
layout(location&nbsp;=&nbsp;5)&nbsp;in&nbsp;vec3&nbsp;a_color;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
<br>
out&nbsp;vec3&nbsp;v_world_pos;<br>
out&nbsp;vec3&nbsp;v_normal;<br>
out&nbsp;vec2&nbsp;v_uv;<br>
out&nbsp;vec3&nbsp;v_color;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;world&nbsp;=&nbsp;u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;world.xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_normal&nbsp;=&nbsp;mat3(transpose(inverse(u_model)))&nbsp;*&nbsp;a_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_uv&nbsp;=&nbsp;a_uv;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_color&nbsp;=&nbsp;a_color;<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view&nbsp;*&nbsp;world;<br>
}<br>
&quot;&quot;&quot;<br>
<br>
VOXEL_FRAGMENT_SHADER&nbsp;=&nbsp;&quot;&quot;&quot;#version&nbsp;330&nbsp;core<br>
<br>
in&nbsp;vec3&nbsp;v_world_pos;<br>
in&nbsp;vec3&nbsp;v_normal;<br>
in&nbsp;vec2&nbsp;v_uv;<br>
in&nbsp;vec3&nbsp;v_color;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
uniform&nbsp;vec4&nbsp;u_color_below;<br>
uniform&nbsp;vec4&nbsp;u_color_above;<br>
uniform&nbsp;vec3&nbsp;u_slice_axis;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;slice&nbsp;axis&nbsp;in&nbsp;entity&nbsp;local&nbsp;space<br>
uniform&nbsp;float&nbsp;u_fill_percent;&nbsp;&nbsp;&nbsp;//&nbsp;0.0&nbsp;-&nbsp;1.0<br>
uniform&nbsp;vec3&nbsp;u_bounds_min;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;bounds&nbsp;in&nbsp;mesh&nbsp;space&nbsp;(before&nbsp;model&nbsp;transform)<br>
uniform&nbsp;vec3&nbsp;u_bounds_max;<br>
<br>
out&nbsp;vec4&nbsp;FragColor;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Transform&nbsp;everything&nbsp;to&nbsp;world&nbsp;space<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;world_bounds_min&nbsp;=&nbsp;(u_model&nbsp;*&nbsp;vec4(u_bounds_min,&nbsp;1.0)).xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;world_bounds_max&nbsp;=&nbsp;(u_model&nbsp;*&nbsp;vec4(u_bounds_max,&nbsp;1.0)).xyz;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;world_slice_axis&nbsp;=&nbsp;normalize(mat3(u_model)&nbsp;*&nbsp;u_slice_axis);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Project&nbsp;bounds&nbsp;onto&nbsp;slice&nbsp;axis<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;axis_min&nbsp;=&nbsp;dot(world_bounds_min,&nbsp;world_slice_axis);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;axis_max&nbsp;=&nbsp;dot(world_bounds_max,&nbsp;world_slice_axis);<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;axis_range&nbsp;=&nbsp;axis_max&nbsp;-&nbsp;axis_min;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Project&nbsp;current&nbsp;world&nbsp;position&nbsp;onto&nbsp;slice&nbsp;axis<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;pos_on_axis&nbsp;=&nbsp;dot(v_world_pos,&nbsp;world_slice_axis);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Normalize&nbsp;position&nbsp;to&nbsp;0-1&nbsp;range&nbsp;along&nbsp;axis<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;normalized_pos&nbsp;=&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(axis_range&nbsp;&gt;&nbsp;0.0001)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normalized_pos&nbsp;=&nbsp;(pos_on_axis&nbsp;-&nbsp;axis_min)&nbsp;/&nbsp;axis_range;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;blend_zone&nbsp;is&nbsp;ABOVE&nbsp;fill_percent<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;fill&nbsp;100%:&nbsp;blend&nbsp;100-105%&nbsp;(doesn't&nbsp;exist),&nbsp;entire&nbsp;object&nbsp;is&nbsp;color_below<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;fill&nbsp;90%:&nbsp;discard&nbsp;&gt;&nbsp;95%,&nbsp;blend&nbsp;90-95%,&nbsp;below&nbsp;90%&nbsp;is&nbsp;color_below<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;fill&nbsp;50%:&nbsp;discard&nbsp;&gt;&nbsp;55%,&nbsp;blend&nbsp;50-55%,&nbsp;below&nbsp;50%&nbsp;is&nbsp;color_below<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;blend_zone&nbsp;=&nbsp;0.05;<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;cut_threshold&nbsp;=&nbsp;u_fill_percent&nbsp;+&nbsp;blend_zone;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Discard&nbsp;fragments&nbsp;above&nbsp;cut&nbsp;threshold<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(normalized_pos&nbsp;&gt;&nbsp;cut_threshold)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discard;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Select&nbsp;base&nbsp;color&nbsp;based&nbsp;on&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;UV.x&nbsp;&gt;=&nbsp;2.0&nbsp;means&nbsp;use&nbsp;vertex&nbsp;color&nbsp;instead&nbsp;of&nbsp;uniform<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec4&nbsp;base_color;<br>
&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;use_vertex_color&nbsp;=&nbsp;(v_uv.x&nbsp;&gt;=&nbsp;1.5);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(use_vertex_color)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color&nbsp;=&nbsp;vec4(v_color,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(normalized_pos&nbsp;&gt;&nbsp;u_fill_percent)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;In&nbsp;blend&nbsp;zone<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;t&nbsp;=&nbsp;(normalized_pos&nbsp;-&nbsp;u_fill_percent)&nbsp;/&nbsp;blend_zone;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color&nbsp;=&nbsp;mix(u_color_below,&nbsp;u_color_above,&nbsp;t);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Below&nbsp;fill&nbsp;percent<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_color&nbsp;=&nbsp;u_color_below;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Simple&nbsp;Lambert&nbsp;diffuse&nbsp;lighting<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;N&nbsp;=&nbsp;normalize(v_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;light_dir&nbsp;=&nbsp;normalize(vec3(0.5,&nbsp;0.8,&nbsp;1.0));<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;ndotl&nbsp;=&nbsp;max(dot(N,&nbsp;light_dir),&nbsp;0.0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;ambient&nbsp;=&nbsp;vec3(0.4);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;diffuse&nbsp;=&nbsp;base_color.rgb&nbsp;*&nbsp;(ambient&nbsp;+&nbsp;ndotl&nbsp;*&nbsp;0.6);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;FragColor&nbsp;=&nbsp;vec4(diffuse,&nbsp;base_color.a);<br>
}<br>
&quot;&quot;&quot;<br>
<br>
<br>
def&nbsp;voxel_display_shader()&nbsp;-&gt;&nbsp;TcShader:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Creates&nbsp;shader&nbsp;for&nbsp;voxel&nbsp;display&nbsp;with&nbsp;slice&nbsp;clipping.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TcShader.from_sources(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VOXEL_VERTEX_SHADER,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VOXEL_FRAGMENT_SHADER,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VoxelDisplay&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<!-- END SCAT CODE -->
</body>
</html>
