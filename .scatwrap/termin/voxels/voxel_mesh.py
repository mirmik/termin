<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/voxels/voxel_mesh.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
Функции&nbsp;для&nbsp;создания&nbsp;мешей&nbsp;с&nbsp;vertex&nbsp;colors&nbsp;для&nbsp;отображения&nbsp;вокселей.<br>
<br>
Использует&nbsp;TcMesh&nbsp;и&nbsp;tc_mesh&nbsp;registry.<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.mesh._mesh_native&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;TcMesh,<br>
&nbsp;&nbsp;&nbsp;&nbsp;TcVertexLayout,<br>
&nbsp;&nbsp;&nbsp;&nbsp;TcAttribType,<br>
)<br>
<br>
<br>
#&nbsp;Cached&nbsp;layout&nbsp;for&nbsp;voxel&nbsp;meshes<br>
_voxel_layout:&nbsp;TcVertexLayout&nbsp;|&nbsp;None&nbsp;=&nbsp;None<br>
<br>
<br>
def&nbsp;_get_voxel_layout()&nbsp;-&gt;&nbsp;TcVertexLayout:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Get&nbsp;or&nbsp;create&nbsp;the&nbsp;tc_vertex_layout&nbsp;for&nbsp;voxel&nbsp;meshes.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Layout:&nbsp;position(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;color(3)&nbsp;=&nbsp;11&nbsp;floats&nbsp;=&nbsp;44&nbsp;bytes.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;_voxel_layout<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_voxel_layout&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;TcVertexLayout()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Standard&nbsp;locations:&nbsp;0=position,&nbsp;1=normal,&nbsp;2=uv,&nbsp;5=color<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.add(&quot;position&quot;,&nbsp;3,&nbsp;TcAttribType.FLOAT32,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.add(&quot;normal&quot;,&nbsp;3,&nbsp;TcAttribType.FLOAT32,&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.add(&quot;uv&quot;,&nbsp;2,&nbsp;TcAttribType.FLOAT32,&nbsp;2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.add(&quot;color&quot;,&nbsp;3,&nbsp;TcAttribType.FLOAT32,&nbsp;5)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_voxel_layout&nbsp;=&nbsp;layout<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;_voxel_layout<br>
<br>
<br>
def&nbsp;create_voxel_mesh(<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;uvs:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertex_colors:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;vertex_normals:&nbsp;np.ndarray&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str&nbsp;=&nbsp;&quot;voxel_mesh&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;uuid:&nbsp;str&nbsp;=&nbsp;&quot;&quot;,<br>
)&nbsp;-&gt;&nbsp;TcMesh:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;a&nbsp;TcMesh&nbsp;with&nbsp;vertex&nbsp;colors&nbsp;for&nbsp;voxel&nbsp;display.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Layout:&nbsp;position(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;color(3)&nbsp;=&nbsp;11&nbsp;floats&nbsp;per&nbsp;vertex.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices:&nbsp;Nx3&nbsp;array&nbsp;of&nbsp;vertex&nbsp;positions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles:&nbsp;Mx3&nbsp;array&nbsp;of&nbsp;triangle&nbsp;indices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs:&nbsp;Nx2&nbsp;array&nbsp;of&nbsp;UV&nbsp;coordinates&nbsp;(optional,&nbsp;defaults&nbsp;to&nbsp;zeros)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_colors:&nbsp;Nx3&nbsp;array&nbsp;of&nbsp;RGB&nbsp;colors&nbsp;(optional,&nbsp;defaults&nbsp;to&nbsp;white)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_normals:&nbsp;Nx3&nbsp;array&nbsp;of&nbsp;normals&nbsp;(optional,&nbsp;defaults&nbsp;to&nbsp;zeros)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;Mesh&nbsp;name&nbsp;for&nbsp;debugging<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TcMesh&nbsp;registered&nbsp;in&nbsp;tc_mesh&nbsp;registry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Convert&nbsp;inputs&nbsp;to&nbsp;proper&nbsp;arrays<br>
&nbsp;&nbsp;&nbsp;&nbsp;verts&nbsp;=&nbsp;np.asarray(vertices,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;tris&nbsp;=&nbsp;np.asarray(triangles,&nbsp;dtype=np.uint32).flatten()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;num_verts&nbsp;=&nbsp;verts.shape[0]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Prepare&nbsp;optional&nbsp;arrays<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;uvs&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs_arr&nbsp;=&nbsp;np.asarray(uvs,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs_arr&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;2),&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;vertex_colors&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colors_arr&nbsp;=&nbsp;np.asarray(vertex_colors,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colors_arr&nbsp;=&nbsp;np.ones((num_verts,&nbsp;3),&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;vertex_normals&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals_arr&nbsp;=&nbsp;np.asarray(vertex_normals,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals_arr&nbsp;=&nbsp;np.zeros((num_verts,&nbsp;3),&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Build&nbsp;interleaved&nbsp;buffer:&nbsp;pos(3)&nbsp;+&nbsp;normal(3)&nbsp;+&nbsp;uv(2)&nbsp;+&nbsp;color(3)&nbsp;=&nbsp;11&nbsp;floats<br>
&nbsp;&nbsp;&nbsp;&nbsp;interleaved&nbsp;=&nbsp;np.hstack([verts,&nbsp;normals_arr,&nbsp;uvs_arr,&nbsp;colors_arr]).astype(np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;layout&nbsp;=&nbsp;_get_voxel_layout()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TcMesh.from_interleaved(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interleaved.flatten(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_verts,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tris,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uuid,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<!-- END SCAT CODE -->
</body>
</html>
