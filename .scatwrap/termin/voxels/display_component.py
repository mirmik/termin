<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/voxels/display_component.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
VoxelDisplayComponent&nbsp;—&nbsp;компонент&nbsp;для&nbsp;отображения&nbsp;воксельной&nbsp;сетки.<br>
<br>
Реализует&nbsp;протокол&nbsp;Drawable&nbsp;и&nbsp;рендерит&nbsp;воксели&nbsp;напрямую.<br>
Выбирает&nbsp;сетку&nbsp;из&nbsp;ResourceManager&nbsp;через&nbsp;комбобокс.<br>
Использует&nbsp;VoxelGridHandle&nbsp;для&nbsp;поддержки&nbsp;hot-reload.<br>
Отсечка&nbsp;по&nbsp;оси&nbsp;выполняется&nbsp;в&nbsp;шейдере&nbsp;для&nbsp;производительности.<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;TYPE_CHECKING,&nbsp;List,&nbsp;Optional,&nbsp;Set,&nbsp;Tuple<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.visualization.core.python_component&nbsp;import&nbsp;PythonComponent<br>
from&nbsp;termin.visualization.core.material&nbsp;import&nbsp;Material<br>
from&nbsp;termin.visualization.core.voxel_grid_handle&nbsp;import&nbsp;VoxelGridHandle<br>
from&nbsp;termin.visualization.render.drawable&nbsp;import&nbsp;GeometryDrawCall<br>
from&nbsp;termin.voxels.voxel_mesh&nbsp;import&nbsp;create_voxel_mesh<br>
from&nbsp;termin.mesh._mesh_native&nbsp;import&nbsp;TcMesh<br>
from&nbsp;termin.editor.inspect_field&nbsp;import&nbsp;InspectField<br>
from&nbsp;termin._native&nbsp;import&nbsp;log<br>
<br>
if&nbsp;TYPE_CHECKING:<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.core.scene&nbsp;import&nbsp;Scene<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.render_context&nbsp;import&nbsp;RenderContext<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.voxels.grid&nbsp;import&nbsp;VoxelGrid<br>
<br>
<br>
#&nbsp;Вершины&nbsp;единичного&nbsp;куба&nbsp;(центрирован&nbsp;в&nbsp;origin)<br>
_CUBE_VERTICES&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Front&nbsp;face<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;-0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;-0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;&nbsp;0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;&nbsp;0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Back&nbsp;face<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;-0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;&nbsp;0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;&nbsp;0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;-0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Top&nbsp;face<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;&nbsp;0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;&nbsp;0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;&nbsp;0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;&nbsp;0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Bottom&nbsp;face<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;-0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;-0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;-0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;-0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Right&nbsp;face<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;-0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;&nbsp;0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;&nbsp;0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;0.5,&nbsp;-0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Left&nbsp;face<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;-0.5,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;-0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;&nbsp;0.5,&nbsp;&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;&nbsp;0.5,&nbsp;-0.5],<br>
],&nbsp;dtype=np.float32)<br>
<br>
_CUBE_TRIANGLES&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;1,&nbsp;2],&nbsp;[0,&nbsp;2,&nbsp;3],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;front<br>
&nbsp;&nbsp;&nbsp;&nbsp;[4,&nbsp;5,&nbsp;6],&nbsp;[4,&nbsp;6,&nbsp;7],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;back<br>
&nbsp;&nbsp;&nbsp;&nbsp;[8,&nbsp;9,&nbsp;10],&nbsp;[8,&nbsp;10,&nbsp;11],&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;top<br>
&nbsp;&nbsp;&nbsp;&nbsp;[12,&nbsp;13,&nbsp;14],&nbsp;[12,&nbsp;14,&nbsp;15],&nbsp;#&nbsp;bottom<br>
&nbsp;&nbsp;&nbsp;&nbsp;[16,&nbsp;17,&nbsp;18],&nbsp;[16,&nbsp;18,&nbsp;19],&nbsp;#&nbsp;right<br>
&nbsp;&nbsp;&nbsp;&nbsp;[20,&nbsp;21,&nbsp;22],&nbsp;[20,&nbsp;22,&nbsp;23],&nbsp;#&nbsp;left<br>
],&nbsp;dtype=np.int32)<br>
<br>
_CUBE_NORMALS&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Front<br>
&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;0,&nbsp;1],&nbsp;[0,&nbsp;0,&nbsp;1],&nbsp;[0,&nbsp;0,&nbsp;1],&nbsp;[0,&nbsp;0,&nbsp;1],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Back<br>
&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;0,&nbsp;-1],&nbsp;[0,&nbsp;0,&nbsp;-1],&nbsp;[0,&nbsp;0,&nbsp;-1],&nbsp;[0,&nbsp;0,&nbsp;-1],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Top<br>
&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;1,&nbsp;0],&nbsp;[0,&nbsp;1,&nbsp;0],&nbsp;[0,&nbsp;1,&nbsp;0],&nbsp;[0,&nbsp;1,&nbsp;0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Bottom<br>
&nbsp;&nbsp;&nbsp;&nbsp;[0,&nbsp;-1,&nbsp;0],&nbsp;[0,&nbsp;-1,&nbsp;0],&nbsp;[0,&nbsp;-1,&nbsp;0],&nbsp;[0,&nbsp;-1,&nbsp;0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Right<br>
&nbsp;&nbsp;&nbsp;&nbsp;[1,&nbsp;0,&nbsp;0],&nbsp;[1,&nbsp;0,&nbsp;0],&nbsp;[1,&nbsp;0,&nbsp;0],&nbsp;[1,&nbsp;0,&nbsp;0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Left<br>
&nbsp;&nbsp;&nbsp;&nbsp;[-1,&nbsp;0,&nbsp;0],&nbsp;[-1,&nbsp;0,&nbsp;0],&nbsp;[-1,&nbsp;0,&nbsp;0],&nbsp;[-1,&nbsp;0,&nbsp;0],<br>
],&nbsp;dtype=np.float32)<br>
<br>
VERTS_PER_CUBE&nbsp;=&nbsp;24<br>
TRIS_PER_CUBE&nbsp;=&nbsp;12<br>
CUBE_SCALE&nbsp;=&nbsp;0.85&nbsp;&nbsp;#&nbsp;Размер&nbsp;кубика&nbsp;относительно&nbsp;ячейки<br>
MAX_VOXELS&nbsp;=&nbsp;100_000<br>
<br>
<br>
class&nbsp;VoxelDisplayComponent(PythonComponent):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Компонент&nbsp;для&nbsp;отображения&nbsp;воксельной&nbsp;сетки&nbsp;из&nbsp;ResourceManager.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Реализует&nbsp;протокол&nbsp;Drawable&nbsp;—&nbsp;рендерит&nbsp;воксели&nbsp;напрямую&nbsp;без&nbsp;MeshRenderer.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Выбирает&nbsp;сетку&nbsp;через&nbsp;комбобокс&nbsp;из&nbsp;зарегистрированных&nbsp;в&nbsp;ResourceManager.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Использует&nbsp;VoxelGridHandle&nbsp;для&nbsp;поддержки&nbsp;hot-reload.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Отсечка&nbsp;и&nbsp;заливка&nbsp;цветом&nbsp;выполняются&nbsp;в&nbsp;шейдере.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_drawable&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;inspect_fields&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;voxel_grid&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;voxel_grid&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Voxel&nbsp;Grid&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;voxel_grid_handle&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;color_below&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;color_below&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Color&nbsp;Below&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;color&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter=lambda&nbsp;obj,&nbsp;val:&nbsp;obj._set_color_below(val),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;color_above&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;color_above&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Color&nbsp;Above&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;color&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter=lambda&nbsp;obj,&nbsp;val:&nbsp;obj._set_color_above(val),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;fill_percent&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;fill_percent&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Fill&nbsp;%&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;slider&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min=0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max=100,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter=lambda&nbsp;obj,&nbsp;val:&nbsp;obj._set_fill_percent(val),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;slice_axis&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;slice_axis&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Slice&nbsp;Axis&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;vec3&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter=lambda&nbsp;obj,&nbsp;val:&nbsp;obj._set_slice_axis(val),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;color_surface&quot;:&nbsp;InspectField(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path=&quot;color_surface&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label=&quot;Color&nbsp;Surface&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind=&quot;color&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setter=lambda&nbsp;obj,&nbsp;val:&nbsp;obj._set_color_surface(val),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;voxel_grid_name:&nbsp;str&nbsp;=&nbsp;&quot;&quot;,&nbsp;grid_name:&nbsp;str&nbsp;=&nbsp;&quot;&quot;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;grid_name&nbsp;is&nbsp;the&nbsp;canonical&nbsp;name,&nbsp;voxel_grid_name&nbsp;is&nbsp;deprecated&nbsp;alias<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_grid_name&nbsp;=&nbsp;grid_name&nbsp;or&nbsp;voxel_grid_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.voxel_grid:&nbsp;VoxelGridHandle&nbsp;=&nbsp;VoxelGridHandle()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._last_version:&nbsp;int&nbsp;=&nbsp;-1&nbsp;&nbsp;#&nbsp;Версия&nbsp;handle&nbsp;для&nbsp;отслеживания&nbsp;hot-reload<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_mesh:&nbsp;Optional[TcMesh]&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._material:&nbsp;Optional[Material]&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._needs_rebuild&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.active_in_editor&nbsp;=&nbsp;True&nbsp;&nbsp;#&nbsp;Enable&nbsp;update()&nbsp;in&nbsp;editor&nbsp;mode<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Цвета&nbsp;с&nbsp;альфа-каналом&nbsp;(RGBA)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.color_below:&nbsp;Tuple[float,&nbsp;float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(0.2,&nbsp;0.6,&nbsp;1.0,&nbsp;0.8)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.color_above:&nbsp;Tuple[float,&nbsp;float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(1.0,&nbsp;0.3,&nbsp;0.2,&nbsp;0.8)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.color_surface:&nbsp;Tuple[float,&nbsp;float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(0.2,&nbsp;1.0,&nbsp;0.3,&nbsp;0.9)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Процент&nbsp;заполнения&nbsp;(0-100),&nbsp;100&nbsp;=&nbsp;вся&nbsp;сетка<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.fill_percent:&nbsp;float&nbsp;=&nbsp;100.0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ось&nbsp;отсечки&nbsp;(нормализованный&nbsp;вектор),&nbsp;по&nbsp;умолчанию&nbsp;Z&nbsp;вверх<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.slice_axis:&nbsp;Tuple[float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(0.0,&nbsp;0.0,&nbsp;1.0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Границы&nbsp;сетки&nbsp;в&nbsp;мировых&nbsp;координатах&nbsp;(вычисляются&nbsp;при&nbsp;построении&nbsp;меша)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._bounds_min:&nbsp;np.ndarray&nbsp;=&nbsp;np.zeros(3,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._bounds_max:&nbsp;np.ndarray&nbsp;=&nbsp;np.zeros(3,&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;grid_name(self)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Name&nbsp;of&nbsp;the&nbsp;voxel&nbsp;grid.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._voxel_grid_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@grid_name.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;grid_name(self,&nbsp;value:&nbsp;str)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_grid_name&nbsp;=&nbsp;value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;value:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.set_voxel_grid_by_name(value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_set_color_below(self,&nbsp;value:&nbsp;Tuple[float,&nbsp;float,&nbsp;float,&nbsp;float])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;цвет&nbsp;ниже&nbsp;порога.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.color_below&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_set_color_above(self,&nbsp;value:&nbsp;Tuple[float,&nbsp;float,&nbsp;float,&nbsp;float])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;цвет&nbsp;выше&nbsp;порога.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.color_above&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_set_color_surface(self,&nbsp;value:&nbsp;Tuple[float,&nbsp;float,&nbsp;float,&nbsp;float])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;цвет&nbsp;поверхностных&nbsp;вокселей.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.color_surface&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_set_fill_percent(self,&nbsp;value:&nbsp;float)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;процент&nbsp;заполнения.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.fill_percent&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_set_slice_axis(self,&nbsp;value:&nbsp;Tuple[float,&nbsp;float,&nbsp;float])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;ось&nbsp;отсечки.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.slice_axis&nbsp;=&nbsp;tuple(value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_get_or_create_material(self)&nbsp;-&gt;&nbsp;Material:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;материал&nbsp;с&nbsp;voxel&nbsp;шейдером.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._material&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.voxels.voxel_shader&nbsp;import&nbsp;voxel_display_shader<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.visualization.render.renderpass&nbsp;import&nbsp;RenderState<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;voxel_display_shader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._material&nbsp;=&nbsp;Material(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader=shader,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color=self.color_below,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase_mark=&quot;transparent&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;render_state=RenderState(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_test=True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depth_write=True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blend=True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cull=True,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._material<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_voxel_grid_by_name(self,&nbsp;name:&nbsp;str)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;воксельную&nbsp;сетку&nbsp;по&nbsp;имени&nbsp;из&nbsp;ResourceManager.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;name:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.voxel_grid&nbsp;=&nbsp;VoxelGridHandle.from_name(name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_grid_name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.voxel_grid&nbsp;=&nbsp;VoxelGridHandle()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_grid_name&nbsp;=&nbsp;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._needs_rebuild&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Drawable&nbsp;protocol&nbsp;---<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;phase_marks(self)&nbsp;-&gt;&nbsp;Set[str]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Фазы&nbsp;рендеринга.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mat&nbsp;=&nbsp;self._get_or_create_material()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{p.phase_mark&nbsp;for&nbsp;p&nbsp;in&nbsp;mat.phases}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;draw_geometry(self,&nbsp;context:&nbsp;&quot;RenderContext&quot;,&nbsp;geometry_id:&nbsp;int&nbsp;=&nbsp;0)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Рисует&nbsp;геометрию&nbsp;вокселей.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;geometry_id&nbsp;игнорируется&nbsp;—&nbsp;у&nbsp;VoxelDisplayComponent&nbsp;одна&nbsp;геометрия<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем&nbsp;hot-reload&nbsp;перед&nbsp;отрисовкой<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._check_hot_reload()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._voxel_mesh&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;self._voxel_mesh.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_mesh.draw_gpu()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_check_hot_reload(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Проверяет,&nbsp;изменился&nbsp;ли&nbsp;grid&nbsp;в&nbsp;keeper&nbsp;(hot-reload).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_version&nbsp;=&nbsp;self.voxel_grid.version<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;current_version&nbsp;!=&nbsp;self._last_version:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._last_version&nbsp;=&nbsp;current_version<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Defer&nbsp;rebuild&nbsp;to&nbsp;update()&nbsp;-&nbsp;don't&nbsp;rebuild&nbsp;during&nbsp;rendering<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._needs_rebuild&nbsp;=&nbsp;True<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_DEBUG_GET_PHASES&nbsp;=&nbsp;False&nbsp;&nbsp;#&nbsp;Debug:&nbsp;отладка&nbsp;get_geometry_draws<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_geometry_draws(self,&nbsp;phase_mark:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None)&nbsp;-&gt;&nbsp;List[GeometryDrawCall]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Возвращает&nbsp;GeometryDrawCalls&nbsp;для&nbsp;рендеринга.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mat&nbsp;=&nbsp;self._get_or_create_material()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;phase_mark&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phases&nbsp;=&nbsp;list(mat.phases)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phases&nbsp;=&nbsp;[p&nbsp;for&nbsp;p&nbsp;in&nbsp;mat.phases&nbsp;if&nbsp;p.phase_mark&nbsp;==&nbsp;phase_mark]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Обновляем&nbsp;uniforms&nbsp;перед&nbsp;возвратом&nbsp;фаз<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(ColorPass&nbsp;вызовет&nbsp;phase.apply()&nbsp;который&nbsp;загрузит&nbsp;их&nbsp;в&nbsp;GPU)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ВАЖНО:&nbsp;используем&nbsp;set_param,&nbsp;т.к.&nbsp;phase.uniforms&nbsp;возвращает&nbsp;копию&nbsp;dict<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color_below_arr&nbsp;=&nbsp;np.array(self.color_below,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color_above_arr&nbsp;=&nbsp;np.array(self.color_above,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slice_axis_arr&nbsp;=&nbsp;np.array(self.slice_axis,&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;phase&nbsp;in&nbsp;phases:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_param(&quot;u_color_below&quot;,&nbsp;color_below_arr)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_param(&quot;u_color_above&quot;,&nbsp;color_above_arr)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_param(&quot;u_slice_axis&quot;,&nbsp;slice_axis_arr)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_param(&quot;u_fill_percent&quot;,&nbsp;self.fill_percent&nbsp;/&nbsp;100.0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_param(&quot;u_bounds_min&quot;,&nbsp;self._bounds_min)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase.set_param(&quot;u_bounds_max&quot;,&nbsp;self._bounds_max)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phases.sort(key=lambda&nbsp;p:&nbsp;p.priority)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[GeometryDrawCall(phase=p)&nbsp;for&nbsp;p&nbsp;in&nbsp;phases]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Построение&nbsp;меша&nbsp;---<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_compute_mesh_uuid(self)&nbsp;-&gt;&nbsp;str&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Compute&nbsp;deterministic&nbsp;UUID&nbsp;based&nbsp;on&nbsp;asset&nbsp;path&nbsp;and&nbsp;version.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;hashlib<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asset&nbsp;=&nbsp;self.voxel_grid.asset<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;asset&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;asset.source_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version&nbsp;=&nbsp;asset.version<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;path&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key&nbsp;=&nbsp;f&quot;voxel_display:{path.as_posix()}:v{version}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hashlib.sha256(key.encode()).hexdigest()[:32]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;_rebuild_mesh(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Перестроить&nbsp;меш&nbsp;из&nbsp;воксельной&nbsp;сетки&nbsp;(без&nbsp;фильтрации,&nbsp;вся&nbsp;сетка).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Очищаем&nbsp;старый&nbsp;меш<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_mesh&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grid&nbsp;=&nbsp;self.voxel_grid.get_grid()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;grid&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;voxel_count&nbsp;=&nbsp;grid.voxel_count<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;voxel_count&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Собираем&nbsp;все&nbsp;воксели&nbsp;и&nbsp;вычисляем&nbsp;bounds<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all_voxels:&nbsp;list[tuple[int,&nbsp;int,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_world&nbsp;=&nbsp;np.array([float('inf'),&nbsp;float('inf'),&nbsp;float('inf')],&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_world&nbsp;=&nbsp;np.array([float('-inf'),&nbsp;float('-inf'),&nbsp;float('-inf')],&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;vx,&nbsp;vy,&nbsp;vz,&nbsp;vtype&nbsp;in&nbsp;grid.iter_non_empty():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all_voxels.append((vx,&nbsp;vy,&nbsp;vz,&nbsp;vtype))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;center&nbsp;=&nbsp;grid.voxel_to_world(vx,&nbsp;vy,&nbsp;vz)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_world&nbsp;=&nbsp;np.minimum(min_world,&nbsp;center)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_world&nbsp;=&nbsp;np.maximum(max_world,&nbsp;center)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;all_voxels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Расширяем&nbsp;bounds&nbsp;на&nbsp;половину&nbsp;размера&nbsp;куба<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;half_cell&nbsp;=&nbsp;grid.cell_size&nbsp;*&nbsp;CUBE_SCALE&nbsp;*&nbsp;0.5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._bounds_min&nbsp;=&nbsp;min_world&nbsp;-&nbsp;half_cell<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._bounds_max&nbsp;=&nbsp;max_world&nbsp;+&nbsp;half_cell<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Try&nbsp;to&nbsp;get&nbsp;cached&nbsp;mesh&nbsp;by&nbsp;deterministic&nbsp;UUID<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh_uuid&nbsp;=&nbsp;self._compute_mesh_uuid()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh_uuid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cached&nbsp;=&nbsp;TcMesh.from_uuid(mesh_uuid)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cached&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;cached.is_valid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_mesh&nbsp;=&nbsp;cached<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ограничение&nbsp;для&nbsp;производительности<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_count&nbsp;=&nbsp;len(all_voxels)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;display_count&nbsp;&gt;&nbsp;MAX_VOXELS:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;VoxelDisplayComponent:&nbsp;too&nbsp;many&nbsp;voxels&nbsp;({display_count}),&nbsp;showing&nbsp;first&nbsp;{MAX_VOXELS}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all_voxels&nbsp;=&nbsp;all_voxels[:MAX_VOXELS]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_count&nbsp;=&nbsp;MAX_VOXELS<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Выделяем&nbsp;массивы<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices&nbsp;=&nbsp;np.zeros((display_count&nbsp;*&nbsp;VERTS_PER_CUBE,&nbsp;3),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles&nbsp;=&nbsp;np.zeros((display_count&nbsp;*&nbsp;TRIS_PER_CUBE,&nbsp;3),&nbsp;dtype=np.int32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;np.zeros((display_count&nbsp;*&nbsp;VERTS_PER_CUBE,&nbsp;3),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs&nbsp;=&nbsp;np.zeros((display_count&nbsp;*&nbsp;VERTS_PER_CUBE,&nbsp;2),&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colors&nbsp;=&nbsp;np.ones((display_count&nbsp;*&nbsp;VERTS_PER_CUBE,&nbsp;3),&nbsp;dtype=np.float32)&nbsp;&nbsp;#&nbsp;default&nbsp;white<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Получаем&nbsp;карту&nbsp;нормалей<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;surface_normals&nbsp;=&nbsp;grid.surface_normals<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cell_size&nbsp;=&nbsp;grid.cell_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;vx,&nbsp;vy,&nbsp;vz,&nbsp;vtype&nbsp;in&nbsp;all_voxels:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Позиция&nbsp;центра&nbsp;вокселя<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;center&nbsp;=&nbsp;grid.voxel_to_world(vx,&nbsp;vy,&nbsp;vz)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Смещаем&nbsp;и&nbsp;масштабируем&nbsp;вершины&nbsp;куба<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v_start&nbsp;=&nbsp;idx&nbsp;*&nbsp;VERTS_PER_CUBE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v_end&nbsp;=&nbsp;v_start&nbsp;+&nbsp;VERTS_PER_CUBE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices[v_start:v_end]&nbsp;=&nbsp;_CUBE_VERTICES&nbsp;*&nbsp;(cell_size&nbsp;*&nbsp;CUBE_SCALE)&nbsp;+&nbsp;center<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals[v_start:v_end]&nbsp;=&nbsp;_CUBE_NORMALS<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs[v_start:v_end,&nbsp;0]&nbsp;=&nbsp;float(vtype)&nbsp;&nbsp;#&nbsp;UV.x&nbsp;=&nbsp;тип&nbsp;вокселя<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;есть&nbsp;нормали&nbsp;для&nbsp;этого&nbsp;вокселя&nbsp;—&nbsp;кодируем&nbsp;первую&nbsp;в&nbsp;цвет<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals_list&nbsp;=&nbsp;surface_normals.get((vx,&nbsp;vy,&nbsp;vz))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normals_list&nbsp;and&nbsp;len(normals_list)&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Берём&nbsp;первую&nbsp;нормаль&nbsp;и&nbsp;кодируем&nbsp;как&nbsp;RGB:&nbsp;[-1,1]&nbsp;-&gt;&nbsp;[0,1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_normal&nbsp;=&nbsp;normals_list[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encoded_color&nbsp;=&nbsp;(first_normal&nbsp;+&nbsp;1.0)&nbsp;*&nbsp;0.5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colors[v_start:v_end]&nbsp;=&nbsp;encoded_color<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Смещаем&nbsp;индексы&nbsp;треугольников<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_start&nbsp;=&nbsp;idx&nbsp;*&nbsp;TRIS_PER_CUBE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_end&nbsp;=&nbsp;t_start&nbsp;+&nbsp;TRIS_PER_CUBE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles[t_start:t_end]&nbsp;=&nbsp;_CUBE_TRIANGLES&nbsp;+&nbsp;v_start<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_mesh&nbsp;=&nbsp;create_voxel_mesh(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertices=vertices,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;triangles=triangles,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uvs=uvs,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_colors=colors,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vertex_normals=normals,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;voxel_display_mesh&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uuid=mesh_uuid&nbsp;or&nbsp;&quot;&quot;,&nbsp;&nbsp;#&nbsp;Use&nbsp;deterministic&nbsp;UUID&nbsp;for&nbsp;caching<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;Lifecycle&nbsp;---<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_added(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;При&nbsp;добавлении&nbsp;загрузить&nbsp;сетку&nbsp;и&nbsp;построить&nbsp;меш.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;есть&nbsp;сохранённое&nbsp;имя&nbsp;сетки,&nbsp;загружаем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._voxel_grid_name&nbsp;and&nbsp;self.voxel_grid.get_grid()&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.set_voxel_grid_by_name(self._voxel_grid_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._needs_rebuild:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._rebuild_mesh()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._needs_rebuild&nbsp;=&nbsp;False<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;on_removed(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Очистить&nbsp;меш&nbsp;при&nbsp;удалении.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.destroy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;destroy(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Release&nbsp;all&nbsp;resources.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._voxel_mesh&nbsp;=&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._material&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;update(self,&nbsp;dt:&nbsp;float)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Обновить&nbsp;меш&nbsp;если&nbsp;нужно.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._needs_rebuild:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._rebuild_mesh()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Request&nbsp;render&nbsp;update&nbsp;after&nbsp;mesh&nbsp;rebuild<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.editor.render_request&nbsp;import&nbsp;request_render_update<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request_render_update()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.error(f&quot;[VoxelDisplayComponent.update]&nbsp;error&nbsp;rebuilding&nbsp;mesh:&nbsp;{e}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._needs_rebuild&nbsp;=&nbsp;False<br>
<br>
<!-- END SCAT CODE -->
</body>
</html>
