<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/voxels/grid.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
&quot;&quot;&quot;<br>
VoxelGrid&nbsp;—&nbsp;контейнер&nbsp;чанков&nbsp;с&nbsp;мировыми&nbsp;координатами.<br>
&quot;&quot;&quot;<br>
<br>
from&nbsp;__future__&nbsp;import&nbsp;annotations<br>
<br>
from&nbsp;typing&nbsp;import&nbsp;Iterator,&nbsp;Optional<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.voxels.chunk&nbsp;import&nbsp;VoxelChunk,&nbsp;CHUNK_SIZE<br>
<br>
<br>
class&nbsp;VoxelGrid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Разреженная&nbsp;сетка&nbsp;вокселей&nbsp;на&nbsp;основе&nbsp;чанков.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Attributes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;origin:&nbsp;Мировые&nbsp;координаты&nbsp;угла&nbsp;сетки&nbsp;(минимум&nbsp;по&nbsp;X,&nbsp;Y,&nbsp;Z).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cell_size:&nbsp;Размер&nbsp;одного&nbsp;вокселя&nbsp;в&nbsp;мировых&nbsp;единицах.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;surface_normals:&nbsp;Словарь&nbsp;нормалей&nbsp;для&nbsp;поверхностных&nbsp;вокселей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;__slots__&nbsp;=&nbsp;(&quot;_origin&quot;,&nbsp;&quot;_cell_size&quot;,&nbsp;&quot;_chunks&quot;,&nbsp;&quot;_name&quot;,&nbsp;&quot;_surface_normals&quot;,&nbsp;&quot;_source_path&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;origin:&nbsp;tuple[float,&nbsp;float,&nbsp;float]&nbsp;=&nbsp;(0.0,&nbsp;0.0,&nbsp;0.0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cell_size:&nbsp;float&nbsp;=&nbsp;0.25,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;str&nbsp;=&nbsp;&quot;&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_path:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._origin&nbsp;=&nbsp;np.array(origin,&nbsp;dtype=np.float32)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cell_size&nbsp;=&nbsp;cell_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._chunks:&nbsp;dict[tuple[int,&nbsp;int,&nbsp;int],&nbsp;VoxelChunk]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._surface_normals:&nbsp;dict[tuple[int,&nbsp;int,&nbsp;int],&nbsp;list[np.ndarray]]&nbsp;=&nbsp;{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._source_path:&nbsp;str&nbsp;|&nbsp;None&nbsp;=&nbsp;source_path<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;origin(self)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Мировые&nbsp;координаты&nbsp;угла&nbsp;сетки.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._origin<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@origin.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;origin(self,&nbsp;value:&nbsp;tuple[float,&nbsp;float,&nbsp;float])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._origin&nbsp;=&nbsp;np.array(value,&nbsp;dtype=np.float32)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;cell_size(self)&nbsp;-&gt;&nbsp;float:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Размер&nbsp;вокселя&nbsp;в&nbsp;мировых&nbsp;единицах.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._cell_size<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@cell_size.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;cell_size(self,&nbsp;value:&nbsp;float)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._cell_size&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;name(self)&nbsp;-&gt;&nbsp;str:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Имя&nbsp;воксельной&nbsp;сетки.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@name.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;name(self,&nbsp;value:&nbsp;str)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._name&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;source_path(self)&nbsp;-&gt;&nbsp;str&nbsp;|&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Путь&nbsp;к&nbsp;файлу-источнику.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._source_path<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@source_path.setter<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;source_path(self,&nbsp;value:&nbsp;str&nbsp;|&nbsp;None)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._source_path&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;surface_normals(self)&nbsp;-&gt;&nbsp;dict[tuple[int,&nbsp;int,&nbsp;int],&nbsp;list[np.ndarray]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Нормали&nbsp;поверхностных&nbsp;вокселей:&nbsp;{(vx,&nbsp;vy,&nbsp;vz):&nbsp;[normal_vec3,&nbsp;...]}.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._surface_normals<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;add_surface_normal(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int,&nbsp;normal:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Добавить&nbsp;нормаль&nbsp;к&nbsp;списку&nbsp;нормалей&nbsp;поверхностного&nbsp;вокселя.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key&nbsp;=&nbsp;(vx,&nbsp;vy,&nbsp;vz)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;key&nbsp;not&nbsp;in&nbsp;self._surface_normals:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._surface_normals[key]&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._surface_normals[key].append(np.array(normal,&nbsp;dtype=np.float32))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_surface_normals(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int,&nbsp;normals:&nbsp;list[np.ndarray])&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;список&nbsp;нормалей&nbsp;для&nbsp;поверхностного&nbsp;вокселя.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._surface_normals[(vx,&nbsp;vy,&nbsp;vz)]&nbsp;=&nbsp;[np.array(n,&nbsp;dtype=np.float32)&nbsp;for&nbsp;n&nbsp;in&nbsp;normals]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_surface_normals(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int)&nbsp;-&gt;&nbsp;Optional[list[np.ndarray]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;список&nbsp;нормалей&nbsp;поверхностного&nbsp;вокселя&nbsp;или&nbsp;None.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._surface_normals.get((vx,&nbsp;vy,&nbsp;vz))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_surface_normal(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int)&nbsp;-&gt;&nbsp;Optional[np.ndarray]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;первую&nbsp;нормаль&nbsp;поверхностного&nbsp;вокселя&nbsp;или&nbsp;None&nbsp;(для&nbsp;совместимости).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normals&nbsp;=&nbsp;self._surface_normals.get((vx,&nbsp;vy,&nbsp;vz))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;normals&nbsp;and&nbsp;len(normals)&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;normals[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;chunk_count(self)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Количество&nbsp;аллоцированных&nbsp;чанков.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(self._chunks)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@property<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;voxel_count(self)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Общее&nbsp;количество&nbsp;непустых&nbsp;вокселей.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sum(c.non_empty_count&nbsp;for&nbsp;c&nbsp;in&nbsp;self._chunks.values())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Координатные&nbsp;преобразования<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;world_to_voxel(self,&nbsp;world_pos:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;tuple[int,&nbsp;int,&nbsp;int]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Преобразовать&nbsp;мировые&nbsp;координаты&nbsp;в&nbsp;индексы&nbsp;вокселя.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local&nbsp;=&nbsp;(world_pos&nbsp;-&nbsp;self._origin)&nbsp;/&nbsp;self._cell_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;int(np.floor(local[0])),&nbsp;int(np.floor(local[1])),&nbsp;int(np.floor(local[2]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;voxel_to_world(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int)&nbsp;-&gt;&nbsp;np.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Преобразовать&nbsp;индексы&nbsp;вокселя&nbsp;в&nbsp;мировые&nbsp;координаты&nbsp;(центр&nbsp;вокселя).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._origin&nbsp;+&nbsp;(np.array([vx,&nbsp;vy,&nbsp;vz])&nbsp;+&nbsp;0.5)&nbsp;*&nbsp;self._cell_size<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;voxel_to_chunk(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int)&nbsp;-&gt;&nbsp;tuple[tuple[int,&nbsp;int,&nbsp;int],&nbsp;tuple[int,&nbsp;int,&nbsp;int]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Разбить&nbsp;глобальные&nbsp;индексы&nbsp;вокселя&nbsp;на&nbsp;chunk&nbsp;key&nbsp;и&nbsp;локальные&nbsp;индексы.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Python&nbsp;floor&nbsp;division&nbsp;и&nbsp;modulo&nbsp;корректно&nbsp;работают&nbsp;с&nbsp;отрицательными&nbsp;числами:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1&nbsp;//&nbsp;16&nbsp;=&nbsp;-1,&nbsp;-1&nbsp;%&nbsp;16&nbsp;=&nbsp;15<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((chunk_x,&nbsp;chunk_y,&nbsp;chunk_z),&nbsp;(local_x,&nbsp;local_y,&nbsp;local_z))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cx&nbsp;=&nbsp;vx&nbsp;//&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cy&nbsp;=&nbsp;vy&nbsp;//&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cz&nbsp;=&nbsp;vz&nbsp;//&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lx&nbsp;=&nbsp;vx&nbsp;%&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ly&nbsp;=&nbsp;vy&nbsp;%&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lz&nbsp;=&nbsp;vz&nbsp;%&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(cx,&nbsp;cy,&nbsp;cz),&nbsp;(lx,&nbsp;ly,&nbsp;lz)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Доступ&nbsp;к&nbsp;вокселям<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;тип&nbsp;вокселя&nbsp;по&nbsp;глобальным&nbsp;индексам.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_key,&nbsp;(lx,&nbsp;ly,&nbsp;lz)&nbsp;=&nbsp;self.voxel_to_chunk(vx,&nbsp;vy,&nbsp;vz)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;self._chunks.get(chunk_key)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;chunk&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;chunk.get(lx,&nbsp;ly,&nbsp;lz)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set(self,&nbsp;vx:&nbsp;int,&nbsp;vy:&nbsp;int,&nbsp;vz:&nbsp;int,&nbsp;value:&nbsp;int)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;тип&nbsp;вокселя&nbsp;по&nbsp;глобальным&nbsp;индексам.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_key,&nbsp;(lx,&nbsp;ly,&nbsp;lz)&nbsp;=&nbsp;self.voxel_to_chunk(vx,&nbsp;vy,&nbsp;vz)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;value&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Удаляем&nbsp;воксель&nbsp;—&nbsp;чанк&nbsp;может&nbsp;стать&nbsp;пустым<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;self._chunks.get(chunk_key)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;chunk&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk.set(lx,&nbsp;ly,&nbsp;lz,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;chunk.is_empty:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del&nbsp;self._chunks[chunk_key]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Добавляем&nbsp;воксель&nbsp;—&nbsp;создаём&nbsp;чанк&nbsp;если&nbsp;нужно<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;self._chunks.get(chunk_key)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;chunk&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;VoxelChunk()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._chunks[chunk_key]&nbsp;=&nbsp;chunk<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk.set(lx,&nbsp;ly,&nbsp;lz,&nbsp;value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_at_world(self,&nbsp;world_pos:&nbsp;np.ndarray)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;тип&nbsp;вокселя&nbsp;по&nbsp;мировым&nbsp;координатам.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vx,&nbsp;vy,&nbsp;vz&nbsp;=&nbsp;self.world_to_voxel(world_pos)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.get(vx,&nbsp;vy,&nbsp;vz)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_at_world(self,&nbsp;world_pos:&nbsp;np.ndarray,&nbsp;value:&nbsp;int)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Установить&nbsp;тип&nbsp;вокселя&nbsp;по&nbsp;мировым&nbsp;координатам.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vx,&nbsp;vy,&nbsp;vz&nbsp;=&nbsp;self.world_to_voxel(world_pos)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.set(vx,&nbsp;vy,&nbsp;vz,&nbsp;value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_chunk(self,&nbsp;cx:&nbsp;int,&nbsp;cy:&nbsp;int,&nbsp;cz:&nbsp;int)&nbsp;-&gt;&nbsp;Optional[VoxelChunk]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Получить&nbsp;чанк&nbsp;по&nbsp;координатам&nbsp;чанка.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._chunks.get((cx,&nbsp;cy,&nbsp;cz))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Итерация<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;iter_chunks(self)&nbsp;-&gt;&nbsp;Iterator[tuple[tuple[int,&nbsp;int,&nbsp;int],&nbsp;VoxelChunk]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Итератор&nbsp;по&nbsp;всем&nbsp;чанкам:&nbsp;(chunk_key,&nbsp;chunk).&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;from&nbsp;self._chunks.items()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;iter_non_empty(self)&nbsp;-&gt;&nbsp;Iterator[tuple[int,&nbsp;int,&nbsp;int,&nbsp;int]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Итератор&nbsp;по&nbsp;всем&nbsp;непустым&nbsp;вокселям.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Yields:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(voxel_x,&nbsp;voxel_y,&nbsp;voxel_z,&nbsp;type)&nbsp;в&nbsp;глобальных&nbsp;координатах.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(cx,&nbsp;cy,&nbsp;cz),&nbsp;chunk&nbsp;in&nbsp;self._chunks.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_x&nbsp;=&nbsp;cx&nbsp;*&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_y&nbsp;=&nbsp;cy&nbsp;*&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_z&nbsp;=&nbsp;cz&nbsp;*&nbsp;CHUNK_SIZE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;lx,&nbsp;ly,&nbsp;lz,&nbsp;vtype&nbsp;in&nbsp;chunk.iter_non_empty():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;base_x&nbsp;+&nbsp;lx,&nbsp;base_y&nbsp;+&nbsp;ly,&nbsp;base_z&nbsp;+&nbsp;lz,&nbsp;vtype<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Операции<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear(self)&nbsp;-&gt;&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Очистить&nbsp;всю&nbsp;сетку.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._chunks.clear()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;bounds(self)&nbsp;-&gt;&nbsp;Optional[tuple[tuple[int,&nbsp;int,&nbsp;int],&nbsp;tuple[int,&nbsp;int,&nbsp;int]]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Получить&nbsp;bounding&nbsp;box&nbsp;в&nbsp;координатах&nbsp;вокселей.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((min_x,&nbsp;min_y,&nbsp;min_z),&nbsp;(max_x,&nbsp;max_y,&nbsp;max_z))&nbsp;или&nbsp;None&nbsp;если&nbsp;пусто.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;self._chunks:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk_keys&nbsp;=&nbsp;list(self._chunks.keys())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_cx&nbsp;=&nbsp;min(k[0]&nbsp;for&nbsp;k&nbsp;in&nbsp;chunk_keys)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_cy&nbsp;=&nbsp;min(k[1]&nbsp;for&nbsp;k&nbsp;in&nbsp;chunk_keys)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_cz&nbsp;=&nbsp;min(k[2]&nbsp;for&nbsp;k&nbsp;in&nbsp;chunk_keys)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_cx&nbsp;=&nbsp;max(k[0]&nbsp;for&nbsp;k&nbsp;in&nbsp;chunk_keys)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_cy&nbsp;=&nbsp;max(k[1]&nbsp;for&nbsp;k&nbsp;in&nbsp;chunk_keys)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_cz&nbsp;=&nbsp;max(k[2]&nbsp;for&nbsp;k&nbsp;in&nbsp;chunk_keys)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(min_cx&nbsp;*&nbsp;CHUNK_SIZE,&nbsp;min_cy&nbsp;*&nbsp;CHUNK_SIZE,&nbsp;min_cz&nbsp;*&nbsp;CHUNK_SIZE),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((max_cx&nbsp;+&nbsp;1)&nbsp;*&nbsp;CHUNK_SIZE&nbsp;-&nbsp;1,&nbsp;(max_cy&nbsp;+&nbsp;1)&nbsp;*&nbsp;CHUNK_SIZE&nbsp;-&nbsp;1,&nbsp;(max_cz&nbsp;+&nbsp;1)&nbsp;*&nbsp;CHUNK_SIZE&nbsp;-&nbsp;1),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;world_bounds(self)&nbsp;-&gt;&nbsp;Optional[tuple[np.ndarray,&nbsp;np.ndarray]]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Получить&nbsp;bounding&nbsp;box&nbsp;в&nbsp;мировых&nbsp;координатах.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(min_corner,&nbsp;max_corner)&nbsp;или&nbsp;None&nbsp;если&nbsp;пусто.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;voxel_bounds&nbsp;=&nbsp;self.bounds()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;voxel_bounds&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(min_v,&nbsp;max_v)&nbsp;=&nbsp;voxel_bounds<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_world&nbsp;=&nbsp;self._origin&nbsp;+&nbsp;np.array(min_v)&nbsp;*&nbsp;self._cell_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_world&nbsp;=&nbsp;self._origin&nbsp;+&nbsp;(np.array(max_v)&nbsp;+&nbsp;1)&nbsp;*&nbsp;self._cell_size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;min_world,&nbsp;max_world<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Surface&nbsp;/&nbsp;Interior&nbsp;operations<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;mark_surface(self,&nbsp;surface_value:&nbsp;int&nbsp;=&nbsp;2)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Помечает&nbsp;поверхностные&nbsp;воксели&nbsp;отдельным&nbsp;типом&nbsp;(in-place).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Поверхностный&nbsp;воксель&nbsp;—&nbsp;непустой,&nbsp;у&nbsp;которого&nbsp;есть&nbsp;хотя&nbsp;бы&nbsp;один&nbsp;пустой&nbsp;сосед.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;surface_value:&nbsp;Тип&nbsp;для&nbsp;поверхностных&nbsp;вокселей&nbsp;(default:&nbsp;VOXEL_SURFACE=2).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Количество&nbsp;помеченных&nbsp;вокселей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors&nbsp;=&nbsp;[(1,&nbsp;0,&nbsp;0),&nbsp;(-1,&nbsp;0,&nbsp;0),&nbsp;(0,&nbsp;1,&nbsp;0),&nbsp;(0,&nbsp;-1,&nbsp;0),&nbsp;(0,&nbsp;0,&nbsp;1),&nbsp;(0,&nbsp;0,&nbsp;-1)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Собираем&nbsp;координаты&nbsp;surface&nbsp;вокселей<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;surface_coords:&nbsp;list[tuple[int,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x,&nbsp;y,&nbsp;z,&nbsp;vtype&nbsp;in&nbsp;self.iter_non_empty():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем&nbsp;есть&nbsp;ли&nbsp;пустой&nbsp;сосед<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;dx,&nbsp;dy,&nbsp;dz&nbsp;in&nbsp;neighbors:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.get(x&nbsp;+&nbsp;dx,&nbsp;y&nbsp;+&nbsp;dy,&nbsp;z&nbsp;+&nbsp;dz)&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;surface_coords.append((x,&nbsp;y,&nbsp;z))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Помечаем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x,&nbsp;y,&nbsp;z&nbsp;in&nbsp;surface_coords:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.set(x,&nbsp;y,&nbsp;z,&nbsp;surface_value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(surface_coords)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clear_by_type(self,&nbsp;type_to_clear:&nbsp;int&nbsp;=&nbsp;1)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Удаляет&nbsp;все&nbsp;воксели&nbsp;указанного&nbsp;типа&nbsp;(in-place).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type_to_clear:&nbsp;Тип&nbsp;вокселей&nbsp;для&nbsp;удаления&nbsp;(default:&nbsp;VOXEL_SOLID=1).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Количество&nbsp;удалённых&nbsp;вокселей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Собираем&nbsp;координаты&nbsp;вокселей&nbsp;для&nbsp;удаления<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_clear:&nbsp;list[tuple[int,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x,&nbsp;y,&nbsp;z,&nbsp;vtype&nbsp;in&nbsp;self.iter_non_empty():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;vtype&nbsp;==&nbsp;type_to_clear:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_clear.append((x,&nbsp;y,&nbsp;z))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Удаляем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x,&nbsp;y,&nbsp;z&nbsp;in&nbsp;to_clear:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.set(x,&nbsp;y,&nbsp;z,&nbsp;0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;len(to_clear)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;extract_surface(self,&nbsp;surface_value:&nbsp;int&nbsp;=&nbsp;1)&nbsp;-&gt;&nbsp;&quot;VoxelGrid&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Создаёт&nbsp;новую&nbsp;сетку&nbsp;только&nbsp;с&nbsp;поверхностными&nbsp;вокселями.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Поверхностный&nbsp;воксель&nbsp;—&nbsp;solid,&nbsp;у&nbsp;которого&nbsp;есть&nbsp;хотя&nbsp;бы&nbsp;один&nbsp;пустой&nbsp;сосед.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;surface_value:&nbsp;Тип&nbsp;для&nbsp;поверхностных&nbsp;вокселей.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Новая&nbsp;VoxelGrid&nbsp;только&nbsp;с&nbsp;поверхностными&nbsp;вокселями.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;VoxelGrid(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;origin=tuple(self._origin),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cell_size=self._cell_size,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=self._name&nbsp;+&nbsp;&quot;_surface&quot;&nbsp;if&nbsp;self._name&nbsp;else&nbsp;&quot;surface&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors&nbsp;=&nbsp;[(1,&nbsp;0,&nbsp;0),&nbsp;(-1,&nbsp;0,&nbsp;0),&nbsp;(0,&nbsp;1,&nbsp;0),&nbsp;(0,&nbsp;-1,&nbsp;0),&nbsp;(0,&nbsp;0,&nbsp;1),&nbsp;(0,&nbsp;0,&nbsp;-1)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x,&nbsp;y,&nbsp;z,&nbsp;vtype&nbsp;in&nbsp;self.iter_non_empty():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем&nbsp;есть&nbsp;ли&nbsp;пустой&nbsp;сосед<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_empty_neighbor&nbsp;=&nbsp;False<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;dx,&nbsp;dy,&nbsp;dz&nbsp;in&nbsp;neighbors:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.get(x&nbsp;+&nbsp;dx,&nbsp;y&nbsp;+&nbsp;dy,&nbsp;z&nbsp;+&nbsp;dz)&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_empty_neighbor&nbsp;=&nbsp;True<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;has_empty_neighbor:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.set(x,&nbsp;y,&nbsp;z,&nbsp;surface_value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;fill_interior(self,&nbsp;fill_value:&nbsp;int&nbsp;=&nbsp;1)&nbsp;-&gt;&nbsp;int:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Заполняет&nbsp;внутреннее&nbsp;пространство&nbsp;замкнутого&nbsp;меша.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Алгоритм:&nbsp;flood&nbsp;fill&nbsp;снаружи,&nbsp;всё&nbsp;недостижимое&nbsp;—&nbsp;внутри.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Args:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill_value:&nbsp;Тип&nbsp;вокселя&nbsp;для&nbsp;заполнения.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Количество&nbsp;заполненных&nbsp;вокселей.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;collections&nbsp;import&nbsp;deque<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;voxel_bounds&nbsp;=&nbsp;self.bounds()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;voxel_bounds&nbsp;is&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(min_x,&nbsp;min_y,&nbsp;min_z),&nbsp;(max_x,&nbsp;max_y,&nbsp;max_z)&nbsp;=&nbsp;voxel_bounds<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Расширяем&nbsp;bounds&nbsp;на&nbsp;1&nbsp;чтобы&nbsp;гарантировать&nbsp;что&nbsp;угол&nbsp;снаружи<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_x&nbsp;-=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_y&nbsp;-=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_z&nbsp;-=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_x&nbsp;+=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_y&nbsp;+=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_z&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;BFS&nbsp;от&nbsp;угла&nbsp;—&nbsp;помечаем&nbsp;всё&nbsp;достижимое&nbsp;снаружи<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outside:&nbsp;set[tuple[int,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;set()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue:&nbsp;deque[tuple[int,&nbsp;int,&nbsp;int]]&nbsp;=&nbsp;deque()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;=&nbsp;(min_x,&nbsp;min_y,&nbsp;min_z)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue.append(start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outside.add(start)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbors&nbsp;=&nbsp;[(1,&nbsp;0,&nbsp;0),&nbsp;(-1,&nbsp;0,&nbsp;0),&nbsp;(0,&nbsp;1,&nbsp;0),&nbsp;(0,&nbsp;-1,&nbsp;0),&nbsp;(0,&nbsp;0,&nbsp;1),&nbsp;(0,&nbsp;0,&nbsp;-1)]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;queue:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x,&nbsp;y,&nbsp;z&nbsp;=&nbsp;queue.popleft()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;dx,&nbsp;dy,&nbsp;dz&nbsp;in&nbsp;neighbors:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nx,&nbsp;ny,&nbsp;nz&nbsp;=&nbsp;x&nbsp;+&nbsp;dx,&nbsp;y&nbsp;+&nbsp;dy,&nbsp;z&nbsp;+&nbsp;dz<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Проверяем&nbsp;bounds<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;nx&nbsp;&lt;&nbsp;min_x&nbsp;or&nbsp;nx&nbsp;&gt;&nbsp;max_x:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;ny&nbsp;&lt;&nbsp;min_y&nbsp;or&nbsp;ny&nbsp;&gt;&nbsp;max_y:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;nz&nbsp;&lt;&nbsp;min_z&nbsp;or&nbsp;nz&nbsp;&gt;&nbsp;max_z:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(nx,&nbsp;ny,&nbsp;nz)&nbsp;in&nbsp;outside:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Если&nbsp;solid&nbsp;—&nbsp;не&nbsp;проходим<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.get(nx,&nbsp;ny,&nbsp;nz)&nbsp;!=&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outside.add((nx,&nbsp;ny,&nbsp;nz))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue.append((nx,&nbsp;ny,&nbsp;nz))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Заполняем&nbsp;всё&nbsp;что&nbsp;не&nbsp;outside&nbsp;и&nbsp;не&nbsp;solid<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filled_count&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x&nbsp;in&nbsp;range(min_x,&nbsp;max_x&nbsp;+&nbsp;1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;y&nbsp;in&nbsp;range(min_y,&nbsp;max_y&nbsp;+&nbsp;1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;z&nbsp;in&nbsp;range(min_z,&nbsp;max_z&nbsp;+&nbsp;1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(x,&nbsp;y,&nbsp;z)&nbsp;not&nbsp;in&nbsp;outside&nbsp;and&nbsp;self.get(x,&nbsp;y,&nbsp;z)&nbsp;==&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.set(x,&nbsp;y,&nbsp;z,&nbsp;fill_value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filled_count&nbsp;+=&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;filled_count<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Сериализация<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;----------------------------------------------------------------<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;direct_serialize(self)&nbsp;-&gt;&nbsp;dict:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Сериализовать&nbsp;сетку&nbsp;в&nbsp;dict.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Если&nbsp;source_path&nbsp;задан,&nbsp;возвращает&nbsp;ссылку&nbsp;на&nbsp;файл.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Иначе&nbsp;сериализует&nbsp;данные&nbsp;inline.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._source_path&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;:&nbsp;&quot;path&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;path&quot;:&nbsp;self._source_path,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;:&nbsp;&quot;inline&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;origin&quot;:&nbsp;self._origin.tolist(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;cell_size&quot;:&nbsp;self._cell_size,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;chunks&quot;:&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&quot;{cx},{cy},{cz}&quot;:&nbsp;chunk.serialize()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(cx,&nbsp;cy,&nbsp;cz),&nbsp;chunk&nbsp;in&nbsp;self._chunks.items()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@classmethod<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;direct_deserialize(cls,&nbsp;data:&nbsp;dict)&nbsp;-&gt;&nbsp;&quot;VoxelGrid&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Десериализовать&nbsp;сетку&nbsp;из&nbsp;dict.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_path&nbsp;=&nbsp;data.get(&quot;path&quot;)&nbsp;if&nbsp;data.get(&quot;type&quot;)&nbsp;==&nbsp;&quot;path&quot;&nbsp;else&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grid&nbsp;=&nbsp;cls(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;origin=tuple(data[&quot;origin&quot;]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cell_size=data[&quot;cell_size&quot;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_path=source_path,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;key_str,&nbsp;chunk_data&nbsp;in&nbsp;data.get(&quot;chunks&quot;,&nbsp;{}).items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cx,&nbsp;cy,&nbsp;cz&nbsp;=&nbsp;map(int,&nbsp;key_str.split(&quot;,&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;VoxelChunk.deserialize(chunk_data)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;chunk.is_empty:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grid._chunks[(cx,&nbsp;cy,&nbsp;cz)]&nbsp;=&nbsp;chunk<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;grid<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Backward&nbsp;compatibility&nbsp;aliases<br>
&nbsp;&nbsp;&nbsp;&nbsp;serialize&nbsp;=&nbsp;direct_serialize<br>
&nbsp;&nbsp;&nbsp;&nbsp;deserialize&nbsp;=&nbsp;direct_deserialize<br>
<!-- END SCAT CODE -->
</body>
</html>
