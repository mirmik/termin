<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/util.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;math<br>
import&nbsp;numpy<br>
<br>
def&nbsp;qmul(q1:&nbsp;numpy.ndarray,&nbsp;q2:&nbsp;numpy.ndarray)&nbsp;-&gt;&nbsp;numpy.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Multiply&nbsp;two&nbsp;quaternions.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;x1,&nbsp;y1,&nbsp;z1,&nbsp;w1&nbsp;=&nbsp;q1<br>
&nbsp;&nbsp;&nbsp;&nbsp;x2,&nbsp;y2,&nbsp;z2,&nbsp;w2&nbsp;=&nbsp;q2<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;numpy.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*x2&nbsp;+&nbsp;x1*w2&nbsp;+&nbsp;y1*z2&nbsp;-&nbsp;z1*y2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*y2&nbsp;-&nbsp;x1*z2&nbsp;+&nbsp;y1*w2&nbsp;+&nbsp;z1*x2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*z2&nbsp;+&nbsp;x1*y2&nbsp;-&nbsp;y1*x2&nbsp;+&nbsp;z1*w2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*w2&nbsp;-&nbsp;x1*x2&nbsp;-&nbsp;y1*y2&nbsp;-&nbsp;z1*z2<br>
&nbsp;&nbsp;&nbsp;&nbsp;])<br>
<br>
def&nbsp;qmul_vector(q:&nbsp;numpy.ndarray,&nbsp;v:&nbsp;numpy.ndarray)&nbsp;-&gt;&nbsp;numpy.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;x1,&nbsp;y1,&nbsp;z1,&nbsp;w1&nbsp;=&nbsp;q<br>
&nbsp;&nbsp;&nbsp;&nbsp;x2,&nbsp;y2,&nbsp;z2&nbsp;=&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;numpy.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*x2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;y1*z2&nbsp;-&nbsp;z1*y2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*y2&nbsp;-&nbsp;x1*z2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;z1*x2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w1*z2&nbsp;+&nbsp;x1*y2&nbsp;-&nbsp;y1*x2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;x1*x2&nbsp;-&nbsp;y1*y2&nbsp;-&nbsp;z1*z2<br>
&nbsp;&nbsp;&nbsp;&nbsp;])<br>
<br>
<br>
def&nbsp;qrot(q:&nbsp;numpy.ndarray,&nbsp;v:&nbsp;numpy.ndarray)&nbsp;-&gt;&nbsp;numpy.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Rotate&nbsp;vector&nbsp;v&nbsp;by&nbsp;quaternion&nbsp;q.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;q_conj&nbsp;=&nbsp;numpy.array([-q[0],&nbsp;-q[1],&nbsp;-q[2],&nbsp;q[3]])<br>
&nbsp;&nbsp;&nbsp;&nbsp;rotated_v&nbsp;=&nbsp;qmul(qmul_vector(q,&nbsp;v),&nbsp;q_conj)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;rotated_v[:3]<br>
<br>
def&nbsp;qslerp(q1:&nbsp;numpy.ndarray,&nbsp;q2:&nbsp;numpy.ndarray,&nbsp;t:&nbsp;float)&nbsp;-&gt;&nbsp;numpy.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Spherical&nbsp;linear&nbsp;interpolation&nbsp;between&nbsp;two&nbsp;quaternions.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;dot&nbsp;=&nbsp;numpy.dot(q1,&nbsp;q2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dot&nbsp;&lt;&nbsp;0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q2&nbsp;=&nbsp;-q2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dot&nbsp;=&nbsp;-dot<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;DOT_THRESHOLD&nbsp;=&nbsp;0.9995<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dot&nbsp;&gt;&nbsp;DOT_THRESHOLD:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;q1&nbsp;+&nbsp;t&nbsp;*&nbsp;(q2&nbsp;-&nbsp;q1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result&nbsp;/&nbsp;numpy.linalg.norm(result)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;theta_0&nbsp;=&nbsp;math.acos(dot)<br>
&nbsp;&nbsp;&nbsp;&nbsp;theta&nbsp;=&nbsp;theta_0&nbsp;*&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;sin_theta&nbsp;=&nbsp;math.sin(theta)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sin_theta_0&nbsp;=&nbsp;math.sin(theta_0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;s1&nbsp;=&nbsp;math.cos(theta)&nbsp;-&nbsp;dot&nbsp;*&nbsp;sin_theta&nbsp;/&nbsp;sin_theta_0<br>
&nbsp;&nbsp;&nbsp;&nbsp;s2&nbsp;=&nbsp;sin_theta&nbsp;/&nbsp;sin_theta_0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(s1&nbsp;*&nbsp;q1)&nbsp;+&nbsp;(s2&nbsp;*&nbsp;q2)<br>
<br>
def&nbsp;deg2rad(deg):<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;deg&nbsp;/&nbsp;180.0&nbsp;*&nbsp;math.pi<br>
<br>
def&nbsp;qinv(q:&nbsp;numpy.ndarray)&nbsp;-&gt;&nbsp;numpy.ndarray:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Compute&nbsp;the&nbsp;inverse&nbsp;of&nbsp;a&nbsp;quaternion.&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;numpy.array([-q[0],&nbsp;-q[1],&nbsp;-q[2],&nbsp;q[3]])<br>
<br>
<br>
<!-- END SCAT CODE -->
</body>
</html>
