<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/linalg/solve.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
from&nbsp;scipy.linalg&nbsp;import&nbsp;cho_factor,&nbsp;cho_solve<br>
from&nbsp;typing&nbsp;import&nbsp;Optional,&nbsp;Tuple,&nbsp;List<br>
<br>
def&nbsp;solve_qp_equalities(H,&nbsp;g,&nbsp;A,&nbsp;b):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Решает&nbsp;задачу:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min&nbsp;&nbsp;1/2&nbsp;x^T&nbsp;H&nbsp;x&nbsp;+&nbsp;g^T&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.t.&nbsp;A&nbsp;x&nbsp;=&nbsp;b<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Академический&nbsp;вывод&nbsp;системы&nbsp;Шура:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ККТ:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;H&nbsp;&nbsp;&nbsp;A^T&nbsp;]&nbsp;[&nbsp;x&nbsp;]&nbsp;=&nbsp;[&nbsp;-g&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;]&nbsp;[&nbsp;λ&nbsp;]&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;b&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Из&nbsp;первой&nbsp;строки:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;-H^{-1}(g&nbsp;+&nbsp;A^T&nbsp;λ)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Подставляем&nbsp;в&nbsp;A&nbsp;x&nbsp;=&nbsp;b:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A[-H^{-1}(g&nbsp;+&nbsp;A^T&nbsp;λ)]&nbsp;=&nbsp;b<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Получаем:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-A&nbsp;H^{-1}&nbsp;g&nbsp;-&nbsp;A&nbsp;H^{-1}&nbsp;A^T&nbsp;λ&nbsp;=&nbsp;b<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Система&nbsp;Шура:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(A&nbsp;H^{-1}&nbsp;A^T)&nbsp;λ&nbsp;=&nbsp;-b&nbsp;-&nbsp;A&nbsp;H^{-1}&nbsp;g<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;После&nbsp;нахождения&nbsp;λ:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;x&nbsp;=&nbsp;-g&nbsp;-&nbsp;A^T&nbsp;λ<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;1)&nbsp;Cholesky&nbsp;разложение:&nbsp;H&nbsp;=&nbsp;L&nbsp;L^T&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L,&nbsp;lower&nbsp;=&nbsp;cho_factor(H)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;2)&nbsp;Вычислить&nbsp;H^{-1}&nbsp;g&nbsp;и&nbsp;H^{-1}&nbsp;A^T&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;здесь&nbsp;считаем&nbsp;два&nbsp;объекта,&nbsp;входящие&nbsp;в&nbsp;формулы&nbsp;Шура:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;H^{-1}&nbsp;g&nbsp;&nbsp;и&nbsp;&nbsp;H^{-1}&nbsp;A^T<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y_g&nbsp;=&nbsp;cho_solve((L,&nbsp;lower),&nbsp;g)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;=&nbsp;H^{-1}&nbsp;g<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;&nbsp;&nbsp;=&nbsp;cho_solve((L,&nbsp;lower),&nbsp;A.T)&nbsp;&nbsp;&nbsp;#&nbsp;=&nbsp;H^{-1}&nbsp;A^T<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;3)&nbsp;Построить&nbsp;систему&nbsp;Шура&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;S&nbsp;=&nbsp;A&nbsp;H^{-1}&nbsp;A^T<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;=&nbsp;A&nbsp;@&nbsp;Y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;r_λ&nbsp;=&nbsp;-b&nbsp;-&nbsp;A&nbsp;H^{-1}&nbsp;g<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r_lambda&nbsp;=&nbsp;-b&nbsp;-&nbsp;A&nbsp;@&nbsp;y_g<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;4)&nbsp;Решить&nbsp;систему&nbsp;Шура:&nbsp;S&nbsp;λ&nbsp;=&nbsp;r_λ&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;λ&nbsp;=&nbsp;np.linalg.solve(S,&nbsp;r_lambda)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;5)&nbsp;Восстановить&nbsp;x:&nbsp;H&nbsp;x&nbsp;=&nbsp;-g&nbsp;-&nbsp;A^T&nbsp;λ&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w&nbsp;=&nbsp;-g&nbsp;-&nbsp;A.T&nbsp;@&nbsp;λ<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;cho_solve((L,&nbsp;lower),&nbsp;w)<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;np.linalg.LinAlgError:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;H&nbsp;может&nbsp;быть&nbsp;лишь&nbsp;положительно&nbsp;полуопределённой.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;H.shape[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;=&nbsp;A.shape[0]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;m&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zero_block&nbsp;=&nbsp;np.zeros((m,&nbsp;m),&nbsp;dtype=H.dtype)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KKT&nbsp;=&nbsp;np.block([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[H,&nbsp;A.T],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[A,&nbsp;zero_block]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rhs&nbsp;=&nbsp;np.concatenate([-g,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sol,&nbsp;*_&nbsp;=&nbsp;np.linalg.lstsq(KKT,&nbsp;rhs,&nbsp;rcond=None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;sol[:n]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;λ&nbsp;=&nbsp;sol[n:]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x,&nbsp;*_&nbsp;=&nbsp;np.linalg.lstsq(H,&nbsp;-g,&nbsp;rcond=None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;λ&nbsp;=&nbsp;np.zeros(0,&nbsp;dtype=H.dtype)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;x,&nbsp;λ<br>
<br>
<br>
<br>
def&nbsp;solve_qp_active_set(<br>
&nbsp;&nbsp;&nbsp;&nbsp;H:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;g:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;A_eq:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;b_eq:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;C:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;d:&nbsp;np.ndarray,<br>
&nbsp;&nbsp;&nbsp;&nbsp;x0:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;active0:&nbsp;Optional[np.ndarray]&nbsp;=&nbsp;None,<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_iter:&nbsp;int&nbsp;=&nbsp;50,<br>
&nbsp;&nbsp;&nbsp;&nbsp;tol:&nbsp;float&nbsp;=&nbsp;1e-7,<br>
&nbsp;&nbsp;&nbsp;&nbsp;active_tol:&nbsp;float&nbsp;=&nbsp;1e-6,<br>
)&nbsp;-&gt;&nbsp;Tuple[np.ndarray,&nbsp;np.ndarray,&nbsp;np.ndarray,&nbsp;np.ndarray,&nbsp;int]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Active-set&nbsp;решатель&nbsp;для&nbsp;задачи:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min&nbsp;&nbsp;1/2&nbsp;x^T&nbsp;H&nbsp;x&nbsp;+&nbsp;g^T&nbsp;x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;x:&nbsp;(n,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.t.&nbsp;A_eq&nbsp;x&nbsp;=&nbsp;b_eq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;A_eq:&nbsp;(m_eq×n),&nbsp;b_eq:&nbsp;(m_eq,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;x&nbsp;&lt;=&nbsp;d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;C:&nbsp;(m_ineq×n),&nbsp;d:&nbsp;(m_ineq,)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Параметры:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,&nbsp;g&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;квадратичный&nbsp;функционал.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;H:&nbsp;(n×n),&nbsp;g:&nbsp;(n,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_eq,&nbsp;b_eq&nbsp;&nbsp;–&nbsp;равенства.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;A_eq:&nbsp;(m_eq×n),&nbsp;b_eq:&nbsp;(m_eq,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C,&nbsp;d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;неравенства.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;C:&nbsp;(m_ineq×n),&nbsp;d:&nbsp;(m_ineq,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;warm-start&nbsp;по&nbsp;x.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;x0:&nbsp;(n,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;warm-start&nbsp;по&nbsp;активному&nbsp;множеству.|&nbsp;active0:&nbsp;(k,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_iter&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;максимум&nbsp;итераций.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tol&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;допуск&nbsp;ККТ.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active_tol&nbsp;&nbsp;–&nbsp;допуск&nbsp;при&nbsp;восстановлении&nbsp;active-set&nbsp;из&nbsp;x0.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;Возвращает:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;решение.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;(n,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lam_eq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;множители&nbsp;равенств.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;(m_eq,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lam_ineq&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;множители&nbsp;активных&nbsp;неравенств.&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;(k,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active_set&nbsp;&nbsp;–&nbsp;индексы&nbsp;активных&nbsp;ограничений.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;(k,)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iters&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;–&nbsp;количество&nbsp;итераций.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;H.shape[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;m_ineq&nbsp;=&nbsp;C.shape[0]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Инициализация&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;np.zeros(n)&nbsp;if&nbsp;x0&nbsp;is&nbsp;None&nbsp;else&nbsp;x0.copy()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Инициализация&nbsp;active-set<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;active:&nbsp;List[int]&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1)&nbsp;Если&nbsp;есть&nbsp;active0&nbsp;—&nbsp;он&nbsp;главный&nbsp;(сохраняем&nbsp;порядок,&nbsp;убираем&nbsp;дубли)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;active0&nbsp;is&nbsp;not&nbsp;None:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;idx&nbsp;in&nbsp;active0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx&nbsp;=&nbsp;int(idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;0&nbsp;&lt;=&nbsp;idx&nbsp;&lt;&nbsp;m_ineq&nbsp;and&nbsp;idx&nbsp;not&nbsp;in&nbsp;active:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active.append(idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2)&nbsp;Если&nbsp;active0&nbsp;нет,&nbsp;но&nbsp;есть&nbsp;x0&nbsp;—&nbsp;пробуем&nbsp;восстановить&nbsp;из&nbsp;C&nbsp;@&nbsp;x0&nbsp;≈&nbsp;d<br>
&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;x0&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;m_ineq&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viol0&nbsp;=&nbsp;C&nbsp;@&nbsp;x0&nbsp;-&nbsp;d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(m_ineq):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;abs(viol0[i])&nbsp;&lt;=&nbsp;active_tol:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active.append(i)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3)&nbsp;Иначе&nbsp;—&nbsp;начинаем&nbsp;с&nbsp;пустого&nbsp;active-set<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;(ничего&nbsp;делать&nbsp;не&nbsp;надо,&nbsp;active&nbsp;и&nbsp;так&nbsp;пуст)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Основной&nbsp;цикл&nbsp;коррекции&nbsp;active-set<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;iters&nbsp;=&nbsp;0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;it&nbsp;in&nbsp;range(max_iter):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iters&nbsp;=&nbsp;it&nbsp;+&nbsp;1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;1.&nbsp;Формируем&nbsp;матрицу&nbsp;активных&nbsp;равенств&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;active:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_act&nbsp;=&nbsp;np.vstack([A_eq,&nbsp;C[active]])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b_act&nbsp;=&nbsp;np.concatenate([b_eq,&nbsp;d[active]])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A_act&nbsp;=&nbsp;A_eq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b_act&nbsp;=&nbsp;b_eq<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;2.&nbsp;Решаем&nbsp;подзадачу&nbsp;равенств&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x,&nbsp;lam_all&nbsp;=&nbsp;solve_qp_equalities(H,&nbsp;g,&nbsp;A_act,&nbsp;b_act)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;3.&nbsp;Разбираем&nbsp;множители&nbsp;Лагранжа&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n_eq&nbsp;=&nbsp;A_eq.shape[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lam_eq&nbsp;=&nbsp;lam_all[:n_eq]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lam_ineq&nbsp;=&nbsp;lam_all[n_eq:]&nbsp;&nbsp;#&nbsp;соответствует&nbsp;active[0],&nbsp;active[1],&nbsp;...<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;4.&nbsp;Ищем&nbsp;нарушенные&nbsp;неравенства&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;m_ineq&nbsp;&gt;&nbsp;0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;violations&nbsp;=&nbsp;C&nbsp;@&nbsp;x&nbsp;-&nbsp;d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;candidates&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;for&nbsp;i&nbsp;in&nbsp;range(m_ineq)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(violations[i]&nbsp;&gt;&nbsp;tol)&nbsp;and&nbsp;(i&nbsp;not&nbsp;in&nbsp;active)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;candidates&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;candidates:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Добавляем&nbsp;самое&nbsp;сильно&nbsp;нарушенное&nbsp;(защита&nbsp;от&nbsp;дублей&nbsp;встроена)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;worst&nbsp;=&nbsp;max(candidates,&nbsp;key=lambda&nbsp;i:&nbsp;violations[i])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active.append(worst)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue&nbsp;&nbsp;#&nbsp;повторяем&nbsp;итерацию&nbsp;с&nbsp;новым&nbsp;active-set<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;5.&nbsp;Проверяем&nbsp;λ&nbsp;на&nbsp;активных&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_remove&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;j,&nbsp;idx&nbsp;in&nbsp;enumerate(active):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;lam_ineq[j]&nbsp;&lt;&nbsp;-tol:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_remove.append(idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;to_remove:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Убираем&nbsp;все&nbsp;ограничения,&nbsp;нарушающие&nbsp;условия&nbsp;ККТ<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active&nbsp;=&nbsp;[i&nbsp;for&nbsp;i&nbsp;in&nbsp;active&nbsp;if&nbsp;i&nbsp;not&nbsp;in&nbsp;to_remove]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue&nbsp;&nbsp;#&nbsp;повторяем&nbsp;итерацию<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;6.&nbsp;ККТ&nbsp;выполнены,&nbsp;нарушений&nbsp;нет,&nbsp;λ&nbsp;&gt;=&nbsp;0&nbsp;—&nbsp;готово&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Финал:&nbsp;отдаём&nbsp;только&nbsp;λ&nbsp;для&nbsp;активных&nbsp;ограничений&nbsp;в&nbsp;корректном&nbsp;порядке<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;------------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;lam_ineq_final&nbsp;=&nbsp;lam_ineq&nbsp;if&nbsp;(m_ineq&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;active)&nbsp;else&nbsp;np.zeros(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;active_arr&nbsp;=&nbsp;np.array(active,&nbsp;dtype=int)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;x,&nbsp;lam_eq,&nbsp;lam_ineq_final,&nbsp;active_arr,&nbsp;iters<br>
<!-- END SCAT CODE -->
</body>
</html>
