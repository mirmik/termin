<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/zencad_adapter.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#!/usr/bin/env&nbsp;python3<br>
<br>
import&nbsp;numpy<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
import&nbsp;zencad<br>
import&nbsp;zencad.assemble<br>
import&nbsp;termin.ga201.point&nbsp;as&nbsp;point<br>
import&nbsp;termin.ga201.join&nbsp;as&nbsp;join<br>
import&nbsp;termin.ga201.screw&nbsp;as&nbsp;screw<br>
import&nbsp;termin.ga201.motor&nbsp;as&nbsp;motor<br>
<br>
from&nbsp;scipy.spatial&nbsp;import&nbsp;ConvexHull<br>
<br>
<br>
class&nbsp;VectorsOfJacobian:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;indexes,&nbsp;sensivities):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.indexes&nbsp;=&nbsp;indexes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sensivities&nbsp;=&nbsp;sensivities<br>
<br>
<br>
def&nbsp;draw_line2_positive(line,&nbsp;step=1,&nbsp;length=0.1):<br>
&nbsp;&nbsp;&nbsp;&nbsp;min&nbsp;=&nbsp;-100<br>
&nbsp;&nbsp;&nbsp;&nbsp;max&nbsp;=&nbsp;100<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;numpy.arange(min,&nbsp;max,&nbsp;step):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;line.x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;=&nbsp;line.y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;point.Point2(x,&nbsp;y,&nbsp;0)&nbsp;*&nbsp;length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;line.parameter_point(i)&nbsp;+&nbsp;d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;line.parameter_point(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zencad.display(zencad.segment(zencad.point3(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.x,&nbsp;a.y,&nbsp;0),&nbsp;zencad.point3(b.x,&nbsp;b.y,&nbsp;0)))<br>
<br>
<br>
def&nbsp;draw_line2(line):<br>
&nbsp;&nbsp;&nbsp;&nbsp;unitized_line&nbsp;=&nbsp;line.unitized()<br>
&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;unitized_line.parameter_point(-100)<br>
&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;unitized_line.parameter_point(100)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;zencad.display(zencad.segment(zencad.point3(a.x,&nbsp;a.y,&nbsp;0),&nbsp;zencad.point3(b.x,&nbsp;b.y,&nbsp;0)))<br>
<br>
<br>
def&nbsp;draw_point2(point):<br>
&nbsp;&nbsp;&nbsp;&nbsp;point&nbsp;=&nbsp;point.unitized()<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;zencad.display(zencad.point3(point.x,&nbsp;point.y,&nbsp;0))<br>
<br>
<br>
def&nbsp;draw_body2(body):<br>
&nbsp;&nbsp;&nbsp;&nbsp;cpnts&nbsp;=&nbsp;[(p.x,&nbsp;p.y)&nbsp;for&nbsp;p&nbsp;in&nbsp;[p.unitized()&nbsp;for&nbsp;p&nbsp;in&nbsp;body.vertices()]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;ConvexHull(cpnts)<br>
&nbsp;&nbsp;&nbsp;&nbsp;zpoints&nbsp;=&nbsp;[zencad.point3(cpnts[i][0],&nbsp;cpnts[i][1])&nbsp;for&nbsp;i&nbsp;in&nbsp;c.vertices]<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;zencad.display(zencad.polygon(zpoints))<br>
<br>
<br>
def&nbsp;zencad_sensivity_to_screw2(sensivity):<br>
&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;sensivity[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;l&nbsp;=&nbsp;sensivity[1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;screw.Screw2(v=numpy.array([l.x,&nbsp;l.y],&nbsp;dtype=numpy.float64),&nbsp;m=a.z)<br>
<br>
<br>
def&nbsp;zencad_transform_to_motor2(transform):<br>
&nbsp;&nbsp;&nbsp;&nbsp;l&nbsp;=&nbsp;transform.translation()<br>
&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;transform.rotation_quat()<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;motor.Motor2(l[0],&nbsp;l[1],&nbsp;0,&nbsp;1)&nbsp;*&nbsp;motor.Motor2(0,&nbsp;0,&nbsp;a.z,&nbsp;a.w)<br>
<br>
<br>
def&nbsp;right_sensivity_screw2_of_kinunit(kinunit,&nbsp;senunit):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Возвращает&nbsp;правую&nbsp;чувствительность&nbsp;сенсорного&nbsp;фрейма&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;к&nbsp;изменению&nbsp;координаты&nbsp;кинематического&nbsp;фрэйма.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H=KRS<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;K&nbsp;-&nbsp;кинематический&nbsp;юнит<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R&nbsp;-&nbsp;мотор&nbsp;выхода&nbsp;юнита&nbsp;ко&nbsp;входу<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H&nbsp;-&nbsp;сенсорный&nbsp;фрейм<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;-&nbsp;относительный&nbsp;мотор&nbsp;сенсорного&nbsp;фрейма<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;V_H&nbsp;=&nbsp;[H^-1&nbsp;*&nbsp;KR]V_R<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carried&nbsp;=&nbsp;(senmotor.inverse()&nbsp;*&nbsp;kinmotor).carry(sensivity)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;sensivity&nbsp;=&nbsp;zencad_sensivity_to_screw2(kinunit.sensivity())<br>
&nbsp;&nbsp;&nbsp;&nbsp;kinout&nbsp;=&nbsp;kinunit.output<br>
&nbsp;&nbsp;&nbsp;&nbsp;kinmotor&nbsp;=&nbsp;zencad_transform_to_motor2(kinout.global_location)<br>
&nbsp;&nbsp;&nbsp;&nbsp;senmotor&nbsp;=&nbsp;zencad_transform_to_motor2(senunit.global_location)<br>
&nbsp;&nbsp;&nbsp;&nbsp;motor&nbsp;=&nbsp;senmotor.inverse()&nbsp;*&nbsp;kinmotor<br>
&nbsp;&nbsp;&nbsp;&nbsp;carried&nbsp;=&nbsp;sensivity.kinematic_carry(motor)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;carried<br>
<br>
<br>
def&nbsp;indexes_of_kinunits(arr):<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[id(a)&nbsp;for&nbsp;a&nbsp;in&nbsp;arr]<br>
<br>
<br>
def&nbsp;right_jacobi_matrix_lin2(kinunits,&nbsp;senunit):<br>
&nbsp;&nbsp;&nbsp;&nbsp;sensivities&nbsp;=&nbsp;[right_sensivity_screw2_of_kinunit(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k,&nbsp;senunit)&nbsp;for&nbsp;k&nbsp;in&nbsp;kinunits]<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat&nbsp;=&nbsp;np.concatenate([k.vector().reshape(2,&nbsp;1)&nbsp;for&nbsp;k&nbsp;in&nbsp;sensivities],&nbsp;axis=1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mat<br>
<br>
<br>
def&nbsp;right_jacobi_matrix_lin2_by_indexes(kinunits,&nbsp;senunit):<br>
&nbsp;&nbsp;&nbsp;&nbsp;indexes&nbsp;=&nbsp;indexes_of_kinunits(kinunits)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sensivities&nbsp;=&nbsp;[right_sensivity_screw2_of_kinunit(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k,&nbsp;senunit)&nbsp;for&nbsp;k&nbsp;in&nbsp;kinunits]<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;VectorsOfJacobian(indexes,&nbsp;sensivities)<br>
<!-- END SCAT CODE -->
</body>
</html>
