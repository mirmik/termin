<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/ARCHIVE/physics/indexed_matrix.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
<br>
import&nbsp;numpy<br>
import&nbsp;torch<br>
<br>
#import&nbsp;coo<br>
import&nbsp;scipy.sparse<br>
<br>
<br>
torch_type&nbsp;=&nbsp;torch.float64<br>
<br>
class&nbsp;IndexedMatrix:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;matrix,&nbsp;lidxs=None,&nbsp;ridxs=None,&nbsp;lcomm=None,&nbsp;rcomm=None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.lcomm&nbsp;=&nbsp;lcomm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.rcomm&nbsp;=&nbsp;rcomm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.lidxs&nbsp;=&nbsp;lidxs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.ridxs&nbsp;=&nbsp;ridxs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#self.matrix&nbsp;=&nbsp;scipy.sparse.lil_matrix(matrix)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.matrix&nbsp;=&nbsp;matrix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.lidxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.index_of_lidxs&nbsp;=&nbsp;{idx:&nbsp;lidxs.index(idx)&nbsp;for&nbsp;idx&nbsp;in&nbsp;lidxs}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.ridxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.index_of_ridxs&nbsp;=&nbsp;{idx:&nbsp;ridxs.index(idx)&nbsp;for&nbsp;idx&nbsp;in&nbsp;ridxs}<br>
<br>
#&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;coo(self):<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.matrix&nbsp;=&nbsp;scipy.sparse.coo_matrix(self.matrix)<br>
<br>
#&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;dense(self):<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.matrix.todense()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;matmul(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.ridxs&nbsp;!=&nbsp;oth.lidxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;Exception(&quot;indexes&nbsp;is&nbsp;not&nbsp;same&nbsp;in&nbsp;convolution&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matrix&nbsp;=&nbsp;self.matrix&nbsp;@&nbsp;oth.matrix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(matrix,&nbsp;self.lidxs,&nbsp;oth.ridxs)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;vecmul(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.ridxs&nbsp;!=&nbsp;oth.idxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;Exception(&quot;indexes&nbsp;is&nbsp;not&nbsp;same&nbsp;in&nbsp;convolution&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matrix&nbsp;=&nbsp;self.matrix&nbsp;@&nbsp;oth.matrix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedVector(matrix,&nbsp;self.lidxs)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__matmul__(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(oth,&nbsp;IndexedVector):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.vecmul(oth)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.matmul(oth)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__neg__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(-self.matrix,&nbsp;self.lidxs,&nbsp;self.ridxs,&nbsp;self.lcomm,&nbsp;self.rcomm)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;inv(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(scipy.sparse.linalg.inv(self.matrix),&nbsp;self.ridxs,&nbsp;self.lidxs,&nbsp;self.rcomm,&nbsp;self.lcomm)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;solve(self,&nbsp;b):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;numpy.linalg.solve(self.matrix,&nbsp;b.matrix)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;raise_if_lidxs_is_not_same(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.lidxs&nbsp;!=&nbsp;oth.lidxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;Exception(&quot;indexes&nbsp;is&nbsp;not&nbsp;same&nbsp;in&nbsp;convolution&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;raise_if_ridxs_is_not_same(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.ridxs&nbsp;!=&nbsp;oth.ridxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;Exception(&quot;indexes&nbsp;is&nbsp;not&nbsp;same&nbsp;in&nbsp;convolution&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;raise_if_not_linkaged(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.ridxs&nbsp;!=&nbsp;oth.lidxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;Exception(&quot;indexes&nbsp;is&nbsp;not&nbsp;same&nbsp;in&nbsp;convolution&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__add__(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.raise_if_lidxs_is_not_same(oth)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.raise_if_ridxs_is_not_same(oth)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(self.matrix&nbsp;+&nbsp;oth.matrix,&nbsp;self.lidxs,&nbsp;self.ridxs,&nbsp;self.lcomm,&nbsp;self.rcomm)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__mul__(self,&nbsp;s):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(self.matrix&nbsp;*&nbsp;s,&nbsp;self.lidxs,&nbsp;self.ridxs,&nbsp;self.lcomm,&nbsp;self.rcomm)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;unsparse(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.matrix.toarray()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;transpose(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(self.matrix.T,&nbsp;self.ridxs,&nbsp;self.lidxs,&nbsp;self.rcomm,&nbsp;self.lcomm)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;accumulate_from(self,&nbsp;other):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lidxs&nbsp;=&nbsp;[self.index_of_lidxs[i]&nbsp;for&nbsp;i&nbsp;in&nbsp;other.lidxs]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ridxs&nbsp;=&nbsp;[self.index_of_ridxs[i]&nbsp;for&nbsp;i&nbsp;in&nbsp;other.ridxs]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(lidxs)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;j&nbsp;in&nbsp;range(len(ridxs)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.matrix[lidxs[i],&nbsp;ridxs[j]]&nbsp;+=&nbsp;other.matrix[i,&nbsp;j]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__str__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&quot;Matrix:\r\n{}\r\nLeft&nbsp;Indexes:&nbsp;{}\r\nRight&nbsp;Indexes:&nbsp;{}\r\n&quot;.format(self.matrix,&nbsp;self.lidxs,&nbsp;self.ridxs)<br>
<br>
<br>
class&nbsp;IndexedVector:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;matrix,&nbsp;idxs,&nbsp;comm=None):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.comm&nbsp;=&nbsp;comm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(matrix,&nbsp;numpy.ndarray)&nbsp;and&nbsp;len(matrix.shape)&nbsp;!=&nbsp;1:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matrix&nbsp;=&nbsp;matrix.reshape(matrix.shape[0],&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.matrix&nbsp;=&nbsp;matrix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.idxs&nbsp;=&nbsp;idxs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.idxs:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.index_of_idxs&nbsp;=&nbsp;{idx:&nbsp;idxs.index(idx)&nbsp;for&nbsp;idx&nbsp;in&nbsp;idxs}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__str__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&quot;Vector:\r\n{}\r\nIndexes:&nbsp;{}\r\n&quot;.format(self.matrix,&nbsp;self.idxs)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;accumulate_from(self,&nbsp;other):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idxs&nbsp;=&nbsp;[self.index_of_idxs[i]&nbsp;for&nbsp;i&nbsp;in&nbsp;other.idxs]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(idxs)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.matrix[idxs[i]]&nbsp;+=&nbsp;other.matrix[i]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;upbind_values(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(self.idxs)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.idxs[i].set_value(self.matrix[i])<br>
<!-- END SCAT CODE -->
</body>
</html>
