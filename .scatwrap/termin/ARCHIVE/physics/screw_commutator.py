<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>termin/ARCHIVE/physics/screw_commutator.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#!/usr/bin/env&nbsp;python3<br>
import&nbsp;numpy<br>
from&nbsp;termin.physics.pose_object&nbsp;import&nbsp;PoseObject<br>
from&nbsp;termin.physics.indexed_matrix&nbsp;import&nbsp;IndexedMatrix,&nbsp;IndexedVector<br>
from&nbsp;termin.ga201.motor&nbsp;import&nbsp;Motor2<br>
from&nbsp;termin.ga201.screw&nbsp;import&nbsp;Screw2<br>
import&nbsp;math<br>
<br>
<br>
class&nbsp;VariableValueCommutator:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;dim):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._dim&nbsp;=&nbsp;dim<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._sources&nbsp;=&nbsp;[VariableValue(self,&nbsp;i)&nbsp;for&nbsp;i&nbsp;in&nbsp;range(dim)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._values&nbsp;=&nbsp;[0]&nbsp;*&nbsp;dim<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;sources(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._sources<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_value(self,&nbsp;idx:&nbsp;int,&nbsp;value:&nbsp;float):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._values[idx]&nbsp;=&nbsp;value<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;values(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._values<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;indexes(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._sources<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;dim(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._dim<br>
<br>
<br>
class&nbsp;VariableValue:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;commutator,&nbsp;index):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.commutator&nbsp;=&nbsp;commutator<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.index&nbsp;=&nbsp;index<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;set_value(self,&nbsp;value):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.commutator.set_value(self.index,&nbsp;value)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__str__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;str(id(self))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__repr__(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;str(id(self))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__lt__(self,&nbsp;oth):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;id(self)&nbsp;&lt;&nbsp;id(oth)<br>
<br>
<br>
class&nbsp;ScrewVariableValue(VariableValue):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;commutator,&nbsp;index):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(commutator,&nbsp;index)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._value&nbsp;=&nbsp;Screw2()<br>
<br>
<br>
class&nbsp;ScrewCommutator(VariableValueCommutator):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;local_senses,&nbsp;pose_object):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dim&nbsp;=&nbsp;len(local_senses)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(dim)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.pose_object&nbsp;=&nbsp;pose_object<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._screws&nbsp;=&nbsp;local_senses<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;screws(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._screws<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;position(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.pose_object.position()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;derivative_matrix_from(self,&nbsp;other):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self_screws&nbsp;=&nbsp;self.screws()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_screws&nbsp;=&nbsp;other.screws()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self_pose&nbsp;=&nbsp;self.pose_object.position()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_pose&nbsp;=&nbsp;other.pose_object.position()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff_pose&nbsp;=&nbsp;self_pose.inverse()&nbsp;*&nbsp;other_pose<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;=&nbsp;numpy.zeros((len(self_screws),&nbsp;len(other_screws)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;self_screw&nbsp;in&nbsp;enumerate(self_screws):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;j,&nbsp;other_screw&nbsp;in&nbsp;enumerate(other_screws):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carried&nbsp;=&nbsp;other_screw.kinematic_carry(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff_pose)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B[i,&nbsp;j]&nbsp;=&nbsp;self_screw.fulldot(carried)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;IndexedMatrix(B,&nbsp;self.indexes(),&nbsp;other.indexes(),&nbsp;lcomm=self,&nbsp;rcomm=other)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;derivative(self,&nbsp;other):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.derivative_matrix_from(other)<br>
<br>
if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;numpy.set_printoptions(precision=3,&nbsp;suppress=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;1:&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p1&nbsp;=&nbsp;PoseObject(Motor2.translation(0,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2&nbsp;=&nbsp;PoseObject(Motor2.translation(1,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc1&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc2&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;=&nbsp;sc1.derivative_matrix_from(sc2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(B)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;2:&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p1&nbsp;=&nbsp;PoseObject(Motor2.translation(2,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2&nbsp;=&nbsp;PoseObject(Motor2.translation(3,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc1&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc2&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;=&nbsp;sc1.derivative_matrix_from(sc2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(B)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;3:&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p1&nbsp;=&nbsp;PoseObject(Motor2.rotation(math.pi/2))<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2&nbsp;=&nbsp;PoseObject(Motor2.rotation(math.pi/2)&nbsp;*&nbsp;Motor2.translation(1,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc1&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc2&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;=&nbsp;sc1.derivative_matrix_from(sc2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(B)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;4:&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p1&nbsp;=&nbsp;PoseObject(Motor2.translation(0,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2&nbsp;=&nbsp;PoseObject(Motor2.rotation(math.pi/2)&nbsp;*&nbsp;Motor2.translation(1,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc1&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[0,&nbsp;1]),&nbsp;Screw2(v=[-1,&nbsp;0]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc2&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;=&nbsp;sc1.derivative_matrix_from(sc2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(B)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;5:&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p1&nbsp;=&nbsp;PoseObject(Motor2.rotation(math.pi/2)&nbsp;*&nbsp;Motor2.translation(0,&nbsp;0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;p2&nbsp;=&nbsp;PoseObject(Motor2.translation(0,&nbsp;1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc1&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[1,&nbsp;0]),&nbsp;Screw2(v=[0,&nbsp;1]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sc2&nbsp;=&nbsp;ScrewCommutator(local_senses=[Screw2(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v=[0,&nbsp;1]),&nbsp;Screw2(v=[-1,&nbsp;0]),&nbsp;Screw2(m=1)],&nbsp;pose_object=p2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;=&nbsp;sc1.derivative_matrix_from(sc2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(B)<br>
<!-- END SCAT CODE -->
</body>
</html>
