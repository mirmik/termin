<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/test_examples.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;importlib<br>
import&nbsp;pathlib<br>
import&nbsp;sys<br>
import&nbsp;pytest<br>
<br>
import&nbsp;termin.visualization.world&nbsp;as&nbsp;world_module<br>
<br>
from&nbsp;termin.visualization.backends&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;set_default_graphics_backend,<br>
&nbsp;&nbsp;&nbsp;&nbsp;set_default_window_backend,<br>
)<br>
<br>
from&nbsp;termin.visualization.backends.nop_graphics&nbsp;import&nbsp;NOPGraphicsBackend<br>
from&nbsp;termin.visualization.backends.nop_window&nbsp;import&nbsp;NOPWindowBackend<br>
<br>
<br>
def&nbsp;collect_example_modules():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Собирает&nbsp;список&nbsp;модулей&nbsp;из&nbsp;examples/visual/*.py,<br>
&nbsp;&nbsp;&nbsp;&nbsp;которые&nbsp;содержат&nbsp;функцию&nbsp;main().<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;examples_dir&nbsp;=&nbsp;pathlib.Path(&quot;examples/visual&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;modules&nbsp;=&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;file&nbsp;in&nbsp;sorted(examples_dir.glob(&quot;*.py&quot;)):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;file.stem&nbsp;==&nbsp;&quot;__init__&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modname&nbsp;=&nbsp;&quot;examples.visual.&quot;&nbsp;+&nbsp;file.stem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules.append(modname)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;modules<br>
<br>
<br>
@pytest.mark.parametrize(&quot;module_name&quot;,&nbsp;collect_example_modules())<br>
def&nbsp;test_example_runs_one_frame(module_name,&nbsp;monkeypatch):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Тест&nbsp;запускает&nbsp;каждый&nbsp;example/*.py&nbsp;один&nbsp;раз&nbsp;с&nbsp;NOP-бекэндами<br>
&nbsp;&nbsp;&nbsp;&nbsp;и&nbsp;завершает&nbsp;его&nbsp;после&nbsp;первого&nbsp;кадра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;1.&nbsp;Завершать&nbsp;визуализацию&nbsp;после&nbsp;первого&nbsp;рендера&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;monkeypatch.setattr(world_module,&nbsp;&quot;CLOSE_AFTER_FIRST_FRAME&quot;,&nbsp;True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;2.&nbsp;Врубить&nbsp;NOP-бекэнды&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;set_default_graphics_backend(NOPGraphicsBackend())<br>
&nbsp;&nbsp;&nbsp;&nbsp;set_default_window_backend(NOPWindowBackend())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;3.&nbsp;Перехват&nbsp;Texture.from_file,&nbsp;чтобы&nbsp;не&nbsp;грузить&nbsp;реальные&nbsp;картинки&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;import&nbsp;termin.visualization.texture&nbsp;as&nbsp;texture_mod<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;monkeypatch.setattr(<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;texture_mod.Texture,<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;from_file&quot;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lambda&nbsp;path:&nbsp;texture_mod.Texture(image_data=None,&nbsp;size=(1,&nbsp;1)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;4.&nbsp;Перехват&nbsp;FontTextureAtlas,&nbsp;чтобы&nbsp;не&nbsp;загружать&nbsp;реальные&nbsp;TTF&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;from&nbsp;termin.visualization.ui.font&nbsp;import&nbsp;FontTextureAtlas<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;def&nbsp;fake_font_init(self,&nbsp;*a,&nbsp;**kw):<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tex&nbsp;=&nbsp;None<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;monkeypatch.setattr(FontTextureAtlas,&nbsp;&quot;__init__&quot;,&nbsp;fake_font_init)<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;monkeypatch.setattr(FontTextureAtlas,&nbsp;&quot;__getattr__&quot;,&nbsp;lambda&nbsp;*a,&nbsp;**k:&nbsp;None)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;---&nbsp;5.&nbsp;Импортируем&nbsp;модуль&nbsp;и&nbsp;запускаем&nbsp;его&nbsp;main()&nbsp;---<br>
&nbsp;&nbsp;&nbsp;&nbsp;module&nbsp;=&nbsp;importlib.import_module(module_name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;hasattr(module,&nbsp;&quot;main&quot;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;module.main()<br>
<!-- END SCAT CODE -->
</body>
</html>
