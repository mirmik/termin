<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/hqtasks_test.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.robot.hqsolver&nbsp;import&nbsp;HQPSolver,&nbsp;Level<br>
from&nbsp;termin.robot.hqtasks&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;JointTrackingTask,<br>
&nbsp;&nbsp;&nbsp;&nbsp;CartesianTrackingTask,<br>
&nbsp;&nbsp;&nbsp;&nbsp;JointEqualityConstraint,<br>
&nbsp;&nbsp;&nbsp;&nbsp;CartesianEqualityConstraint,<br>
&nbsp;&nbsp;&nbsp;&nbsp;JointBoundsConstraint,<br>
&nbsp;&nbsp;&nbsp;&nbsp;JointVelocityDampingTask,<br>
&nbsp;&nbsp;&nbsp;&nbsp;JointPositionBoundsConstraint,<br>
&nbsp;&nbsp;&nbsp;&nbsp;build_joint_soft_limit_task,<br>
)<br>
<br>
<br>
def&nbsp;test_joint_tracking_and_bounds_tasks():<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver&nbsp;=&nbsp;HQPSolver(n_vars=2)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl&nbsp;=&nbsp;Level(priority=0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl.add_task(JointTrackingTask(q_ref=[2.0,&nbsp;-1.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl.add_inequality(JointBoundsConstraint(lower=[-0.5,&nbsp;-0.5],&nbsp;upper=[1.0,&nbsp;0.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver.add_level(lvl)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;solver.solve()<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(x,&nbsp;[1.0,&nbsp;-0.5],&nbsp;atol=1e-7)<br>
<br>
<br>
def&nbsp;test_cartesian_tasks_with_equalities():<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver&nbsp;=&nbsp;HQPSolver(n_vars=3)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl0&nbsp;=&nbsp;Level(priority=0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sel&nbsp;=&nbsp;np.array([[1.0,&nbsp;0.0,&nbsp;0.0]])<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl0.add_equality(JointEqualityConstraint(q_target=[1.0,&nbsp;0.0,&nbsp;0.0],&nbsp;selection=sel))<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver.add_level(lvl0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl1&nbsp;=&nbsp;Level(priority=1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;J_cart&nbsp;=&nbsp;np.array([[0.0,&nbsp;1.0,&nbsp;0.0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0.0,&nbsp;0.0,&nbsp;1.0]])<br>
&nbsp;&nbsp;&nbsp;&nbsp;desired&nbsp;=&nbsp;np.array([2.0,&nbsp;-3.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl1.add_task(CartesianTrackingTask(J_cart,&nbsp;desired))<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl1.add_equality(CartesianEqualityConstraint(np.array([[0.0,&nbsp;1.0,&nbsp;1.0]]),&nbsp;np.array([0.0])))<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver.add_level(lvl1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;solver.solve()<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(x,&nbsp;[1.0,&nbsp;2.5,&nbsp;-2.5],&nbsp;atol=1e-7)<br>
<br>
<br>
def&nbsp;test_joint_velocity_damping_task_prefers_zero():<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver&nbsp;=&nbsp;HQPSolver(n_vars=1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl&nbsp;=&nbsp;Level(priority=0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl.add_task(JointTrackingTask(q_ref=[5.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;lvl.add_task(JointVelocityDampingTask(n_dofs=1,&nbsp;weight=np.array([10.0])))<br>
&nbsp;&nbsp;&nbsp;&nbsp;solver.add_level(lvl)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;solver.solve()<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(x,&nbsp;[10.0&nbsp;/&nbsp;22.0],&nbsp;atol=1e-9)<br>
<br>
<br>
def&nbsp;test_joint_position_bounds_constraint_builds_expected_matrices():<br>
&nbsp;&nbsp;&nbsp;&nbsp;q&nbsp;=&nbsp;np.array([0.5,&nbsp;-0.5])<br>
&nbsp;&nbsp;&nbsp;&nbsp;constraint&nbsp;=&nbsp;JointPositionBoundsConstraint(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_current=q,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lower=np.array([-1.0,&nbsp;-1.0]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;upper=np.array([1.0,&nbsp;1.0]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dt=0.5,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;expected_C&nbsp;=&nbsp;np.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0.5,&nbsp;0.0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0.0,&nbsp;0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-0.5,&nbsp;0.0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0.0,&nbsp;-0.5],<br>
&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;expected_d&nbsp;=&nbsp;np.array([0.5,&nbsp;1.5,&nbsp;1.5,&nbsp;0.5])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(constraint.C,&nbsp;expected_C)<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(constraint.d,&nbsp;expected_d)<br>
<br>
<br>
def&nbsp;test_build_joint_soft_limit_task():<br>
&nbsp;&nbsp;&nbsp;&nbsp;q&nbsp;=&nbsp;np.array([np.deg2rad(118.0),&nbsp;np.deg2rad(-118.0)])<br>
&nbsp;&nbsp;&nbsp;&nbsp;bounds&nbsp;=&nbsp;np.array([np.deg2rad(120.0),&nbsp;np.deg2rad(120.0)])<br>
&nbsp;&nbsp;&nbsp;&nbsp;task&nbsp;=&nbsp;build_joint_soft_limit_task(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q_current=q,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lower=-bounds,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;upper=bounds,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin=np.deg2rad(5.0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gain=2.0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;task&nbsp;is&nbsp;not&nbsp;None<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;task.J.shape[1]&nbsp;==&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Первый&nbsp;сустав&nbsp;должен&nbsp;отталкиваться&nbsp;в&nbsp;отрицательную&nbsp;сторону<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;task.v[0]&nbsp;&lt;&nbsp;0.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Второй&nbsp;сустав&nbsp;—&nbsp;в&nbsp;положительную<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;task.v[-1]&nbsp;&gt;&nbsp;0.0<br>
<!-- END SCAT CODE -->
</body>
</html>
