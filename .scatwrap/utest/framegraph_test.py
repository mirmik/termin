<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/framegraph_test.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#&nbsp;utest/framegraph_test.py<br>
<br>
import&nbsp;unittest<br>
<br>
from&nbsp;termin.visualization.framegraph&nbsp;import&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;FramePass,<br>
&nbsp;&nbsp;&nbsp;&nbsp;FrameGraph,<br>
&nbsp;&nbsp;&nbsp;&nbsp;FrameGraphCycleError,<br>
&nbsp;&nbsp;&nbsp;&nbsp;FrameGraphMultiWriterError,<br>
&nbsp;&nbsp;&nbsp;&nbsp;FrameGraphError,<br>
)<br>
<br>
<br>
class&nbsp;DummyPass(FramePass):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Тестовый&nbsp;пасс&nbsp;без&nbsp;реального&nbsp;исполнения.&quot;&quot;&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;pass_name,&nbsp;reads=None,&nbsp;writes=None,&nbsp;inplace=False):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass_name=pass_name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reads=set(reads&nbsp;or&nbsp;[]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writes=set(writes&nbsp;or&nbsp;[]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inplace=inplace,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;execute(self,&nbsp;*args,&nbsp;**kwargs):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;В&nbsp;тестах&nbsp;ничего&nbsp;не&nbsp;делаем<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<br>
<br>
<br>
class&nbsp;FrameGraphTests(unittest.TestCase):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_simple_linear_chain(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A&nbsp;-&gt;&nbsp;B&nbsp;-&gt;&nbsp;C<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;g1&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;g1&quot;},&nbsp;writes={&quot;g2&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;g2&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(set(names),&nbsp;{&quot;A&quot;,&nbsp;&quot;B&quot;,&nbsp;&quot;C&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;B&quot;),&nbsp;names.index(&quot;C&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_branching(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;A<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;/&nbsp;\<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;B&nbsp;&nbsp;&nbsp;C<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;\&nbsp;/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;D<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r1&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r1&quot;},&nbsp;writes={&quot;r2&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r1&quot;},&nbsp;writes={&quot;r3&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;r2&quot;,&nbsp;&quot;r3&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A&nbsp;должен&nbsp;быть&nbsp;до&nbsp;B&nbsp;и&nbsp;C<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;B&nbsp;и&nbsp;C&nbsp;должны&nbsp;быть&nbsp;до&nbsp;D<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;B&quot;),&nbsp;names.index(&quot;D&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;C&quot;),&nbsp;names.index(&quot;D&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_external_resource(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ресурс,&nbsp;который&nbsp;никто&nbsp;не&nbsp;пишет,&nbsp;но&nbsp;кто-то&nbsp;читает&nbsp;—&nbsp;считаем&nbsp;внешним&nbsp;входом<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;reads={&quot;external_x&quot;},&nbsp;writes={&quot;r1&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r1&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Никаких&nbsp;исключений&nbsp;не&nbsp;бросается<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_multi_writer_error(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Один&nbsp;и&nbsp;тот&nbsp;же&nbsp;ресурс&nbsp;пишет&nbsp;два&nbsp;пасса&nbsp;—&nbsp;это&nbsp;запрещаем.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r1&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;writes={&quot;r1&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;self.assertRaises(FrameGraphMultiWriterError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_cycle_detection(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;A&nbsp;пишет&nbsp;r1,&nbsp;читает&nbsp;r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;B&nbsp;пишет&nbsp;r2,&nbsp;читает&nbsp;r1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;reads={&quot;r2&quot;},&nbsp;writes={&quot;r1&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r1&quot;},&nbsp;writes={&quot;r2&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;self.assertRaises(FrameGraphCycleError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_pass_without_resources(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Пассы&nbsp;без&nbsp;reads/writes&nbsp;ни&nbsp;от&nbsp;чего&nbsp;не&nbsp;зависят<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Любой&nbsp;порядок&nbsp;валиден,&nbsp;главное&nbsp;—&nbsp;все&nbsp;на&nbsp;месте<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(set(names),&nbsp;{&quot;A&quot;,&nbsp;&quot;B&quot;,&nbsp;&quot;C&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_empty_graph(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(schedule,&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_d_last(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;x&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;y&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r_mod&quot;},&nbsp;inplace=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;D&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;D&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;D&quot;),&nbsp;names.index(&quot;C&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_d_last_another_order(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;x&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;y&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r_mod&quot;},&nbsp;inplace=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;d,&nbsp;c,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;D&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;D&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;D&quot;),&nbsp;names.index(&quot;C&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_chain(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;a&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;a&quot;},&nbsp;writes={&quot;b&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;b&quot;},&nbsp;writes={&quot;c&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;c&quot;},&nbsp;writes={&quot;d&quot;},&nbsp;inplace=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;B&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;C&quot;),&nbsp;names.index(&quot;D&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_must_fault(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;a&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;a&quot;},&nbsp;writes={&quot;b&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;b&quot;},&nbsp;writes={&quot;c&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;c&quot;},&nbsp;writes={&quot;d&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;DummyPass(&quot;E&quot;,&nbsp;reads={&quot;b&quot;},&nbsp;writes={&quot;e&quot;},&nbsp;inplace=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d,&nbsp;e])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;self.assertRaises(FrameGraphError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_after_all_readers(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;пишет&nbsp;r,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;и&nbsp;C&nbsp;читают&nbsp;r,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;inplace&nbsp;читает&nbsp;r&nbsp;и&nbsp;пишет&nbsp;r_mod.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ожидаем:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;A&nbsp;перед&nbsp;B,&nbsp;C,&nbsp;D;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;D&nbsp;после&nbsp;B&nbsp;и&nbsp;C&nbsp;(т.е.&nbsp;сначала&nbsp;все&nbsp;читатели&nbsp;исходного&nbsp;состояния&nbsp;ресурса,&nbsp;потом&nbsp;модификатор).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;x&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;y&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r_mod&quot;},&nbsp;inplace=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;D&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;D&nbsp;(модифицирующий)&nbsp;должен&nbsp;быть&nbsp;самым&nbsp;поздним&nbsp;потребителем&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;D&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;D&quot;),&nbsp;names.index(&quot;C&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_with_readers_of_modified_resource(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;пишет&nbsp;r,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;inplace:&nbsp;r&nbsp;-&gt;&nbsp;r_mod,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;и&nbsp;D&nbsp;читают&nbsp;r_mod.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Здесь&nbsp;важно,&nbsp;что:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;B&nbsp;идёт&nbsp;после&nbsp;A&nbsp;(по&nbsp;зависимости),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;C&nbsp;и&nbsp;D&nbsp;идут&nbsp;после&nbsp;B&nbsp;(потребляют&nbsp;модифицированное&nbsp;состояние).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r_mod&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r_mod&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;r_mod&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;B&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;B&quot;),&nbsp;names.index(&quot;D&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_between_two_readers_on_same_resource(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;пишет&nbsp;r,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;читает&nbsp;r,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;inplace:&nbsp;r&nbsp;-&gt;&nbsp;r_mod,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;читает&nbsp;r_mod,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;читает&nbsp;r.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ожидаем:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;A&nbsp;перед&nbsp;всеми;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;C&nbsp;(inplace)&nbsp;после&nbsp;всех&nbsp;читателей&nbsp;r&nbsp;(B&nbsp;и&nbsp;E),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;но&nbsp;до&nbsp;D,&nbsp;который&nbsp;потребляет&nbsp;r_mod.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r_mod&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;DummyPass(&quot;D&quot;,&nbsp;reads={&quot;r_mod&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;DummyPass(&quot;E&quot;,&nbsp;reads={&quot;r&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c,&nbsp;d,&nbsp;e])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;C&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;D&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;E&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;C&nbsp;должен&nbsp;быть&nbsp;самым&nbsp;поздним&nbsp;читателем&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;C&quot;),&nbsp;names.index(&quot;B&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertGreater(names.index(&quot;C&quot;),&nbsp;names.index(&quot;E&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;D&nbsp;уже&nbsp;читает&nbsp;r_mod,&nbsp;поэтому&nbsp;после&nbsp;C<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;C&quot;),&nbsp;names.index(&quot;D&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_from_external_resource(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Внешний&nbsp;ресурс&nbsp;ext&nbsp;никто&nbsp;не&nbsp;пишет,&nbsp;но&nbsp;inplace-пасс&nbsp;его&nbsp;читает&nbsp;и&nbsp;пишет&nbsp;новый&nbsp;ресурс&nbsp;r.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Это&nbsp;должно&nbsp;считаться&nbsp;валидным&nbsp;(ext&nbsp;—&nbsp;внешний&nbsp;вход),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;главное,&nbsp;чтобы&nbsp;порядок&nbsp;зависимости&nbsp;ext-&gt;r&nbsp;не&nbsp;ломал&nbsp;граф.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;reads={&quot;ext&quot;},&nbsp;writes={&quot;r&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule&nbsp;=&nbsp;g.build_schedule()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;=&nbsp;[p.pass_name&nbsp;for&nbsp;p&nbsp;in&nbsp;schedule]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Просто&nbsp;проверяем,&nbsp;что&nbsp;порядок&nbsp;зависимостей&nbsp;соблюдён<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertLess(names.index(&quot;A&quot;),&nbsp;names.index(&quot;B&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_inplace_and_normal_writer_conflict(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Проверяем&nbsp;конфликт&nbsp;между&nbsp;обычным&nbsp;writer&nbsp;и&nbsp;inplace-writerом,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;пишущими&nbsp;одно&nbsp;и&nbsp;то&nbsp;же&nbsp;имя&nbsp;ресурса.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r&quot;},&nbsp;inplace=True)&nbsp;&nbsp;#&nbsp;пишет&nbsp;тот&nbsp;же&nbsp;ресурс<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Должен&nbsp;сработать&nbsp;MultiWriter,&nbsp;а&nbsp;не&nbsp;какая-нибудь&nbsp;странная&nbsp;другая&nbsp;ошибка<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;self.assertRaises(FrameGraphMultiWriterError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_cycle_with_inplace(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;inplace:&nbsp;читает&nbsp;r,&nbsp;пишет&nbsp;r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B:&nbsp;читает&nbsp;r2,&nbsp;пишет&nbsp;r<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Это&nbsp;явный&nbsp;цикл&nbsp;по&nbsp;данным,&nbsp;его&nbsp;должен&nbsp;поймать&nbsp;детектор&nbsp;циклов.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r2&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r2&quot;},&nbsp;writes={&quot;r&quot;})<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;self.assertRaises(FrameGraphCycleError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.build_schedule()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_two_inplace_on_same_input_must_fail(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Два&nbsp;inplace&nbsp;пасса,&nbsp;висящих&nbsp;на&nbsp;одном&nbsp;и&nbsp;том&nbsp;же&nbsp;входном&nbsp;ресурсе,&nbsp;—&nbsp;запрещены.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;пишет&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;inplace:&nbsp;r&nbsp;-&gt;&nbsp;r1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;inplace:&nbsp;r&nbsp;-&gt;&nbsp;r2&nbsp;&nbsp;&nbsp;(второй&nbsp;модификатор&nbsp;того&nbsp;же&nbsp;источника)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;DummyPass(&quot;A&quot;,&nbsp;writes={&quot;r&quot;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;DummyPass(&quot;B&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r1&quot;},&nbsp;inplace=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyPass(&quot;C&quot;,&nbsp;reads={&quot;r&quot;},&nbsp;writes={&quot;r2&quot;},&nbsp;inplace=True)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g&nbsp;=&nbsp;FrameGraph([a,&nbsp;b,&nbsp;c])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;self.assertRaises(FrameGraphError):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.build_schedule()<br>
<br>
<br>
if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;unittest.main()<br>
<!-- END SCAT CODE -->
</body>
</html>
