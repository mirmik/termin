<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/test_screen_point_to_ray.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
import&nbsp;pytest<br>
<br>
from&nbsp;termin.visualization&nbsp;import&nbsp;Entity,&nbsp;Scene<br>
from&nbsp;termin.visualization.camera&nbsp;import&nbsp;PerspectiveCameraComponent<br>
from&nbsp;termin.geombase.pose3&nbsp;import&nbsp;Pose3<br>
from&nbsp;termin.colliders.sphere&nbsp;import&nbsp;SphereCollider<br>
<br>
<br>
def&nbsp;build_basic_camera():<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity&nbsp;=&nbsp;Entity(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pose=Pose3(lin=np.array([0.0,&nbsp;0.0,&nbsp;0.0])),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;camera&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam&nbsp;=&nbsp;PerspectiveCameraComponent()<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity.add_component(cam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cam_entity,&nbsp;cam<br>
<br>
<br>
def&nbsp;test_center_ray_direction_forward():<br>
&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;800,&nbsp;600<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport&nbsp;=&nbsp;(0,&nbsp;0,&nbsp;w,&nbsp;h)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity,&nbsp;cam&nbsp;=&nbsp;build_basic_camera()<br>
&nbsp;&nbsp;&nbsp;&nbsp;ray&nbsp;=&nbsp;cam.screen_point_to_ray(w&nbsp;*&nbsp;0.5,&nbsp;h&nbsp;*&nbsp;0.5,&nbsp;viewport)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;forward&nbsp;=&nbsp;np.array([0,&nbsp;0,&nbsp;-1],&nbsp;dtype=float)<br>
&nbsp;&nbsp;&nbsp;&nbsp;dot&nbsp;=&nbsp;np.dot(ray.direction&nbsp;/&nbsp;np.linalg.norm(ray.direction),&nbsp;forward)<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;dot&nbsp;&gt;&nbsp;0.99,&nbsp;f&quot;Bad&nbsp;direction:&nbsp;{ray.direction},&nbsp;dot={dot}&quot;<br>
<br>
<br>
def&nbsp;test_left_right_ray_symmetry():<br>
&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;800,&nbsp;600<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport&nbsp;=&nbsp;(0,&nbsp;0,&nbsp;w,&nbsp;h)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity,&nbsp;cam&nbsp;=&nbsp;build_basic_camera()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ray_left&nbsp;=&nbsp;cam.screen_point_to_ray(0,&nbsp;h&nbsp;*&nbsp;0.5,&nbsp;viewport)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ray_right&nbsp;=&nbsp;cam.screen_point_to_ray(w,&nbsp;h&nbsp;*&nbsp;0.5,&nbsp;viewport)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;pytest.approx(ray_left.direction[0],&nbsp;rel=1e-3)&nbsp;==&nbsp;-ray_right.direction[0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;pytest.approx(ray_left.direction[1],&nbsp;rel=1e-3)&nbsp;==&nbsp;ray_right.direction[1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;pytest.approx(ray_left.direction[2],&nbsp;rel=1e-3)&nbsp;==&nbsp;ray_right.direction[2]<br>
<br>
<br>
def&nbsp;test_top_bottom_symmetry():<br>
&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;800,&nbsp;600<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport&nbsp;=&nbsp;(0,&nbsp;0,&nbsp;w,&nbsp;h)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity,&nbsp;cam&nbsp;=&nbsp;build_basic_camera()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ray_top&nbsp;=&nbsp;cam.screen_point_to_ray(w&nbsp;*&nbsp;0.5,&nbsp;0,&nbsp;viewport)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ray_bottom&nbsp;=&nbsp;cam.screen_point_to_ray(w&nbsp;*&nbsp;0.5,&nbsp;h,&nbsp;viewport)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;pytest.approx(ray_top.direction[1],&nbsp;rel=1e-3)&nbsp;==&nbsp;-ray_bottom.direction[1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;pytest.approx(ray_top.direction[0],&nbsp;rel=1e-3)&nbsp;==&nbsp;ray_bottom.direction[0]<br>
<br>
<br>
def&nbsp;test_raycast_center_hits_object():<br>
&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;800,&nbsp;600<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport&nbsp;=&nbsp;(0,&nbsp;0,&nbsp;w,&nbsp;h)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene&nbsp;=&nbsp;Scene()<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity,&nbsp;cam&nbsp;=&nbsp;build_basic_camera()<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene.add(cam_entity)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;obj&nbsp;=&nbsp;Entity(pose=Pose3(lin=np.array([0.0,&nbsp;0.0,&nbsp;-5.0])),&nbsp;name=&quot;obj&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;sphere&nbsp;=&nbsp;SphereCollider(np.array([0.0,&nbsp;0.0,&nbsp;-5.0]),&nbsp;1.0)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;termin.colliders.collider_component&nbsp;import&nbsp;ColliderComponent<br>
&nbsp;&nbsp;&nbsp;&nbsp;obj.add_component(ColliderComponent(sphere))<br>
&nbsp;&nbsp;&nbsp;&nbsp;scene.add(obj)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ray&nbsp;=&nbsp;cam.screen_point_to_ray(w&nbsp;*&nbsp;0.5,&nbsp;h&nbsp;*&nbsp;0.5,&nbsp;viewport)<br>
&nbsp;&nbsp;&nbsp;&nbsp;hit&nbsp;=&nbsp;scene.raycast(ray)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;hit&nbsp;is&nbsp;not&nbsp;None,&nbsp;&quot;Raycast&nbsp;failed&nbsp;to&nbsp;hit&nbsp;the&nbsp;object&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;hit.entity.name&nbsp;==&nbsp;&quot;obj&quot;<br>
<br>
<br>
def&nbsp;test_screen_edges_not_nan():<br>
&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;h&nbsp;=&nbsp;800,&nbsp;600<br>
&nbsp;&nbsp;&nbsp;&nbsp;viewport&nbsp;=&nbsp;(0,&nbsp;0,&nbsp;w,&nbsp;h)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;cam_entity,&nbsp;cam&nbsp;=&nbsp;build_basic_camera()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;edges&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(0,&nbsp;0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(0,&nbsp;h),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(w,&nbsp;0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(w,&nbsp;h),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(w&nbsp;//&nbsp;2,&nbsp;0),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(0,&nbsp;h&nbsp;//&nbsp;2),<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;x,&nbsp;y&nbsp;in&nbsp;edges:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ray&nbsp;=&nbsp;cam.screen_point_to_ray(x,&nbsp;y,&nbsp;viewport)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;not&nbsp;np.isnan(ray.direction).any()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;not&nbsp;np.isnan(ray.origin).any()<br>
<!-- END SCAT CODE -->
</body>
</html>
