<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/robot_test.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
<br>
from&nbsp;termin.geombase&nbsp;import&nbsp;Pose3<br>
from&nbsp;termin.kinematic.kinematic&nbsp;import&nbsp;Rotator3<br>
from&nbsp;termin.kinematic.transform&nbsp;import&nbsp;Transform3<br>
from&nbsp;termin.robot.robot&nbsp;import&nbsp;Robot<br>
from&nbsp;termin.robot.hqsolver&nbsp;import&nbsp;HQPSolver,&nbsp;Level,&nbsp;QuadraticTask<br>
from&nbsp;termin.kinematic.kinchain&nbsp;import&nbsp;KinematicChain3<br>
<br>
<br>
def&nbsp;_build_two_link_tree():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;=&nbsp;Transform3(name=&quot;base&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;j0&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;0.0,&nbsp;1.0]),&nbsp;parent=base,&nbsp;name=&quot;j0&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;link0&nbsp;=&nbsp;Transform3(parent=j0.output,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;0.4),&nbsp;name=&quot;link0&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;j1&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;1.0,&nbsp;0.0]),&nbsp;parent=link0,&nbsp;name=&quot;j1&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ee&nbsp;=&nbsp;Transform3(parent=j1.output,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;0.2),&nbsp;name=&quot;ee&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Дополнительная&nbsp;ветвь&nbsp;для&nbsp;проверки,&nbsp;что&nbsp;лишние&nbsp;пары&nbsp;индексируются,&nbsp;но&nbsp;не&nbsp;влияют<br>
&nbsp;&nbsp;&nbsp;&nbsp;j_branch&nbsp;=&nbsp;Rotator3(axis=np.array([1.0,&nbsp;0.0,&nbsp;0.0]),&nbsp;parent=base,&nbsp;name=&quot;j_branch&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;Transform3(parent=j_branch.output,&nbsp;local_pose=Pose3.translation(0.3,&nbsp;0.0,&nbsp;0.0),&nbsp;name=&quot;branch_tip&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;base,&nbsp;ee,&nbsp;j0,&nbsp;j1,&nbsp;j_branch<br>
<br>
<br>
def&nbsp;_build_two_link_tree_2():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;=&nbsp;Transform3(name=&quot;base&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;j0&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;0.0,&nbsp;1.0]),&nbsp;parent=base,&nbsp;name=&quot;j0&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;link0&nbsp;=&nbsp;Transform3(parent=j0.output,&nbsp;local_pose=Pose3.translation(1.0,&nbsp;0.0,&nbsp;0.0),&nbsp;name=&quot;link0&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;j1&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;0.0,&nbsp;1.0]),&nbsp;parent=link0,&nbsp;name=&quot;j1&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ee&nbsp;=&nbsp;Transform3(parent=j1.output,&nbsp;local_pose=Pose3.translation(1.0,&nbsp;0.0,&nbsp;0.0),&nbsp;name=&quot;ee&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Уводим&nbsp;конфигурацию&nbsp;от&nbsp;сингулярного&nbsp;положения,&nbsp;чтобы&nbsp;Якобиан&nbsp;был&nbsp;полноранговым.<br>
&nbsp;&nbsp;&nbsp;&nbsp;j0.set_coord(0.1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;j1.set_coord(-0.1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;base,&nbsp;ee,&nbsp;j0,&nbsp;j1<br>
<br>
<br>
def&nbsp;_build_multi_branch_tree():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;=&nbsp;Transform3(name=&quot;base&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;waist&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;0.0,&nbsp;1.0]),&nbsp;parent=base,&nbsp;name=&quot;waist&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;torso&nbsp;=&nbsp;Transform3(parent=waist.output,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;0.3),&nbsp;name=&quot;torso&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;left_mount&nbsp;=&nbsp;Transform3(parent=torso,&nbsp;local_pose=Pose3.translation(-0.15,&nbsp;0.0,&nbsp;0.0),&nbsp;name=&quot;left_mount&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;j_left_shoulder&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;1.0,&nbsp;0.0]),&nbsp;parent=left_mount,&nbsp;name=&quot;l_sh&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;j_left_elbow&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;1.0,&nbsp;0.0]),&nbsp;parent=j_left_shoulder.output,&nbsp;name=&quot;l_el&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;left_ee&nbsp;=&nbsp;Transform3(parent=j_left_elbow.output,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;0.25),&nbsp;name=&quot;left_ee&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;right_mount&nbsp;=&nbsp;Transform3(parent=torso,&nbsp;local_pose=Pose3.translation(0.15,&nbsp;0.0,&nbsp;0.0),&nbsp;name=&quot;right_mount&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;j_right_shoulder&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;1.0,&nbsp;0.0]),&nbsp;parent=right_mount,&nbsp;name=&quot;r_sh&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;j_right_elbow&nbsp;=&nbsp;Rotator3(axis=np.array([0.0,&nbsp;1.0,&nbsp;0.0]),&nbsp;parent=j_right_shoulder.output,&nbsp;name=&quot;r_el&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;right_ee&nbsp;=&nbsp;Transform3(parent=j_right_elbow.output,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;0.25),&nbsp;name=&quot;right_ee&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;leg_mount&nbsp;=&nbsp;Transform3(parent=base,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;-0.2),&nbsp;name=&quot;leg_mount&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;j_leg&nbsp;=&nbsp;Rotator3(axis=np.array([1.0,&nbsp;0.0,&nbsp;0.0]),&nbsp;parent=leg_mount,&nbsp;name=&quot;leg_joint&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;Transform3(parent=j_leg.output,&nbsp;local_pose=Pose3.translation(0.0,&nbsp;0.0,&nbsp;-0.4),&nbsp;name=&quot;leg_tip&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;joints&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;waist&quot;:&nbsp;waist,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;l_sh&quot;:&nbsp;j_left_shoulder,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;l_el&quot;:&nbsp;j_left_elbow,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;r_sh&quot;:&nbsp;j_right_shoulder,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;r_el&quot;:&nbsp;j_right_elbow,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;leg&quot;:&nbsp;j_leg,<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;effectors&nbsp;=&nbsp;{&quot;left&quot;:&nbsp;left_ee,&nbsp;&quot;right&quot;:&nbsp;right_ee}<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;base,&nbsp;joints,&nbsp;effectors<br>
<br>
<br>
def&nbsp;test_robot_sensitivity_matches_chain():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base,&nbsp;ee,&nbsp;*_&nbsp;=&nbsp;_build_two_link_tree()<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot&nbsp;=&nbsp;Robot(base)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;chain&nbsp;=&nbsp;KinematicChain3(distal=ee,&nbsp;proximal=base)<br>
&nbsp;&nbsp;&nbsp;&nbsp;chain_twists&nbsp;=&nbsp;chain.sensitivity_twists(topbody=ee)<br>
&nbsp;&nbsp;&nbsp;&nbsp;chain_units&nbsp;=&nbsp;chain.kinunits()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot_twists&nbsp;=&nbsp;robot.sensitivity_twists(ee)<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;set(robot_twists.keys())&nbsp;==&nbsp;set(chain_units)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1&nbsp;DOF&nbsp;на&nbsp;сустав&nbsp;→&nbsp;массивы&nbsp;сравниваем&nbsp;по&nbsp;одному&nbsp;твисту<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;joint,&nbsp;screw&nbsp;in&nbsp;zip(chain_units,&nbsp;chain_twists):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joint_twist&nbsp;=&nbsp;robot_twists[joint][0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(joint_twist.ang,&nbsp;screw.ang,&nbsp;atol=1e-9)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(joint_twist.lin,&nbsp;screw.lin,&nbsp;atol=1e-9)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;expected&nbsp;=&nbsp;np.zeros((6,&nbsp;robot.dofs))<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;joint,&nbsp;twists&nbsp;in&nbsp;robot_twists.items():<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sl&nbsp;=&nbsp;robot.joint_slice(joint)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i,&nbsp;twist&nbsp;in&nbsp;enumerate(twists):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected[0:3,&nbsp;sl.start&nbsp;+&nbsp;i]&nbsp;=&nbsp;twist.ang<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected[3:6,&nbsp;sl.start&nbsp;+&nbsp;i]&nbsp;=&nbsp;twist.lin<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(robot.jacobian(ee),&nbsp;expected,&nbsp;atol=1e-9)<br>
<br>
<br>
def&nbsp;test_robot_handles_branching_indices():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base,&nbsp;ee,&nbsp;j0,&nbsp;j1,&nbsp;j_branch&nbsp;=&nbsp;_build_two_link_tree()<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot&nbsp;=&nbsp;Robot(base)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;twists&nbsp;=&nbsp;robot.sensitivity_twists(ee)<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;set(twists.keys())&nbsp;==&nbsp;{j0,&nbsp;j1}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;jac&nbsp;=&nbsp;robot.jacobian(ee)<br>
&nbsp;&nbsp;&nbsp;&nbsp;branch_slice&nbsp;=&nbsp;robot.joint_slice(j_branch)<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(jac[:,&nbsp;branch_slice],&nbsp;np.zeros((6,&nbsp;branch_slice.stop&nbsp;-&nbsp;branch_slice.start)),&nbsp;atol=1e-12)<br>
<br>
<br>
def&nbsp;test_robot_multi_branch_selection():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base,&nbsp;joints,&nbsp;effectors&nbsp;=&nbsp;_build_multi_branch_tree()<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot&nbsp;=&nbsp;Robot(base)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;left_twists&nbsp;=&nbsp;robot.sensitivity_twists(effectors[&quot;left&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;set(left_twists.keys())&nbsp;==&nbsp;{joints[&quot;waist&quot;],&nbsp;joints[&quot;l_sh&quot;],&nbsp;joints[&quot;l_el&quot;]}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;right_twists&nbsp;=&nbsp;robot.sensitivity_twists(effectors[&quot;right&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;set(right_twists.keys())&nbsp;==&nbsp;{joints[&quot;waist&quot;],&nbsp;joints[&quot;r_sh&quot;],&nbsp;joints[&quot;r_el&quot;]}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;left_jac&nbsp;=&nbsp;robot.jacobian(effectors[&quot;left&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;right_jac&nbsp;=&nbsp;robot.jacobian(effectors[&quot;right&quot;])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;irrelevant&nbsp;in&nbsp;[&quot;r_sh&quot;,&nbsp;&quot;r_el&quot;,&nbsp;&quot;leg&quot;]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sl&nbsp;=&nbsp;robot.joint_slice(joints[irrelevant])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(left_jac[:,&nbsp;sl],&nbsp;0.0,&nbsp;atol=1e-12)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;irrelevant&nbsp;in&nbsp;[&quot;l_sh&quot;,&nbsp;&quot;l_el&quot;,&nbsp;&quot;leg&quot;]:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sl&nbsp;=&nbsp;robot.joint_slice(joints[irrelevant])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_allclose(right_jac[:,&nbsp;sl],&nbsp;0.0,&nbsp;atol=1e-12)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;waist_slice&nbsp;=&nbsp;robot.joint_slice(joints[&quot;waist&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;np.linalg.norm(left_jac[:,&nbsp;waist_slice])&nbsp;&gt;&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;np.linalg.norm(right_jac[:,&nbsp;waist_slice])&nbsp;&gt;&nbsp;0<br>
<br>
<br>
def&nbsp;test_robot_integrate_joint_speeds():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base,&nbsp;joints,&nbsp;_&nbsp;=&nbsp;_build_multi_branch_tree()<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot&nbsp;=&nbsp;Robot(base)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;speeds&nbsp;=&nbsp;np.zeros(robot.dofs)<br>
&nbsp;&nbsp;&nbsp;&nbsp;slice_leg&nbsp;=&nbsp;robot.joint_slice(joints[&quot;leg&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;speeds[slice_leg]&nbsp;=&nbsp;1.5&nbsp;&nbsp;#&nbsp;rad/s<br>
&nbsp;&nbsp;&nbsp;&nbsp;slice_waist&nbsp;=&nbsp;robot.joint_slice(joints[&quot;waist&quot;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;speeds[slice_waist]&nbsp;=&nbsp;-0.25<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot.integrate_joint_speeds(speeds,&nbsp;dt=0.2)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;np.isclose(joints[&quot;leg&quot;].get_coord(),&nbsp;0.3)<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;np.isclose(joints[&quot;waist&quot;].get_coord(),&nbsp;-0.05)<br>
<br>
<br>
def&nbsp;test_robot_hqp_reaches_point():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base,&nbsp;ee,&nbsp;*_&nbsp;=&nbsp;_build_two_link_tree()<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot&nbsp;=&nbsp;Robot(base)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;=&nbsp;np.array([0.08,&nbsp;0.08,&nbsp;0.56])<br>
&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;=&nbsp;0.2<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;_&nbsp;in&nbsp;range(60):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current&nbsp;=&nbsp;ee.global_pose().lin<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;target&nbsp;-&nbsp;current<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;np.linalg.norm(err)&nbsp;&lt;&nbsp;1e-4:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;solver&nbsp;=&nbsp;HQPSolver(n_vars=robot.dofs)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lvl&nbsp;=&nbsp;Level(priority=0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J&nbsp;=&nbsp;robot.translation_jacobian(ee)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lvl.add_task(QuadraticTask(J,&nbsp;err))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;solver.add_level(lvl)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;solver.solve()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;robot.integrate_joint_speeds(delta,&nbsp;dt)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;np.linalg.norm(target&nbsp;-&nbsp;ee.global_pose().lin)&nbsp;&lt;&nbsp;5e-3<br>
<br>
<br>
def&nbsp;test_robot_hqp_reaches_point_2():<br>
&nbsp;&nbsp;&nbsp;&nbsp;base,&nbsp;ee,&nbsp;*_&nbsp;=&nbsp;_build_two_link_tree_2()<br>
&nbsp;&nbsp;&nbsp;&nbsp;robot&nbsp;=&nbsp;Robot(base)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;=&nbsp;np.array([0.5,&nbsp;0.5,&nbsp;0.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;=&nbsp;0.2<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;_&nbsp;in&nbsp;range(600):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current&nbsp;=&nbsp;ee.global_pose().lin<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;target&nbsp;-&nbsp;current<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;np.linalg.norm(err)&nbsp;&lt;&nbsp;1e-4:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;solver&nbsp;=&nbsp;HQPSolver(n_vars=robot.dofs)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lvl&nbsp;=&nbsp;Level(priority=0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J&nbsp;=&nbsp;robot.translation_jacobian(ee)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;J.shape&nbsp;==&nbsp;(3,&nbsp;2)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signal&nbsp;=&nbsp;err&nbsp;*&nbsp;0.1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lvl.add_task(QuadraticTask(J,&nbsp;signal))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;solver.add_level(lvl)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;solver.solve()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;robot.integrate_joint_speeds(delta,&nbsp;dt)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&quot;EE&nbsp;pos:&nbsp;{ee.global_pose().lin},&nbsp;err&nbsp;norm:&nbsp;{np.linalg.norm(err)}&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;np.linalg.norm(target&nbsp;-&nbsp;ee.global_pose().lin)&nbsp;&lt;&nbsp;5e-3<br>
<!-- END SCAT CODE -->
</body>
</html>
