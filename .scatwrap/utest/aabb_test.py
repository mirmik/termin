<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/aabb_test.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
from&nbsp;termin.kinematic&nbsp;import&nbsp;Transform<br>
from&nbsp;termin.geombase&nbsp;import&nbsp;Pose3,&nbsp;AABB,&nbsp;TransformAABB<br>
import&nbsp;unittest<br>
import&nbsp;numpy<br>
<br>
class&nbsp;AABBTest(unittest.TestCase):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_aabb_creation(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;points&nbsp;=&nbsp;numpy.array([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1.0,&nbsp;2.0,&nbsp;3.0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[4.0,&nbsp;5.0,&nbsp;6.0],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-1.0,&nbsp;-2.0,&nbsp;-3.0]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb&nbsp;=&nbsp;AABB.from_points(points)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_min&nbsp;=&nbsp;numpy.array([-1.0,&nbsp;-2.0,&nbsp;-3.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_max&nbsp;=&nbsp;numpy.array([4.0,&nbsp;5.0,&nbsp;6.0])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(aabb.min_point,&nbsp;expected_min)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(aabb.max_point,&nbsp;expected_max)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_aabb_merge(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb1&nbsp;=&nbsp;AABB(numpy.array([0.0,&nbsp;0.0,&nbsp;0.0]),&nbsp;numpy.array([1.0,&nbsp;1.0,&nbsp;1.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb2&nbsp;=&nbsp;AABB(numpy.array([0.5,&nbsp;0.5,&nbsp;0.5]),&nbsp;numpy.array([2.0,&nbsp;2.0,&nbsp;2.0]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;merged_aabb&nbsp;=&nbsp;aabb1.merge(aabb2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_min&nbsp;=&nbsp;numpy.array([0.0,&nbsp;0.0,&nbsp;0.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_max&nbsp;=&nbsp;numpy.array([2.0,&nbsp;2.0,&nbsp;2.0])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(merged_aabb.min_point,&nbsp;expected_min)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(merged_aabb.max_point,&nbsp;expected_max)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_intersects(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb1&nbsp;=&nbsp;AABB(numpy.array([0.0,&nbsp;0.0]),&nbsp;numpy.array([1.0,&nbsp;1.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb2&nbsp;=&nbsp;AABB(numpy.array([0.5,&nbsp;0.5]),&nbsp;numpy.array([1.5,&nbsp;1.5]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb3&nbsp;=&nbsp;AABB(numpy.array([2.0,&nbsp;2.0]),&nbsp;numpy.array([3.0,&nbsp;3.0]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertTrue(aabb1.intersects(aabb2))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertFalse(aabb1.intersects(aabb3))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb4&nbsp;=&nbsp;AABB(numpy.array([-0.5,&nbsp;0.5]),&nbsp;numpy.array([0.5,&nbsp;1.5]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertTrue(aabb1.intersects(aabb4))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_transform_aabb(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transform&nbsp;=&nbsp;Transform(Pose3.identity())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aabb&nbsp;=&nbsp;AABB(numpy.array([-1.0,&nbsp;-1.0,&nbsp;-1.0]),&nbsp;numpy.array([1.0,&nbsp;1.0,&nbsp;1.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;taabb&nbsp;=&nbsp;TransformAABB(transform,&nbsp;aabb)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compiled_aabb&nbsp;=&nbsp;taabb.compile_tree_aabb()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.min_point,&nbsp;aabb.min_point)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.max_point,&nbsp;aabb.max_point)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_transform_aabb_with_children(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_transform&nbsp;=&nbsp;Transform(Pose3.identity())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_transform&nbsp;=&nbsp;Transform(Pose3.identity(),&nbsp;parent=parent_transform)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_aabb&nbsp;=&nbsp;AABB(numpy.array([-2.0,&nbsp;-2.0,&nbsp;-2.0]),&nbsp;numpy.array([2.0,&nbsp;2.0,&nbsp;2.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_aabb&nbsp;=&nbsp;AABB(numpy.array([-1.0,&nbsp;-1.0,&nbsp;-1.0]),&nbsp;numpy.array([1.0,&nbsp;1.0,&nbsp;1.0]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_taabb&nbsp;=&nbsp;TransformAABB(parent_transform,&nbsp;parent_aabb)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_taabb&nbsp;=&nbsp;TransformAABB(child_transform,&nbsp;child_aabb)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compiled_aabb&nbsp;=&nbsp;parent_taabb.compile_tree_aabb()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_min&nbsp;=&nbsp;numpy.array([-2.0,&nbsp;-2.0,&nbsp;-2.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_max&nbsp;=&nbsp;numpy.array([2.0,&nbsp;2.0,&nbsp;2.0])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.min_point,&nbsp;expected_min)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.max_point,&nbsp;expected_max)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.max_point,&nbsp;expected_max)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test_transform_aabb_with_children_with_latest_relocation(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_transform&nbsp;=&nbsp;Transform(Pose3.identity())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_transform&nbsp;=&nbsp;Transform(Pose3.identity(),&nbsp;parent=parent_transform)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_transform._version_for_walking_to_distal,&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_transform._version_only_my,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_transform._version_for_walking_to_proximal,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(child_transform._version_for_walking_to_distal,&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(child_transform._version_only_my,&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(child_transform._version_for_walking_to_proximal,&nbsp;1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_aabb&nbsp;=&nbsp;AABB(numpy.array([-2.0,&nbsp;-2.0,&nbsp;-2.0]),&nbsp;numpy.array([2.0,&nbsp;2.0,&nbsp;2.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_aabb&nbsp;=&nbsp;AABB(numpy.array([-1.0,&nbsp;-1.0,&nbsp;-1.0]),&nbsp;numpy.array([1.0,&nbsp;1.0,&nbsp;1.0]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_taabb&nbsp;=&nbsp;TransformAABB(parent_transform,&nbsp;parent_aabb)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_taabb&nbsp;=&nbsp;TransformAABB(child_transform,&nbsp;child_aabb)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_taabb._last_tree_inspected_version,&nbsp;-1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Initial&nbsp;compilation<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compiled_aabb&nbsp;=&nbsp;parent_taabb.compile_tree_aabb()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_taabb._last_tree_inspected_version,&nbsp;1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.min_point,&nbsp;numpy.array([-2.0,&nbsp;-2.0,&nbsp;-2.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb.max_point,&nbsp;numpy.array([2.0,&nbsp;2.0,&nbsp;2.0]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Move&nbsp;child&nbsp;transform<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_transform.relocate(Pose3(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ang=numpy.array([0.0,&nbsp;0.0,&nbsp;0.0,&nbsp;1.0]),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lin=numpy.array([3.0,&nbsp;0.0,&nbsp;0.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;check&nbsp;versions&nbsp;of&nbsp;transforms<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_transform._version_for_walking_to_distal,&nbsp;2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_transform._version_only_my,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(parent_transform._version_for_walking_to_proximal,&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(child_transform._version_for_walking_to_distal,&nbsp;2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(child_transform._version_only_my,&nbsp;2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.assertEqual(child_transform._version_for_walking_to_proximal,&nbsp;2)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_world_aabb&nbsp;=&nbsp;child_taabb.get_world_aabb()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(child_world_aabb.min_point,&nbsp;numpy.array([2.0,&nbsp;-1.0,&nbsp;-1.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(child_world_aabb.max_point,&nbsp;numpy.array([4.0,&nbsp;1.0,&nbsp;1.0]))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Recompile&nbsp;after&nbsp;relocation<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compiled_aabb_after_move&nbsp;=&nbsp;parent_taabb.compile_tree_aabb()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_min_after_move&nbsp;=&nbsp;numpy.array([-2.0,&nbsp;-2.0,&nbsp;-2.0])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected_max_after_move&nbsp;=&nbsp;numpy.array([4.0,&nbsp;2.0,&nbsp;2.0])<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb_after_move.min_point,&nbsp;expected_min_after_move)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numpy.testing.assert_array_equal(compiled_aabb_after_move.max_point,&nbsp;expected_max_after_move)<br>
<!-- END SCAT CODE -->
</body>
</html>
