<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>utest/serialize_test.py</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
import&nbsp;numpy&nbsp;as&nbsp;np<br>
from&nbsp;termin.visualization.material&nbsp;import&nbsp;Material<br>
from&nbsp;termin.visualization.shader&nbsp;import&nbsp;ShaderProgram<br>
<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
from&nbsp;termin.visualization.serialization&nbsp;import&nbsp;serializable<br>
from&nbsp;termin.visualization.entity&nbsp;import&nbsp;Component<br>
<br>
import&nbsp;numpy&nbsp;as&nbsp;np<br>
from&nbsp;termin.visualization.entity&nbsp;import&nbsp;Entity,&nbsp;Component<br>
from&nbsp;termin.geombase.pose3&nbsp;import&nbsp;Pose3<br>
from&nbsp;termin.visualization.scene&nbsp;import&nbsp;Scene<br>
from&nbsp;termin.visualization.entity&nbsp;import&nbsp;Entity<br>
from&nbsp;termin.geombase.pose3&nbsp;import&nbsp;Pose3<br>
from&nbsp;termin.visualization.entity&nbsp;import&nbsp;Component<br>
<br>
<br>
@serializable(fields=[&quot;x&quot;])<br>
class&nbsp;C(Component):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;x=0):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.x&nbsp;=&nbsp;x<br>
<br>
<br>
@serializable(fields=[&quot;value&quot;,&nbsp;&quot;flag&quot;])<br>
class&nbsp;DummyComponent(Component):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;value=0,&nbsp;flag=False):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.value&nbsp;=&nbsp;value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.flag&nbsp;=&nbsp;flag<br>
<br>
<br>
class&nbsp;DummyContext:<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;load_shader(self,&nbsp;path):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ShaderProgram(&quot;vs&quot;,&nbsp;&quot;fs&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;load_texture(self,&nbsp;path):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;f&quot;texture:{path}&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;create_material(self,&nbsp;shader,&nbsp;color):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Material(shader,&nbsp;color=color)<br>
<br>
<br>
def&nbsp;test_material_serialize_deserialize():<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader&nbsp;=&nbsp;ShaderProgram(&quot;vs&quot;,&nbsp;&quot;fs&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;shader.source_path&nbsp;=&nbsp;&quot;shaders/basic.glsl&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;=&nbsp;Material(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shader=shader,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color=np.array([1.0,&nbsp;0.5,&nbsp;0.2,&nbsp;1.0],&nbsp;np.float32),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textures={},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uniforms={&quot;roughness&quot;:&nbsp;0.5},<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;Material.serialize(m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ctx&nbsp;=&nbsp;DummyContext()<br>
&nbsp;&nbsp;&nbsp;&nbsp;m2&nbsp;=&nbsp;Material.deserialize(data,&nbsp;ctx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(m2.color&nbsp;==&nbsp;m.color).all()<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;m2.uniforms[&quot;roughness&quot;]&nbsp;==&nbsp;0.5<br>
<br>
<br>
<br>
<br>
def&nbsp;test_component_roundtrip():<br>
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;DummyComponent(value=42,&nbsp;flag=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;c.serialize()<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;c2&nbsp;=&nbsp;DummyComponent.deserialize(data[&quot;data&quot;],&nbsp;DummyContext())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;c2.value&nbsp;==&nbsp;42<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;c2.flag&nbsp;is&nbsp;True<br>
<br>
<br>
<br>
<br>
def&nbsp;test_entity_serialize_deserialize():<br>
&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;Entity(pose=Pose3.identity(),&nbsp;name=&quot;test&quot;,&nbsp;scale=2.0,&nbsp;priority=3)<br>
&nbsp;&nbsp;&nbsp;&nbsp;e.add_component(C(x=123))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;e.serialize()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(data)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;e2&nbsp;=&nbsp;Entity.deserialize(data,&nbsp;DummyContext())<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;e2.name&nbsp;==&nbsp;&quot;test&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;isinstance(e2.scale,&nbsp;np.ndarray)<br>
&nbsp;&nbsp;&nbsp;&nbsp;np.testing.assert_array_almost_equal(e2.scale,&nbsp;np.array([2.0,&nbsp;2.0,&nbsp;2.0]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;e2.priority&nbsp;==&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;len(e2.components)&nbsp;==&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;e2.components[0].x&nbsp;==&nbsp;123<br>
<br>
<br>
<br>
<br>
#&nbsp;def&nbsp;test_scene_roundtrip():<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;Scene()<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;Entity(pose=Pose3.identity(),&nbsp;name=&quot;obj&quot;)<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.add_component(C(x=99))<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.add(e)<br>
<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;s.serialize()<br>
<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s2&nbsp;=&nbsp;Scene.deserialize(data,&nbsp;DummyContext(),&nbsp;Entity)<br>
<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;len(s2.entities)&nbsp;==&nbsp;1<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ent&nbsp;=&nbsp;s2.entities[0]<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;ent.name&nbsp;==&nbsp;&quot;obj&quot;<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;ent.components[0].x&nbsp;==&nbsp;99<br>
<!-- END SCAT CODE -->
</body>
</html>
