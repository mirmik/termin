<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>examples/project/Shaders/LineShader3.shader</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
@program&nbsp;LineShader3<br>
<br>
@phase&nbsp;opaque<br>
<br>
@property&nbsp;Float&nbsp;u_width&nbsp;=&nbsp;0.05<br>
@property&nbsp;Color&nbsp;u_color&nbsp;=&nbsp;Color(1.0,&nbsp;1.0,&nbsp;1.0,&nbsp;1.0)<br>
<br>
//&nbsp;============================================================<br>
//&nbsp;Vertex&nbsp;Shader&nbsp;—&nbsp;просто&nbsp;передаёт&nbsp;позицию&nbsp;в&nbsp;мировых&nbsp;координатах<br>
//&nbsp;============================================================<br>
@stage&nbsp;vertex<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
<br>
out&nbsp;vec3&nbsp;v_world_pos;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;(u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0)).xyz;<br>
}<br>
<br>
//&nbsp;============================================================<br>
//&nbsp;Geometry&nbsp;Shader&nbsp;—&nbsp;разворачивает&nbsp;GL_LINES&nbsp;в&nbsp;billboard&nbsp;quads<br>
//&nbsp;с&nbsp;круглыми&nbsp;заглушками&nbsp;на&nbsp;концах&nbsp;для&nbsp;сглаживания&nbsp;стыков<br>
//&nbsp;============================================================<br>
@stage&nbsp;geometry<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(lines)&nbsp;in;<br>
//&nbsp;4&nbsp;для&nbsp;quad&nbsp;+&nbsp;2&nbsp;круга&nbsp;*&nbsp;6&nbsp;сегментов&nbsp;*&nbsp;3&nbsp;вершины&nbsp;=&nbsp;4&nbsp;+&nbsp;36&nbsp;=&nbsp;40<br>
layout(triangle_strip,&nbsp;max_vertices&nbsp;=&nbsp;48)&nbsp;out;<br>
<br>
in&nbsp;vec3&nbsp;v_world_pos[];<br>
<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
uniform&nbsp;float&nbsp;u_width;<br>
<br>
const&nbsp;int&nbsp;CIRCLE_SEGMENTS&nbsp;=&nbsp;6;<br>
const&nbsp;float&nbsp;PI&nbsp;=&nbsp;3.14159265359;<br>
<br>
//&nbsp;Позиция&nbsp;камеры&nbsp;(извлекаем&nbsp;из&nbsp;view&nbsp;matrix)<br>
vec3&nbsp;get_camera_pos(mat4&nbsp;view)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat3&nbsp;rot&nbsp;=&nbsp;mat3(view);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;d&nbsp;=&nbsp;vec3(view[3]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-d&nbsp;*&nbsp;rot;<br>
}<br>
<br>
//&nbsp;Рисует&nbsp;полный&nbsp;круг&nbsp;в&nbsp;точке&nbsp;стыка&nbsp;(отдельными&nbsp;треугольниками)<br>
void&nbsp;emit_circle(vec3&nbsp;center,&nbsp;vec3&nbsp;perp,&nbsp;vec3&nbsp;tangent,&nbsp;float&nbsp;radius,&nbsp;mat4&nbsp;vp)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;CIRCLE_SEGMENTS;&nbsp;i++)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;a0&nbsp;=&nbsp;float(i)&nbsp;/&nbsp;float(CIRCLE_SEGMENTS)&nbsp;*&nbsp;2.0&nbsp;*&nbsp;PI;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;a1&nbsp;=&nbsp;float(i&nbsp;+&nbsp;1)&nbsp;/&nbsp;float(CIRCLE_SEGMENTS)&nbsp;*&nbsp;2.0&nbsp;*&nbsp;PI;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p0&nbsp;=&nbsp;center&nbsp;+&nbsp;(perp&nbsp;*&nbsp;cos(a0)&nbsp;+&nbsp;tangent&nbsp;*&nbsp;sin(a0))&nbsp;*&nbsp;radius;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p1&nbsp;=&nbsp;center&nbsp;+&nbsp;(perp&nbsp;*&nbsp;cos(a1)&nbsp;+&nbsp;tangent&nbsp;*&nbsp;sin(a1))&nbsp;*&nbsp;radius;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Треугольник:&nbsp;center&nbsp;-&gt;&nbsp;p0&nbsp;-&gt;&nbsp;p1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(center,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(p0,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(p1,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndPrimitive();<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p0&nbsp;=&nbsp;v_world_pos[0];<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p1&nbsp;=&nbsp;v_world_pos[1];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;camera_pos&nbsp;=&nbsp;get_camera_pos(u_view);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Направление&nbsp;линии<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;line_dir&nbsp;=&nbsp;normalize(p1&nbsp;-&nbsp;p0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Направление&nbsp;к&nbsp;камере&nbsp;(среднее&nbsp;для&nbsp;обоих&nbsp;концов)<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;mid&nbsp;=&nbsp;(p0&nbsp;+&nbsp;p1)&nbsp;*&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;to_camera&nbsp;=&nbsp;normalize(camera_pos&nbsp;-&nbsp;mid);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Перпендикуляр&nbsp;к&nbsp;линии&nbsp;в&nbsp;плоскости,&nbsp;обращённой&nbsp;к&nbsp;камере<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;perp&nbsp;=&nbsp;normalize(cross(line_dir,&nbsp;to_camera));<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;half_width&nbsp;=&nbsp;u_width&nbsp;*&nbsp;0.5;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat4&nbsp;vp&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Основной&nbsp;quad&nbsp;линии<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v0&nbsp;=&nbsp;p0&nbsp;-&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v1&nbsp;=&nbsp;p0&nbsp;+&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v2&nbsp;=&nbsp;p1&nbsp;-&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v3&nbsp;=&nbsp;p1&nbsp;+&nbsp;perp&nbsp;*&nbsp;half_width;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v0,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v1,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v2,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v3,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;EndPrimitive();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Круглые&nbsp;заглушки&nbsp;на&nbsp;обоих&nbsp;концах&nbsp;сегмента<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;tangent&nbsp;=&nbsp;line_dir&nbsp;для&nbsp;ориентации&nbsp;круга&nbsp;в&nbsp;плоскости&nbsp;billboard<br>
&nbsp;&nbsp;&nbsp;&nbsp;emit_circle(p0,&nbsp;perp,&nbsp;line_dir,&nbsp;half_width,&nbsp;vp);<br>
&nbsp;&nbsp;&nbsp;&nbsp;emit_circle(p1,&nbsp;perp,&nbsp;line_dir,&nbsp;half_width,&nbsp;vp);<br>
}<br>
<br>
//&nbsp;============================================================<br>
//&nbsp;Fragment&nbsp;Shader&nbsp;—&nbsp;выводит&nbsp;цвет<br>
//&nbsp;============================================================<br>
@stage&nbsp;fragment<br>
#version&nbsp;330&nbsp;core<br>
<br>
uniform&nbsp;vec4&nbsp;u_color;<br>
<br>
out&nbsp;vec4&nbsp;frag_color;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;frag_color&nbsp;=&nbsp;u_color;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
