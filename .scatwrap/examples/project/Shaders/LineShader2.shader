<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>examples/project/Shaders/LineShader2.shader</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
@program&nbsp;LineShader2<br>
<br>
@phase&nbsp;opaque<br>
<br>
@property&nbsp;Float&nbsp;u_width&nbsp;=&nbsp;0.05<br>
@property&nbsp;Color&nbsp;u_color&nbsp;=&nbsp;Color(1.0,&nbsp;1.0,&nbsp;1.0,&nbsp;1.0)<br>
<br>
//&nbsp;============================================================<br>
//&nbsp;Vertex&nbsp;Shader&nbsp;—&nbsp;просто&nbsp;передаёт&nbsp;позицию&nbsp;в&nbsp;мировых&nbsp;координатах<br>
//&nbsp;============================================================<br>
@stage&nbsp;vertex<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(location&nbsp;=&nbsp;0)&nbsp;in&nbsp;vec3&nbsp;a_position;<br>
<br>
uniform&nbsp;mat4&nbsp;u_model;<br>
<br>
out&nbsp;vec3&nbsp;v_world_pos;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;v_world_pos&nbsp;=&nbsp;(u_model&nbsp;*&nbsp;vec4(a_position,&nbsp;1.0)).xyz;<br>
}<br>
<br>
//&nbsp;============================================================<br>
//&nbsp;Geometry&nbsp;Shader&nbsp;—&nbsp;разворачивает&nbsp;GL_LINES&nbsp;в&nbsp;billboard&nbsp;quads<br>
//&nbsp;с&nbsp;круглыми&nbsp;заглушками&nbsp;на&nbsp;концах&nbsp;для&nbsp;сглаживания&nbsp;стыков<br>
//&nbsp;============================================================<br>
@stage&nbsp;geometry<br>
#version&nbsp;330&nbsp;core<br>
<br>
layout(lines)&nbsp;in;<br>
//&nbsp;4&nbsp;вершины&nbsp;для&nbsp;quad&nbsp;+&nbsp;2&nbsp;*&nbsp;(CAP_SEGMENTS&nbsp;+&nbsp;1)&nbsp;для&nbsp;полукругов&nbsp;на&nbsp;концах<br>
//&nbsp;CAP_SEGMENTS&nbsp;=&nbsp;4&nbsp;-&gt;&nbsp;max_vertices&nbsp;=&nbsp;4&nbsp;+&nbsp;2*5*3&nbsp;=&nbsp;34&nbsp;(triangle&nbsp;fan&nbsp;как&nbsp;strip)<br>
layout(triangle_strip,&nbsp;max_vertices&nbsp;=&nbsp;34)&nbsp;out;<br>
<br>
in&nbsp;vec3&nbsp;v_world_pos[];<br>
<br>
uniform&nbsp;mat4&nbsp;u_view;<br>
uniform&nbsp;mat4&nbsp;u_projection;<br>
uniform&nbsp;float&nbsp;u_width;<br>
<br>
const&nbsp;int&nbsp;CAP_SEGMENTS&nbsp;=&nbsp;4;&nbsp;&nbsp;//&nbsp;Сегментов&nbsp;в&nbsp;полукруге<br>
const&nbsp;float&nbsp;PI&nbsp;=&nbsp;3.14159265359;<br>
<br>
//&nbsp;Позиция&nbsp;камеры&nbsp;(извлекаем&nbsp;из&nbsp;view&nbsp;matrix)<br>
vec3&nbsp;get_camera_pos(mat4&nbsp;view)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat3&nbsp;rot&nbsp;=&nbsp;mat3(view);<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;d&nbsp;=&nbsp;vec3(view[3]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-d&nbsp;*&nbsp;rot;<br>
}<br>
<br>
void&nbsp;emit_cap(vec3&nbsp;center,&nbsp;vec3&nbsp;perp,&nbsp;vec3&nbsp;line_dir,&nbsp;vec3&nbsp;to_cam,&nbsp;float&nbsp;radius,&nbsp;mat4&nbsp;vp,&nbsp;bool&nbsp;is_start)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Полукруг&nbsp;на&nbsp;конце&nbsp;линии<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;perp&nbsp;—&nbsp;перпендикуляр&nbsp;в&nbsp;плоскости&nbsp;billboard<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;line_dir&nbsp;—&nbsp;направление&nbsp;линии&nbsp;(для&nbsp;ориентации&nbsp;полукруга)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;start_angle&nbsp;=&nbsp;is_start&nbsp;?&nbsp;PI&nbsp;*&nbsp;0.5&nbsp;:&nbsp;-PI&nbsp;*&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;end_angle&nbsp;=&nbsp;is_start&nbsp;?&nbsp;PI&nbsp;*&nbsp;1.5&nbsp;:&nbsp;PI&nbsp;*&nbsp;0.5;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;=&nbsp;CAP_SEGMENTS;&nbsp;i++)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;t&nbsp;=&nbsp;float(i)&nbsp;/&nbsp;float(CAP_SEGMENTS);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;angle&nbsp;=&nbsp;mix(start_angle,&nbsp;end_angle,&nbsp;t);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Вектор&nbsp;в&nbsp;плоскости&nbsp;billboard<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;offset&nbsp;=&nbsp;perp&nbsp;*&nbsp;cos(angle)&nbsp;+&nbsp;line_dir&nbsp;*&nbsp;sin(angle);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p&nbsp;=&nbsp;center&nbsp;+&nbsp;offset&nbsp;*&nbsp;radius;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Каждый&nbsp;сегмент&nbsp;—&nbsp;треугольник&nbsp;от&nbsp;центра<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(center,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(p,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;EndPrimitive();<br>
}<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p0&nbsp;=&nbsp;v_world_pos[0];<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;p1&nbsp;=&nbsp;v_world_pos[1];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;camera_pos&nbsp;=&nbsp;get_camera_pos(u_view);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Направление&nbsp;линии<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;line_dir&nbsp;=&nbsp;normalize(p1&nbsp;-&nbsp;p0);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Направление&nbsp;к&nbsp;камере&nbsp;(среднее&nbsp;для&nbsp;обоих&nbsp;концов)<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;mid&nbsp;=&nbsp;(p0&nbsp;+&nbsp;p1)&nbsp;*&nbsp;0.5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;to_camera&nbsp;=&nbsp;normalize(camera_pos&nbsp;-&nbsp;mid);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Перпендикуляр&nbsp;к&nbsp;линии&nbsp;в&nbsp;плоскости,&nbsp;обращённой&nbsp;к&nbsp;камере<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;perp&nbsp;=&nbsp;normalize(cross(line_dir,&nbsp;to_camera));<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;float&nbsp;half_width&nbsp;=&nbsp;u_width&nbsp;*&nbsp;0.5;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mat4&nbsp;vp&nbsp;=&nbsp;u_projection&nbsp;*&nbsp;u_view;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Основной&nbsp;quad&nbsp;линии<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v0&nbsp;=&nbsp;p0&nbsp;-&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v1&nbsp;=&nbsp;p0&nbsp;+&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v2&nbsp;=&nbsp;p1&nbsp;-&nbsp;perp&nbsp;*&nbsp;half_width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vec3&nbsp;v3&nbsp;=&nbsp;p1&nbsp;+&nbsp;perp&nbsp;*&nbsp;half_width;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v0,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v1,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v2,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;gl_Position&nbsp;=&nbsp;vp&nbsp;*&nbsp;vec4(v3,&nbsp;1.0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;EmitVertex();<br>
&nbsp;&nbsp;&nbsp;&nbsp;EndPrimitive();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Круглые&nbsp;заглушки&nbsp;на&nbsp;концах<br>
&nbsp;&nbsp;&nbsp;&nbsp;emit_cap(p0,&nbsp;perp,&nbsp;line_dir,&nbsp;to_camera,&nbsp;half_width,&nbsp;vp,&nbsp;true);<br>
&nbsp;&nbsp;&nbsp;&nbsp;emit_cap(p1,&nbsp;perp,&nbsp;line_dir,&nbsp;to_camera,&nbsp;half_width,&nbsp;vp,&nbsp;false);<br>
}<br>
<br>
//&nbsp;============================================================<br>
//&nbsp;Fragment&nbsp;Shader&nbsp;—&nbsp;выводит&nbsp;цвет<br>
//&nbsp;============================================================<br>
@stage&nbsp;fragment<br>
#version&nbsp;330&nbsp;core<br>
<br>
uniform&nbsp;vec4&nbsp;u_color;<br>
<br>
out&nbsp;vec4&nbsp;frag_color;<br>
<br>
void&nbsp;main()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;frag_color&nbsp;=&nbsp;u_color;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
