<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TECHNICAL_NOTES.md</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
Обзор&nbsp;проекта&nbsp;mirmik/termin&nbsp;(TECHNICAL_NOTES)<br>
Обзор&nbsp;директорий<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/editor&nbsp;–&nbsp;Приложения&nbsp;и&nbsp;утилиты&nbsp;на&nbsp;базе&nbsp;движка.&nbsp;Содержит&nbsp;запуск&nbsp;редактора&nbsp;(run_editor.py)&nbsp;и&nbsp;файлы&nbsp;интерфейса&nbsp;редактора&nbsp;(например,&nbsp;editor_window.py,&nbsp;editor_tree.py,&nbsp;editor_inspector.py).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/visualization&nbsp;–&nbsp;Подсистема&nbsp;визуализации&nbsp;3D-сцены.&nbsp;Включает&nbsp;ядро&nbsp;рендеринга&nbsp;(сцена,&nbsp;сущности,&nbsp;компоненты,&nbsp;рендерер,&nbsp;граф&nbsp;кадров),&nbsp;графический&nbsp;бэкенд&nbsp;(OpenGL/Qt/GLFW),&nbsp;материалы&nbsp;и&nbsp;шейдеры,&nbsp;систему&nbsp;пост-эффектов&nbsp;и&nbsp;утилиты&nbsp;для&nbsp;отображения&nbsp;(камеры,&nbsp;контроллеры,&nbsp;gизмо&nbsp;и&nbsp;пр.).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/kinematic&nbsp;–&nbsp;Кинематические&nbsp;структуры&nbsp;и&nbsp;трансформации.&nbsp;Определяет&nbsp;иерархические&nbsp;трансформы&nbsp;(Transform,&nbsp;Transform3),&nbsp;позволяющие&nbsp;строить&nbsp;сцену&nbsp;как&nbsp;дерево&nbsp;трансформаций,&nbsp;и&nbsp;связанные&nbsp;алгоритмы&nbsp;(например,&nbsp;кинематические&nbsp;цепи).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/geombase&nbsp;–&nbsp;Базовые&nbsp;геометрические&nbsp;примитивы&nbsp;и&nbsp;алгебры.&nbsp;Содержит&nbsp;классы&nbsp;позиций/ориентаций&nbsp;(Pose3&nbsp;–&nbsp;комбинация&nbsp;кватерниона&nbsp;и&nbsp;вектора&nbsp;трансляции)&nbsp;и&nbsp;базовые&nbsp;операции&nbsp;с&nbsp;ними&nbsp;(например,&nbsp;умножение&nbsp;поз,&nbsp;преобразование&nbsp;точек).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/mesh&nbsp;–&nbsp;Работа&nbsp;с&nbsp;полигональными&nbsp;мешами.&nbsp;Реализует&nbsp;структуры&nbsp;для&nbsp;2D/3D&nbsp;сеток&nbsp;(Mesh2,&nbsp;Mesh3),&nbsp;генераторы&nbsp;простых&nbsp;форм&nbsp;(например,&nbsp;CubeMesh,&nbsp;CylinderMesh)&nbsp;и&nbsp;функции&nbsp;импорта&nbsp;(через&nbsp;Assimp).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/colliders&nbsp;–&nbsp;Коллизии&nbsp;и&nbsp;пересечения.&nbsp;Определяет&nbsp;компоненты-коллайдеры&nbsp;(ColliderComponent)&nbsp;и&nbsp;формы&nbsp;(сферы,&nbsp;лучи&nbsp;и&nbsp;др.),&nbsp;поддерживает&nbsp;расчёт&nbsp;пересечений/лучевых&nbsp;бросков&nbsp;в&nbsp;сцене&nbsp;(см.&nbsp;методы&nbsp;Scene.raycast()).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/physics&nbsp;–&nbsp;Модуль&nbsp;физики&nbsp;(возможно&nbsp;экспериментальный).&nbsp;Содержит&nbsp;зачатки&nbsp;физического&nbsp;движка&nbsp;(например,&nbsp;динамические&nbsp;тела,&nbsp;силы)&nbsp;–&nbsp;сейчас&nbsp;расположен&nbsp;в&nbsp;архиве&nbsp;проекта&nbsp;и&nbsp;не&nbsp;активно&nbsp;используется.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/fem&nbsp;–&nbsp;Реализация&nbsp;элементов&nbsp;конечных&nbsp;элементов&nbsp;(Finite&nbsp;Element&nbsp;Method)&nbsp;и&nbsp;связанных&nbsp;алгоритмов&nbsp;(например,&nbsp;расчёты&nbsp;для&nbsp;многотельных&nbsp;систем).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/geomalgo&nbsp;–&nbsp;Геометрические&nbsp;алгоритмы&nbsp;высокого&nbsp;уровня&nbsp;(вычислительная&nbsp;геометрия,&nbsp;операции&nbsp;над&nbsp;примитивами&nbsp;и&nbsp;т.п.).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/linalg&nbsp;–&nbsp;Вспомогательная&nbsp;линейная&nbsp;алгебра&nbsp;(возможно,&nbsp;утилиты&nbsp;для&nbsp;работы&nbsp;с&nbsp;матрицами,&nbsp;векторами,&nbsp;кватернионами&nbsp;и&nbsp;т.д.).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/robot&nbsp;–&nbsp;Компоненты&nbsp;для&nbsp;робототехники&nbsp;и&nbsp;кинематики&nbsp;роботов&nbsp;(например,&nbsp;класс&nbsp;Robot,&nbsp;расчет&nbsp;прямой/обратной&nbsp;кинематики).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/loaders&nbsp;–&nbsp;Импортеры&nbsp;внешних&nbsp;форматов&nbsp;и&nbsp;моделей&nbsp;(например,&nbsp;загрузчик&nbsp;FBX,&nbsp;OBJ&nbsp;и&nbsp;др.&nbsp;через&nbsp;pyassimp).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;termin/utils&nbsp;–&nbsp;Разные&nbsp;утилиты&nbsp;и&nbsp;вспомогательные&nbsp;функции,&nbsp;включая&nbsp;работу&nbsp;с&nbsp;кватернионами&nbsp;(termin/util.py&nbsp;предоставляет&nbsp;операции&nbsp;qmul,&nbsp;qrot&nbsp;и&nbsp;пр.,&nbsp;используемые&nbsp;в&nbsp;Pose3).<br>
Карта&nbsp;ключевых&nbsp;классов<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Scene&nbsp;(termin/visualization/core/scene.py):&nbsp;Класс&nbsp;сцены&nbsp;–&nbsp;контейнер&nbsp;всех&nbsp;сущностей.&nbsp;Хранит&nbsp;список&nbsp;entities&nbsp;и&nbsp;глобальные&nbsp;параметры&nbsp;(цвет&nbsp;фона,&nbsp;освещение).&nbsp;Отвечает&nbsp;за&nbsp;добавление/удаление&nbsp;объектов,&nbsp;регистрацию&nbsp;компонентов&nbsp;(в&nbsp;т.ч.&nbsp;коллайдеров&nbsp;и&nbsp;интерактивных&nbsp;компонентов)&nbsp;и&nbsp;обновление&nbsp;их&nbsp;логики&nbsp;каждый&nbsp;кадр.&nbsp;Методы&nbsp;add/remove&nbsp;управляют&nbsp;иерархией&nbsp;сущностей&nbsp;и&nbsp;автоматически&nbsp;регистрируют&nbsp;компоненты&nbsp;в&nbsp;соответствующих&nbsp;списках&nbsp;(коллайдеры,&nbsp;апдейты&nbsp;и&nbsp;т.д.).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Entity&nbsp;(termin/visualization/core/entity.py):&nbsp;Сущность&nbsp;сцены&nbsp;(объект)&nbsp;с&nbsp;компонентной&nbsp;архитектурой&nbsp;(аналог&nbsp;Unity&nbsp;GameObject).&nbsp;Содержит&nbsp;трансформ&nbsp;(transform:&nbsp;Transform3),&nbsp;список&nbsp;компонентов&nbsp;и&nbsp;свойства&nbsp;видимости/активности.&nbsp;Предоставляет&nbsp;методы&nbsp;управления&nbsp;компонентами&nbsp;(add_component,&nbsp;remove_component),&nbsp;поиска&nbsp;компонентов,&nbsp;обновления&nbsp;и&nbsp;отрисовки.&nbsp;Метод&nbsp;Entity.draw(context)&nbsp;обходит&nbsp;все&nbsp;компоненты&nbsp;и&nbsp;вызывает&nbsp;их&nbsp;draw,&nbsp;если&nbsp;объект&nbsp;активен.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Component&nbsp;(termin/visualization/core/entity.py):&nbsp;Базовый&nbsp;класс&nbsp;компонента&nbsp;сущности&nbsp;(отрисовываемого&nbsp;или&nbsp;логического).&nbsp;Хранит&nbsp;ссылку&nbsp;на&nbsp;владельца&nbsp;(self.entity),&nbsp;флаг&nbsp;активности&nbsp;(enabled).&nbsp;Определяет&nbsp;интерфейсы:&nbsp;start()&nbsp;(вызвается&nbsp;при&nbsp;добавлении&nbsp;в&nbsp;активную&nbsp;сцену),&nbsp;update(dt)&nbsp;для&nbsp;обновления&nbsp;каждый&nbsp;кадр,&nbsp;draw(context)&nbsp;для&nbsp;рендеринга.&nbsp;Разновидности&nbsp;компонентов&nbsp;могут&nbsp;переопределять&nbsp;эти&nbsp;методы.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;MeshRenderer&nbsp;(termin/visualization/render/components/mesh_renderer.py):&nbsp;Компонент-отрисовщик&nbsp;меша.&nbsp;Хранит&nbsp;ссылку&nbsp;на&nbsp;геометрию&nbsp;(mesh:&nbsp;MeshDrawable)&nbsp;и&nbsp;материал(ы)&nbsp;для&nbsp;рендера.&nbsp;Поддерживает&nbsp;несколько&nbsp;проходов&nbsp;рендеринга:&nbsp;свойство&nbsp;passes&nbsp;–&nbsp;список&nbsp;RenderPass&nbsp;(каждый&nbsp;содержит&nbsp;материал&nbsp;и&nbsp;состояние&nbsp;рендера).&nbsp;В&nbsp;методе&nbsp;draw&nbsp;применяет&nbsp;для&nbsp;каждого&nbsp;пасса&nbsp;нужное&nbsp;состояние&nbsp;(RenderState&nbsp;–&nbsp;глубина,&nbsp;режим&nbsp;отрисовки&nbsp;и&nbsp;т.п.),&nbsp;устанавливает&nbsp;материал&nbsp;(шейдер&nbsp;и&nbsp;униформы),&nbsp;затем&nbsp;рисует&nbsp;меш.&nbsp;После&nbsp;отрисовки&nbsp;сбрасывает&nbsp;состояние&nbsp;к&nbsp;дефолтному.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;RenderPass&nbsp;(termin/visualization/render/renderpass.py):&nbsp;Структура,&nbsp;описывающая&nbsp;материал&nbsp;и&nbsp;состояние&nbsp;рендеринга&nbsp;для&nbsp;одного&nbsp;прохода&nbsp;отрисовки.&nbsp;Содержит&nbsp;ссылку&nbsp;на&nbsp;материал&nbsp;(Material)&nbsp;и&nbsp;конфигурацию&nbsp;графического&nbsp;состояния&nbsp;(RenderState&nbsp;–&nbsp;параметры&nbsp;тестов&nbsp;глубины,&nbsp;смешивания,&nbsp;отсекающей&nbsp;поверхности&nbsp;и&nbsp;пр.).&nbsp;Используется&nbsp;компонентами-отрисовщиками&nbsp;(например,&nbsp;в&nbsp;MeshRenderer.passes)&nbsp;для&nbsp;задания&nbsp;нескольких&nbsp;этапов&nbsp;вывода&nbsp;одного&nbsp;объекта&nbsp;(например,&nbsp;сначала&nbsp;непрозрачный&nbsp;материал,&nbsp;затем&nbsp;контур&nbsp;и&nbsp;т.п.).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;CameraComponent&nbsp;и&nbsp;контроллеры&nbsp;камер&nbsp;(termin/visualization/core/camera.py):&nbsp;Компоненты,&nbsp;отвечающие&nbsp;за&nbsp;матрицы&nbsp;вида/проекции.&nbsp;Например,&nbsp;PerspectiveCameraComponent&nbsp;–&nbsp;перспективная&nbsp;камера&nbsp;с&nbsp;расчётом&nbsp;матриц,&nbsp;а&nbsp;OrbitCameraController&nbsp;–&nbsp;компонент-ввод,&nbsp;позволяющий&nbsp;вращать/приближать&nbsp;камеру&nbsp;орбитально&nbsp;вокруг&nbsp;цели.&nbsp;Камеры&nbsp;являются&nbsp;тоже&nbsp;компонентами&nbsp;Entity,&nbsp;что&nbsp;позволяет&nbsp;добавлять&nbsp;их&nbsp;в&nbsp;сцену.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Window&nbsp;(termin/visualization/platform/window.py):&nbsp;Абстракция&nbsp;оконного&nbsp;контекста.&nbsp;Создаётся&nbsp;через&nbsp;бэкенд&nbsp;(WindowBackend&nbsp;–&nbsp;Qt&nbsp;или&nbsp;GLFW)&nbsp;и&nbsp;держит&nbsp;нативное&nbsp;окно&nbsp;или&nbsp;виджет.&nbsp;Содержит&nbsp;список&nbsp;вьюпортов&nbsp;(экземпляры&nbsp;Viewport)&nbsp;–&nbsp;областей&nbsp;отображения&nbsp;сцены.&nbsp;Следит&nbsp;за&nbsp;событиями&nbsp;ввода&nbsp;(мышь,&nbsp;клавиатура)&nbsp;и&nbsp;делегирует&nbsp;их&nbsp;компонентам&nbsp;(Scene.dispatch_input&nbsp;распространяет&nbsp;события&nbsp;интерактивным&nbsp;компонентам).&nbsp;Имеет&nbsp;метод&nbsp;render(),&nbsp;который&nbsp;запускает&nbsp;рендеринг&nbsp;всех&nbsp;вьюпортов,&nbsp;собирая&nbsp;их&nbsp;конвейеры&nbsp;рендеринга&nbsp;и&nbsp;выполняя&nbsp;граф&nbsp;кадра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Viewport&nbsp;(termin/visualization/core/viewport.py):&nbsp;Представление&nbsp;сцены&nbsp;в&nbsp;окне,&nbsp;связка&nbsp;из&nbsp;указателя&nbsp;на&nbsp;scene,&nbsp;camera&nbsp;и&nbsp;прямоугольника&nbsp;в&nbsp;окне.&nbsp;Имеет&nbsp;собственный&nbsp;список&nbsp;проходов&nbsp;frame_passes&nbsp;–&nbsp;конвейер&nbsp;рендеринга&nbsp;кадра&nbsp;для&nbsp;данного&nbsp;вида.&nbsp;Метод&nbsp;Viewport.make_default_pipeline()&nbsp;собирает&nbsp;типовой&nbsp;набор&nbsp;проходов&nbsp;(Color&nbsp;→&nbsp;PostFX&nbsp;→&nbsp;Canvas&nbsp;→&nbsp;Present),&nbsp;а&nbsp;set_render_pipeline(passes)&nbsp;применяется&nbsp;для&nbsp;установки&nbsp;пользовательского&nbsp;конвейера.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;FrameGraph&nbsp;(termin/visualization/render/framegraph/core.py):&nbsp;Класс,&nbsp;реализующий&nbsp;граф&nbsp;зависимостей&nbsp;ресурсов&nbsp;кадра.&nbsp;На&nbsp;вход&nbsp;получает&nbsp;список&nbsp;объектов&nbsp;FramePass&nbsp;(каждый&nbsp;описывает&nbsp;один&nbsp;этап&nbsp;рендеринга)&nbsp;и&nbsp;вычисляет&nbsp;их&nbsp;порядок&nbsp;выполнения&nbsp;с&nbsp;учётом&nbsp;зависимостей&nbsp;«чтение&nbsp;после&nbsp;записи».&nbsp;Проверяет&nbsp;на&nbsp;ошибки:&nbsp;несколько&nbsp;пассов&nbsp;пишущих&nbsp;один&nbsp;ресурс,&nbsp;циклы&nbsp;зависимостей,&nbsp;правила&nbsp;in-place&nbsp;пассов&nbsp;(изменяющих&nbsp;ресурс&nbsp;на&nbsp;месте).&nbsp;Результат&nbsp;–&nbsp;упорядоченный&nbsp;список&nbsp;пассов&nbsp;(schedule)&nbsp;для&nbsp;выполнения.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;FramePass&nbsp;(termin/visualization/render/framegraph/core.py):&nbsp;Структура&nbsp;одного&nbsp;этапа&nbsp;графа&nbsp;кадра.&nbsp;Содержит&nbsp;имя&nbsp;пасса,&nbsp;множество&nbsp;ресурсов&nbsp;reads&nbsp;(читаемых)&nbsp;и&nbsp;writes&nbsp;(писаемых),&nbsp;а&nbsp;также&nbsp;флаг&nbsp;inplace&nbsp;(модифицирует&nbsp;ли&nbsp;ресурс&nbsp;на&nbsp;месте).&nbsp;От&nbsp;FramePass&nbsp;наследуется&nbsp;RenderFramePass&nbsp;(termin/visualization/render/framegraph/passes/base.py),&nbsp;добавляющий&nbsp;абстрактный&nbsp;метод&nbsp;execute(self,&nbsp;ctx)&nbsp;–&nbsp;реализацию&nbsp;действия&nbsp;пасса&nbsp;над&nbsp;контекстом&nbsp;кадра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Renderer&nbsp;(termin/visualization/render/renderer.py):&nbsp;Класс-отрисовщик&nbsp;сцены.&nbsp;Экземпляр&nbsp;Renderer&nbsp;создаётся&nbsp;в&nbsp;мире&nbsp;визуализации&nbsp;и&nbsp;привязан&nbsp;к&nbsp;графическому&nbsp;бэкенду&nbsp;(OpenGL).&nbsp;Предоставляет&nbsp;методы&nbsp;для&nbsp;отрисовки&nbsp;содержимого&nbsp;вьюпорта:&nbsp;render_viewport(scene,&nbsp;camera,&nbsp;viewport_rect,&nbsp;key)&nbsp;–&nbsp;подготавливает&nbsp;камеру&nbsp;(устанавливает&nbsp;viewport,&nbsp;собирает&nbsp;матрицы&nbsp;вида/проекции),&nbsp;затем&nbsp;обходит&nbsp;все&nbsp;Entity&nbsp;в&nbsp;сцене&nbsp;и&nbsp;вызывает&nbsp;у&nbsp;них&nbsp;draw&nbsp;(что&nbsp;в&nbsp;итоге&nbsp;вызывает&nbsp;draw&nbsp;компонентов).&nbsp;Таким&nbsp;образом&nbsp;Renderer&nbsp;выполняет&nbsp;главный&nbsp;проход&nbsp;рисования&nbsp;мира.&nbsp;Также&nbsp;есть&nbsp;специальный&nbsp;render_viewport_pick&nbsp;–&nbsp;отрисовка&nbsp;сцены&nbsp;в&nbsp;режим&nbsp;идентификаторов&nbsp;для&nbsp;picking&nbsp;(см.&nbsp;ниже).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;VisualizationWorld&nbsp;(termin/visualization/core/world.py):&nbsp;Глобальный&nbsp;управляющий&nbsp;объект&nbsp;приложения.&nbsp;Хранит&nbsp;список&nbsp;сцен&nbsp;и&nbsp;окон,&nbsp;а&nbsp;также&nbsp;экземпляр&nbsp;Renderer.&nbsp;Предоставляет&nbsp;методы&nbsp;add_scene,&nbsp;create_window&nbsp;и&nbsp;управляет&nbsp;главным&nbsp;циклом&nbsp;(run())&nbsp;–&nbsp;обновляет&nbsp;все&nbsp;сцены&nbsp;(вызов&nbsp;Scene.update(dt)&nbsp;для&nbsp;компонентов&nbsp;каждый&nbsp;кадр)&nbsp;и&nbsp;запускает&nbsp;отрисовку&nbsp;окон.<br>
(Кроме&nbsp;того,&nbsp;проект&nbsp;содержит&nbsp;множество&nbsp;других&nbsp;классов:&nbsp;системы&nbsp;материалов&nbsp;и&nbsp;шейдеров,&nbsp;бэкенды&nbsp;(termin/visualization/platform/backends),&nbsp;примеры&nbsp;использования&nbsp;в&nbsp;examples/,&nbsp;но&nbsp;выше&nbsp;перечислены&nbsp;ключевые&nbsp;сущности&nbsp;для&nbsp;понимания&nbsp;структуры.)<br>
Архитектура&nbsp;редактора&nbsp;Termin<br>
Редактор&nbsp;–&nbsp;это&nbsp;встроенное&nbsp;приложение&nbsp;(PyQt5)&nbsp;для&nbsp;визуального&nbsp;управления&nbsp;сценой.&nbsp;Он&nbsp;расположен&nbsp;в&nbsp;модуле&nbsp;termin/editor&nbsp;и&nbsp;включает&nbsp;следующие&nbsp;основные&nbsp;компоненты:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Окно&nbsp;редактора&nbsp;(EditorWindow,&nbsp;файл&nbsp;termin/editor/editor_window.py)&nbsp;–&nbsp;Главный&nbsp;класс&nbsp;UI&nbsp;на&nbsp;основе&nbsp;QMainWindow.&nbsp;Загружает&nbsp;разметку&nbsp;интерфейса&nbsp;из&nbsp;Qt&nbsp;Designer&nbsp;(editor.ui)&nbsp;и&nbsp;содержит&nbsp;области:&nbsp;дерево&nbsp;сцены&nbsp;(QTreeView),&nbsp;панель&nbsp;инспектора&nbsp;и&nbsp;контейнер&nbsp;для&nbsp;виджета&nbsp;viewport.&nbsp;При&nbsp;инициализации&nbsp;получает&nbsp;текущий&nbsp;world&nbsp;(VisualizationWorld)&nbsp;и&nbsp;scene,&nbsp;подсоединяет&nbsp;их&nbsp;к&nbsp;виджету&nbsp;отображения&nbsp;и&nbsp;настраивает&nbsp;взаимодействие.&nbsp;В&nbsp;конструкторе&nbsp;EditorWindow:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Загружает&nbsp;UI,&nbsp;инициализирует&nbsp;sceneTree&nbsp;(виджет&nbsp;иерархии)&nbsp;с&nbsp;моделью&nbsp;SceneTreeModel.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Создаёт&nbsp;EntityInspector&nbsp;для&nbsp;панели&nbsp;свойств&nbsp;и&nbsp;настраивает&nbsp;библиотеку&nbsp;компонентов,&nbsp;доступных&nbsp;для&nbsp;добавления&nbsp;(регистрация&nbsp;стандартных&nbsp;компонентов&nbsp;камеры,&nbsp;контроллера,&nbsp;меш-рендерера).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Добавляет&nbsp;в&nbsp;сцену&nbsp;служебные&nbsp;объекты&nbsp;редактора:&nbsp;EditorEntities&nbsp;(контейнер),&nbsp;под&nbsp;которым&nbsp;создаётся&nbsp;своя&nbsp;камера&nbsp;редактора&nbsp;и&nbsp;объект&nbsp;gizmo&nbsp;(манипулятор).&nbsp;Gizmo&nbsp;представлен&nbsp;классами&nbsp;GizmoEntity&nbsp;и&nbsp;GizmoMoveController&nbsp;(в&nbsp;termin.editor.gizmo_axes),&nbsp;которые&nbsp;отвечают&nbsp;за&nbsp;отображение&nbsp;осей&nbsp;и&nbsp;перемещение&nbsp;выделенного&nbsp;объекта.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Выстраивает&nbsp;связи&nbsp;сигналов/слотов&nbsp;Qt:&nbsp;например,&nbsp;при&nbsp;клике&nbsp;по&nbsp;дереву&nbsp;сцены&nbsp;вызывает&nbsp;обработчик&nbsp;on_tree_click&nbsp;для&nbsp;обновления&nbsp;инспектора&nbsp;и&nbsp;выделения&nbsp;объекта.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Дерево&nbsp;сцены&nbsp;(SceneTreeModel,&nbsp;файл&nbsp;termin/editor/editor_tree.py)&nbsp;–&nbsp;Модель&nbsp;данных&nbsp;Qt,&nbsp;отражающая&nbsp;иерархию&nbsp;сущностей&nbsp;сцены.&nbsp;Построена&nbsp;на&nbsp;основе&nbsp;дерева&nbsp;Transform3:&nbsp;в&nbsp;дереве&nbsp;показываются&nbsp;только&nbsp;объекты&nbsp;Entity&nbsp;(Transform-узлы&nbsp;пропущены).&nbsp;Модель&nbsp;обеспечивает&nbsp;методы&nbsp;index/parent&nbsp;для&nbsp;Qt&nbsp;и&nbsp;функцию&nbsp;index_for_object(obj)&nbsp;–&nbsp;найти&nbsp;QModelIndex&nbsp;по&nbsp;объекту&nbsp;сцены,&nbsp;что&nbsp;позволяет,&nbsp;например,&nbsp;выделить&nbsp;в&nbsp;дереве&nbsp;сущность,&nbsp;на&nbsp;которую&nbsp;пользователь&nbsp;кликнул&nbsp;в&nbsp;viewport.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Панель&nbsp;инспектора:&nbsp;состоит&nbsp;из&nbsp;нескольких&nbsp;частей,&nbsp;объединённых&nbsp;классом&nbsp;EntityInspector&nbsp;(termin/editor/editor_inspector.py).&nbsp;EntityInspector&nbsp;(QWidget)&nbsp;содержит&nbsp;вертикально:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;TransformInspector&nbsp;–&nbsp;виджет&nbsp;для&nbsp;редактирования&nbsp;трансформации&nbsp;(позиция,&nbsp;вращение,&nbsp;масштаб)&nbsp;выделенного&nbsp;объекта.&nbsp;Он&nbsp;привязывается&nbsp;либо&nbsp;к&nbsp;Entity.transform,&nbsp;либо&nbsp;прямо&nbsp;к&nbsp;Transform3,&nbsp;если&nbsp;выделен&nbsp;узел&nbsp;трансформации.&nbsp;Реализован&nbsp;в&nbsp;termin/editor/transform_inspector.py:&nbsp;три&nbsp;ряда&nbsp;QDoubleSpinBox&nbsp;для&nbsp;XYZ&nbsp;позиции,&nbsp;вращения&nbsp;и&nbsp;масштаба,&nbsp;обновляющие&nbsp;Transform3&nbsp;и&nbsp;испускающие&nbsp;сигнал&nbsp;transform_changed.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;ComponentsPanel&nbsp;–&nbsp;список&nbsp;компонентов&nbsp;текущего&nbsp;объекта.&nbsp;Отображает&nbsp;имена&nbsp;всех&nbsp;ent.components&nbsp;и&nbsp;позволяет&nbsp;через&nbsp;контекстное&nbsp;меню&nbsp;добавлять&nbsp;новый&nbsp;компонент&nbsp;(из&nbsp;зарегистрированной&nbsp;библиотеки)&nbsp;или&nbsp;удалять&nbsp;существующий.&nbsp;При&nbsp;добавлении/удалении&nbsp;он&nbsp;испускает&nbsp;сигнал&nbsp;components_changed.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;ComponentInspectorPanel&nbsp;–&nbsp;инспектор&nbsp;свойств&nbsp;выбранного&nbsp;компонента.&nbsp;Отображает&nbsp;поля&nbsp;из&nbsp;Component.inspect_fields&nbsp;(если&nbsp;определены&nbsp;компонентом)&nbsp;динамически,&nbsp;создавая&nbsp;для&nbsp;каждого&nbsp;поля&nbsp;соответствующий&nbsp;UI&nbsp;элемент&nbsp;(числовые&nbsp;спинбоксы,&nbsp;чекбоксы,&nbsp;текстовые&nbsp;поля&nbsp;и&nbsp;т.д.).&nbsp;Изменения&nbsp;значений&nbsp;вызывают&nbsp;обновление&nbsp;компонента&nbsp;(через&nbsp;setter-функции,&nbsp;если&nbsp;заданы).&nbsp;Испускает&nbsp;сигнал&nbsp;component_changed&nbsp;при&nbsp;модификации.<br>
EntityInspector&nbsp;управляет&nbsp;синхронизацией&nbsp;этих&nbsp;панелей:&nbsp;метод&nbsp;set_target(obj)&nbsp;устанавливает&nbsp;текущую&nbsp;цель&nbsp;(Entity&nbsp;или&nbsp;Transform3)&nbsp;–&nbsp;обновляет&nbsp;TransformInspector&nbsp;и&nbsp;список&nbsp;компонентов,&nbsp;сбрасывает&nbsp;компонент-инспектор.&nbsp;При&nbsp;выборе&nbsp;компонента&nbsp;из&nbsp;списка&nbsp;вызывается&nbsp;_on_component_selected,&nbsp;который&nbsp;передаёт&nbsp;этот&nbsp;компонент&nbsp;в&nbsp;ComponentInspectorPanel&nbsp;для&nbsp;отображения&nbsp;его&nbsp;полей.&nbsp;Сигналы&nbsp;от&nbsp;вложенных&nbsp;панелей&nbsp;транслируются&nbsp;наружу&nbsp;(transform_changed,&nbsp;component_changed).&nbsp;В&nbsp;итоге&nbsp;панель&nbsp;инспектора&nbsp;обеспечивает&nbsp;редактирование&nbsp;всех&nbsp;аспектов&nbsp;выбранного&nbsp;объекта.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Gizmo&nbsp;(манипулятор)&nbsp;–&nbsp;Специальный&nbsp;объект&nbsp;для&nbsp;манипуляции&nbsp;трансформацией&nbsp;выделенной&nbsp;сущности.&nbsp;Создаётся&nbsp;EditorWindow&nbsp;при&nbsp;старте&nbsp;и&nbsp;добавляется&nbsp;в&nbsp;сцену&nbsp;под&nbsp;родителем&nbsp;EditorEntities.&nbsp;Класс&nbsp;GizmoEntity&nbsp;представляет&nbsp;визуальные&nbsp;оси&nbsp;и&nbsp;плоскости,&nbsp;а&nbsp;компонент&nbsp;GizmoMoveController&nbsp;обрабатывает&nbsp;события&nbsp;ввода&nbsp;(drag-n-drop)&nbsp;для&nbsp;перемещения/вращения&nbsp;выделенного&nbsp;объекта.&nbsp;Когда&nbsp;меняется&nbsp;выбор,&nbsp;EditorWindow&nbsp;вызывает&nbsp;gizmo.find_component(GizmoMoveController).set_target(selected_ent),&nbsp;тем&nbsp;самым&nbsp;задавая,&nbsp;к&nbsp;какому&nbsp;объекту&nbsp;привязан&nbsp;манипулятор.&nbsp;Gizmo&nbsp;не&nbsp;является&nbsp;выбираемым&nbsp;(selectable=False),&nbsp;чтобы&nbsp;не&nbsp;перехватывать&nbsp;выделение&nbsp;пользователя.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Виджет&nbsp;viewport&nbsp;–&nbsp;область&nbsp;визуализации&nbsp;3D-сцены&nbsp;внутри&nbsp;окна&nbsp;редактора.&nbsp;EditorWindow&nbsp;интегрирует&nbsp;движок&nbsp;рендеринга&nbsp;в&nbsp;Qt:&nbsp;при&nbsp;инициализации&nbsp;вызывается&nbsp;world.create_window(parent=self.viewportContainer),&nbsp;что&nbsp;создаёт&nbsp;окно&nbsp;рендеринга&nbsp;на&nbsp;базе&nbsp;Qt&nbsp;(через&nbsp;QtWindowBackend)&nbsp;и&nbsp;возвращает&nbsp;объект&nbsp;Window.&nbsp;Затем&nbsp;добавляется&nbsp;вьюпорт:&nbsp;self.viewport&nbsp;=&nbsp;viewport_window.add_viewport(self.scene,&nbsp;self.camera)&nbsp;–&nbsp;привязка&nbsp;текущей&nbsp;сцены&nbsp;и&nbsp;редакторской&nbsp;камеры&nbsp;к&nbsp;вьюпорту.&nbsp;Полученный&nbsp;OpenGL-виджет&nbsp;(viewport_window.handle.widget)&nbsp;вставляется&nbsp;в&nbsp;макет&nbsp;Qt-интерфейса.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Обработка&nbsp;ввода&nbsp;и&nbsp;выбор&nbsp;объектов:&nbsp;EditorWindow&nbsp;переключает&nbsp;окно&nbsp;в&nbsp;режим&nbsp;&quot;editor&quot;&nbsp;(viewport_window.set_world_mode(&quot;editor&quot;))&nbsp;–&nbsp;это&nbsp;включает&nbsp;генерацию&nbsp;буфера&nbsp;идентификаторов&nbsp;(ID&nbsp;buffer)&nbsp;для&nbsp;подбора&nbsp;объектов.&nbsp;В&nbsp;EditorWindow&nbsp;настраиваются&nbsp;коллбеки:&nbsp;viewport_window.on_mouse_button_event&nbsp;=&nbsp;self.mouse_button_event,&nbsp;on_mouse_move_event&nbsp;=&nbsp;self.mouse_moved,&nbsp;а&nbsp;after_render_handler&nbsp;=&nbsp;self._after_render.&nbsp;При&nbsp;движении&nbsp;курсора&nbsp;метод&nbsp;mouse_moved&nbsp;просто&nbsp;запоминает&nbsp;координаты&nbsp;для&nbsp;hover-pick.&nbsp;В&nbsp;after_render&nbsp;(вызывается&nbsp;после&nbsp;каждого&nbsp;кадра)&nbsp;редактор&nbsp;выполняет&nbsp;скрытый&nbsp;рендер-проход&nbsp;picking’a,&nbsp;читает&nbsp;ID&nbsp;под&nbsp;курсором&nbsp;и&nbsp;определяет&nbsp;hover_entity_id&nbsp;–&nbsp;идентификатор&nbsp;сущности&nbsp;под&nbsp;мышью,&nbsp;затем&nbsp;вызывает&nbsp;_request_update()&nbsp;для&nbsp;перерисовки&nbsp;с&nbsp;подсветкой.&nbsp;Щелчок&nbsp;мыши&nbsp;(mouse&nbsp;press)&nbsp;аналогично&nbsp;запускает&nbsp;чтение&nbsp;ID&nbsp;и&nbsp;обновляет&nbsp;selected_entity_id&nbsp;–&nbsp;идентификатор&nbsp;выбранной&nbsp;сущности.&nbsp;Далее&nbsp;происходит&nbsp;вызов&nbsp;on_selection_changed,&nbsp;который&nbsp;помимо&nbsp;установки&nbsp;gizmo,&nbsp;находит&nbsp;сам&nbsp;Entity&nbsp;по&nbsp;ID&nbsp;(через&nbsp;Window)&nbsp;и&nbsp;обновляет&nbsp;выделение&nbsp;в&nbsp;дереве&nbsp;сцены&nbsp;(_select_object_in_tree)&nbsp;и&nbsp;инспекторе.&nbsp;Таким&nbsp;образом&nbsp;реализовано&nbsp;интерактивное&nbsp;выделение&nbsp;объектов&nbsp;в&nbsp;viewport.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Конвейер&nbsp;рендеринга&nbsp;редактора:&nbsp;в&nbsp;отличие&nbsp;от&nbsp;простого&nbsp;приложения,&nbsp;редактор&nbsp;использует&nbsp;расширенный&nbsp;граф&nbsp;рендеринга&nbsp;для&nbsp;поддержки&nbsp;выделения&nbsp;и&nbsp;подсветки.&nbsp;EditorWindow&nbsp;переопределяет&nbsp;конвейер&nbsp;вьюпорта&nbsp;через&nbsp;viewport.set_render_pipeline(self.make_pipeline()).&nbsp;Метод&nbsp;make_pipeline()&nbsp;собирает&nbsp;список&nbsp;пассов:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;ColorPass&nbsp;–&nbsp;основной&nbsp;проход&nbsp;цвета&nbsp;сцены&nbsp;(пишет&nbsp;ресурс&nbsp;&quot;color&quot;,&nbsp;рисует&nbsp;все&nbsp;видимые&nbsp;объекты).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;IdPass&nbsp;–&nbsp;проход&nbsp;генерации&nbsp;ID-буфера&nbsp;(пишет&nbsp;ресурс&nbsp;&quot;preid&quot;,&nbsp;читая&nbsp;&quot;empty_id&quot;).&nbsp;Он&nbsp;использует&nbsp;Renderer.render_viewport_pick&nbsp;для&nbsp;отрисовки&nbsp;всех&nbsp;MeshRenderer&nbsp;объектов&nbsp;с&nbsp;уникальными&nbsp;цветами,&nbsp;сохраняя&nbsp;ссылки&nbsp;Entity→ID&nbsp;внутри&nbsp;Window.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;GizmoPass&nbsp;–&nbsp;дополнительный&nbsp;проход&nbsp;для&nbsp;корректировки&nbsp;ID-буфера&nbsp;с&nbsp;учётом&nbsp;Gizmo.&nbsp;Этот&nbsp;пасс&nbsp;читает&nbsp;промежуточный&nbsp;буфер&nbsp;&quot;preid&quot;&nbsp;и&nbsp;пишет&nbsp;итоговый&nbsp;&quot;id&quot;,&nbsp;одновременно&nbsp;рисуя&nbsp;геометрию&nbsp;gizmo&nbsp;особым&nbsp;образом&nbsp;(только&nbsp;в&nbsp;альфа-канале).&nbsp;Это&nbsp;нужно,&nbsp;чтобы&nbsp;детали&nbsp;манипулятора&nbsp;не&nbsp;мешали&nbsp;подсветке:&nbsp;GizmoPass&nbsp;помечает&nbsp;пиксели&nbsp;gizmo,&nbsp;изменяя&nbsp;альфа,&nbsp;но&nbsp;не&nbsp;меняя&nbsp;RGB&nbsp;ID-карты.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;PostProcessPass&nbsp;(назван&nbsp;&quot;PostFX&quot;)&nbsp;–&nbsp;пасс&nbsp;постобработки&nbsp;цвета.&nbsp;Берёт&nbsp;на&nbsp;вход&nbsp;&quot;color&quot;&nbsp;и&nbsp;выдаёт&nbsp;&quot;color_pp&quot;.&nbsp;Содержит&nbsp;цепочку&nbsp;PostEffect-эффектов,&nbsp;которая&nbsp;настраивается&nbsp;далее.&nbsp;В&nbsp;редакторе&nbsp;сразу&nbsp;после&nbsp;создания&nbsp;пасса&nbsp;добавляются&nbsp;два&nbsp;эффекта&nbsp;HighlightEffect&nbsp;–&nbsp;для&nbsp;hover&nbsp;и&nbsp;для&nbsp;selected.&nbsp;Класс&nbsp;HighlightEffect&nbsp;(termin/visualization/render/posteffects/highlight.py)&nbsp;–&nbsp;пост-эффект,&nbsp;выделяющий&nbsp;границы&nbsp;выбранного/подсвеченного&nbsp;объекта&nbsp;цветной&nbsp;рамкой.&nbsp;Он&nbsp;запрашивает&nbsp;ресурс&nbsp;&quot;id&quot;&nbsp;(ID-карта&nbsp;сцены),&nbsp;сравнивает&nbsp;каждый&nbsp;пиксель&nbsp;ID&nbsp;с&nbsp;заданным&nbsp;ID&nbsp;объекта&nbsp;и&nbsp;рисует&nbsp;контур&nbsp;вокруг&nbsp;областей&nbsp;совпадения&nbsp;(жёлтый&nbsp;для&nbsp;выбранного,&nbsp;голубой&nbsp;для&nbsp;подсвеченного).&nbsp;Эти&nbsp;эффекты&nbsp;делают&nbsp;визуальную&nbsp;подсветку&nbsp;выделенного&nbsp;объекта&nbsp;и&nbsp;объекта&nbsp;под&nbsp;курсором.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;CanvasPass&nbsp;–&nbsp;проход&nbsp;наложения&nbsp;UI.&nbsp;Берёт&nbsp;результат&nbsp;цвета&nbsp;с&nbsp;постэффектами&nbsp;(&quot;color_pp&quot;)&nbsp;и&nbsp;выводит&nbsp;&quot;color+ui&quot;.&nbsp;Если&nbsp;у&nbsp;вьюпорта&nbsp;задан&nbsp;canvas&nbsp;(например,&nbsp;для&nbsp;отрисовки&nbsp;2D-элементов&nbsp;интерфейса&nbsp;поверх&nbsp;3D),&nbsp;CanvasPass&nbsp;вызовет&nbsp;viewport.canvas.render()&nbsp;для&nbsp;рисования&nbsp;этих&nbsp;элементов.&nbsp;В&nbsp;редакторе&nbsp;canvas&nbsp;обычно&nbsp;не&nbsp;используется,&nbsp;но&nbsp;пасс&nbsp;включён&nbsp;для&nbsp;общности.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;PresentToScreenPass&nbsp;–&nbsp;финальный&nbsp;пасс&nbsp;вывода&nbsp;на&nbsp;экран.&nbsp;Берёт&nbsp;комбинированный&nbsp;буфер&nbsp;(&quot;color+ui&quot;)&nbsp;и&nbsp;отображает&nbsp;в&nbsp;окно&nbsp;(осуществляет&nbsp;blit&nbsp;в&nbsp;системный&nbsp;framebuffer).<br>
Такой&nbsp;пайплайн&nbsp;обеспечивает:&nbsp;отрисовку&nbsp;сцены,&nbsp;получение&nbsp;ID-карты&nbsp;для&nbsp;интерактивности,&nbsp;маскирование&nbsp;gizmo,&nbsp;наложение&nbsp;подсветки&nbsp;и&nbsp;вывод&nbsp;результата.&nbsp;FrameGraph&nbsp;внутри&nbsp;Window&nbsp;выстраивает&nbsp;зависимости&nbsp;этих&nbsp;пассов&nbsp;(например,&nbsp;что&nbsp;GizmoPass&nbsp;и&nbsp;HighlightEffect&nbsp;зависят&nbsp;от&nbsp;ресурса&nbsp;&quot;id&quot;&nbsp;от&nbsp;IdPass,&nbsp;а&nbsp;постэффект&nbsp;зависит&nbsp;от&nbsp;&quot;color&quot;)&nbsp;и&nbsp;выполняет&nbsp;их&nbsp;в&nbsp;нужном&nbsp;порядке.<br>
Архитектура&nbsp;графического&nbsp;пайплайна&nbsp;Termin<br>
Основной&nbsp;графический&nbsp;конвейер&nbsp;построен&nbsp;вокруг&nbsp;FrameGraph&nbsp;(графа&nbsp;кадра)&nbsp;и&nbsp;набора&nbsp;FramePass&nbsp;(проходов).&nbsp;Этот&nbsp;механизм&nbsp;обеспечивает&nbsp;гибкую&nbsp;конфигурацию&nbsp;этапов&nbsp;рендеринга&nbsp;для&nbsp;каждого&nbsp;вьюпорта:&nbsp;можно&nbsp;добавлять/удалять&nbsp;пассы&nbsp;(например,&nbsp;пост-эффекты,&nbsp;буфер&nbsp;picking’а&nbsp;и&nbsp;пр.)&nbsp;без&nbsp;жёсткого&nbsp;сценария.&nbsp;Ниже&nbsp;—&nbsp;ключевые&nbsp;элементы&nbsp;этого&nbsp;пайплайна:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;FramePass&nbsp;и&nbsp;FrameGraph&nbsp;–&nbsp;Каждый&nbsp;проход&nbsp;кадра&nbsp;(FramePass)&nbsp;декларирует,&nbsp;какие&nbsp;именованные&nbsp;ресурсы&nbsp;(текстуры/буферы&nbsp;кадра)&nbsp;он&nbsp;читает&nbsp;и&nbsp;пишет.&nbsp;Например,&nbsp;ColorPass&nbsp;пишет&nbsp;ресурс&nbsp;&quot;color&quot;,&nbsp;читая&nbsp;&quot;empty&quot;&nbsp;(заглушку&nbsp;начала&nbsp;графа).&nbsp;FrameGraph&nbsp;собирает&nbsp;все&nbsp;пассы&nbsp;в&nbsp;граф&nbsp;зависимостей:&nbsp;если&nbsp;пасс&nbsp;B&nbsp;читает&nbsp;ресурс,&nbsp;который&nbsp;пишет&nbsp;пасс&nbsp;A,&nbsp;то&nbsp;установится&nbsp;зависимость&nbsp;A→B.&nbsp;Метод&nbsp;FrameGraph.build_schedule()&nbsp;выполняет&nbsp;топологическую&nbsp;сортировку,&nbsp;разделяя&nbsp;inplace-проходы&nbsp;(которые&nbsp;помечены&nbsp;как&nbsp;inplace=True,&nbsp;то&nbsp;есть&nbsp;модифицируют&nbsp;ресурс&nbsp;на&nbsp;месте)&nbsp;и&nbsp;контролируя,&nbsp;что&nbsp;один&nbsp;ресурс&nbsp;пишется&nbsp;только&nbsp;одним&nbsp;пассом.&nbsp;Результат&nbsp;—&nbsp;упорядоченный&nbsp;список,&nbsp;по&nbsp;которому&nbsp;будет&nbsp;выполнен&nbsp;рендеринг&nbsp;кадра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Контекст&nbsp;кадра&nbsp;–&nbsp;Перед&nbsp;выполнением&nbsp;графа&nbsp;создаётся&nbsp;объект&nbsp;FrameContext&nbsp;(см.&nbsp;termin/visualization/render/framegraph/context.py).&nbsp;Он&nbsp;содержит&nbsp;ссылки&nbsp;на&nbsp;текущее&nbsp;окно,&nbsp;вьюпорт,&nbsp;графический&nbsp;бэкенд,&nbsp;размеры&nbsp;и&nbsp;словарь&nbsp;fbos&nbsp;–&nbsp;уже&nbsp;созданных&nbsp;Framebuffer&nbsp;объектов&nbsp;для&nbsp;именованных&nbsp;ресурсов.&nbsp;Window&nbsp;заранее&nbsp;подготавливает&nbsp;FBO&nbsp;на&nbsp;каждую&nbsp;группу&nbsp;алиасов&nbsp;ресурсов&nbsp;(например,&nbsp;если&nbsp;&quot;color&quot;&nbsp;и&nbsp;&quot;color_pp&quot;&nbsp;—&nbsp;алиасы&nbsp;одного&nbsp;физического&nbsp;буфера&nbsp;при&nbsp;разных&nbsp;этапах,&nbsp;они&nbsp;получат&nbsp;один&nbsp;FBO),&nbsp;и&nbsp;раскладывает&nbsp;их&nbsp;в&nbsp;ctx.fbos.&nbsp;Пассы&nbsp;при&nbsp;выполнении&nbsp;берут&nbsp;нужные&nbsp;FBO&nbsp;из&nbsp;ctx.fbos&nbsp;по&nbsp;имени.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Реализация&nbsp;проходов&nbsp;(RenderFramePass)&nbsp;–&nbsp;Каждый&nbsp;конкретный&nbsp;проход&nbsp;рендеринга&nbsp;–&nbsp;класс,&nbsp;наследующий&nbsp;RenderFramePass,&nbsp;должен&nbsp;реализовать&nbsp;метод&nbsp;execute(self,&nbsp;ctx:&nbsp;FrameContext).&nbsp;В&nbsp;Termin&nbsp;определены&nbsp;стандартные&nbsp;пассы&nbsp;в&nbsp;модуле&nbsp;termin/visualization/render/framegraph/passes:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;ColorPass&nbsp;–&nbsp;Очищает&nbsp;буфер&nbsp;цвета&nbsp;и&nbsp;вызывает&nbsp;window.renderer.render_viewport(...)&nbsp;для&nbsp;отрисовки&nbsp;всей&nbsp;сцены&nbsp;текущей&nbsp;камерой&nbsp;в&nbsp;привязанный&nbsp;FBO.&nbsp;Этот&nbsp;пасс&nbsp;отвечает&nbsp;за&nbsp;основную&nbsp;геометрию.&nbsp;Помечен&nbsp;inplace=True,&nbsp;так&nbsp;как&nbsp;обновляет&nbsp;ресурс&nbsp;&quot;color&quot;&nbsp;на&nbsp;месте.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;IdPass&nbsp;–&nbsp;Создаёт&nbsp;буфер&nbsp;идентификаторов&nbsp;для&nbsp;picking.&nbsp;Перед&nbsp;выполнением&nbsp;Window&nbsp;назначает&nbsp;FBO&nbsp;для&nbsp;&quot;id&quot;&nbsp;ресурса.&nbsp;В&nbsp;execute&nbsp;IdPass&nbsp;очищает&nbsp;его&nbsp;и&nbsp;проходится&nbsp;по&nbsp;всем&nbsp;сущностям&nbsp;сцены:&nbsp;для&nbsp;каждого&nbsp;видимого&nbsp;и&nbsp;pickable&nbsp;объекта&nbsp;вычисляет&nbsp;уникальный&nbsp;ID&nbsp;(через&nbsp;Window._get_pick_id_for_entity)&nbsp;и&nbsp;передаёт&nbsp;словарь&nbsp;pick_ids&nbsp;в&nbsp;renderer.render_viewport_pick(...).&nbsp;RenderViewportPick&nbsp;в&nbsp;Renderer&nbsp;отрисовывает&nbsp;только&nbsp;компоненты&nbsp;MeshRenderer,&nbsp;заливая&nbsp;каждую&nbsp;меш-геометрию&nbsp;плоским&nbsp;цветом,&nbsp;закодированным&nbsp;под&nbsp;ID.&nbsp;В&nbsp;итоге&nbsp;в&nbsp;текстуру&nbsp;&quot;id&quot;&nbsp;записываются&nbsp;уникальные&nbsp;цвета&nbsp;идентификаторов&nbsp;(RGB).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;PostProcessPass&nbsp;–&nbsp;Универсальный&nbsp;пасс&nbsp;постобработки.&nbsp;Инициализируется&nbsp;с&nbsp;цепочкой&nbsp;эффектов&nbsp;(объекты,&nbsp;наследующие&nbsp;PostEffect)&nbsp;и&nbsp;входным/выходным&nbsp;ресурсами.&nbsp;В&nbsp;execute&nbsp;этот&nbsp;пасс&nbsp;реализует&nbsp;применение&nbsp;N&nbsp;эффектов&nbsp;последовательно,&nbsp;используя&nbsp;технику&nbsp;ping-pong:&nbsp;если&nbsp;один&nbsp;эффект&nbsp;–&nbsp;рисует&nbsp;сразу&nbsp;в&nbsp;целевой&nbsp;FBO,&nbsp;если&nbsp;несколько&nbsp;–&nbsp;чередует&nbsp;два&nbsp;временных&nbsp;FBO.&nbsp;Каждый&nbsp;PostEffect&nbsp;получает&nbsp;на&nbsp;вход&nbsp;текущую&nbsp;текстуру&nbsp;цвета,&nbsp;словарь&nbsp;extra_textures&nbsp;(доп.&nbsp;ресурсы,&nbsp;которые&nbsp;эффект&nbsp;запросил&nbsp;через&nbsp;required_resources()),&nbsp;размер&nbsp;кадра&nbsp;и&nbsp;ключ&nbsp;контекста.&nbsp;Затем&nbsp;эффект&nbsp;должен&nbsp;настроить&nbsp;шейдер&nbsp;и&nbsp;нарисовать&nbsp;полноэкранный&nbsp;квад,&nbsp;применяя&nbsp;свой&nbsp;фильтр.&nbsp;По&nbsp;завершении&nbsp;цепочки&nbsp;PostProcessPass&nbsp;возвращает&nbsp;глубинный&nbsp;буфер&nbsp;в&nbsp;нормальное&nbsp;состояние&nbsp;(включает&nbsp;тест&nbsp;глубины&nbsp;обратно).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Примеры&nbsp;пост-эффектов:&nbsp;HighlightEffect&nbsp;(описан&nbsp;выше)&nbsp;накладывает&nbsp;цветной&nbsp;контур&nbsp;на&nbsp;выбранные&nbsp;объекты&nbsp;с&nbsp;использованием&nbsp;буфера&nbsp;&quot;id&quot;.&nbsp;Другие&nbsp;эффекты&nbsp;могут&nbsp;быть,&nbsp;например,&nbsp;GrayscaleEffect&nbsp;(оттенки&nbsp;серого)&nbsp;и&nbsp;т.п.&nbsp;–&nbsp;они&nbsp;обычно&nbsp;лежат&nbsp;в&nbsp;termin/visualization/render/posteffects/*&nbsp;и&nbsp;реализуют&nbsp;свой&nbsp;метод&nbsp;draw.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;CanvasPass&nbsp;–&nbsp;Пасс-компоновщик&nbsp;UI.&nbsp;Он&nbsp;помечен&nbsp;inplace=True&nbsp;и&nbsp;читает,&nbsp;например,&nbsp;ресурс&nbsp;&quot;color_pp&quot;,&nbsp;а&nbsp;пишет&nbsp;&quot;color+ui&quot;.&nbsp;В&nbsp;execute&nbsp;он&nbsp;просто&nbsp;биндит&nbsp;выходной&nbsp;FBO&nbsp;и&nbsp;вызывает&nbsp;рендер&nbsp;2D-канвы&nbsp;(если&nbsp;задана).&nbsp;Как&nbsp;правило,&nbsp;CanvasPass&nbsp;используется&nbsp;для&nbsp;наложения&nbsp;элементов&nbsp;интерфейса&nbsp;(текст,&nbsp;иконки)&nbsp;поверх&nbsp;3D.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;PresentToScreenPass&nbsp;–&nbsp;Финальный&nbsp;пасс&nbsp;графа,&nbsp;который&nbsp;берёт&nbsp;указанный&nbsp;ресурс&nbsp;(обычно&nbsp;комбинированный&nbsp;цвет+UI)&nbsp;и&nbsp;выводит&nbsp;на&nbsp;экран.&nbsp;Реализован,&nbsp;вероятно,&nbsp;внутри&nbsp;Window:&nbsp;после&nbsp;выполнения&nbsp;всех&nbsp;пассов&nbsp;Window&nbsp;берет&nbsp;конечный&nbsp;FBO&nbsp;и&nbsp;делает&nbsp;swap_buffers()&nbsp;для&nbsp;отображения.&nbsp;(В&nbsp;коде&nbsp;PresentToScreenPass&nbsp;просто&nbsp;пишет&nbsp;в&nbsp;буфер&nbsp;окна).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Связь&nbsp;с&nbsp;Renderer&nbsp;и&nbsp;компонентами&nbsp;–&nbsp;Обратите&nbsp;внимание,&nbsp;глобальный&nbsp;Renderer&nbsp;работает&nbsp;совместно&nbsp;с&nbsp;FrameGraph-пассами:&nbsp;ColorPass&nbsp;и&nbsp;IdPass&nbsp;используют&nbsp;window.renderer&nbsp;для&nbsp;отрисовки&nbsp;сцены.&nbsp;Таким&nbsp;образом&nbsp;логика&nbsp;обхода&nbsp;Entities&nbsp;и&nbsp;вызова&nbsp;их&nbsp;компонентов&nbsp;сконцентрирована&nbsp;в&nbsp;одном&nbsp;месте&nbsp;(Renderer),&nbsp;а&nbsp;пассы&nbsp;лишь&nbsp;настраивают&nbsp;параметры&nbsp;(какой&nbsp;буфер&nbsp;таргет,&nbsp;очищать&nbsp;ли&nbsp;фон,&nbsp;специальные&nbsp;режимы).&nbsp;Компоненты&nbsp;визуализации&nbsp;(например,&nbsp;MeshRenderer,&nbsp;SkyboxRenderer&nbsp;и&nbsp;др.)&nbsp;в&nbsp;своих&nbsp;методах&nbsp;draw(context)&nbsp;проверяют&nbsp;фазы/режимы&nbsp;через&nbsp;поле&nbsp;context.phase&nbsp;если&nbsp;нужно&nbsp;(например,&nbsp;могут&nbsp;не&nbsp;рисовать&nbsp;что-то&nbsp;в&nbsp;режиме&nbsp;&quot;pick&quot;).&nbsp;Большинство&nbsp;компонентов&nbsp;просто&nbsp;рисуют&nbsp;во&nbsp;всех&nbsp;фазах,&nbsp;но,&nbsp;например,&nbsp;можно&nbsp;настроить&nbsp;чтобы&nbsp;какой-то&nbsp;компонент&nbsp;отрисовывался&nbsp;только&nbsp;на&nbsp;определённом&nbsp;этапе.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Рендер-стейт&nbsp;и&nbsp;материалы&nbsp;–&nbsp;При&nbsp;рендере&nbsp;каждого&nbsp;объекта&nbsp;компоненты&nbsp;могут&nbsp;менять&nbsp;состояние&nbsp;рендеринга&nbsp;(глубина,&nbsp;блэнд,&nbsp;отсеивание)&nbsp;с&nbsp;помощью&nbsp;GraphicsBackend.apply_render_state().&nbsp;Класс&nbsp;RenderState&nbsp;определяет&nbsp;все&nbsp;такие&nbsp;параметры&nbsp;и&nbsp;используется&nbsp;внутри&nbsp;RenderPass&nbsp;каждого&nbsp;MeshRenderer.&nbsp;Например,&nbsp;для&nbsp;полупрозрачного&nbsp;материала&nbsp;можно&nbsp;задать&nbsp;blend=True&nbsp;с&nbsp;нужными&nbsp;факторами.&nbsp;Сами&nbsp;материалы&nbsp;(termin/visualization/core/material.py)&nbsp;хранят&nbsp;шейдеры&nbsp;и&nbsp;параметры&nbsp;униформ.&nbsp;В&nbsp;ходе&nbsp;MeshRenderer.draw()&nbsp;каждый&nbsp;материал&nbsp;активируется&nbsp;методом&nbsp;apply(model,&nbsp;view,&nbsp;proj,&nbsp;...),&nbsp;который&nbsp;привязывает&nbsp;шейдер&nbsp;и&nbsp;загружает&nbsp;матрицы&nbsp;преобразования.&nbsp;После&nbsp;отрисовки&nbsp;объекта&nbsp;рендер-стейт&nbsp;обычно&nbsp;сбрасывается&nbsp;на&nbsp;по&nbsp;умолчанию&nbsp;(глубина&nbsp;включена,&nbsp;блэнд&nbsp;выключен).<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Гибкость&nbsp;системы&nbsp;–&nbsp;Подход&nbsp;с&nbsp;FrameGraph&nbsp;и&nbsp;компонентами&nbsp;делает&nbsp;движок&nbsp;модульным.&nbsp;Можно&nbsp;добавлять&nbsp;новые&nbsp;компоненты&nbsp;(например,&nbsp;ParticleEmitter&nbsp;с&nbsp;собственным&nbsp;draw),&nbsp;они&nbsp;автоматически&nbsp;впишутся&nbsp;в&nbsp;цикл&nbsp;Renderer.&nbsp;Можно&nbsp;изменять&nbsp;конвейер&nbsp;вьюпорта:&nbsp;например,&nbsp;отключить&nbsp;пост-эффекты&nbsp;или&nbsp;добавить&nbsp;свой&nbsp;(достаточно&nbsp;вставить/удалить&nbsp;пасс&nbsp;в&nbsp;viewport.frame_passes).&nbsp;Конвейер&nbsp;редактора,&nbsp;как&nbsp;показано,&nbsp;расширяет&nbsp;дефолтный,&nbsp;добавляя&nbsp;IdPass&nbsp;и&nbsp;эффекты.&nbsp;Все&nbsp;ресурсы&nbsp;именованные,&nbsp;и&nbsp;конфликтов&nbsp;не&nbsp;возникает&nbsp;благодаря&nbsp;проверкам&nbsp;FrameGraph&nbsp;(один&nbsp;ресурс&nbsp;–&nbsp;один&nbsp;продюсер).&nbsp;Такой&nbsp;дизайн&nbsp;облегчает&nbsp;нейросети&nbsp;понимание&nbsp;последовательности&nbsp;шагов&nbsp;визуализации&nbsp;и&nbsp;взаимодействия&nbsp;компонентов:&nbsp;сцена&nbsp;содержит&nbsp;объекты&nbsp;с&nbsp;компонентами,&nbsp;Renderer&nbsp;обходит&nbsp;сцену&nbsp;и&nbsp;вызывает&nbsp;их&nbsp;отрисовку,&nbsp;FrameGraph&nbsp;управляет&nbsp;многоэтапным&nbsp;выводом&nbsp;кадра&nbsp;(основной&nbsp;цвет,&nbsp;идентификаторы,&nbsp;пост-обработка,&nbsp;UI),&nbsp;а&nbsp;PostEffects&nbsp;позволяют&nbsp;на&nbsp;лету&nbsp;модифицировать&nbsp;итоговое&nbsp;изображение&nbsp;без&nbsp;изменения&nbsp;логики&nbsp;компонентов&nbsp;сцены.<br>
<!-- END SCAT CODE -->
</body>
</html>
